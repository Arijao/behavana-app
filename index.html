<!DOCTYPE html>
<html lang="fr">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Material+Icons&family=Material+Symbols+Outlined&display=swap"
        rel="stylesheet">

    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEHAVANA - Système de Gestion</title>
    
    <!-- SEO & Description -->
    <meta name="description" content="Application de gestion des avances et de la collecte de vanille. Fonctionne offline.">
    <meta name="keywords" content="behavana, vanille, gestion, collecte, avances">
    <meta name="author" content="BEHAVANA">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/behavana-app/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" href="/behavana-app/logo.jpg" type="image/jpeg">
    <link rel="shortcut icon" href="/behavana-app/logo.jpg" type="image/jpeg">
    
    <!-- Theme Color (Android) -->
    <meta name="theme-color" content="#6750a4">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#10081c">
    
    <!-- Apple PWA Support (iOS) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BEHAVANA">
    <link rel="apple-touch-icon" href="/behavana-app/logo.jpg">
    
    <!-- Windows/MS Support -->
    <meta name="msapplication-TileColor" content="#6750a4">
    <meta name="msapplication-TileImage" content="/behavana-app/logo.jpg">
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="reception-export-enhanced.js"></script>

    <style>
        /* Landscape Mode Optimization for Small Screens */
        @media (max-height: 600px) and (orientation: landscape) {
            .header {
                height: 48px !important;
                padding: 0 8px !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                flex-wrap: nowrap !important;
            }

            /* YEAR SELECTOR - Toujours visible en paysage */
            .year-selector {
                display: flex !important;
                margin-left: 6px !important;
                gap: 4px !important;
                flex-shrink: 0 !important;
            }
            
            .year-label {
                display: none !important;  /* Cache "Année" pour gagner de l'espace */
            }
            
            #active-year {
                min-width: 65px !important;
                max-width: 75px !important;
                padding: 5px 10px !important;
                font-size: 13px !important;
                height: 34px !important;
                border-radius: 8px !important;
            }
            
            /* Barre de recherche plus compacte */
            .global-search-wrapper {
                max-width: 140px !important;
                height: 34px !important;
                margin: 0 4px !important;
                flex-shrink: 1 !important;
            }
            
            #global-search-input {
                font-size: 11px !important;
            }
            
            /* Header actions compactes */
            .header-actions {
                gap: 3px !important;
                flex-shrink: 0 !important;
            }
            
            .header-actions .btn-icon {
                width: 34px !important;
                height: 34px !important;
            }

            #sidebar-toggle {
                flex-shrink: 0 !important;
                padding: 6px !important;
                width: 34px !important;
                height: 34px !important;
            }

            .main-content {
                padding-top: 55px !important;
            }

            .sidebar {
                width: 240px !important;
                display: flex !important;
                flex-direction: column !important;
                height: 100vh !important;
                overflow: hidden !important;
            }

            .sidebar-header {
                padding: 10px 24px !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 10px 0 !important;
                -webkit-overflow-scrolling: touch;
            }

            .logo-icon {
                width: 32px !important;
                height: 32px !important;
            }

            .company-name {
                font-size: 16px !important;
            }

            .overview-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
            }

            .form-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .stat-card {
                padding: 8px !important;
            }

            .stat-icon {
                width: 32px !important;
                height: 32px !important;
                font-size: 18px !important;
            }
        }


        /* Specific fixes for Redmi Note 8 Pro and similar devices */
        @media (max-width: 450px) {
            .overview-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .stat-value {
                font-size: 16px !important;
            }

            .header {
                padding: 0 10px !important;
            }

            .global-search-wrapper {
                margin: 0 5px !important;
            }

            .data-table td {
                padding-left: 45% !important;
                font-size: 11px !important;
                white-space: normal !important;
                word-break: break-word !important;
            }

            .data-table td:before {
                width: 40% !important;
            }

            .btn {
                padding: 10px 16px !important;
                font-size: 14px !important;
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .form-group {
                margin-bottom: 10px !important;
            }

            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Prevent zoom on focus in iOS/Android */
        }

        /* ==========================================
         RESPONSIVE FIXES FOR MOBILE & LANDSCAPE
        ========================================== */
        @media (max-width: 992px) {

            .sidebar {
                position: fixed !important;
                left: 0 !important;
                top: 0 !important;
                bottom: 0 !important;
                width: 280px !important;
                transform: translateX(-100%) !important;
                z-index: 9999 !important;
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
                display: flex !important;
                flex-direction: column !important;
                visibility: visible !important;
                background: rgba(30, 30, 30, 0.98) !important;
                backdrop-filter: blur(20px) !important;
                overflow: hidden !important;
            }

            .nav-menu {
                flex: 1 !important;
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
            }

            .sidebar-header {
                flex-shrink: 0 !important;
            }

            .sidebar.mobile-open {
                transform: translateX(0) !important;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5) !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 12px !important;
                padding-top: 75px !important;
            }

            .header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 65px !important;
                z-index: 10000 !important;
                padding: 0 15px !important;
                border-radius: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                background: rgba(40, 40, 40, 0.9) !important;
            }

            #sidebar-toggle {
                display: flex !important;
                z-index: 1600 !important;
            }

            .global-search-wrapper {
                display: flex !important;
                flex: 1;
                max-width: none;
                margin: 0 10px;
                z-index: 10001 !important;
                position: relative !important;
                pointer-events: auto !important;
            }

            .dashboard-overview {
                padding: 16px !important;
                margin-bottom: 16px !important;
            }

            .dashboard-title {
                font-size: 18px !important;
            }

            .dashboard-subtitle {
                font-size: 13px !important;
                margin-bottom: 16px !important;
            }

            .overview-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            .overview-stat {
                padding: 12px !important;
            }

            .overview-stat-value {
                font-size: 18px !important;
            }

            .stat-card {
                padding: 12px !important;
            }

            .stat-icon {
                width: 40px !important;
                height: 40px !important;
                font-size: 20px !important;
            }

            .stat-value {
                font-size: 18px !important;
            }

            .stat-label {
                font-size: 13px !important;
            }

            .modal-header {
                margin: -16px -16px 16px -16px !important;
                padding: 12px 16px !important;
            }

            .modal-title {
                font-size: 16px !important;
            }

            .modal-content .form-group {
                margin-bottom: 12px !important;
            }

            .modal-content .form-label {
                font-size: 12px !important;
            }

            .modal-content .form-input,
            .modal-content .form-select {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            .modal-content .btn-group {
                flex-direction: row !important;
                gap: 8px !important;
                margin-top: 16px !important;
            }

            .modal-content .btn-group .btn {
                flex: 1 !important;
                padding: 10px !important;
                font-size: 13px !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .data-table table,
            .data-table thead,
            .data-table tbody,
            .data-table th,
            .data-table td,
            .data-table tr {
                display: block;
            }

            .data-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .data-table tr {
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 12px !important;
                margin-bottom: 12px !important;
                padding: 12px !important;
                background: rgba(80, 80, 80, 0.4) !important;
            }

            .data-table td {
                border: none !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
                position: relative !important;
                padding-left: 40% !important;
                padding-top: 8px !important;
                padding-bottom: 8px !important;
                min-height: 32px !important;
                display: flex !important;
                align-items: center !important;
                text-align: right !important;
                justify-content: flex-end !important;
                font-size: 12px !important;
            }

            .data-table tr td:last-child {
                border-bottom: none !important;
                justify-content: center !important;
                padding-left: 0 !important;
                margin-top: 8px !important;
            }

            .data-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 8px;
                width: 35%;
                padding-right: 8px;
                white-space: nowrap;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.6) !important;
                font-size: 11px !important;
                text-align: left;
            }

            .actions-cell {
                justify-content: center !important;
                width: 100% !important;
                gap: 12px !important;
            }

            .global-search-wrapper {
                display: flex !important;
                flex: 1 !important;
                max-width: 200px !important;
                margin: 0 8px !important;
                background: rgba(255, 255, 255, 0.15) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                height: 36px !important;
                padding: 0 12px !important;
                position: relative !important;
                z-index: 10001 !important;
                pointer-events: auto !important;
                /* AMPIANA */
                touch-action: auto !important;
                /* AMPIANA - ho an'ny touch screen */
            }

            #global-search-input {
                width: 100% !important;
                background: transparent !important;
                border: none !important;
                color: #fff !important;
                font-size: 13px !important;
                padding: 0 !important;
                position: relative !important;
                z-index: 10002 !important;
                pointer-events: auto !important;
                /* AMPIANA */
                touch-action: auto !important;
                /* AMPIANA */
                -webkit-user-select: text !important;
                /* AMPIANA - ho an'ny iOS */
                user-select: text !important;
                /* AMPIANA */
            }

            #global-search-input:focus {
                outline: none !important;
                background: transparent !important;
            }

            /* Hamarino fa ny icon dia tsy manarona ny input */
            .global-search-wrapper .material-icons {
                pointer-events: none !important;
                /* Tsy afaka mi-click ny icon */
                z-index: 10000 !important;
            }
        }

        /* Landscape Mode Optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                height: 50px !important;
            }

            .main-content {
                padding-top: 60px !important;
            }

            .dashboard-overview {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                padding: 15px !important;
            }

            .overview-stats {
                grid-template-columns: repeat(4, 1fr) !important;
                width: 100%;
            }

            .modal-content {
                max-height: 95vh !important;
                top: 10px !important;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        /* iPhone Xs Specific (375px) */
        @media (max-width: 375px) {
            .overview-stats {
                grid-template-columns: 1fr 1fr !important;
            }

            .stat-value {
                font-size: 16px !important;
            }

            .modal-content {
                width: 95% !important;
                padding: 12px !important;
            }
        }

        

        

        /* Desktop only - raha collapsed */
        @media (min-width: 993px) {
            .sidebar.collapsed {
                width: 80px;
            }
            .sidebar.collapsed .logo-icon {
                width: 40px;
                height: 40px;
            }
            .sidebar.collapsed .company-name,
            .sidebar.collapsed .company-subtitle,
            .sidebar.collapsed .nav-text {
                display: none;
            }
            .sidebar.collapsed .nav-item {
                margin: 4px 8px;
            }
            .sidebar.collapsed .nav-link {
                justify-content: center;
                padding: 12px;
            }
            .sidebar.collapsed .nav-link span.material-icons {
                margin: 0;
            }
            .main-content.sidebar-collapsed {
                margin-left: 80px;
                width: calc(100% - 80px);
            }
        }

        /* ==========================================
    GLASSMORPHISM THEME - Inspired by Modern UI
    ========================================== */
        :root {
            --md-sys-color-primary: #0061a4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d1e4ff;
            --md-sys-color-on-primary-container: #001d36;
            --md-sys-color-secondary: #535f70;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #d7e3f7;
            --md-sys-color-on-secondary-container: #101c2b;
            --md-sys-color-tertiary: #6b5778;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #f2daff;
            --md-sys-color-on-tertiary-container: #251431;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-success: #006d3a;
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-success-container: #98f7b5;
            --md-sys-color-on-success-container: #00210e;
            --md-sys-color-background: #fdfcff;
            --md-sys-color-on-background: #1a1c1e;
            --md-sys-color-surface: #fdfcff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe2eb;
            --md-sys-color-on-surface-variant: #43474e;
            --md-sys-color-outline: #73777f;
            --md-sys-color-outline-variant: #c3c7cf;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #f4eff4;
            --md-sys-color-inverse-primary: #d0bcff;
            --md-sys-color-surface-tint: #6750a4;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #d0bcff;
            --md-sys-color-on-primary: #381e72;
            --md-sys-color-primary-container: #4f378b;
            --md-sys-color-on-primary-container: #eaddff;
            --md-sys-color-secondary: #ccc2dc;
            --md-sys-color-on-secondary: #332d41;
            --md-sys-color-secondary-container: #4a4458;
            --md-sys-color-on-secondary-container: #e8def8;
            --md-sys-color-tertiary: #efb8c8;
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633b48;
            --md-sys-color-on-tertiary-container: #ffd8e4;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000a;
            --md-sys-color-on-error-container: #ffdad6;
            --md-sys-color-success: #a5d6a7;
            --md-sys-color-on-success: #1b5e20;
            --md-sys-color-success-container: #2e7d32;
            --md-sys-color-on-success-container: #e8f5e8;
            --md-sys-color-background: #10081c;
            --md-sys-color-on-background: #e6e1e5;
            --md-sys-color-surface: #10081c;
            --md-sys-color-on-surface: #e6e1e5;
            --md-sys-color-surface-variant: #49454f;
            --md-sys-color-on-surface-variant: #cab6d0;
            --md-sys-color-outline: #938f99;
            --md-sys-color-outline-variant: #49454f;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #e6e1e5;
            --md-sys-color-inverse-on-surface: #313033;
            --md-sys-color-inverse-primary: #6750a4;
            --md-sys-color-surface-tint: #d0bcff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--md-sys-color-surface);
            border-right: 1px solid var(--md-sys-color-outline-variant);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            overflow: visible;
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
        }

        .company-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
        }

        .company-subtitle {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            padding: 24px 0;
        }

        .nav-item {
            margin: 4px 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
            position: relative;
            min-height: 48px; /* Mobile accessibility */
        }

        /* --- Tooltip System --- */
        .nav-link::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 12px);
            top: 50%;
            transform: translateY(-50%);
            background-color: #1e1e1e;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            z-index: 10001;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-link::before {
            content: "";
            position: absolute;
            left: calc(100% + 6px);
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #1e1e1e;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            z-index: 10001;
            pointer-events: none;
        }

        @media (min-width: 993px) {
            .sidebar.collapsed .nav-link:hover::after,
            .sidebar.collapsed .nav-link:hover::before {
                opacity: 1 !important;
                visibility: visible !important;
            }
        }

        @media (max-width: 992px) {
            .nav-link::after, .nav-link::before { display: none !important; }
        }
    

        .nav-link:hover {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .nav-link.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }



        

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: calc(100% - 280px);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-variant);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--md-sys-color-primary);
            border-radius: 10px;
            border: 2px solid var(--md-sys-color-surface-variant);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background-color: var(--md-sys-color-surface);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--md-sys-color-outline-variant);
            position: sticky;
            top: 0;
            z-index: 120;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 120%;
            height: 120%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn .material-icons {
            font-size: 20px;
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 16px rgba(0, 97, 164, 0.3);
        }

        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-secondary:hover {
            background-color: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 2px solid var(--md-sys-color-outline);
        }

        .btn-outline:hover {
            background-color: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary-container);
        }

        .btn-danger {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 16px rgba(186, 26, 26, 0.3);
        }

        .btn-success {
            background-color: var(--md-sys-color-success);
            color: var(--md-sys-color-on-success);
        }

        .btn-success:hover {
            box-shadow: 0 6px 16px rgba(0, 109, 58, 0.3);
        }

        .btn-icon {
            padding: 6px;
            min-width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin: 0;
            flex-shrink: 0;
        }

        .btn-icon .material-icons {
            font-size: 18px;
            line-height: 1;
        }

        .btn-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-icon:active::before {
            width: 120%;
            height: 120%;
        }

        .btn-icon:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-icon:active {
            transform: translateY(0) scale(0.95);
        }

        .btn-icon.btn-outline {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1.5px solid var(--md-sys-color-outline);
        }

        .btn-icon.btn-outline:hover {
            background-color: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary-container);
        }

        .btn-icon.btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
        }

        .btn-icon.btn-primary:hover {
            background-color: var(--md-sys-color-primary);
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(0, 97, 164, 0.3);
        }

        .btn-icon.btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: none;
        }

        .btn-icon.btn-secondary:hover {
            background-color: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
            box-shadow: 0 4px 12px rgba(83, 95, 112, 0.3);
        }

        .btn-icon.btn-danger {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            border: none;
        }

        .btn-icon.btn-danger:hover {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
            box-shadow: 0 4px 12px rgba(186, 26, 26, 0.3);
        }

        .btn-icon.btn-success {
            background-color: var(--md-sys-color-success-container);
            color: var(--md-sys-color-on-success-container);
            border: none;
        }

        .btn-icon.btn-success:hover {
            background-color: var(--md-sys-color-success);
            color: var(--md-sys-color-on-success);
            box-shadow: 0 4px 12px rgba(0, 109, 58, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        @media (max-width:768px) {
            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }
        }

        .btn:disabled,
        .btn-icon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn.loading,
        .btn-icon.loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }

        .btn.loading::after,
        .btn-icon.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btnSpin 0.6s linear infinite;
        }

        @keyframes btnSpin {
            to {
                transform: rotate(360deg);
            }
        }

        .btn:active:not(:disabled),
        .btn-icon:active:not(:disabled) {
            transform: scale(0.95);
        }

        .btn:focus-visible,
        .btn-icon:focus-visible {
            outline: 2px solid var(--md-sys-color-primary);
            outline-offset: 2px;
        }

        .actions-cell {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            margin: 0 auto;
        }

        @media (max-width:480px) {
            .actions-cell {
                flex-direction: column;
                gap: 4px;
            }

            .actions-cell .btn-icon {
                width: 100%;
            }
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: var(--md-sys-color-on-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.hide {
            opacity: 0;
        }

        .toast.success {
            background-color: var(--md-sys-color-success);
            color: var(--md-sys-color-on-success);
        }

        .toast.error {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .global-search-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 24px;
            padding: 4px 16px;
            flex-grow: 0.5;
            max-width: 400px;
            transition: all 0.2s ease;
        }

        .global-search-wrapper:focus-within {
            background-color: var(--md-sys-color-surface);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary);
        }

        .global-search-wrapper .material-icons {
            color: var(--md-sys-color-on-surface-variant);
            margin-right: 8px;
        }

        #global-search-input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 8px 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .dashboard-overview {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container));
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-overview::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>') no-repeat;
            background-size: contain;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-sys-color-on-primary-container);
            margin-bottom: 4px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
            margin-bottom: 24px;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .overview-stat {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .overview-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-sys-color-on-primary-container);
            margin-bottom: 4px;
        }

        .overview-stat-label {
            font-size: 14px;
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--md-sys-color-outline-variant);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            opacity: 0.8;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 15px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 12px;
        }

        .stat-trend.positive {
            color: var(--md-sys-color-success);
        }

        .stat-trend.negative {
            color: var(--md-sys-color-error);
        }

        .stat-trend.neutral {
            color: var(--md-sys-color-on-surface-variant);
        }

        .solde-global-card {
            background: linear-gradient(135deg, var(--md-sys-color-success-container), var(--md-sys-color-success));
            color: var(--md-sys-color-on-success);
        }

        .solde-global-card.debiteur {
            background: linear-gradient(135deg, var(--md-sys-color-error-container), var(--md-sys-color-error));
            color: var(--md-sys-color-on-error);
        }

        .solde-global-card.equilibre {
            background: linear-gradient(135deg, var(--md-sys-color-secondary-container), var(--md-sys-color-secondary));
            color: var(--md-sys-color-on-secondary);
        }

        .solde-global-card .stat-value,
        .solde-global-card .stat-label,
        .solde-global-card .stat-trend {
            color: inherit;
        }

        .solde-global-card .stat-icon {
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--md-sys-color-outline-variant);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .summary-insights {
            background-color: var(--md-sys-color-surface);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--md-sys-color-outline-variant);
            margin-bottom: 32px;
        }

        .insights-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            background-color: var(--md-sys-color-surface-variant);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--md-sys-color-on-primary);
        }

        .insight-content {
            flex: 1;
            position: relative;
        }

        .insight-text {
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .insight-detail {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        #debtors-card.clickable {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #debtors-card.clickable:hover {
            background-color: var(--md-sys-color-primary-container);
            transform: scale(1.02);
        }

        #debtors-card.clickable .insight-content::after {
            content: 'arrow_forward';
            font-family: 'Material Icons';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-primary);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #debtors-card.clickable:hover .insight-content::after {
            opacity: 1;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-table {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-bottom: 24px;
            border: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }

        .table-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content:space-between;
            align-items: center;
            background-color: var(--md-sys-color-surface);
            z-index: 110;
            border-radius: 16px 16px 0 0;
            flex-shrink: 0;
            position: relative;
        }

        .table-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .table-scroll-wrapper {
            overflow-y: auto;
            overflow-x: auto;
            flex: 1;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 150px;
        }

        .data-table td:not(:first-child):not(:last-child) {
            min-width: 100px;
        }

        .data-table td[data-label*="Montant"],
        .data-table td[data-label*="Prix"],
        .data-table td[data-label*="Solde"],
        .data-table td[data-label*="Valeur"] {
            white-space: nowrap;
        }

        .data-table td[data-label*="Date"] {
            white-space: nowrap;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            width: auto;
            min-width: 120px;
            max-width: 150px;
            white-space: nowrap;
            padding: 12px;
            text-align: right;
            vertical-align: middle;
        }

        .actions-cell {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: nowrap;
            width: 100%;
        }

        .data-table th:last-child {
            text-align: center;
        }

        .data-table th {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            user-select: none;
            vertical-align: middle;
        }

        .data-table tbody tr:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-on-surface);
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
            vertical-align: middle;
        }

        th::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            opacity: 0.3;
        }

        th.asc::after {
            border-bottom-color: var(--md-sys-color-on-surface-variant);
            opacity: 1;
        }

        th.desc::after {
            border-top-color: var(--md-sys-color-on-surface-variant);
            opacity: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            vertical-align: top;
        }

        tbody tr:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        td {
            color: var(--md-sys-color-on-surface);
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
        }

        .form-container {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            font-size: 13px;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }

        .form-input:focus {
            border-color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-surface);
            box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1);
            transform: translateY(-1px);
        }

        .form-input:hover {
            border-color: var(--md-sys-color-outline);
        }

        .form-input:disabled {
            background-color: var(--md-sys-color-surface-variant);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Champs readonly - non focusables */
        input[readonly],
        textarea[readonly] {
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }

        input[readonly]:focus,
        textarea[readonly]:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%230061a4' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .form-select:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1)!important;
            transform: translateY(-1px);
        }

        .form-select:hover {
            border-color: var(--md-sys-color-outline);
        }

        .form-select:disabled {
            background-color: var(--md-sys-color-surface-variant);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            min-height: 100px;
            resize: vertical;
            font-family: 'Roboto', sans-serif;
        }

        .form-textarea:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1);
            transform: translateY(-1px);
        }

        .form-textarea:hover {
            border-color: var(--md-sys-color-outline);
        }

        .form-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .form-input-group .material-icons {
            position: absolute;
            left: 14px;
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none;
            font-size: 20px;
        }

        .form-input-group .form-input {
            padding-left: 44px;
        }

        .form-label.required::after {
            content: '*';
            color: var(--md-sys-color-error);
            margin-left: 4px;
            font-size: 14px;
        }

        .form-helper-text {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .form-helper-text.error {
            color: var(--md-sys-color-error);
        }

        .form-input.error,
        .form-select.error {
            border-color: var(--md-sys-color-error);
        }

        .form-input.error:focus,
        .form-select.error:focus {
            box-shadow: 0 0 0 4px rgba(186, 26, 26, 0.1);
        }

        .form-input.success,
        .form-select.success {
            border-color: var(--md-sys kasscolor-success);
        }

        .form-input.success:focus,
        .form-select.success:focus {
            box-shadow: 0 0 0 4px rgba(0, 109, 58, 0.1);
        }

        .form-checkbox,
        .form-radio {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px;
            background-color: var(--md-sys-color-surface);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .form-radio {
            border-radius: 50%;
        }

        .form-checkbox:checked,
        .form-radio:checked {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .form-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--md-sys-color-on-primary);
            font-size: 14px;
            font-weight: bold;
        }

        .form-radio:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--md-sys-color-on-primary);
        }

        .form-check-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .form-input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .form-input[type="number"]::-webkit-outer-spin-button,
        .form-input[type="number"]::-webkit-inner-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-debiteur {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }

        .status-crediteur {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-equilibre {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInModal 0.3s ease forwards;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: var(--md-sys-color-surface);
            border-radius: 24px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            animation: scaleInModal 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
        }

        @keyframes scaleInModal {
            to {
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--md-sys-color-outline-variant);
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container));
            margin: -24px -24px 24px -24px;
            padding: 20px 24px;
            border-radius: 24px 24px 0 0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-title .material-icons {
            font-size: 28px;
            color: var(--md-sys-color-primary);
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 24px;
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--md-sys-color-on-surface);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background-color: var(--md-sys-color-surface-variant);
            transform: rotate(180deg);
        }

        .modal-content .form-group {
            margin-bottom: 18px;
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-content .form-input,
        .modal-content .form-select,
        .modal-content .form-textarea {
            padding: 10px 14px;
            font-size: 14px;
            width: 100%;
            border: 2px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }

        .modal-content .form-input:focus,
        .modal-content .form-select:focus,
        .modal-content .form-textarea:focus {
            border-color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-surface);
            box-shadow: 0 0 0 4px rgba(103, 80, 164, 0.1);
            transform: translateY(-1px);
        }

        .modal-content .form-input:hover,
        .modal-content .form-select:hover,
        .modal-content .form-textarea:hover {
            border-color: var(--md-sys-color-outline);
        }

        .modal-content .form-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: 'Roboto', sans-serif;
        }

        .modal-content .modal-title {
            font-size: 20px;
        }

        .modal-content .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .modal-content .btn-group .btn {
            flex: 1;
            justify-content: center;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--md-sys-color-outline-variant);
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--md-sys-color-outline);
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .actions-cell {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .empty-state .material-icons {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--md-sys-color-outline-variant);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #sidebar-toggle {
            margin-right: 16px;
        }



        .credit-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .credit-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--md-sys-color-primary);
            flex-shrink: 0;
            background-color: var(--md-sys-color-surface);
            background-image: url('logo.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .credit-text {
            flex-grow: 1;
        }

        .credit-text p {
            font-size: 14px;
            margin: 0;
        }

        .credit-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-primary);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .credit-name:hover {
            text-decoration: underline;
            color: var(--md-sys-color-tertiary);
        }

        .credit-version {
            font-size: 12px;
            font-weight: 500;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 4px 10px;
            border-radius: 8px;
        }



        @media (max-width:768px) {

            .sidebar {
                width: 280px !important;
                left: 0 !important;
                transform: translateX(-100%) !important;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                position: fixed !important;
                z-index: 3000 !important;
                height: 100vh !important;
                visibility: visible !important;
                display: block !important;
            }

            .sidebar.mobile-open {
                transform: translateX(0) !important;
            }

            .sidebar.mobile-open .company-name,
            .sidebar.mobile-open .company-subtitle,
            .sidebar.mobile-open .nav-link .nav-text {
                display: block !important;
            }

            .sidebar.mobile-open .logo {
                justify-content: flex-start !important;
            }

            .sidebar.mobile-open .nav-link {
                justify-content: flex-start !important;
                padding: 12px 16px !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 12px !important;
                padding-top: 70px !important;
            }

            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                border-radius: 0;
                margin-bottom: 0;
                z-index: 1500;
                padding: 8px 12px;
                height: 60px;
            }

            #sidebar-toggle {
                display: flex !important;
                z-index: 1600;
                position: relative;
                padding: 8px;
            }

            .global-search-wrapper {
                display: none;
            }

            .dashboard-overview {
                padding: 16px !important;
                margin-bottom: 16px !important;
            }

            .dashboard-title {
                font-size: 18px !important;
            }

            .dashboard-subtitle {
                font-size: 13px !important;
                margin-bottom: 16px !important;
            }

            .overview-stat {
                padding: 12px !important;
            }

            .overview-stat-value {
                font-size: 18px !important;
            }

            .stat-card {
                padding: 12px !important;
            }

            .stat-icon {
                width: 40px !important;
                height: 40px !important;
                font-size: 20px !important;
            }

            .stat-value {
                font-size: 18px !important;
            }

            .stat-label {
                font-size: 13px !important;
            }

            .modal-content {
                width: 92% !important;
                max-width: 92% !important;
                padding: 16px !important;
                margin: 0 auto !important;
                max-height: 85vh !important;
                border-radius: 16px !important;
            }

            .modal-header {
                margin: -16px -16px 16px -16px !important;
                padding: 12px 16px !important;
            }

            .modal-title {
                font-size: 16px !important;
            }

            .modal-content .form-group {
                margin-bottom: 12px !important;
            }

            .modal-content .form-label {
                font-size: 12px !important;
            }

            .modal-content .form-input,
            .modal-content .form-select {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            .modal-content .btn-group {
                flex-direction: row !important;
                gap: 8px !important;
                margin-top: 16px !important;
            }

            .modal-content .btn-group .btn {
                flex: 1 !important;
                padding: 10px !important;
                font-size: 13px !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .overview-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            .data-table table,
            .data-table thead,
            .data-table tbody,
            .data-table th,
            .data-table td,
            .data-table tr {
                display: block;
            }

            .data-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .data-table tr {
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 12px !important;
                margin-bottom: 12px !important;
                padding: 12px !important;
                background: rgba(80, 80, 80, 0.4) !important;
            }

            .data-table td {
                border: none !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
                position: relative !important;
                padding-left: 40% !important;
                padding-top: 8px !important;
                padding-bottom: 8px !important;
                min-height: 32px !important;
                display: flex !important;
                align-items: center !important;
                text-align: right !important;
                justify-content: flex-end !important;
                font-size: 12px !important;
            }

            .data-table tr td:last-child {
                border-bottom: none !important;
                justify-content: center !important;
                padding-left: 0 !important;
                margin-top: 8px !important;
            }

            .data-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 8px;
                width: 35%;
                padding-right: 8px;
                white-space: nowrap;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.6) !important;
                font-size: 11px !important;
                text-align: left;
            }

            .actions-cell {
                justify-content: center !important;
                width: 100% !important;
                gap: 12px !important;
            }
        }

        .form-label {
            color: var(--md-sys-color-on-surface) !important;
            font-weight: 600 !important;
            opacity: 1 !important;
        }

        [data-theme="dark"] .form-label {
            color: var(--md-sys-color-on-surface) !important;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        }


        @media (max-width: 992px) {
            .header {
                gap: 8px !important;
                padding: 0 8px !important;
            }

            .header h1 {
                display: none !important;
            }

            .global-search-wrapper {
                max-width: 180px !important;
            }
        }


        @media (max-width: 992px) {
            .global-search-wrapper {
                display: flex !important;
                flex: 1 !important;
                max-width: 200px !important;
                margin: 0 8px !important;
                background: rgba(255, 255, 255, 0.15) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                height: 36px !important;
                padding: 0 12px !important;
            }

            #global-search-input {
                font-size: 12px !important;
                color: white !important;
                position: relative !important;
                z-index: 10002 !important;
                pointer-events: auto !important;
            }

            #global-search-input::placeholder {
                color: rgba(255, 255, 255, 0.6) !important;
            }

            .header-actions {
                gap: 4px !important;
            }

            .btn-icon {
                width: 32px !important;
                height: 32px !important;
            }
        }


        
    </style>
    <style>
        /* Landscape Mode Optimization for Small Screens */
        @media (max-height: 600px) and (orientation: landscape) {
            .header {
                height: 48px !important;
            }

            .main-content {
                padding-top: 55px !important;
            }

            .sidebar {
                width: 240px !important;
                display: flex !important;
                flex-direction: column !important;
                height: 100vh !important;
                overflow: hidden !important;
            }

            .sidebar-header {
                padding: 10px 24px !important;
                flex-shrink: 0 !important;
            }

            .nav-menu {
                flex: 1 !important;
                overflow-y: auto !important;
                padding: 10px 0 !important;
                -webkit-overflow-scrolling: touch;
            }

            .logo-icon {
                width: 32px !important;
                height: 32px !important;
            }

            .company-name {
                font-size: 16px !important;
            }

            .overview-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important;
            }

            .form-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .stat-card {
                padding: 8px !important;
            }

            .stat-icon {
                width: 32px !important;
                height: 32px !important;
                font-size: 18px !important;
            }
        }

        /* Specific fixes for Redmi Note 8 Pro and similar devices */
        @media (max-width: 450px) {
            .overview-stats {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .stat-value {
                font-size: 16px !important;
            }

            .header {
                padding: 0 10px !important;
            }

            .global-search-wrapper {
                margin: 0 5px !important;
            }

            .data-table td {
                padding-left: 45% !important;
                font-size: 11px !important;
                white-space: normal !important;
                word-break: break-word !important;
            }

            .data-table td:before {
                width: 40% !important;
            }

            .btn {
                padding: 10px 16px !important;
                font-size: 14px !important;
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .form-group {
                margin-bottom: 10px !important;
            }

            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Prevent zoom on focus in iOS/Android */
        }

        /* ==========================================
    GLASSMORPHISM THEME - Inspired by Modern UI
    ========================================== */

        /* Background with blur effect */
        body {
            background-image: url('https://images.unsplash.com/photo-1497366216548-37526070297c?w=1920');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(8px);
            z-index: -1;
        }

        /* Sidebar - Dark Glassmorphism */
        .sidebar {
            background: rgba(40, 40, 40, 0.75) !important;
            backdrop-filter: blur(30px) saturate(150%) !important;
            -webkit-backdrop-filter: blur(30px) saturate(150%) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3) !important;
        }

        .sidebar-header {
            background: rgba(60, 60, 60, 0.5) !important;
            backdrop-filter: blur(20px) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 0 !important;
        }

        .company-name,
        .company-subtitle {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Navigation Links */
        .nav-link {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            color: rgba(255, 255, 255, 0.85) !important;
            transition: all 0.3s ease !important;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            transform: translateX(8px) !important;
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1) !important;
        }

        .nav-link.active {
            background: rgba(103, 80, 164, 0.4) !important;
            border: 1px solid rgba(103, 80, 164, 0.6) !important;
            box-shadow: 0 4px 20px rgba(103, 80, 164, 0.3) !important;
        }

        /* Main Content Area */
        .main-content {
            background: transparent !important;
        }

        /* Header - Glassmorphism */
        .header {
            background: rgba(60, 60, 60, 0.6) !important;
            backdrop-filter: blur(25px) saturate(140%) !important;
            -webkit-backdrop-filter: blur(25px) saturate(140%) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }

        .header h1 {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Search Bar */
        .global-search-wrapper {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
        }

        .global-search-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 0 20px rgba(103, 80, 164, 0.4) !important;
        }

        #global-search-input {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        #global-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        .year-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .year-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9) !important;
            opacity: 1 !important;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            white-space: nowrap;
        }

        #active-year {
            min-width: 85px !important;
            max-width: 110px !important;
            padding: 8px 14px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            color: rgba(255, 255, 255, 1) !important;
            background: linear-gradient(135deg, rgba(103, 80, 164, 0.9), rgba(107, 87, 120, 0.85)) !important;
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 16px rgba(103, 80, 164, 0.6), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
            backdrop-filter: blur(15px) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-align: center !important;
            letter-spacing: 0.5px !important;
        }

        #active-year:hover {
            background: linear-gradient(135deg, rgba(103, 80, 164, 1), rgba(107, 87, 120, 1)) !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 6px 24px rgba(103, 80, 164, 0.8), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
            transform: translateY(-2px) !important;
        }

        #active-year:focus {
            outline: none !important;
            border-color: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.4),
                        0 6px 24px rgba(103, 80, 164, 0.8) !important;
        }

        /* Options du dropdown */
        #active-year option {
            background-color: rgba(40, 40, 40, 0.98) !important;
            color: white !important;
            padding: 12px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
        }

        #active-year option:hover,
        #active-year option:checked {
            background: linear-gradient(135deg, rgba(103, 80, 164, 0.9), rgba(107, 87, 120, 0.8)) !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .year-label {
                display: none;
            }
            
            #active-year {
                min-width: 75px !important;
                padding: 6px 12px !important;
                font-size: 15px !important;
            }
        }

        /* ========================================
        YEAR SLIDER - FLUID ANIMATION STYLE (Dribbble-inspired)
        ======================================== */

        .year-slider-container {
            display: flex;
            align-items: center;
            position: relative;
            margin-left: 12px;
            padding: 8px 0;
        }

        .year-slider-track {
            width: 6px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            overflow: visible;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.4);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Elastic ease */
        }

        .year-slider-track:hover {
            background: rgba(255, 255, 255, 0.25);
            width: 8px; /* Morphing effect - mitombo ny width */
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.5), 0 0 16px rgba(255, 215, 0, 0.4);
            transform: scaleY(1.05); /* Mihalava kely rehefa hover */
        }

        .year-slider-track.dragging {
            background: rgba(255, 255, 255, 0.3);
            width: 9px; /* Mitombo bebe kokoa rehefa drag */
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .year-slider-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.9), rgba(255, 193, 7, 0.8));
            border-radius: 10px;
            transition: height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); /* Elastic bounce */
            box-shadow: 0 -2px 12px rgba(255, 215, 0, 0.6);
            pointer-events: none;
        }

        .year-slider-thumb {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, rgba(103, 80, 164, 0.95), rgba(107, 87, 120, 0.9));
            border: 3px solid rgba(255, 215, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Elastic ease */
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            z-index: 10;
            pointer-events: auto;
            touch-action: none;
        }

        .year-slider-thumb:hover {
            transform: translate(-50%, -50%) scale(1.15); /* Elastic scale */
            border-color: rgba(255, 215, 0, 1);
            border-width: 4px; /* Morphing border - mivadika ny border */
            box-shadow: 
                0 16px 40px rgba(0, 0, 0, 0.6),
                0 0 35px rgba(255, 215, 0, 0.8),
                inset 0 3px 8px rgba(255, 255, 255, 0.5);
        }

        .year-slider-thumb:active,
        .year-slider-thumb.dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.2) rotate(5deg); /* Extra rotation rehefa drag */
            border-color: rgba(255, 215, 0, 1);
            border-width: 5px;
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.7),
                0 0 50px rgba(255, 215, 0, 1),
                inset 0 4px 10px rgba(255, 255, 255, 0.6);
            animation: thumbPulse 0.6s ease-in-out infinite; /* Breathing effect rehefa drag */
        }

        /* Breathing animation rehefa drag */
        @keyframes thumbPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .year-display-compact {
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.8),
                0 0 25px rgba(255, 215, 0, 0.7);
            letter-spacing: -0.5px;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 11;
            position: relative;
        }

        /* Animation rehefa miova ny taona */
        .year-slider-thumb.changing {
            animation: thumbBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes thumbBounce {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.25); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .year-display-compact.changing {
            animation: yearFlash 0.4s ease;
        }

        @keyframes yearFlash {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); color: #FFF; }
            100% { opacity: 1; transform: scale(1); }
        }

        /* ========================================
        RESPONSIVE - TABLETTE
        ======================================== */
        @media (max-width: 992px) {
            .year-slider-container {
                margin-left: 8px;
            }
            
            .year-slider-track {
                width: 5px;
                height: 70px;
            }
            
            .year-slider-track:hover {
                width: 7px;
            }
            
            .year-slider-thumb {
                width: 56px;
                height: 56px;
            }
            
            .year-display-compact {
                font-size: 18px;
            }
        }

        /* ========================================
        RESPONSIVE - MOBILE
        ======================================== */
        @media (max-width: 768px) {
            .year-slider-container {
                margin-left: 6px;
                padding: 6px 0;
            }
            
            .year-slider-track {
                width: 4px;
                height: 60px;
            }
            
            .year-slider-track:hover {
                width: 6px;
            }
            
            .year-slider-thumb {
                width: 50px;
                height: 50px;
                border-width: 2px;
            }
            
            .year-slider-thumb:hover {
                transform: translate(-50%, -50%) scale(1.1);
                border-width: 3px;
            }
            
            .year-slider-thumb:active,
            .year-slider-thumb.dragging {
                transform: translate(-50%, -50%) scale(1.15) rotate(3deg);
                border-width: 4px;
            }
            
            .year-display-compact {
                font-size: 16px;
            }
        }

        /* ========================================
        RESPONSIVE - PETIT MOBILE
        ======================================== */
        @media (max-width: 375px) {
            .year-slider-container {
                margin-left: 4px;
            }
            
            .year-slider-track {
                width: 3px;
                height: 50px;
            }
            
            .year-slider-track:hover {
                width: 5px;
            }
            
            .year-slider-thumb {
                width: 44px;
                height: 44px;
            }
            
            .year-display-compact {
                font-size: 14px;
            }
        }

        /* ========================================
        RESPONSIVE - PAYSAGE
        ======================================== */
        @media (max-height: 600px) and (orientation: landscape) {
            .year-slider-container {
                margin-left: 6px;
                padding: 4px 0;
            }
            
            .year-slider-track {
                width: 4px;
                height: 50px;
            }
            
            .year-slider-track:hover {
                width: 6px;
            }
            
            .year-slider-thumb {
                width: 42px;
                height: 42px;
            }
            
            .year-display-compact {
                font-size: 14px;
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            .year-slider-container {
                order: 3;
                flex-shrink: 0;
                margin: 0 4px;
            }
            
            .year-slider-track {
                width: 3px;
                height: 40px;
            }
            
            .year-slider-track:hover {
                width: 5px;
            }
            
            .year-slider-thumb {
                width: 36px;
                height: 36px;
            }
            
            .year-display-compact {
                font-size: 12px;
            }
        }

        /* iPhone SE Paysage */
        @media (max-width: 667px) and (max-height: 375px) and (orientation: landscape) {
            .year-slider-track {
                width: 3px;
                height: 36px;
            }
            
            .year-slider-track:hover {
                width: 4px;
            }
            
            .year-slider-thumb {
                width: 32px;
                height: 32px;
            }
            
            .year-display-compact {
                font-size: 11px;
            }
        }



        /* Dashboard Overview */
        .dashboard-overview {
            background: rgba(60, 60, 60, 0.6) !important;
            backdrop-filter: blur(25px) saturate(150%) !important;
            -webkit-backdrop-filter: blur(25px) saturate(150%) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }

        .dashboard-title,
        .dashboard-subtitle {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Stats Cards - Glass Effect */
        .stat-card,
        .overview-stat {
            background: rgba(80, 80, 80, 0.5) !important;
            backdrop-filter: blur(20px) saturate(130%) !important;
            -webkit-backdrop-filter: blur(20px) saturate(130%) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3) !important;
        }

        .stat-card:hover {
            background: rgba(90, 90, 90, 0.6) !important;
            transform: translateY(-8px) scale(1.02) !important;
            box-shadow: 0 12px 40px rgba(103, 80, 164, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
        }

        .stat-card::before {
            background: linear-gradient(90deg,
                    rgba(103, 80, 164, 0.8),
                    rgba(107, 87, 120, 0.8)) !important;
        }

        .stat-value,
        .stat-label,
        .overview-stat-value,
        .overview-stat-label {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Data Tables - Glassmorphism */
        .data-table {
            background: rgba(60, 60, 60, 0.6) !important;
            backdrop-filter: blur(25px) saturate(140%) !important;
            -webkit-backdrop-filter: blur(25px) saturate(140%) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }

        .table-header {
            background: rgba(80, 80, 80, 0.5) !important;
            backdrop-filter: blur(15px) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
        }

        .table-title {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .data-table th {
            background: rgba(70, 70, 70, 0.6) !important;
            color: rgba(255, 255, 255, 0.85) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2) !important;
        }

        .data-table td {
            color: rgba(255, 255, 255, 0.8) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Modals - Strong Glassmorphism */
        .modal {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(30px) !important;
            -webkit-backdrop-filter: blur(30px) !important;
        }

        .modal-content {
            background: rgba(60, 60, 60, 0.85) !important;
            backdrop-filter: blur(40px) saturate(150%) !important;
            -webkit-backdrop-filter: blur(40px) saturate(150%) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
        }

        .modal-header {
            background: rgba(80, 80, 80, 0.5) !important;
            backdrop-filter: blur(15px) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15) !important;
        }

        .modal-title {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Forms - Glass Input */
        .form-input,
        .form-select,
        .form-textarea {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Placeholder color */
        .form-inputplaceholder,
        .form-textareaplaceholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }

        /* === CORRECTION POUR VISIBILITÉ DES OPTIONS DANS SELECT === */
        .form-select option {
            background-color: #2a2a2a !important;  /* Fond noir pour les options */
            color: white !important;               /* Texte blanc */
            padding: 8px !important;
        }

        .form-select option:hover,
        .form-select option:focus,
        .form-select option:checked {
            background-color: rgba(103, 80, 164, 0.8) !important;
            color: white !important;
        }

        .form-select:focus {
            background: rgba(40, 40, 40, 0.95) !important;
            border: 2px solid rgba(103, 80, 164, 0.8) !important;
            box-shadow: 0 0 20px rgba(103, 80, 164, 0.5) !important;
        }

        .form-select option:disabled {
            background-color: #1a1a1a !important;
            color: rgba(255, 255, 255, 0.4) !important;
            font-style: italic;
        }


        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 2px solid rgba(103, 80, 164, 0.6) !important;
            box-shadow: 0 0 20px rgba(103, 80, 164, 0.4) !important;
        }

        .form-label {
            color: rgba(255, 255, 255, 0.9) !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Buttons - Glass Effect */
        .btn {
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: rgba(103, 80, 164, 0.7) !important;
        }

        .btn-primary:hover {
            background: rgba(103, 80, 164, 0.9) !important;
            box-shadow: 0 8px 24px rgba(103, 80, 164, 0.5) !important;
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.1) !important;
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.2) !important;
        }

        /* Insights & Summary */
        .summary-insights,
        .insight-item {
            background: rgba(70, 70, 70, 0.6) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .insights-title,
        .insight-text {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .insight-detail {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Close Button */
        .close-btn {
            background: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .close-btn:hover {
            background: rgba(255, 80, 80, 0.6) !important;
            box-shadow: 0 4px 16px rgba(255, 80, 80, 0.4) !important;
        }

        /* FAB Button */
        .fab {
            background: rgba(103, 80, 164, 0.8) !important;
            backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 0 8px 32px rgba(103, 80, 164, 0.5) !important;
        }

        .fab:hover {
            background: rgba(103, 80, 164, 1) !important;
            box-shadow: 0 12px 40px rgba(103, 80, 164, 0.7) !important;
        }

        /* Logo Icon */
        .logo-icon {
            background: rgba(103, 80, 164, 0.8) !important;
            box-shadow: 0 4px 16px rgba(103, 80, 164, 0.5) !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            background: rgba(40, 40, 40, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(103, 80, 164, 0.7);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(103, 80, 164, 0.9);
        }

        /* Grid layout optimization for product-like cards */
        .stats-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)) !important;
            gap: 24px !important;
        }

        @media (min-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* Reception Modal - Paysage avec Glass effect */
        #reception-modal .modal-content {
            max-width: 95vw !important;
            width: 95vw !important;
            background: rgba(60, 60, 60, 0.9) !important;
        }

        #reception-modal .form-grid {
            grid-template-columns: repeat(3, 1fr) !important;
        }

        @media (max-width: 1024px) {
            #reception-modal .form-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 768px) {
            #reception-modal .form-grid {
                grid-template-columns: 1fr !important;
            }
        }


        .form-label {
            color: var(--md-sys-color-on-surface) !important;
            font-weight: 600 !important;
            opacity: 1 !important;
        }

        [data-theme="dark"] .form-label {
            color: var(--md-sys-color-on-surface) !important;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
        }

        /* ============================================
        LANDSCAPE MODE FIXES (812x375 ary mitovy)
        ============================================ */
        @media (max-height: 500px) and (orientation: landscape) {

            /* HEADER - Kely kokoa */
            .header {
                height: 42px !important;
                padding: 0 8px !important;
            }

            .header h1 {
                font-size: 14px !important;
            }

            #sidebar-toggle {
                padding: 6px !important;
                width: 36px !important;
                height: 36px !important;
            }

            /* MAIN CONTENT - Kely ny padding */
            .main-content {
                padding-top: 50px !important;
                padding: 4px !important;
                padding-top: 46px !important;
            }

            /* DASHBOARD OVERVIEW - Kely kokoa */
            .dashboard-overview {
                padding: 6px !important;
                margin-bottom: 6px !important;
            }

            .dashboard-title {
                font-size: 14px !important;
                margin-bottom: 2px !important;
            }

            .dashboard-subtitle {
                font-size: 10px !important;
                margin-bottom: 6px !important;
            }

            .overview-stats {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 6px !important;
            }

            .overview-stat {
                padding: 6px !important;
            }

            .overview-stat-value {
                font-size: 12px !important;
            }

            .overview-stat-label {
                font-size: 9px !important;
            }

            /* STATS GRID - 2 columns */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 10px !important;
                display: none !important;
            }

            .stat-card {
                padding: 10px !important;
            }

            .stat-value {
                font-size: 16px !important;
            }

            .stat-label {
                font-size: 11px !important;
            }

            .stat-icon {
                width: 35px !important;
                height: 35px !important;
                font-size: 18px !important;
            }

            /* FILTERS - Compact mode */
            .filters {
                margin-bottom: 10px !important;
                gap: 8px !important;
            }

            .filter-group {
                gap: 4px !important;
            }

            .filter-label {
                font-size: 11px !important;
                margin-bottom: 2px !important;
            }

            .form-select,
            .form-input {
                padding: 6px 10px !important;
                font-size: 12px !important;
                height: 32px !important;
            }

            .btn {
                padding: 6px 12px !important;
                font-size: 11px !important;
            }

            /* DATA TABLE - VERY IMPORTANT FIXES */
            .data-table {
                max-height: calc(100vh - 110px) !important;
                /* Kely kokoa */
                margin-bottom: 8px !important;
            }

            .table-header {
                padding: 8px 16px !important;
                /* Kely kokoa */
                min-height: 50px !important;
                /* AMPIANA */

            }

            .table-title {
                font-size: 14px !important;
            }

            .table-scroll-wrapper {
                max-height: calc(100vh - 170px) !important;
                /* ITO NO VERY IMPORTANT */
                min-height: 200px !important;
                overflow-y: auto !important;
                overflow-x: auto !important;
            }

            .data-table th {
                padding: 6px 8px !important;
                font-size: 10px !important;
                position: sticky !important;
                top: 0 !important;
                z-index: 100 !important;
                background-color: var(--md-sys-color-surface-variant) !important;
            }

            .data-table td {
                padding: 8px !important;
                font-size: 11px !important;
                line-height: 1.3 !important;
            }

            .btn-icon {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px !important;
            }

            .btn-icon .material-icons {
                font-size: 16px !important;
            }

            /* MODAL - Full screen mode */
            .modal-content {
                max-height: 95vh !important;
                width: 95vw !important;
                max-width: 95vw !important;
                top: 10px !important;
                padding: 12px !important;
            }

            .modal-header {
                padding: 8px 12px !important;
                margin: -12px -12px 12px -12px !important;
            }

            .modal-title {
                font-size: 14px !important;
            }

            .modal-content .form-group {
                margin-bottom: 8px !important;
            }

            .modal-content .form-label {
                font-size: 11px !important;
                margin-bottom: 4px !important;
            }

            .modal-content .form-input,
            .modal-content .form-select {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* PAGINATION - Compact */
            .pagination-controls {
                padding: 4px !important;
                gap: 4px !important;
                font-size: 10px !important;
            }

            .pagination-controls button {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-width: 26px !important;
                height: 26px !important;
            }

            .pagination-controls span {
                font-size: 10px !important;
            }

            /* INSIGHTS */
            .summary-insights {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }

            .insights-title {
                font-size: 14px !important;
                margin-bottom: 10px !important;
            }

            .insight-item {
                padding: 10px !important;
                margin-bottom: 8px !important;
            }

            .insight-icon {
                width: 32px !important;
                height: 32px !important;
                font-size: 16px !important;
            }

            .insight-text {
                font-size: 12px !important;
            }

            .insight-detail {
                font-size: 11px !important;
            }

            /* FILTERS - Very compact */
            .filters {
                margin-bottom: 6px !important;
                gap: 6px !important;
                flex-wrap: nowrap !important;
                /* Tsy mi-wrap */
                overflow-x: auto !important;
                /* Scroll horizontal raha tsy ampy toerana */
            }

            .filter-group {
                gap: 2px !important;
                min-width: fit-content !important;
            }

            .filter-label {
                font-size: 10px !important;
                margin-bottom: 2px !important;
                white-space: nowrap !important;
            }

            .form-select,
            .form-input {
                padding: 4px 8px !important;
                font-size: 11px !important;
                height: 28px !important;
                /* OVAO - taloha 32px */
            }

            .btn {
                padding: 4px 10px !important;
                font-size: 10px !important;
                height: 28px !important;
                /* AMPIANA */
                white-space: nowrap !important;
            }

            .btn .material-icons {
                font-size: 14px !important;
            }
        }

        /* iPhone SE Landscape (667x375) */
        @media (max-width: 667px) and (max-height: 375px) and (orientation: landscape) {
            .table-scroll-wrapper {
                max-height: calc(100vh - 220px) !important;
            }

            .overview-stats {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* iPad Mini Landscape (1024x768) */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .table-scroll-wrapper {
                max-height: calc(100vh - 280px) !important;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }

        /* === BOUTON "+ Ajouter"  RESPONSIVE === */

        /* Par défaut, le bouton garde son padding normal */
        .btn-add-weight {
            display: inline-flex !important;
            align-items: center !important;
            gap: 6px !important;
            justify-content: center !important;
        }

        /* En mode paysage ou petit écran : cache le texte, garde l'icône */
        @media (max-width: 768px) {
            .btn-add-weight {
                padding: 0 12px !important;  /* Réduit le padding */
                min-width: 44px !important;   /* Garde la zone tactile */
            }
            
            .btn-add-weight .btn-text {
                display: none !important;     /* Cache "Hampiditra" */
            }
            
            .btn-add-weight .material-icons {
                margin: 0 !important;         /* Centre l'icône */
            }
        }

        /* Mode paysage très petit (comme sur ton screenshot) */
        @media (max-height: 600px) and (orientation: landscape) {
            .btn-add-weight {
                padding: 0 10px !important;
                min-width: 40px !important;
                height: 36px !important;
            }
            
            .btn-add-weight .btn-text {
                display: none !important;
            }
            
            .btn-add-weight .material-icons {
                font-size: 20px !important;
            }
        }

        /* Mode très petit (mobile portrait) */
        @media (max-width: 450px) {
            .btn-add-weight {
                padding: 0 10px !important;
            }
            
            .btn-add-weight .btn-text {
                display: none !important;
            }
        }
        /*======                          =======*/
        /* Hover effect ho anny clickable chart */
        .chart-container:has(#qualityChart):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
            transition: all 0.3s ease;
        }

        /* Hover effect ho anny clickable chart - SANS :has() */
        .chart-container {
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-container[style*="cursor: pointer"]:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        }

        .chart-container[style*="cursor: pointer"]::after {
            content: '🔍 Cliquer pour détails';
            position: absolute;
            bottom: 16px;
            right: 16px;
            font-size: 11px;
            color: var(--md-sys-color-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 10;
        }

        .chart-container[style*="cursor: pointer"]:hover::after {
            opacity: 1;
        }

        /* FORCE MODAL VISIBILITY */
        #quality-chart-modal {
            z-index: 99999 !important;
        }

        #quality-chart-modal.modal[style*="display: block"] {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #quality-chart-modal .modal-content {
            position: relative !important;
            z-index: 100000 !important;
            background: var(--md-sys-color-surface) !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
        }

        /* =====================================================
        CORRECTION DE VISIBILITÉ - CARTE SOLDE GLOBAL
        ===================================================== */

        /* Carte Solde Global - Fond uniforme identique aux autres cartes */
        .solde-global-card,
        .solde-global-card.debiteur,
        .solde-global-card.equilibre {
            /* Même style que les autres stat-card - fond uniforme */
            background: rgba(80, 80, 80, 0.5) !important;
            backdrop-filter: blur(20px) saturate(130%) !important;
            -webkit-backdrop-filter: blur(20px) saturate(130%) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3) !important;
        }

        /* Hover identique aux autres cartes */
        .solde-global-card:hover {
            background: rgba(90, 90, 90, 0.6) !important;
            transform: translateY(-8px) scale(1.02) !important;
            box-shadow: 0 12px 40px rgba(103, 80, 164, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.25) !important;
        }

        /* ====================================================
        SEULS LES TEXTES CHANGENT DE COULEUR SELON L'ÉTAT
        ==================================================== */

        /* État CRÉDITEUR (Excédent disponible) - VERT */
        .solde-global-card:not(.debiteur):not(.equilibre) .stat-value,
        .solde-global-card:not(.debiteur):not(.equilibre) .stat-label {
            color: rgba(129, 199, 132, 1) !important;
            /* Vert clair très visible */
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8),
                        0 0 20px rgba(129, 199, 132, 0.4) !important;
            font-weight: 600 !important;
        }

        .solde-global-card:not(.debiteur):not(.equilibre) .stat-trend {
            color: rgba(165, 214, 167, 1) !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6) !important;
        }

        .solde-global-card:not(.debiteur):not(.equilibre) .stat-icon {
            background: rgba(129, 199, 132, 0.3) !important;
            color: rgba(200, 230, 201, 1) !important;
            box-shadow: 0 4px 16px rgba(129, 199, 132, 0.4) !important;
        }

        .solde-global-card:not(.debiteur):not(.equilibre) .progress-fill {
            background: linear-gradient(90deg, 
                rgba(129, 199, 132, 0.8), 
                rgba(165, 214, 167, 0.9)) !important;
            box-shadow: 0 0 15px rgba(129, 199, 132, 0.5) !important;
        }

        /* État DÉBITEUR (Dette) - ROUGE */
        .solde-global-card.debiteur .stat-value,
        .solde-global-card.debiteur .stat-label {
            color: rgba(239, 154, 154, 1) !important;
            /* Rouge clair très visible */
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8),
                        0 0 20px rgba(239, 154, 154, 0.4) !important;
            font-weight: 600 !important;
        }

        .solde-global-card.debiteur .stat-trend {
            color: rgba(255, 205, 210, 1) !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6) !important;
        }

        .solde-global-card.debiteur .stat-icon {
            background: rgba(239, 154, 154, 0.3) !important;
            color: rgba(255, 205, 210, 1) !important;
            box-shadow: 0 4px 16px rgba(239, 154, 154, 0.4) !important;
        }

        .solde-global-card.debiteur .progress-fill {
            background: linear-gradient(90deg, 
                rgba(239, 154, 154, 0.8), 
                rgba(229, 115, 115, 0.9)) !important;
            box-shadow: 0 0 15px rgba(239, 154, 154, 0.5) !important;
        }

        /* État ÉQUILIBRE - BLEU/GRIS */
        .solde-global-card.equilibre .stat-value,
        .solde-global-card.equilibre .stat-label {
            color: rgba(144, 202, 249, 1) !important;
            /* Bleu clair très visible */
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8),
                        0 0 20px rgba(144, 202, 249, 0.4) !important;
            font-weight: 600 !important;
        }

        .solde-global-card.equilibre .stat-trend {
            color: rgba(187, 222, 251, 1) !important;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6) !important;
        }

        .solde-global-card.equilibre .stat-icon {
            background: rgba(144, 202, 249, 0.3) !important;
            color: rgba(187, 222, 251, 1) !important;
            box-shadow: 0 4px 16px rgba(144, 202, 249, 0.4) !important;
        }

        .solde-global-card.equilibre .progress-fill {
            background: linear-gradient(90deg, 
                rgba(144, 202, 249, 0.8), 
                rgba(100, 181, 246, 0.9)) !important;
            box-shadow: 0 0 15px rgba(144, 202, 249, 0.5) !important;
        }

        /* Amélioration de la lisibilité en hover */
        .solde-global-card:hover .stat-value,
        .solde-global-card:hover .stat-label,
        .solde-global-card:hover .stat-trend {
            filter: brightness(1.15) !important;
        }
    </style>

</head>

<body>
    <div class="container">
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2500; backdrop-filter:blur(4px);">
        </div>
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar" role="navigation" aria-label="Menu principal">
            <div class="sidebar-header">
                <div class="logo">
                    <!-- Kaody vaovao misy ny icon vanille SVG -->
                    <div class="logo-icon">
                        <i class="fa-solid fa-spa" style="font-size: 24px;"></i>
                    </div>



                    <div>
                        <div class="company-name">BEHAVANA</div>
                        <div class="company-subtitle">Gestion de Collecte</div>
                    </div>
                </div>
            </div>

            <ul class="nav-menu" role="menubar">
                <li class="nav-item" role="none">
                    <a class="nav-link active" data-section="dashboard" role="menuitem" aria-current="page" tabindex="0"
                        data-tooltip="Tableau de Bord">
                        <span class="material-icons" aria-hidden="true">dashboard</span>
                        <span class="nav-text">Tableau de Bord</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="collectors" role="menuitem" tabindex="-1"
                        data-tooltip="Collecteurs">
                        <span class="material-icons" aria-hidden="true">people</span>
                        <span class="nav-text">Collecteurs</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="advances" role="menuitem" tabindex="-1" data-tooltip="Avances">
                        <span class="material-icons" aria-hidden="true">account_balance_wallet</span>
                        <span class="nav-text">Avances</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="remboursements" role="menuitem" tabindex="-1"
                        data-tooltip="Remboursements">
                        <span class="material-icons" aria-hidden="true">paid</span>
                        <span class="nav-text">Remboursements</span>
                    </a>
                </li>
                <!-- =================== -->
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="paiements" role="menuitem" tabindex="-1"
                        data-tooltip="Paiements Effectués">
                        <span class="material-icons" style="transform: scaleX(-1);">payments</span>
                        <span class="nav-text">Paiements Effectués</span>
                    </a>
                </li>
                <!-- =================== -->
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="expenses" role="menuitem" tabindex="-1" data-tooltip="Dépenses">
                        <span class="material-icons" aria-hidden="true">receipt_long</span>
                        <span class="nav-text">Dépenses</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="reception" role="menuitem" tabindex="-1"
                        data-tooltip="Réception">
                        <span class="material-icons" aria-hidden="true">inventory</span>
                        <span class="nav-text">Réception</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="delivery" role="menuitem" tabindex="-1"
                        data-tooltip="Livraison Export">
                        <span class="material-icons" aria-hidden="true">local_shipping</span>
                        <span class="nav-text">Livraison Export</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="analysis" role="menuitem" tabindex="-1"
                        data-tooltip="Suivi & Analyse">
                        <span class="material-icons" aria-hidden="true">analytics</span>
                        <span class="nav-text">Suivi & Analyse</span>
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="settings" role="menuitem" tabindex="-1" data-tooltip="Paramètres">
                        <span class="material-icons" aria-hidden="true">settings</span>
                        <span class="nav-text">Paramètres</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <button id="sidebar-toggle" class="btn btn-icon" title="Afeno/Asehoy ny sisin-dàlana">
                    <span class="material-icons" aria-hidden="true">menu_open</span>
                </button>
                <h1 id="page-title">Tableau de Bord</h1>
                <div class="global-search-wrapper">
                    <span class="material-icons">search</span>
                    <input id="global-search-input" type="text" placeholder="Recherche Globale..."
                        oninput="debouncedGlobalSearch()">
                </div>

                <div class="year-slider-container">
                    <div class="year-slider-track" id="yearSliderTrack">
                        <div class="year-slider-fill" id="yearSliderFill"></div>
                        <div class="year-slider-thumb" id="yearSliderThumb">
                            <span class="year-display-compact" id="yearDisplay">2026</span>
                        </div>
                    </div>
                </div>



                <div class="header-actions">
                    <button class="theme-toggle" id="theme-toggle" aria-label="Manova ny lohahevitra (maizina/mazava)">
                        <span class="material-icons" aria-hidden="true">dark_mode</span>
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboard">
                <!-- Dashboard Overview -->
                <div class="dashboard-overview">
                    <div class="dashboard-title">Aperçu Global</div>
                    <div class="dashboard-subtitle">État financier et opérationnel de BEHAVANA</div>

                    <div class="overview-stats">
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-collectors">0</div>
                            <div class="overview-stat-label">Collecteurs Actifs</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-transactions">0</div>
                            <div class="overview-stat-label">Transactions Totales</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-month">Ce Mois</div>
                            <div class="overview-stat-label">Année Active</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Stats Grid -->
                <div class="stats-grid">
                    <!-- Total Avances -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-advances">0 Ar</div>
                                <div class="stat-label">Total Avances Accordées</div>
                                <div class="stat-trend negative">
                                    <span class="material-icons">trending_down</span>
                                    Argent sorti
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: #9aecb8;">
                                <span class="material-icons">credit_score</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="advances-progress" style="width: 100%;"></div>
                        </div>
                    </div>

                    <!-- === TOTAL DÉPENSES === -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-expenses">0 Ar</div>
                                <div class="stat-label">Total Dépenses Opérationnelles</div>
                                <div class="stat-trend negative">
                                    <span class="material-icons">trending_down</span>
                                    Argent sorti
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-secondary);">
                                <span class="material-icons">receipt_long</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="expenses-progress"
                                style="width: 100%; background: var(--md-sys-color-secondary);"></div>
                        </div>
                    </div>

                    <!-- Vanille Collectée -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-vanilla-weight">0 kg</div>
                                <div class="stat-label">Vanille Collectée</div>
                                <div class="stat-trend positive">
                                    <span class="material-icons">trending_up</span>
                                    Stock physique
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-primary);">
                                <span class="material-icons">eco</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="vanilla-progress" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Valeur Totale Vanille -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-vanilla-value">0 Ar</div>
                                <div class="stat-label">Valeur Totale Vanille</div>
                                <div class="stat-trend positive">
                                    <span class="material-icons">trending_up</span>
                                    Argent rentré
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-tertiary);">
                                <span class="material-icons">attach_money</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="value-progress" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- SOLDE GLOBAL - NEW ENHANCED CARD -->
                    <div class="stat-card solde-global-card equilibre" id="solde-global-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="solde-global">0 Ar</div>
                                <div class="stat-label">Solde Global</div>
                                <div class="stat-trend" id="solde-trend">
                                    <span class="material-icons" id="solde-trend-icon">trending_flat</span>
                                    <span id="solde-trend-text">État équilibré</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <span class="material-icons" id="solde-icon">account_balance</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="solde-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Summary Insights -->
                <div class="summary-insights">
                    <div class="insights-title">
                        <span class="material-icons">insights</span>
                        Analyse de Rentabilité
                    </div>

                    <!-- Karatra 1: Valeur Récupérable (Kalitao Tsara) -->
                    <div class="insight-item" id="insight-valeur-recuperable">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-success);">
                            <span class="material-icons">diamond</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Valeur Récupérable (Bonnes Qualités)</div>
                            <div class="insight-detail" id="valeur-recuperable-detail">Calcul en cours...</div>
                        </div>
                    </div>

                    <!-- Karatra 2: Perte sur Qualité Inférieure -->
                    <div class="insight-item" id="insight-perte-qualite">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-error);">
                            <span class="material-icons">trending_down</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Perte sur Qualité Inférieure</div>
                            <div class="insight-detail" id="perte-qualite-detail">Calcul en cours...</div>
                        </div>
                    </div>

                    <!-- Karatra 3: Taux de Rendement Opérationnel -->
                    <div class="insight-item" id="insight-rendement-op">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-primary);">
                            <span class="material-icons">percent</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Taux de Rendement Opérationnel</div>
                            <div class="insight-detail" id="rendement-op-detail">Calcul en cours...</div>
                        </div>
                    </div>
                </div>
                <!-- =================================================================== -->
                <!-- === BLOC VAOVAO AMPIANA: FIVERENAN'NY RÉSUMÉ FINANCIER TALOHA === -->
                <!-- =================================================================== -->
                <div class="summary-insights" style="margin-top: 32px;"> <!-- Nampiana elanelana kely -->
                    <div class="insights-title">
                        <span class="material-icons">query_stats</span>
                        Résumé Financier (Suivi des Comptes)
                    </div>

                    <!-- Karatra 1: État Financier (Déficit/Excédent) -->
                    <div class="insight-item">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-error);"
                            id="insight-icon-1">
                            <span class="material-icons">trending_flat</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text" id="insight-title-1">État Financier</div>
                            <div class="insight-detail" id="insight-detail-1">Aucune donnée disponible pour le moment
                            </div>
                        </div>
                    </div>

                    <!-- Karatra 2: Taux de Récupération -->
                    <div class="insight-item">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-primary);"
                            id="insight-icon-2">
                            <span class="material-icons">timeline</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Taux de Récupération des Avances</div>
                            <div class="insight-detail" id="recovery-rate">0% des avances sont actuellement couvertes
                                par la vanille collectée</div>
                        </div>
                    </div>

                    <!-- Karatra 3: Collecteurs en Dette (Clicable) -->
                    <div class="insight-item" id="debtors-card">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-tertiary);"
                            id="insight-icon-3">
                            <span class="material-icons">people</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Collecteurs en Dette</div>
                            <div class="insight-detail" id="debtors-info">Aucun collecteur enregistré</div>
                        </div>
                    </div>
                </div>


                <!-- === BLOC VAOVAO MISY TOERANA HO AN'NY GRAFIKA 3 === -->
                <div class="charts-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 32px;">

                    <!-- Toerana ho an'ny Grafika Mitsangana (Tsy miova) -->
                    <div class="chart-container"
                        style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3
                            style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">
                            Total des Avances par Collecteur</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- Toerana ho an'ny Grafika Boribory (Tsy miova) -->
                    <div class="chart-container"
                        style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3
                            style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">
                            Répartition (Avances vs Valeur Vanille)</h3>
                        <canvas id="pieChart"></canvas>
                    </div>

                    <!-- === TOERANA VAOVAO HO AN'NY GRAFIKA FAHATELO === -->
                    <div class="chart-container"
                        style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3
                            style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">
                            Poids Réceptionnées par Qualité de Vanille </h3>
                        <canvas id="qualityChart"></canvas>
                    </div>
                    <!-- =============================================== -->

                </div>


            </section>

            <!-- Collectors Section -->
            <section class="content-section" id="collectors">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Collecteurs</h2>
                        <button class="btn btn-primary" onclick="openCollectorModal()">
                            <span class="material-icons">add</span>
                            Ajouter Collecteur
                        </button>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Téléphone</th>
                                    <th>C.I.N</th>
                                    <th>Délivré le</th>
                                    <th>Adresse</th>
                                    <th>Statut</th>
                                    <th>Solde</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="collectors-table">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <div class="material-icons">people_outline</div>
                                        <div>Aucun collecteur enregistré</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>

            </section>

            <!-- Advances Section -->
            <section class="content-section" id="advances">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Collecteur</label>
                        <select class="form-select" id="advance-filter-collector">
                            <option value="">Tous les collecteurs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date début</label>
                        <input type="date" class="form-input" id="advance-filter-start"
                            onchange="filterAdvancesByDate()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date fin</label>
                        <input type="date" class="form-input" id="advance-filter-end" onchange="filterAdvancesByDate()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Actions rapides</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                                onclick="setDateFilter('today')">Aujourd'hui</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                                onclick="setDateFilter('week')">Cette semaine</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                                onclick="setDateFilter('month')">Ce mois</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                                onclick="setDateFilter('year')">Cette année</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                                onclick="clearDateFilter()">Effacer</button>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Avances</h2>
                        <button class="btn btn-primary" onclick="openAdvanceModal()">
                            <span class="material-icons">add</span>
                            Nouvelle Avance
                        </button>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Collecteur</th>
                                    <th>Montant</th>
                                    <th style="padding: 8px; text-align: left;">Motif</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="advances-table">
                                <tr>
                                    <td colspan="4" class="empty-state">
                                        <div class="material-icons">account_balance_wallet</div>
                                        <div>Aucune avance enregistrée</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>

            <!-- === REMBOURSEMENTS Section === -->
            <section class="content-section" id="remboursements">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Historique des Remboursements</h2>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Collecteur</th>
                                    <th>Montant Remboursé</th>
                                    <th style="padding: 8px; text-align: left;">Note</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="remboursements-table">
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>
            <!-- ================================= -->

            <!-- === PAIEMENTS Section === -->
            <section class="content-section" id="paiements">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Historique des Paiements de Soldes</h2>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Collecteur</th>
                                    <th>Montant Payé</th>
                                    <th style="padding: 8px; text-align: left;">Note</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paiements-table">
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>
            <!-- ============================== -->

            <!-- Expenses Section -->
            <section class="content-section" id="expenses">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Dépenses Opérationnelles</h2>
                        <button class="btn btn-primary" onclick="openExpenseModal()">
                            <span class="material-icons">add</span>
                            Ajouter Dépense
                        </button>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Catégorie</th>
                                    <th>Description</th>
                                    <th>Montant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-table">
                                <!-- Ho fenoina amin'ny JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>

            <!-- Reception Section -->
            <section class="content-section" id="reception">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Suivi opérationnel des collecteurs</h2>
                        <div>
                            <button class="btn btn-outline" onclick="exportInvoice()">
                                <span class="material-icons">picture_as_pdf</span>
                                Export PDF
                            </button>
                            <button class="btn btn-primary" onclick="openReceptionModal()">
                                <span class="material-icons">add</span>
                                Nouvelle Réception
                            </button>
                        </div>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Collecteur</th>
                                    <th>Poids Brut</th>
                                    <th>Poids Net</th>
                                    <th style="padding: 8px; text-align: left;">Qualité</th>
                                    <th>Prix/kg</th>
                                    <th>Valeur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reception-table">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <div class="material-icons">inventory</div>
                                        <div>Aucune réception enregistrée</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>

            <!-- Delivery Section -->
            <section class="content-section" id="delivery">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Livraison à l'Exportateur</h2>
                        <button class="btn btn-primary" onclick="openDeliveryModal()">
                            <span class="material-icons">add</span>
                            Nouvelle Livraison
                        </button>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>N° BL / Facture</th>
                                    <th style="padding: 8px; text-align: left;">Qualité</th>
                                    <th>Poids</th>
                                    <th>Valeur</th>
                                    <th>Exportateur</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="delivery-table">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <div class="material-icons">local_shipping</div>
                                        <div>Aucune livraison enregistrée</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>

            <!-- Analysis Section -->
            <section class="content-section" id="analysis">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Filtrer par Collecteur</label>
                        <select class="form-select" id="analysis-filter-collector" onchange="updateAnalysisTable()">
                            <option value="">Tous les collecteurs</option>
                        </select>
                    </div>
                    <!-- === SIVANA VAOVAO AMPIANA ETU === -->
                    <div class="filter-group">
                        <label class="filter-label">Filtrer par Qualité de Vanille</label>
                        <select class="form-select" id="analysis-filter-quality" onchange="updateAnalysisTable()">
                            <option value="">Toutes les qualités</option>
                            <!-- Ho fenoina ho azy amin'ny JavaScript ity -->
                        </select>
                    </div>
                    <!-- ================================== -->

                    <!-- BOKOTRA VAOVAO -->
                    <div class="filter-group">
                        <label class="filter-label">Actions & Rapports</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="showAllInAnalysis()">
                                <span class="material-icons">clear_all</span>
                                Afficher Tout
                            </button>
                            <!-- Bokotra efa nisy -->
                            <button class="btn btn-outline" onclick="exportAnalysis()">
                                <span class="material-icons">paid</span> <!-- Novaina icon -->
                                Rapport Comptes
                            </button>
                            <!-- === BOKOTRA VAOVAO AMPIANA ETU === -->
                            <button class="btn btn-outline" onclick="exportPoidsAnalysis()">
                                <span class="material-icons">scale</span> <!-- Icon vaovao -->
                                Rapport Poids
                            </button>
                            <!-- ================================== -->
                            <button class="btn btn-success" onclick="exportAnalysisToExcel()">
                                <span class="material-icons">table_view</span>
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- === BLOC VAOVAO: ANALYSE DU PRIX DE REVIENT === -->
                <div class="summary-insights" style="margin-bottom: 32px;">
                    <div class="insights-title">
                        <span class="material-icons">calculate</span>
                        Analyse du Prix de Revient
                    </div>

                    <div id="prix-revient-container">
                        <!-- Ho fenoina amin'ny JavaScript ity -->
                        <div class="empty-state">
                            <span class="material-icons">hourglass_empty</span>
                            <div>Aucune réception de vanille pour calculer le prix de revient.</div>
                        </div>
                    </div>
                </div>
                <!-- ============================================= -->

                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">État des Collecteurs</h2>
                    </div>
                    <!-- ========== AMPIANA ITY WRAPPER ITY ========== -->
                    <div class="table-scroll-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Collecteur</th>
                                    <th>Total Débits (Avances + paiements.)</th>
                                    <th>Total Crédits (Livr. + Remb.)</th>
                                    <th>Solde</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="analysis-table">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <div class="material-icons">analytics</div>
                                        <div>Aucune donnée d'analyse disponible</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- ========== FARANY NY WRAPPER ========== -->
                </div>
            </section>


            <!-- Settings Section -->
            <section class="content-section" id="settings">
                <div class="credit-card">
                    <div class="credit-icon">
                    </div>
                    <div class="credit-text">
                        <p>Application développée et maintenue par</p>
                        <a href="#" target="_blank" class="credit-name">Rado Mandimbiarijao Developer</a>
                    </div>
                    <div class="credit-version">
                        Version 1.0.0
                    </div>
                </div>
                
                <div class="form-container">
                    <h2>Paramètres</h2>

                    <!-- 👇 AMPIDIRO ETO ITY BLOC VAOVAO ITY 👇 -->
                    <!-- ============================ -->
                    <!-- 📱 INSTALLATION PWA -->
                    <!-- ============================ -->
                    <div class="form-group" style="background: var(--md-sys-color-secondary-container); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span class="material-icons" style="color: var(--md-sys-color-primary); font-size: 32px;">
                                install_mobile
                            </span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">
                                    📱 Installation de l'Application
                                </div>
                                <div style="font-size: 13px; color: var(--md-sys-color-on-surface-variant);">
                                    Installer BEHAVANA pour un accès rapide et hors-ligne
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            id="pwa-install-btn" 
                            onclick="installApp()" 
                            class="btn btn-primary" 
                            style="width: 100%; display: none; margin-bottom: 12px;">
                            <span class="material-icons">download</span>
                            Installer l'Application
                        </button>
                        
                        <!-- Instructions iOS -->
                        <div style="font-size: 12px; color: var(--md-sys-color-outline); padding: 12px; background: var(--md-sys-color-surface-variant); border-radius: 8px; border-left: 3px solid var(--md-sys-color-primary);">
                            <div style="display: flex; align-items: start; gap: 8px;">
                                <span class="material-icons" style="font-size: 18px;">info</span>
                                <div>
                                    <strong>📱 iPhone/iPad:</strong> Tsindrio ny <strong>Share button</strong> 
                                    <span class="material-icons" style="font-size: 14px; vertical-align: middle;">ios_share</span>, 
                                    dia safidio <strong>"Add to Home Screen"</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ============================ -->

                    <!-- Resto des paramètres (efa misy) -->
                    <div class="form-group">
                        <label class="form-label">Apparence</label>
                        <select class="form-select" id="theme-select">
                            <option value="light">Mode Clair</option>
                            <option value="dark">Mode Sombre</option>
                        </select>
                    </div>

                    <!-- === BLOC VAOVAO AMPIANA === -->
                    <div class="form-group">
                        <label class="form-label" for="rendement-rate">
                            Taux de Rendement (Vanille Verte → Noire)
                            <span class="material-icons"
                                title="Pourcentage du poids final après séchage. Exemple : 25 % si 100 kg de vanille verte donnent 25 kg de vanille noire, soit un rendement de 25 % (ratio 4:1)."
                                style="font-size: 16px; vertical-align: middle; cursor: help;">help_outline</span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="form-input" id="rendement-rate" value="25"
                                style="flex-grow: 1;">
                            <span style="font-size: 20px; font-weight: 500;">%</span>
                            <button class="btn btn-secondary" onclick="saveSettings()">Enregistrer</button>
                        </div>
                        <small
                            style="display: block; margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">Ce
                            taux est utilisé pour estimer le poids sec et calculer le prix de revient final.</small>
                    </div>
                    <!-- ============================ -->

                    <div class="form-group">
                        <label class="form-label">Gestion des Données</label>
                        <div class="btn-group">
                            <button class="btn btn-outline" onclick="exportData()">
                                <span class="material-icons">download</span>
                                Exporter les Données
                            </button>
                            <button class="btn btn-secondary" onclick="importData()">
                                <span class="material-icons">upload</span>
                                Importer les Données
                            </button>
                            <button class="btn btn-danger" onclick="resetData()">
                                <span class="material-icons">delete_forever</span>
                                Remise à Zéro
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gestion des Qualités -->
                <div class="data-table" style="margin-top: 32px;">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Qualités de Vanille</h2>
                        <button class="btn btn-primary" onclick="openQualityModal()">
                            <span class="material-icons">add</span>
                            Ajouter Qualité
            </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom de la Qualité</th>
                                <th>Description</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="qualities-table">
                            <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <!-- Collector Modal -->
    <div class="modal" id="collector-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter/Modifier Collecteur</h3>
                <button class="close-btn" onclick="closeModal('collector-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="collector-form">
                <div class="form-group">
                    <label class="form-label">Nom Complet</label>
                    <input type="text" id="collector-name" class="form-input" required aria-required="true"
                        oninput="capitalizeLive(this)">

                </div>
                <div class="form-group">
                    <label for="collector-phone" class="form-label">Téléphone</label>
                    <input type="tel" class="form-input" id="collector-phone" placeholder="030 00 000 00">
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">badge</span>
                        CIN
                    </label>
                    <input type="text" class="form-input" id="collector-cin" placeholder="000 000 000 000"
                        maxlength="17" oninput="formatCIN(this)">
                </div>
                <!-- === SAHA VAOVAO AMPIANA === -->
                <div class="form-group">
                    <label class="form-label" for="collector-cin-date">Date de délivrance CIN</label>
                    <input type="date" class="form-input" id="collector-cin-date">
                </div>
                <!-- ========================== -->

                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input type="text" class="form-input" id="collector-address" placeholder="Adresse du collecteur">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('collector-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Advance Modal -->
    <div class="modal" id="advance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Avance</h3>
                <button class="close-btn" onclick="closeModal('advance-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="advance-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="advance-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Collecteur</label>
                    <select class="form-select" id="advance-collector" required>
                        <option value="">Sélectionner un collecteur</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="advance-amount" required
                        placeholder="0">

                </div>
                <div class="form-group">
                    <label class="form-label" for="advance-motif">Motif de l'avance</label>
                    <input type="text" class="form-input" id="advance-motif" placeholder="Ex: Achat vanille verte...">
                </div>
                <!-- ========================== -->
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('advance-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reception Modal -->
    <div class="modal" id="reception-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Réception </h3>
                <button class="close-btn" onclick="closeModal('reception-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="reception-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Collecteur</label>
                        <select class="form-select" id="reception-collector" required
                            onchange="updateCollectorBalanceDisplay()">
                            <option value="">Sélectionner un collecteur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Solde Actuel</label>
                        <input type="text" class="form-input" id="reception-collector-balance" readonly
                            tabindex="-1" placeholder="Solde du collecteur">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="reception-date" required>
                    </div>

                    <!-- SECTION AMÉLIORÉE DU PESAGE RAPIDE dans le Reception Modal -->
                    <div class="form-group"
                        style="grid-column: span 2; background: var(--md-sys-color-secondary-container); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
                        <label class="form-label"
                            style="font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 16px;">
                            <span class="material-icons">scale</span>
                            Pesage Rapide - Saisie Multiple
                        </label>

                        <!-- INPUT SECTION AMÉLIORÉE -->
                        <div style="display: flex; gap: 10px; margin-top: 12px; align-items: stretch;">
                            <div style="flex: 1; display: flex; gap: 8px;">
                                <input type="text" class="form-input" id="quick-weight-input"
                                    placeholder="Poids (kg)" style="flex: 1;"
                                    onkeypress="if(event.key === 'Enter') { event.preventDefault(); addQuickWeight(); }">
                                <input type="text" class="form-input" id="quick-tare-input"
                                    placeholder="Tare" style="width: 70px; background: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline);"
                                    oninput="updateReceptionFromQuickWeights()">
                                <button type="button" class="btn btn-primary btn-add-weight" onclick="addQuickWeight" style="padding: 0 20px; white-space: nowrap">
                                    <span class="material-icons" style="font-size: 18px">add</span>
                                    <span class="btn-text">Ajouter</span>
                                </button>

                            </div>
                        </div>

                        <!-- LISTE DES POIDS AVEC SCROLL -->
                        <div id="quick-weights-list" style="
                                display: flex; 
                                flex-wrap: wrap; 
                                gap: 8px; 
                                margin-top: 12px; 
                                min-height: 45px; 
                                max-height: 150px;
                                overflow-y: auto;
                                padding: 10px; 
                                border: 2px dashed var(--md-sys-color-outline); 
                                border-radius: 8px;
                                background: rgba(255,255,255,0.5);
                            ">
                            <!-- Les poids s'affichent ici -->
                        </div>

                        <!-- STATISTIQUES ET ACTIONS -->
                        <div
                            style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div
                                style="display: flex; gap: 20px; font-size: 13px; color: var(--md-sys-color-on-secondary-container); font-weight: 500;">
                                <span>
                                    <span class="material-icons"
                                        style="font-size: 16px; vertical-align: middle;">shopping_bag</span>
                                    Isan'ny gony: <strong id="quick-bag-count">0</strong>
                                </span>
                                <span>
                                    <span class="material-icons"
                                        style="font-size: 16px; vertical-align: middle;">scale</span>
                                    Brut: <strong id="quick-total-weight">0.00</strong> kg
                                </span>
                                <span>
                                    <span class="material-icons"
                                        style="font-size: 16px; vertical-align: middle;">balance</span>
                                    Net: <strong id="quick-net-weight">0.00</strong> kg
                                </span>
                            </div>

                            <div style="display: flex; gap: 8px;">
                                <button type="button" onclick="undoLastWeight()"
                                    style="background: none; border: none; color: var(--md-sys-color-primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: flex; align-items: center; gap: 4px;"
                                    title="Hamafa ny farany">
                                    <span class="material-icons" style="font-size: 16px;">undo</span>
                                    Hamafa farany
                                </button>
                                <button type="button" onclick="clearQuickWeights()"
                                    style="background: none; border: none; color: var(--md-sys-color-error); cursor: pointer; font-size: 12px; padding: 4px 8px; display: flex; align-items: center; gap: 4px;"
                                    title="Hamafa rehetra">
                                    <span class="material-icons" style="font-size: 16px;">delete_sweep</span>
                                    Hamafa rehetra
                                </button>
                            </div>
                        </div>

                        <!-- AIDE / INSTRUCTIONS -->
                        <div
                            style="margin-top: 12px; padding: 10px; background: rgba(103, 80, 164, 0.1); border-radius: 6px; font-size: 11px; color: var(--md-sys-color-on-secondary-container);">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">info</span>
                            <strong>Fomba fampiasana:</strong> Ampidiro ny lanjan'ny gony tsirairay, dia tsindrio
                            "Ajouter" na "Enter". Ny total dia hiampy ho azy.
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Poids Brut (kg)</label>
                        <input type="number" step="0.01" class="form-input" id="reception-gross-weight">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre de Sacs</label>
                        <input type="number" class="form-input" id="reception-bag-count" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tare</label>
                        <input type="number" step="0.01" class="form-input" id="reception-bag-weight" value="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Net (kg)</label>
                        <input type="number" step="0.01" class="form-input" id="reception-net-weight" readonly tabindex="-1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Qualité</label>
                        <input type="text" class="form-input" id="reception-quality" list="quality-list" required placeholder="Sélectionner ou saisir la qualité">
                        <datalist id="quality-list">
                            <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prix par kg (Ar)</label>
                        <input type="number" class="form-input" id="reception-price">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valeur Totale (Ar)</label>
                        <input type="number" class="form-input" id="reception-total-value" readonly tabindex="-1">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('reception-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delivery Modal -->


    <div class="modal" id="delivery-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Livraison</h3>
                <button class="close-btn" onclick="closeModal('delivery-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="delivery-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="delivery-date" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Exportateur</label>
                    <input type="text" class="form-input" id="delivery-exporter" placeholder="Nom de l'exportateur">
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">N° BL</label>
                        <input type="text" class="form-input" id="delivery-bl" placeholder="Auto" readonly tabindex="-1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">N° Facture</label>
                        <input type="text" class="form-input" id="delivery-invoice" placeholder="Auto" readonly tabindex="-1">
                    </div>
                </div>
                <!-- BLOC QUALITÉ -->
                <div class="form-group">
                    <label class="form-label">Qualité de la Vanille</label>
                    <input type="text" class="form-input" id="delivery-quality" list="quality-list" required placeholder="Sélectionner ou saisir la qualité">
                </div>
                <!-- ============================ -->

                <!-- SECTION AMÉLIORÉE DU PESAGE RAPIDE dans le Delivery Modal -->
                <div class="form-group"
                    style="background: var(--md-sys-color-secondary-container); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
                    <label class="form-label"
                        style="font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        <span class="material-icons">scale</span>
                        Pesage Rapide - Saisie Multiple
                    </label>

                    <!-- INPUT SECTION AMÉLIORÉE -->
                    <div style="display: flex; gap: 10px; margin-top: 12px; align-items: stretch;">
                        <div style="flex: 1; display: flex; gap: 8px;">
                            <input type="text" class="form-input" id="delivery-quick-weight-input"
                                placeholder="Lanja (kg)" style="flex: 1;"
                                onkeypress="if(event.key === 'Enter') { event.preventDefault(); addDeliveryQuickWeight(); }">
                            <input type="text" class="form-input" id="delivery-quick-tare-input"
                                placeholder="Tare" style="width: 70px; background: var(--md-sys-color-surface-variant); border: 1px solid var(--md-sys-color-outline); font-weight: bold; color: var(--md-sys-color-primary);"
                                oninput="updateDeliveryFromQuickWeights()">
                            <button type="button" class="btn btn-primary btn-add-weight" onclick="addDeliveryQuickWeight" style="padding: 0 20px; white-space: nowrap">
                                <span class="material-icons" style="font-size: 18px">add</span>
                                <span class="btn-text">Ajouter</span>
                            </button>

                        </div>
                    </div>

                    <!-- LISTE DES POIDS AVEC SCROLL -->
                    <div id="delivery-quick-weights-list" style="
                            display: flex; 
                            flex-wrap: wrap; 
                            gap: 8px; 
                            margin-top: 12px; 
                            min-height: 45px; 
                            max-height: 150px;
                            overflow-y: auto;
                            padding: 10px; 
                            border: 2px dashed var(--md-sys-color-outline); 
                            border-radius: 8px;
                            background: rgba(255,255,255,0.5);
                        ">
                        <!-- Les poids s'affichent ici -->
                    </div>

                    <!-- STATISTIQUES ET ACTIONS -->
                    <div
                        style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div
                            style="display: flex; gap: 20px; font-size: 13px; color: var(--md-sys-color-on-secondary-container); font-weight: 500;">
                            <span>
                                <span class="material-icons"
                                    style="font-size: 16px; vertical-align: middle;">shopping_bag</span>
                                Isan'ny gony: <strong id="delivery-quick-bag-count">0</strong>
                            </span>
                            <span>
                                <span class="material-icons"
                                    style="font-size: 16px; vertical-align: middle;">scale</span>
                                Brut: <strong id="delivery-quick-total-weight">0.00</strong> kg
                            </span>
                            <span>
                                <span class="material-icons"
                                    style="font-size: 16px; vertical-align: middle;">balance</span>
                                Net: <strong id="delivery-quick-net-weight">0.00</strong> kg
                            </span>
                        </div>

                        <div style="display: flex; gap: 8px;">
                            <button type="button" onclick="undoLastDeliveryWeight()"
                                style="background: none; border: none; color: var(--md-sys-color-primary); cursor: pointer; font-size: 12px; padding: 4px 8px; display: flex; align-items: center; gap: 4px;"
                                title="Hamafa ny farany">
                                <span class="material-icons" style="font-size: 16px;">undo</span>
                                Hamafa farany
                            </button>
                            <button type="button" onclick="clearDeliveryQuickWeights()"
                                style="background: none; border: none; color: var(--md-sys-color-error); cursor: pointer; font-size: 12px; padding: 4px 8px; display: flex; align-items: center; gap: 4px;"
                                title="Hamafa rehetra">
                                <span class="material-icons" style="font-size: 16px;">delete_sweep</span>
                                Hamafa rehetra
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Poids Brut (kg)</label>
                        <input type="text" class="form-input" id="delivery-gross-weight" oninput="calculateDeliveryValues()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre de Sacs</label>
                        <input type="number" class="form-input" id="delivery-bag-count" value="1" oninput="calculateDeliveryValues()">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label class="form-label">Tare (kg)</label>
                        <input type="text" class="form-input" id="delivery-bag-weight" value="" oninput="calculateDeliveryValues()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Net (kg)</label>
                        <input type="text" class="form-input" id="delivery-weight" required readonly tabindex="-1">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Prix par kg (Ar)</label>
                    <input type="text" class="form-input" id="delivery-price" oninput="calculateDeliveryValues()">
                </div>
                <div class="form-group">
                    <label class="form-label">Valeur Totale (Ar)</label>
                    <input type="text" class="form-input" id="delivery-total-value" readonly tabindex="-1">
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('delivery-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal" id="expense-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Dépense</h3>
                <button class="close-btn" onclick="closeModal('expense-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Catégorie</label>
                    <select class="form-select" id="expense-category" required>
                        <option value="">Sélectionner une catégorie</option>
                        <option value="Paiement Collecteur">Paiement Solde Collecteur</option>
                        <option value="Salaire">Salaire Mpiasa</option>
                        <option value="Transport">Transport</option>
                        <option value="Nourriture">Nourriture / Sakafo</option>
                        <option value="Ristourne">Ristourne / Quittance</option>
                        <option value="Carburant">Carburant</option>
                        <option value="Logistique">Logistique (sacs, matériels...)</option>
                        <option value="Administratif">Administratif (téléphone, internet...)</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="expense-description" required
                        placeholder="Ex: Karama volana Jona, Sakafo antoandro...">
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="expense-amount" required
                        placeholder="0">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('expense-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===REMBOURSEMENT MODAL  === -->
    <div class="modal" id="remboursement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enregistrer un Remboursement</h3>
                <button class="close-btn" onclick="closeModal('remboursement-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="remboursement-form" onsubmit="saveRemboursement(event)">
                <input type="hidden" id="remboursement-collector-id">
                <div class="form-group">
                    <label class="form-label">Collecteur</label>
                    <input type="text" class="form-input" id="remboursement-collector-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant du remboursement (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="remboursement-amount" required
                        placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Date du remboursement</label>
                    <input type="date" class="form-input" id="remboursement-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note (optionnel)</label>
                    <input type="text" class="form-input" id="remboursement-note"
                        placeholder="Ex: Reliquat du 15/08/2024">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline"
                        onclick="closeModal('remboursement-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    <!-- ================================== -->
    <!--Quality modal-->
    <div class="modal" id="quality-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter/Modifier Qualité</h3>
                <button class="close-btn" onclick="closeModal('quality-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="quality-form" onsubmit="saveQuality(event)">
                <input type="hidden" id="quality-id">
                <div class="form-group">
                    <label class="form-label">Nom de la Qualité</label>
                    <input type="text" id="quality-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnel)</label>
                    <input type="text" id="quality-description" class="form-input">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('quality-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quality Chart Detail Modal - VAOVAO AMPIANA -->
    <div class="modal" id="quality-chart-modal">
        <div class="modal-content" style="max-width: 95vw; width: 95vw; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="material-icons" style="vertical-align: middle;">bar_chart</span>
                    Détails des Poids par Qualité
                </h3>
                <button class="close-btn" onclick="closeModal('quality-chart-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <div style="overflow-y: auto; max-height: calc(90vh - 80px); padding: 20px;">

                <!-- Graphique Lehibe -->
                <div
                    style="background: var(--md-sys-color-surface-variant); padding: 24px; border-radius: 16px; margin-bottom: 24px;">
                    <canvas id="qualityChartModal" style="max-height: 400px;"></canvas>
                </div>

                <!-- Table Détaillé -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">📊 Données Complètes</h3>
                    </div>
                    <div class="table-scroll-wrapper" style="max-height: 350px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Qualité</th>
                                    <th>Poids Total (kg)</th>
                                    <th>Pourcentage</th>
                                    <th>Nb Réceptions</th>
                                </tr>
                            </thead>
                            <tbody id="quality-detail-table">
                                <!-- Data eto -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>

        function initTooltips() {
            // Les tooltips sont maintenant gérés via CSS position: absolute par rapport au parent .nav-link
            // Plus besoin de calcul dynamique de position via JS
        }
    
        let appData = {
            collectors: [],
            advances: [],
            receptions: [],
            deliveries: [],
            qualities: [],
            expenses: [],
            remboursements: [],
            paiements: []
        };
        let pieChartInstance = null;
        let barChartInstance = null;
        let qualityChartInstance = null;
        let db;
        const dbName = 'BehavanaDB_v2';
        const dbVersion = 3;
        let dbInitialized = false;
        let pendingOperations = [];
        let quickWeights = [];
        let deliveryQuickWeights = [];
        let currentYear = new Date().getFullYear();
        const ACTIVE_YEAR_STORAGE_KEY = 'behavana_active_year';

        function executeWhenReady(operation) {
            if (dbInitialized && db) {
                operation();
            } else {
                pendingOperations.push(operation);
            }
        }
        function processPendingOperations() {
            while (pendingOperations.length > 0) {
                const operation = pendingOperations.shift();
                operation();
            }
        }

        function getYearFromDateString(dateStr) {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            if (Number.isNaN(d.getTime())) return null;
            return d.getFullYear();
        }

        function isItemInCurrentYear(item) {
            if (!item || !item.date) return false;
            return getYearFromDateString(item.date) === currentYear;
        }

        function getAdvancesForCurrentYear() {
            return (appData.advances || []).filter(isItemInCurrentYear);
        }

        function getReceptionsForCurrentYear() {
            return (appData.receptions || []).filter(isItemInCurrentYear);
        }

        function getDeliveriesForCurrentYear() {
            return (appData.deliveries || []).filter(isItemInCurrentYear);
        }

        function getExpensesForCurrentYear() {
            return (appData.expenses || []).filter(isItemInCurrentYear);
        }

        function getRemboursementsForCurrentYear() {
            return (appData.remboursements || []).filter(isItemInCurrentYear);
        }

        function getPaiementsForCurrentYear() {
            return (appData.paiements || []).filter(isItemInCurrentYear);
        }

        function initDB() {
            if (!window.indexedDB) {
                console.warn('IndexedDB not supported, using memory storage');
                dbInitialized = true;
                updateEnhancedDashboard();
                updateCollectorSelects();
                updateCollectorsTable();
                updateAdvancesTable();
                updateReceptionTable();
                updateDeliveryTable();
                updateAnalysisTable();
                return;
            }
            const request = indexedDB.open(dbName, dbVersion);
            request.onerror = function (event) {
                console.error('Database error:', event.target.error);
                dbInitialized = true;
                updateEnhancedDashboard();
                updateCollectorSelects();
                updateCollectorsTable();
                updateAdvancesTable();
                updateReceptionTable();
                updateDeliveryTable();
                updateAnalysisTable();
            };
            request.onsuccess = function (event) {
                db = event.target.result;
                dbInitialized = true;
                console.log('Database initialized successfully');
                db.onerror = function (event) {
                    console.error('Database error:', event.target.error);
                };
                loadData();
                processPendingOperations();
            };
            request.onupgradeneeded = function (event) {
                db = event.target.result;
                console.log(`Creating new database structure for ${dbName} version ${db.version}...`);
                if (!db.objectStoreNames.contains('collectors')) {
                    db.createObjectStore('collectors', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "collectors" store.');
                }
                if (!db.objectStoreNames.contains('advances')) {
                    db.createObjectStore('advances', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "advances" store.');
                }
                if (!db.objectStoreNames.contains('receptions')) {
                    db.createObjectStore('receptions', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "receptions" store.');
                }
                if (!db.objectStoreNames.contains('deliveries')) {
                    db.createObjectStore('deliveries', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "deliveries" store.');
                }
                if (!db.objectStoreNames.contains('qualities')) {
                    const qualityStore = db.createObjectStore('qualities', { keyPath: 'id', autoIncrement: true });
                    qualityStore.createIndex('name', 'name', { unique: true });
                    console.log('Created "qualities" store.');
                    const defaultQualities = [
                        { name: 'Lava', description: 'Vanille de qualité supérieure' },
                        { name: 'Fohy', description: 'Vanille plus courte' },
                        { name: 'Fendue', description: 'Vanille fendue ou vaky' },
                        { name: 'Lo', description: 'Vanille de qualité inférieure' },
                        { name: 'Verte', description: 'Vanille non préparée' }
                    ];
                    defaultQualities.forEach(q => qualityStore.add(q));
                    console.log('Added default qualities.');
                }
                if (!db.objectStoreNames.contains('expenses')) {
                    db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "expenses" store.');
                }
                if (!db.objectStoreNames.contains('remboursements')) {
                    db.createObjectStore('remboursements', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "remboursements" store.');
                }
                if (!db.objectStoreNames.contains('paiements')) {
                    db.createObjectStore('paiements', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "paiements" store.');
                }
            };
        }
        function loadData() {
            if (!db) {
                console.warn('Database not initialized, using empty data.');
                updateAllTables();
                return;
            }
            const storeNames = Array.from(db.objectStoreNames);
            if (storeNames.length === 0) {
                console.warn('No object stores found in the database.');
                updateAllTables();
                return;
            }
            const promises = storeNames.map(storeName => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        resolve({ storeName: storeName, data: request.result || [] });
                    };
                    request.onerror = () => {
                        console.error(`Error loading data from ${storeName}:`, request.error);
                        reject({ storeName: storeName, data: [] });
                    };
                });
            });
            Promise.allSettled(promises)
                .then(results => {
                    storeNames.forEach(name => appData[name] = []);
                    results.forEach(result => {
                        if (result.status === 'fulfilled') {
                            const { storeName, data } = result.value;
                            appData[storeName] = data;
                        } else {
                        }
                    });
                    console.log('All data loaded successfully:', appData);
                    buildCache();
                    updateAllTables();
                });
        }
        async function saveToDB(storeName, data) {
            try {
                await executeWhenReadyPromise();
                if (!db || db.readyState === 'done') {
                    console.warn(`Database not available for '${storeName}', using memory fallback.`);
                    saveToDB_Fallback(storeName, data);
                    return;
                }
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    transaction.oncomplete = () => {
                        console.log(`Data successfully saved to ${storeName}.`);
                        resolve();
                    };
                    transaction.onerror = (event) => {
                        console.error(`Transaction error on ${storeName}:`, event.target.error);
                        reject(event.target.error);
                    };
                });
                invalidateCache();
                loadData();
            } catch (error) {
                console.error(`Failed to save data to ${storeName}. Error:`, error);
                showToast(`Erreur lors de l'enregistrement dans ${storeName}.`, 'error');
                saveToDB_Fallback(storeName, data);
            }
        }
        function executeWhenReadyPromise() {
            return new Promise(resolve => {
                if (dbInitialized && db) {
                    resolve();
                } else {
                    pendingOperations.push(resolve);
                }
            });
        }
        function saveToDB_Fallback(storeName, data) {
            if (!data.id) {
                data.id = Date.now() + Math.random();
            }
            const existingIndex = appData[storeName].findIndex(item => item.id === data.id);
            if (existingIndex >= 0) {
                appData[storeName][existingIndex] = data;
            } else {
                appData[storeName].push(data);
            }
            updateAllTables();
        }
        async function deleteFromDB(storeName, id, onSuccessCallback) {
            try {
                await executeWhenReadyPromise();
                if (!db || db.readyState === 'done') {
                    console.warn(`Database not available for deleting from '${storeName}', using memory fallback.`);
                    deleteFromDB_Fallback(storeName, id);
                    if (onSuccessCallback) onSuccessCallback();
                    return;
                }
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    transaction.oncomplete = () => {
                        console.log(`Data with id ${id} successfully deleted from ${storeName}.`);
                        resolve();
                    };
                    transaction.onerror = (event) => {
                        console.error(`Transaction error on deleting from ${storeName}:`, event.target.error);
                        reject(event.target.error);
                    };
                });
                if (onSuccessCallback) {
                    onSuccessCallback();
                }
                loadData();
            } catch (error) {
                console.error(`Failed to delete data with id ${id} from ${storeName}. Error:`, error);
                showToast(`Erreur lors de la suppression dans ${storeName}.`, 'error');
                deleteFromDB_Fallback(storeName, id);
                if (onSuccessCallback) onSuccessCallback();
            }
        }
        function deleteFromDB_Fallback(storeName, id) {
            const index = appData[storeName].findIndex(item => item.id === id);
            if (index >= 0) {
                appData[storeName].splice(index, 1);
                updateAllTables();
            }
        }
        let calculationCache = {
            balances: {},
            totals: {},
            timestamp: 0,
            isValid: false
        };
        function invalidateCache() {
            calculationCache.isValid = false;
            calculationCache.timestamp = Date.now();
        }
        function buildCache() {
            if (calculationCache.isValid && (Date.now() - calculationCache.timestamp < 1000)) {
                return;
            }
            console.time('Cache Build');
            calculationCache.balances = {};
            appData.collectors.forEach(collector => {
                calculationCache.balances[collector.id] = calculateCollectorBalance(collector.id);
            });
            const advYear  = getAdvancesForCurrentYear();
            const expYear  = getExpensesForCurrentYear();
            const recYear  = getReceptionsForCurrentYear();
            const rembYear = getRemboursementsForCurrentYear();

            calculationCache.totals = {
                advances:      advYear.reduce((s,a) => s + a.amount, 0),
                expenses:      expYear.reduce((s,e) => s + e.amount, 0),
                receptions:    recYear.reduce((s,r) => s + r.totalValue, 0),
                weight:        recYear.reduce((s,r) => s + r.netWeight, 0),
                remboursements:rembYear.reduce((s,r) => s + r.amount, 0)
            };

            calculationCache.isValid = true;
            console.timeEnd('Cache Build');
        }
        function getCachedBalance(collectorId) {
            if (!calculationCache.isValid) {
                buildCache();
            }
            return calculationCache.balances[collectorId] || 0;
        }
        function updateAllTables() {
            console.time('updateAllTables');
            invalidateCache();
            buildCache();
            updateCollectorSelects();
            updateQualitySelect();
            updateAnalysisQualityFilter();
            updateCollectorsTable();
            updateAdvancesTable();
            updateReceptionTable();
            updateDeliveryTable();
            updateExpensesTable();
            updateRemboursementsTable();
            updatePaiementsTable();
            updateAnalysisTable();
            updateQualitiesTable();
            updateEnhancedDashboard();
            updatePrixRevientAnalysis();
            updateCharts();
            console.timeEnd('updateAllTables');
        }
        function calculateGlobalBalance() {
            const totalAdvances = appData.advances.reduce((sum, advance) => sum + advance.amount, 0);
            const totalVanillaValue = appData.receptions.reduce((sum, reception) => sum + reception.totalValue, 0);
            const balance = totalVanillaValue - totalAdvances;
            const recoveryRate = totalAdvances > 0 ? (totalVanillaValue / totalAdvances * 100).toFixed(1) : 0;
            return {
                balance: balance,
                recoveryRate: recoveryRate,
                isPositive: balance >= 0,
                deficit: Math.abs(balance),
                totalAdvances: totalAdvances,
                totalVanillaValue: totalVanillaValue
            };
        }
        function updateEnhancedDashboard() {
            const expensesData = getExpensesForCurrentYear();
            const advancesData = getAdvancesForCurrentYear();
            const receptionsData = getReceptionsForCurrentYear();
            const deliveriesData = getDeliveriesForCurrentYear();
            
            // ✅ FILTRER: Collecteurs actifs (avec données) ET disponibles dans l'année
            const collectorsData = appData.collectors.filter(collector => {
                // D'abord vérifier si le collecteur existe dans cette année
                if (!isCollectorAvailableInCurrentYear(collector)) {
                    return false;
                }
                
                // Ensuite vérifier s'il a des données
                const hasAdvances = advancesData.some(a => a.collectorId === collector.id);
                const hasReceptions = receptionsData.some(r => r.collectorId === collector.id);
                const hasRemboursements = getRemboursementsForCurrentYear().some(rem => rem.collectorId === collector.id);
                const hasPaiements = getPaiementsForCurrentYear().some(p => p.collectorId === collector.id);
                
                return hasAdvances || hasReceptions || hasRemboursements || hasPaiements;
            });
            
            // ... reste du code identique
            
            const totalAdvances = advancesData.reduce((sum, advance) => sum + advance.amount, 0);
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const totalMoneyOut = totalAdvances + totalExpenses;
            const totalVanillaValue = receptionsData.reduce((sum, reception) => sum + reception.totalValue, 0);
            const totalRemboursements = appData.remboursements
                .reduce((sum, rem) => sum + rem.amount, 0);
            const totalMoneyIn = totalVanillaValue + totalRemboursements;
            const totalVanillaWeight = receptionsData.reduce((sum, reception) => sum + reception.netWeight, 0);
            const balance = totalMoneyIn - totalMoneyOut;
            const recoveryRate = totalMoneyOut > 0 ? (totalVanillaValue / totalMoneyOut) * 100 : 0;
            
            const globalBalanceInfo = {
                balance: balance,
                recoveryRate: recoveryRate.toFixed(1),
                isPositive: balance >= 0,
                deficit: Math.abs(balance),
                totalAdvances: totalAdvances,
                totalExpenses: totalExpenses,
                totalMoneyOut: totalMoneyOut,
                totalVanillaValue: totalVanillaValue
            };
            
            document.getElementById('total-advances').textContent = formatCurrency(totalAdvances);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('total-vanilla-value').textContent = formatCurrency(totalVanillaValue);
            document.getElementById('total-vanilla-weight').textContent = totalVanillaWeight.toFixed(2) + ' kg';
            
            const totalTransactions = advancesData.length + receptionsData.length + deliveriesData.length + expensesData.length;
            
            document.getElementById('overview-collectors').textContent = collectorsData.length;
            document.getElementById('overview-transactions').textContent = totalTransactions;
            document.getElementById('overview-month').textContent = getCurrentMonth();
            
            updateGlobalBalanceCard(globalBalanceInfo);
            updateInsights(globalBalanceInfo);
            updateRentabiliteInsights();
            updateProgressBars(globalBalanceInfo, totalVanillaWeight);
        }


        function updateGlobalBalanceCard(balanceInfo) {
            const soldeCard = document.getElementById('solde-global-card');
            const soldeValue = document.getElementById('solde-global');
            const soldeIcon = document.getElementById('solde-icon');
            const soldeTrendIcon = document.getElementById('solde-trend-icon');
            const soldeTrendText = document.getElementById('solde-trend-text');
            soldeValue.textContent = (balanceInfo.isPositive ? '+' : '-') + formatCurrency(balanceInfo.deficit);
            soldeCard.className = 'stat-card solde-global-card ' +
                (balanceInfo.isPositive ? 'crediteur' : balanceInfo.balance === 0 ? 'equilibre' : 'debiteur');
            if (balanceInfo.isPositive) {
                soldeIcon.textContent = 'account_balance_wallet';
                soldeTrendIcon.textContent = 'trending_up';
                soldeTrendText.textContent = 'Excédent disponible';
            } else if (balanceInfo.balance === 0) {
                soldeIcon.textContent = 'balance';
                soldeTrendIcon.textContent = 'trending_flat';
                soldeTrendText.textContent = 'Parfaitement équilibré';
            } else {
                soldeIcon.textContent = 'account_balance';
                soldeTrendIcon.textContent = 'trending_down';
                soldeTrendText.textContent = 'Argent non récupéré';
            }
        }
        function updateInsights(balanceInfo) {
            const insightTitle1 = document.getElementById('insight-title-1');
            const insightDetail1 = document.getElementById('insight-detail-1');
            const recoveryRate = document.getElementById('recovery-rate');
            const debtorsInfo = document.getElementById('debtors-info');
            const insightIcon1 = document.getElementById('insight-icon-1');
            const debtorsCard = document.getElementById('debtors-card');
            const totalMoneyOut = balanceInfo.totalAdvances + balanceInfo.totalExpenses;
            const recoveryRateValue = totalMoneyOut > 0 ? (balanceInfo.totalVanillaValue / totalMoneyOut * 100) : 0;
            const avanceBalance = balanceInfo.totalVanillaValue - balanceInfo.totalAdvances;
            if (avanceBalance >= 0) {
                insightTitle1.textContent = 'Excédent sur Avances';
                insightDetail1.textContent = `La valeur de la vanille couvre les avances de ${formatCurrency(avanceBalance)}.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_up</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-success)';
            } else {
                insightTitle1.textContent = 'Déficit sur Avances';
                insightDetail1.textContent = `Il manque ${formatCurrency(Math.abs(avanceBalance))} de vanille pour couvrir les avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_down</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-error)';
            }
            recoveryRate.textContent = `${recoveryRateValue.toFixed(1)}% des coûts (avances+dépenses) sont couverts par la valeur de la vanille.`;
            const debtorsCount = calculateDebtorsCount();
            debtorsCard.onclick = null;
            debtorsCard.classList.remove('clickable');
            if (debtorsCount === 0) {
                debtorsInfo.textContent = 'Aucun collecteur n\'a de dette en cours.';
            } else {
                debtorsInfo.textContent = `${debtorsCount} collecteur${debtorsCount > 1 ? 's' : ''} ont encore des dettes. Cliquez pour voir.`;
                debtorsCard.classList.add('clickable');
                debtorsCard.onclick = function () {
                    sessionStorage.setItem('analysis_filter', 'debiteur');
                    navigateToSection('analysis');
                };
            }
        }
        function calculateDebtorsCount() {
            let debtorsCount = 0;
            if (!appData.collectors) return 0;
            appData.collectors.forEach(collector => {
                const balance = calculateCollectorBalance(collector.id);
                if (balance < 0) {
                    debtorsCount++;
                }
            });
            return debtorsCount;
        }

        function updateProgressBars(balanceInfo, totalWeight) {
            const advancesProgress = document.getElementById('advances-progress');
            const expensesProgress = document.getElementById('expenses-progress');
            const vanillaProgress = document.getElementById('vanilla-progress');
            const valueProgress = document.getElementById('value-progress');
            const soldeProgress = document.getElementById('solde-progress');

            if (advancesProgress) advancesProgress.style.width = '100%';
            if (expensesProgress) expensesProgress.style.width = '100%';
            
            // Calculer les pourcentages pour les autres
            const totalOut = balanceInfo.totalAdvances + balanceInfo.totalExpenses;
            
            if (vanillaProgress) {
                // On peut baser le progrès du poids sur un objectif ou simplement montrer 100% s'il y a du stock
                vanillaProgress.style.width = totalWeight > 0 ? '100%' : '0%';
            }
            
            if (valueProgress) {
                const percent = totalOut > 0 ? Math.min(100, (balanceInfo.totalVanillaValue / totalOut) * 100) : 0;
                valueProgress.style.width = percent + '%';
            }
            
            if (soldeProgress) {
                const percent = balanceInfo.isPositive ? 100 : (totalOut > 0 ? Math.min(100, (balanceInfo.totalVanillaValue / totalOut) * 100) : 0);
                soldeProgress.style.width = percent + '%';
            }
        }
        function getCurrentMonth() {
            const months = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];
            return months[new Date().getMonth()];
        }
        document.addEventListener('DOMContentLoaded', function () {
            initDB();
            loadSettings();
            initYearDisplay();
            validateCollectorNameLive();
            validateCollectorCINLive();
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    navigateToSection(section);
                });
            });
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            setupFormHandlers();
            setCurrentDate();
            setupReceptionCalculations();
            setupDeliveryCalculations();
            loadThemePreference();
            const amountInput = document.getElementById('advance-amount');
            if (amountInput) {
                amountInput.addEventListener('input', function (e) {
                    let rawValue = e.target.value.replace(/\D/g, '');
                    if (rawValue === '') {
                        e.target.value = '';
                        return;
                    }
                    let formattedValue = Number(rawValue).toLocaleString('fr-MG');
                    e.target.value = formattedValue;
                });
            }
            initTooltips();

            document.getElementById("sidebar-toggle").addEventListener("click", (e) => {
                e.stopPropagation();
                const sidebar = document.getElementById("sidebar");
                const mainContent = document.querySelector(".main-content");
                const toggleIcon = document.querySelector("#sidebar-toggle .material-icons");
                const overlay = document.getElementById("sidebar-overlay");

                if (window.innerWidth <= 992) {
                    sidebar.classList.toggle("mobile-open");
                    if (sidebar.classList.contains("mobile-open")) {
                        toggleIcon.textContent = "close";
                        overlay.style.display = "block";
                        document.body.style.overflow = "hidden";
                    } else {
                        toggleIcon.textContent = "menu";
                        overlay.style.display = "none";
                        document.body.style.overflow = "";
                    }
                } else {
                    sidebar.classList.toggle("collapsed");
                    mainContent.classList.toggle("sidebar-collapsed");
                    if (sidebar.classList.contains("collapsed")) {
                        toggleIcon.textContent = "menu";
                    } else {
                        toggleIcon.textContent = "menu_open";
                    }
                }
            });

            const closeSidebar = () => {
                const sidebar = document.getElementById("sidebar");
                const overlay = document.getElementById("sidebar-overlay");
                const toggleIcon = document.querySelector("#sidebar-toggle .material-icons");
                sidebar.classList.remove("mobile-open");
                overlay.style.display = "none";
                document.body.style.overflow = "";
                toggleIcon.textContent = "menu";
            };

            document.getElementById("sidebar-overlay").addEventListener("click", closeSidebar);

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeSidebar();
                    }
                });
            });
        });
        function navigateToSection(sectionName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionName);
            if (activeSection) {
                activeSection.classList.add('active');
            }
            const titles = {
                'dashboard': 'Tableau de Bord',
                'collectors': 'Gestion des Collecteurs',
                'advances': 'Gestion des Avances',
                'remboursements': 'Historique des Remboursements',
                'paiements': 'Historique des Paiements',
                'reception': 'Réception',
                'delivery': 'Livraison à l\'Exportateur',
                'expenses': 'Gestion des Dépenses',
                'analysis': 'Suivi & Analyse',
                'settings': 'Paramètres'
            };
            document.getElementById('page-title').textContent = titles[sectionName] || 'BEHAVANA';
            const requestedFilter = sessionStorage.getItem('analysis_filter');
            if (sectionName === 'analysis') {
                updateAnalysisTable();
                if (requestedFilter === 'debiteur') {
                    setTimeout(() => {
                        filterAnalysisForDebtors();
                    }, 100);
                    sessionStorage.removeItem('analysis_filter');
                }
            }
        }
        function toggleTheme() {
            const currentTheme = document.body.dataset.theme || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            setTimeout(updateCharts, 50);
        }
        function setTheme(theme) {
            document.body.dataset.theme = theme;
            document.getElementById('theme-select').value = theme;
            const themeIcon = document.querySelector('#theme-toggle .material-icons');
            themeIcon.textContent = theme === 'light' ? 'dark_mode' : 'light_mode';
            localStorage.setItem('theme', theme);
        }
        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.style.display = '';
            modal.style.opacity = '';
            modal.style.visibility = '';
            modal.classList.add('active');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            console.log('🚪 Closing modal:', modalId);

            // FORCE close - remove ALL styles
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';

            // Remove onclick event
            modal.onclick = null;

            // Destroy chart raha quality chart modal
            if (modalId === 'quality-chart-modal' && window.qualityChartModalInstance) {
                window.qualityChartModalInstance.destroy();
                window.qualityChartModalInstance = null;
                console.log('✅ Quality chart destroyed');
            }

            // Destroy chart raha advances chart modal
            if (modalId === 'advances-chart-modal' && window.advancesChartModalInstance) {
                window.advancesChartModalInstance.destroy();
                window.advancesChartModalInstance = null;
                console.log('✅ Advances chart destroyed');
            }

            // Remove modal class active if exists
            modal.classList.remove('active');

            console.log('✅ Modal closed:', modalId);
        }


        function openCollectorModal(collectorId = null) {
            const form = document.getElementById('collector-form');
            form.reset();
            delete form.dataset.editId;
            if (collectorId) {
                const collector = appData.collectors.find(c => c.id === collectorId);
                if (collector) {
                    document.getElementById('collector-name').value = collector.name;
                    document.getElementById('collector-phone').value = collector.phone;
                    document.getElementById('collector-cin').value = collector.cin || '';
                    document.getElementById('collector-cin-date').value = collector.cinDate || '';
                    document.getElementById('collector-address').value = collector.address || '';
                    form.dataset.editId = collectorId;
                }
            }
            openModal('collector-modal');
        }
        function openAdvanceModal(advanceId = null) {
            updateCollectorSelects();
            const form = document.getElementById('advance-form');
            form.reset();
            delete form.dataset.editId;
            if (advanceId) {
                const advance = appData.advances.find(a => a.id === advanceId);
                if (advance) {
                    document.getElementById('advance-date').value = advance.date;
                    document.getElementById('advance-collector').value = advance.collectorId;
                    document.getElementById('advance-amount').value = advance.amount;
                    document.getElementById('advance-motif').value = advance.motif || '';
                    form.dataset.editId = advanceId;
                }
            } else {
                setCurrentDate();
            }
            openModal('advance-modal');
        }
        // Fonction pour ajouter un poids avec validation
        function addQuickWeight() {
            const input = document.getElementById('quick-weight-input');
            let val = input.value.trim().replace(',', '.');
            const weight = parseFloat(val);

            // Validation
            if (isNaN(weight) || weight <= 0) {
                showToast('Ampidiro lanja marina (> 0 kg)', 'error', 2000);
                input.focus();
                return;
            }

            // Vérification limite raisonnable (éviter erreurs de saisie)
            if (weight > 100) {
                if (!confirm(`Gony mavesatra loatra: ${weight} kg. Hanohy ve?`)) {
                    return;
                }
            }

            // Ajouter le poids
            quickWeights.push(weight);

            // Réinitialiser l'input et focus
            input.value = '';
            input.focus();

            // Mettre à jour l'affichage
            renderQuickWeights();
            updateReceptionFromQuickWeights();

            // Animation de succès
            showToast(`✓ ${weight} kg nampiana`, 'success', 1000);
        }

        // Fonction pour afficher les poids avec design amélioré
        function renderQuickWeights() {
            const list = document.getElementById('quick-weights-list');
            const countEl = document.getElementById('quick-bag-count');
            const totalEl = document.getElementById('quick-total-weight');
            const netEl = document.getElementById('quick-net-weight');
            const tareInput = document.getElementById('quick-tare-input');
            const tare = parseFloat(tareInput.value.toString().replace(',', '.')) || 0;

            // Calculer le total
            const total = quickWeights.reduce((sum, w) => sum + w, 0);
            const net = total - (quickWeights.length * tare);

            // Vider la liste
            list.innerHTML = '';

            if (quickWeights.length === 0) {
                list.innerHTML = `
                    <div style="width: 100%; text-align: center; color: var(--md-sys-color-outline); padding: 10px; font-size: 12px;">
                        <span class="material-icons" style="font-size: 24px; opacity: 0.5;">inbox</span>
                        <div>Tsy misy lanja nampiana</div>
                    </div>
                `;
                countEl.textContent = '0';
                totalEl.textContent = '0.00';
                return;
            }

            // Afficher chaque poids
            quickWeights.forEach((w, index) => {
                const tag = document.createElement('span');
                tag.style.cssText = `
                    background: var(--md-sys-color-primary);
                    color: white;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-size: 13px;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: all 0.2s;
                    cursor: default;
                `;

                tag.innerHTML = `
                    <span style="font-size: 11px; opacity: 0.8;">#${index + 1}</span>
                    <strong>${w} kg</strong>
                    <span class="material-icons" 
                        style="font-size: 16px; cursor: pointer; opacity: 0.8; hover: opacity: 1;" 
                        onclick="removeQuickWeight(${index})"
                        title="Hamafa">
                        close
                    </span>
                `;

                // Effet hover
                tag.onmouseenter = () => {
                    tag.style.transform = 'scale(1.05)';
                    tag.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                };
                tag.onmouseleave = () => {
                    tag.style.transform = 'scale(1)';
                    tag.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };

                list.appendChild(tag);
            });

            // Mettre à jour les statistiques
            countEl.textContent = quickWeights.length;
            totalEl.textContent = total.toFixed(2);
            netEl.textContent = net > 0 ? net.toFixed(2) : '0.00';
        }

        // Fonction pour supprimer un poids spécifique
        function removeQuickWeight(index) {
            const removedWeight = quickWeights[index];
            quickWeights.splice(index, 1);

            renderQuickWeights();
            updateReceptionFromQuickWeights();

            showToast(`✓ ${removedWeight} kg nesorina`, 'info', 1500);
        }

        // NOUVELLE FONCTION: Annuler le dernier ajout
        function undoLastWeight() {
            if (quickWeights.length === 0) {
                showToast('Tsy misy lanja', 'info', 1500);
                return;
            }

            const lastWeight = quickWeights.pop();
            renderQuickWeights();
            updateReceptionFromQuickWeights();

            showToast(`✓ ${lastWeight} kg nesorina`, 'info', 1500);
        }

        // Fonction pour tout effacer avec confirmation
        function clearQuickWeights() {
            if (quickWeights.length === 0) {
                return;
            }

            if (confirm(`Hamafa ny lanja rehetra (${quickWeights.length} gony)?`)) {
                quickWeights = [];
                renderQuickWeights();
                updateReceptionFromQuickWeights();

                showToast('✓ Voafafa daholo', 'success', 1500);
            }
        }

        // Fonction pour mettre à jour les champs de réception
        function updateReceptionFromQuickWeights() {
            const totalWeight = quickWeights.reduce((sum, w) => sum + w, 0);
            const bagCount = quickWeights.length;
            const tareInput = document.getElementById('quick-tare-input');
            const tareValue = tareInput.value.toString().replace(',', '.');

            // Mettre à jour Poids Brut
            document.getElementById('reception-gross-weight').value = totalWeight.toFixed(2);

            // Mettre à jour Nombre de Sacs
            document.getElementById('reception-bag-count').value = bagCount;

            // Mettre à jour la Tare
            document.getElementById('reception-bag-weight').value = tareValue;

            // Recalculer les valeurs
            renderQuickWeights();
            calculateReceptionValues();
        }

        // Amélioration de la fonction d'ouverture du modal
        function openReceptionModal(receptionId = null) {
            // Réinitialiser le pesage rapide (sans confirmation)
            quickWeights = [];
            renderQuickWeights();

            updateCollectorSelects();
            updateQualitySelect();

            const form = document.getElementById('reception-form');
            form.reset();
            delete form.dataset.editId;

            if (receptionId) {
                const reception = appData.receptions.find(r => r.id === receptionId);
                if (reception) {
                    form.dataset.editId = receptionId;
                    document.getElementById('reception-collector').value = reception.collectorId;
                    updateCollectorBalanceDisplay();
                    document.getElementById('reception-date').value = reception.date;
                    document.getElementById('reception-gross-weight').value = reception.grossWeight;
                    document.getElementById('reception-bag-count').value = reception.bagCount;
                    document.getElementById('reception-bag-weight').value = reception.bagWeight;
                    document.getElementById('quick-tare-input').value = reception.bagWeight;
                    document.getElementById('reception-quality').value = reception.quality;
                    document.getElementById('reception-price').value = reception.price;
                    document.getElementById('reception-net-weight').value = reception.netWeight;
                    document.getElementById('reception-total-value').value = reception.totalValue;

                    // Famerenana ny lanja tsirairay (quickWeights)
                    if (reception.quickWeights && Array.isArray(reception.quickWeights)) {
                        quickWeights = [...reception.quickWeights];
                        renderQuickWeights();
                    }
                }
            } else {
                setCurrentDate();
                document.getElementById('reception-bag-count').value = 1;
                document.getElementById('reception-bag-weight').value = '';
                document.getElementById('quick-tare-input').value = '';
                calculateReceptionValues();
            }

            openModal('reception-modal');

            // Focus sur l'input du pesage rapide
            setTimeout(() => {
                document.getElementById('quick-weight-input').focus();
            }, 300);
        }
        function generateAutoNumber(prefix, dateStr, storeName) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const datePrefix = `${prefix}${year}${month}`;
            
            const items = appData[storeName] || [];
            const sameMonthItems = items.filter(item => {
                const val = prefix === 'BL' ? item.bl : item.invoice;
                return val && val.startsWith(datePrefix);
            });
            
            let maxNum = 0;
            sameMonthItems.forEach(item => {
                const val = prefix === 'BL' ? item.bl : item.invoice;
                const num = parseInt(val.substring(datePrefix.length));
                if (num > maxNum) maxNum = num;
            });
            
            return `${datePrefix}${String(maxNum + 1).padStart(3, '0')}`;
        }



        function openDeliveryModal(deliveryId = null) {
            updateQualitySelect();

            // Reset Quick Weighing Section
            deliveryQuickWeights = [];
            renderDeliveryQuickWeights();
            document.getElementById('delivery-quick-tare-input').value = '';

            if (deliveryId) {
                const delivery = appData.deliveries.find(d => d.id === deliveryId);
                if (delivery) {
                    document.getElementById('delivery-date').value = delivery.date;
                    document.getElementById('delivery-bl').value = delivery.bl || '';
                    document.getElementById('delivery-invoice').value = delivery.invoice;
                    document.getElementById('delivery-quality').value = delivery.quality || '';
                    document.getElementById('delivery-gross-weight').value = delivery.grossWeight || delivery.weight;
                    document.getElementById('delivery-bag-count').value = delivery.bagCount || 1;
                    document.getElementById('delivery-bag-weight').value = delivery.bagWeight || 0;
                    document.getElementById('delivery-quick-tare-input').value = delivery.bagWeight || 0;
                    document.getElementById('delivery-weight').value = delivery.weight;
                    document.getElementById('delivery-price').value = delivery.price || '';
                    document.getElementById('delivery-exporter').value = delivery.exporter;
                    document.getElementById('delivery-form').dataset.editId = deliveryId;

                    // Restaurer les poids individuels
                    if (delivery.quickWeights && Array.isArray(delivery.quickWeights)) {
                        deliveryQuickWeights = [...delivery.quickWeights];
                        renderDeliveryQuickWeights();
                    }
                    
                    calculateDeliveryValues();
                }
            } else {
                document.getElementById('delivery-form').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('delivery-date').value = today;
                document.getElementById('delivery-bl').value = generateAutoNumber('BL', today, 'deliveries');
                document.getElementById('delivery-invoice').value = generateAutoNumber('FAC', today, 'deliveries');
                document.getElementById('delivery-bag-count').value = 1;
                document.getElementById('delivery-bag-weight').value = '';
                delete document.getElementById('delivery-form').dataset.editId;
                calculateDeliveryValues();
            }
            openModal('delivery-modal');
            
            // Focus sur l'input du pesage rapide
            setTimeout(() => {
                document.getElementById('delivery-quick-weight-input').focus();
            }, 300);
        }
        function setupFormHandlers() {
            document.getElementById('collector-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveCollector();
            });
            document.getElementById('advance-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveAdvance();
            });
            document.getElementById('reception-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveReception();
            });
            document.getElementById('delivery-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveDelivery();
            });
            document.getElementById('theme-select').addEventListener('change', function () {
                setTheme(this.value);
            });
            document.getElementById('collector-phone').addEventListener('input', formatPhoneNumber);
            document.getElementById('expense-form').addEventListener('submit', function (e) {
                e.preventDefault();
                saveExpense();
            });
        }
        function formatPhoneNumber(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 10) {
                value = value.substring(0, 10);
                value = value.replace(/(\d{3})(\d{2})(\d{3})(\d{2})/, '$1 $2 $3 $4');
            }
            e.target.value = value;
        }
        function capitalizeWords(str) {
            return str.replace(/\w\S*/g, (txt) =>
                txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }
        function saveCollector() {
            const form = document.getElementById('collector-form');
            const name = capitalizeWords(document.getElementById('collector-name').value);
            const phone = document.getElementById('collector-phone').value.replace(/\s/g, '');
            const cin = document.getElementById('collector-cin').value.trim();
            const cinDate = document.getElementById('collector-cin-date').value;
            const address = document.getElementById('collector-address').value;
            
            // Validation téléphone
            if (phone && (phone.length !== 10 || !phone.startsWith('0'))) {
                alert('Le numéro de téléphone doit contenir 10 chiffres et commencer par 0.');
                return;
            }
            
            const editId = form.dataset.editId;
            
            // Vérifier unicité du nom
            const existingName = appData.collectors.find(c => {
                if (editId && c.id == editId) return false;
                return c.name.toLowerCase() === name.toLowerCase();
            });
            
            if (existingName) {
                showToast('❌ Un collecteur avec ce nom existe déjà!', 'error', 3000);
                document.getElementById('collector-name').focus();
                return;
            }
            
            // Vérifier unicité du CIN
            if (cin) {
                const existingCIN = appData.collectors.find(c => {
                    if (editId && c.id == editId) return false;
                    return c.cin && c.cin.toLowerCase() === cin.toLowerCase();
                });
                
                if (existingCIN) {
                    showToast('❌ Un collecteur avec ce N° CIN existe déjà!', 'error', 3000);
                    document.getElementById('collector-cin').focus();
                    return;
                }
            }
            
            const collector = {
                name: name,
                phone: phone,
                cin: cin,
                cinDate: cinDate,
                address: address,
                createdAt: new Date().toISOString()
            };
            
            if (editId) {
                collector.id = parseInt(editId);
            }
            
            saveToDB('collectors', collector);
            closeModal('collector-modal');
            showToast('✅ Collecteur enregistré avec succès!', 'success');
        }

        function saveAdvance() {
            const form = document.getElementById('advance-form');
            const cleanAmount = document.getElementById('advance-amount').value.replace(/\D/g, '');
            const advance = {
                date: document.getElementById('advance-date').value,
                collectorId: parseInt(document.getElementById('advance-collector').value),
                amount: parseInt(cleanAmount) || 0,
                motif: document.getElementById('advance-motif').value.trim(),
                createdAt: new Date().toISOString()
            };
            if (form.dataset.editId) {
                advance.id = parseInt(form.dataset.editId);
            }
            saveToDB('advances', advance);
            closeModal('advance-modal');
            showToast('Avance enregistrée avec succès!');
        }
        function saveReception() {
            const collectorId = parseInt(document.getElementById('reception-collector').value);
            const date = document.getElementById('reception-date').value;
            const grossWeight = parseFloat(document.getElementById('reception-gross-weight').value);
            const bagCount = parseInt(document.getElementById('reception-bag-count').value);
            const bagWeight = parseFloat(document.getElementById('reception-bag-weight').value);
            const netWeight = parseFloat(document.getElementById('reception-net-weight').value);
            const quality = document.getElementById('reception-quality').value;
            const priceInput = document.getElementById('reception-price').value;
            const price = (!priceInput || priceInput === '') ? 0 : parseFloat(priceInput);
            const totalValue = isNaN(parseFloat(document.getElementById('reception-total-value').value)) ? 0 : parseFloat(document.getElementById('reception-total-value').value);

            if (!collectorId || !date || isNaN(netWeight) || !quality || quality === '') {
                showToast('Fenoy tsara ny takelaka azafady', 'error');
                return;
            }

            const reception = {
                collectorId,
                date,
                grossWeight,
                bagCount,
                bagWeight,
                netWeight,
                quality: quality,
                price,
                totalValue,
                quickWeights: [...quickWeights] // Tehirizina ny lanja tsirairay
            };

            const form = document.getElementById('reception-form');
            if (form.dataset.editId) {
                reception.id = parseInt(form.dataset.editId);
            }

            saveToDB('receptions', reception);
            closeModal('reception-modal');
            showToast('Réception enregistrée avec succès!');
        }

        function saveDelivery() {
            const form = document.getElementById('delivery-form');
            const delivery = {
                date: document.getElementById('delivery-date').value,
                bl: document.getElementById('delivery-bl').value,
                invoice: document.getElementById('delivery-invoice').value,
                quality: document.getElementById('delivery-quality').value,
                grossWeight: parseFloat(document.getElementById('delivery-gross-weight').value.toString().replace(',', '.')) || 0,
                bagCount: parseInt(document.getElementById('delivery-bag-count').value) || 0,
                bagWeight: parseFloat(document.getElementById('delivery-bag-weight').value.toString().replace(',', '.')) || 0,
                weight: parseFloat(document.getElementById('delivery-weight').value.toString().replace(',', '.')) || 0,
                price: parseFloat(document.getElementById('delivery-price').value.toString().replace(',', '.')) || 0,
                totalValue: parseInt(document.getElementById('delivery-total-value').value) || 0,
                exporter: document.getElementById('delivery-exporter').value,
                quickWeights: [...deliveryQuickWeights],
                createdAt: new Date().toISOString()
            };
            if (form.dataset.editId) {
                delivery.id = parseInt(form.dataset.editId);
            }
            saveToDB('deliveries', delivery);
            closeModal('delivery-modal');
            showToast('Livraison enregistrée avec succès!');
        }
        function deleteCollector(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce collecteur?')) {
                deleteFromDB('collectors', id, () => {
                    showToast('Collecteur supprimé.', 'error');
                });
            }
        }
        function deleteAdvance(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette avance?')) {
                deleteFromDB('advances', id, () => {
                    showToast('Avance supprimée.', 'error');
                });
            }
        }
        function deleteReception(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette réception?')) {
                deleteFromDB('receptions', id, () => {
                    showToast('Réception supprimée.', 'error');
                });
            }
        }
        function deleteDelivery(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette livraison?')) {
                deleteFromDB('deliveries', id, () => {
                    showToast('Livraison supprimée.', 'error');
                });
            }
        }
        function setupReceptionCalculations() {
            ['reception-gross-weight', 'reception-bag-count', 'reception-bag-weight', 'reception-price', 'reception-net-weight'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateReceptionValues);
            });
        }
        function calculateReceptionValues() {
            const grossWeightInput = document.getElementById('reception-gross-weight');
            const netWeightInput = document.getElementById('reception-net-weight');
            const grossWeight = parseFloat(grossWeightInput.value.toString().replace(',', '.')) || 0;
            const bagCount = parseInt(document.getElementById('reception-bag-count').value) || 0;
            const bagWeight = parseFloat(document.getElementById('reception-bag-weight').value.toString().replace(',', '.')) || 0;
            const price = parseFloat(document.getElementById('reception-price').value.toString().replace(',', '.')) || 0;

            // Calculer le poids net : Poids Brut - (Nombre de sacs * Poids par sac)
            const totalBagWeight = bagCount * bagWeight;
            let netWeight = grossWeight - totalBagWeight;

            // Mettre à jour l'affichage du poids net
            netWeightInput.value = netWeight > 0 ? netWeight.toFixed(2) : '0.00';

            // Calculer la valeur totale
            const totalValue = netWeight * price;
            document.getElementById('reception-total-value').value = Math.round(totalValue);
        }
        function setupDeliveryCalculations() {
            ['delivery-gross-weight', 'delivery-bag-count', 'delivery-bag-weight', 'delivery-price'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateDeliveryValues);
            });
        }
        function calculateDeliveryValues() {
            const grossWeightInput = document.getElementById('delivery-gross-weight');
            const netWeightInput = document.getElementById('delivery-weight');
            const grossWeight = parseFloat(grossWeightInput.value.toString().replace(',', '.')) || 0;
            const bagCount = parseInt(document.getElementById('delivery-bag-count').value) || 0;
            const bagWeight = parseFloat(document.getElementById('delivery-bag-weight').value.toString().replace(',', '.')) || 0;
            const price = parseFloat(document.getElementById('delivery-price').value.toString().replace(',', '.')) || 0;

            // Calculer le poids net : Poids Brut - (Nombre de sacs * Poids par sac)
            const totalBagWeight = bagCount * bagWeight;
            let netWeight = grossWeight - totalBagWeight;

            // Mettre à jour l'affichage du poids net
            netWeightInput.value = netWeight > 0 ? netWeight.toFixed(2) : '0.00';

            // Calculer la valeur totale
            const totalValue = netWeight * price;
            document.getElementById('delivery-total-value').value = Math.round(totalValue);
        }

        // --- Fonctions Pesage Rapide pour Livraison ---
        function addDeliveryQuickWeight() {
            const input = document.getElementById('delivery-quick-weight-input');
            let val = input.value.trim().replace(',', '.');
            const weight = parseFloat(val);

            if (isNaN(weight) || weight <= 0) {
                showToast('Ampidiro lanja marina (> 0 kg)', 'error', 2000);
                input.focus();
                return;
            }

            if (weight > 100) {
                if (!confirm(`Gony mavesatra loatra: ${weight} kg. Hanohy ve?`)) {
                    return;
                }
            }

            deliveryQuickWeights.push(weight);
            input.value = '';
            input.focus();

            renderDeliveryQuickWeights();
            updateDeliveryFromQuickWeights();
            showToast(`✓ ${weight} kg nampiana`, 'success', 1000);
        }

        function renderDeliveryQuickWeights() {
            const list = document.getElementById('delivery-quick-weights-list');
            const countEl = document.getElementById('delivery-quick-bag-count');
            const totalEl = document.getElementById('delivery-quick-total-weight');
            const netEl = document.getElementById('delivery-quick-net-weight');
            const tareInput = document.getElementById('delivery-quick-tare-input');
            const tare = parseFloat(tareInput.value.toString().replace(',', '.')) || 0;

            const total = deliveryQuickWeights.reduce((sum, w) => sum + w, 0);
            const net = total - (deliveryQuickWeights.length * tare);

            list.innerHTML = '';

            if (deliveryQuickWeights.length === 0) {
                list.innerHTML = `
                    <div style="width: 100%; text-align: center; color: var(--md-sys-color-outline); padding: 10px; font-size: 12px;">
                        <span class="material-icons" style="font-size: 24px; opacity: 0.5;">inbox</span>
                        <div>Tsy misy lanja nampiana</div>
                    </div>
                `;
                countEl.textContent = '0';
                totalEl.textContent = '0.00';
                netEl.textContent = '0.00';
                return;
            }

            deliveryQuickWeights.forEach((w, index) => {
                const tag = document.createElement('span');
                tag.style.cssText = `
                    background: var(--md-sys-color-primary);
                    color: white;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-size: 13px;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: all 0.2s;
                    cursor: default;
                `;

                tag.innerHTML = `
                    <span style="font-size: 11px; opacity: 0.8;">#${index + 1}</span>
                    <strong>${w} kg</strong>
                    <span class="material-icons" 
                        style="font-size: 16px; cursor: pointer; opacity: 0.8; hover: opacity: 1;" 
                        onclick="removeDeliveryQuickWeight(${index})"
                        title="Hamafa">
                        close
                    </span>
                `;

                tag.onmouseenter = () => {
                    tag.style.transform = 'scale(1.05)';
                    tag.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                };
                tag.onmouseleave = () => {
                    tag.style.transform = 'scale(1)';
                    tag.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };

                list.appendChild(tag);
            });

            countEl.textContent = deliveryQuickWeights.length;
            totalEl.textContent = total.toFixed(2);
            netEl.textContent = net > 0 ? net.toFixed(2) : '0.00';
        }

        function removeDeliveryQuickWeight(index) {
            const removedWeight = deliveryQuickWeights[index];
            deliveryQuickWeights.splice(index, 1);
            renderDeliveryQuickWeights();
            updateDeliveryFromQuickWeights();
            showToast(`✓ ${removedWeight} kg nesorina`, 'info', 1500);
        }

        function undoLastDeliveryWeight() {
            if (deliveryQuickWeights.length === 0) {
                showToast('Tsy misy lanja', 'info', 1500);
                return;
            }
            const lastWeight = deliveryQuickWeights.pop();
            renderDeliveryQuickWeights();
            updateDeliveryFromQuickWeights();
            showToast(`✓ ${lastWeight} kg nesorina`, 'info', 1500);
        }

        function clearDeliveryQuickWeights() {
            if (deliveryQuickWeights.length === 0) return;
            if (confirm(`Hamafa ny lanja rehetra (${deliveryQuickWeights.length} gony)?`)) {
                deliveryQuickWeights = [];
                renderDeliveryQuickWeights();
                updateDeliveryFromQuickWeights();
                showToast('✓ Voafafa daholo', 'success', 1500);
            }
        }

        function updateDeliveryFromQuickWeights() {
            const totalWeight = deliveryQuickWeights.reduce((sum, w) => sum + w, 0);
            const bagCount = deliveryQuickWeights.length;
            const tareInput = document.getElementById('delivery-quick-tare-input');
            const tareValue = tareInput.value.toString().replace(',', '.');

            document.getElementById('delivery-gross-weight').value = totalWeight.toFixed(2);
            document.getElementById('delivery-bag-count').value = bagCount;
            document.getElementById('delivery-bag-weight').value = tareValue;

            renderDeliveryQuickWeights();
            calculateDeliveryValues();
        }
        function updateCollectorSelects() {
            const selects = ['advance-collector', 'reception-collector', 'advance-filter-collector', 'analysis-filter-collector'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Garder seulement la première option (vide)
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // ✅ FILTRER: Seulement les collecteurs disponibles dans l'année actuelle
                const availableCollectors = appData.collectors.filter(isCollectorAvailableInCurrentYear);
                
                availableCollectors.forEach(collector => {
                    const option = document.createElement('option');
                    option.value = collector.id;
                    option.textContent = collector.name;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        function updateCollectorsTable() {
            const tbody = document.getElementById('collectors-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            
            // ✅ FILTRER: Seulement les collecteurs créés avant ou pendant l'année actuelle
            const availableCollectors = appData.collectors.filter(isCollectorAvailableInCurrentYear);
            
            if (availableCollectors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="material-icons">people_outline</div>
                            <div>Aucun collecteur pour l'année ${currentYear}</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const paginatedCollectors = getPaginatedData(availableCollectors, 'collectors');
            
            paginatedCollectors.forEach(collector => {
                const balance = getCachedBalance(collector.id);
                const status = getCollectorStatus(balance);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nom">${collector.name}</td>
                    <td data-label="Téléphone">${collector.phone}</td>
                    <td data-label="C.I.N">${collector.cin || ''}</td>
                    <td data-label="Délivré le">${collector.cinDate ? formatDate(collector.cinDate) : ''}</td>
                    <td data-label="Adresse">${collector.address || ''}</td>
                    <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                    <td data-label="Solde">${formatCurrency(Math.abs(balance))}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openCollectorModal(${collector.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteCollector(${collector.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('collectors', availableCollectors.length);
            initTableSorting();
        }


        // Ajoute cette fonction après getYearFromDateString()
        function getCollectorCreationYear(collector) {
            if (!collector.createdAt) return null;
            const d = new Date(collector.createdAt);
            if (Number.isNaN(d.getTime())) return null;
            return d.getFullYear();
        }

        // Fonction pour vérifier si un collecteur existe dans l'année actuelle
        function isCollectorAvailableInCurrentYear(collector) {
            const creationYear = getCollectorCreationYear(collector);
            if (!creationYear) return true; // Si pas de date, on l'affiche (ancien collecteur)
            return creationYear <= currentYear; // Afficher si créé avant ou pendant l'année actuelle
        }

        function updateAdvancesTable() {
            const tbody = document.getElementById('advances-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            const sortedAdvances = filterAdvances();
            const filteredAdvances = filterAdvances();
            if (filteredAdvances.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">account_balance_wallet</div>
                            <div>Aucune avance enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            const paginatedAdvances = getPaginatedData(filteredAdvances, 'advances');
            paginatedAdvances.forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(advance.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>                  
                    <td data-label="Montant">${formatCurrency(advance.amount)}</td>
                    <td data-label="Motif">${advance.motif || 'N/A'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openAdvanceModal(${advance.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteAdvance(${advance.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('advances', filteredAdvances.length);
            initTableSorting();
        }
        function updateReceptionTable() {
            const tbody = document.getElementById('reception-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';

            // 1) On ne garde que les réceptions de l'année active
            const receptionsForYear = getReceptionsForCurrentYear();

            if (receptionsForYear.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="material-icons">inventory</div>
                            <div>Aucune réception enregistrée pour cette année</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 2) Pagination sur ces données filtrées
            const paginatedReceptions = getPaginatedData(receptionsForYear, 'receptions');

            paginatedReceptions.forEach(reception => {
                const collector = appData.collectors.find(c => c.id === reception.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(reception.date)}</td>
                    <td>${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td>${reception.grossWeight} kg</td>
                    <td>${reception.netWeight} kg</td>
                    <td><span class="status-badge status-${reception.quality.toLowerCase()}">${reception.quality}</span></td>
                    <td>${formatCurrency(reception.price)}kg</td>
                    <td>${formatCurrency(reception.totalValue)}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openReceptionModal(${reception.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteReception(${reception.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="generateReceipt(${reception.id})" title="Imprimer le Reçu du Jour">
                            <span class="material-icons">print</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('receptions', receptionsForYear.length);
            initTableSorting();
        }

        function updateDeliveryTable() {
            const tbody = document.getElementById('delivery-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';

            // 1) On part des livraisons de l'année active
            const deliveriesForYear = getDeliveriesForCurrentYear();

            if (deliveriesForYear.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="material-icons">local_shipping</div>
                            <div>Aucune livraison enregistrée pour cette année</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // 2) Pagination sur les données filtrées
            const paginatedDeliveries = getPaginatedData(deliveriesForYear, 'deliveries');

            paginatedDeliveries.forEach(delivery => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(delivery.date)}</td>
                    <td>
                        <div style="font-weight: 600">${delivery.bl || '-'}</div>
                        <div style="font-size: 11px; opacity: 0.7">${delivery.invoice || ''}</div>
                    </td>
                    <td>
                        <span class="status-badge" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container)">
                            ${delivery.quality || 'N/A'}
                        </span>
                    </td>
                    <td>${delivery.weight} kg</td>
                    <td>${formatCurrency(delivery.totalValue)}</td>
                    <td>${delivery.exporter || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openDeliveryModal(${delivery.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteDelivery(${delivery.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                        <button class="btn btn-icon btn-secondary" onclick="generateDeliveryPDF(${delivery.id}, 'BL')" title="Imprimer BL">
                            <span class="material-icons">description</span>
                        </button>
                        <button class="btn btn-icon btn-success" onclick="generateDeliveryPDF(${delivery.id}, 'Facture')" title="Imprimer Facture">
                            <span class="material-icons">receipt</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('deliveries', deliveriesForYear.length);
            initTableSorting();
        }

        function updateAnalysisTable() {
            console.time('updateAnalysisTable');
            const tbody = document.getElementById('analysis-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            
            // ✅ FILTRER: Seulement les collecteurs disponibles dans l'année actuelle
            const availableCollectors = appData.collectors.filter(isCollectorAvailableInCurrentYear);
            
            if (availableCollectors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="material-icons">analytics</div>
                            <div>Aucun collecteur disponible pour l'année ${currentYear}</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const filterCollectorId = document.getElementById('analysis-filter-collector').value;
            const filterQuality = document.getElementById('analysis-filter-quality').value;
            
            // ✅ FILTRER: Utiliser availableCollectors au lieu de appData.collectors
            let collectorsToShow = filterCollectorId ?
                availableCollectors.filter(c => c.id == filterCollectorId) :
                availableCollectors;
            
            if (!calculationCache.isValid) {
                buildCache();
            }
            
            const paiementsParCollecteur = {};
            const remboursementsParCollecteur = {};
            const receptionsParCollecteur = {};
            
            // ✅ BON: On part des données de l'année courante
            const paiementsYear = getPaiementsForCurrentYear();
            const remboursementsYear = getRemboursementsForCurrentYear();
            const receptionsYear = getReceptionsForCurrentYear();
            
            // Agrégation par collecteur
            paiementsYear.forEach(p => {
                if (!paiementsParCollecteur[p.collectorId]) paiementsParCollecteur[p.collectorId] = 0;
                paiementsParCollecteur[p.collectorId] += p.amount;
            });
            
            remboursementsYear.forEach(rem => {
                if (!remboursementsParCollecteur[rem.collectorId]) remboursementsParCollecteur[rem.collectorId] = 0;
                remboursementsParCollecteur[rem.collectorId] += rem.amount;
            });
            
            receptionsYear.forEach(r => {
                if (filterQuality && r.quality !== filterQuality) return;
                if (!receptionsParCollecteur[r.collectorId]) receptionsParCollecteur[r.collectorId] = 0;
                receptionsParCollecteur[r.collectorId] += r.totalValue;
            });
            
            // ✅ OPTIONNEL: Filtrer pour n'afficher que ceux avec des transactions dans l'année
            // (Tu peux commenter ces lignes si tu veux afficher tous les collecteurs même sans transaction)
            collectorsToShow = collectorsToShow.filter(collector => {
                const totalAdvances = getTotalAdvances(collector.id);
                const totalPaiements = paiementsParCollecteur[collector.id] || 0;
                const totalDeliveriesFiltered = receptionsParCollecteur[collector.id] || 0;
                const totalRemboursements = remboursementsParCollecteur[collector.id] || 0;
                
                // Afficher si au moins une transaction existe
                return (totalAdvances > 0 || totalPaiements > 0 || totalDeliveriesFiltered > 0 || totalRemboursements > 0);
            });
            
            if (collectorsToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="material-icons">inbox</div>
                            <div>Aucune transaction pour l'année ${currentYear}</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const paginatedCollectors = getPaginatedData(collectorsToShow, 'analysis');
            const fragment = document.createDocumentFragment();
            
            paginatedCollectors.forEach(collector => {
                const totalAdvances = getTotalAdvances(collector.id);
                const totalPaiements = paiementsParCollecteur[collector.id] || 0;
                const totalDebits = totalAdvances + totalPaiements;
                
                const totalDeliveriesFiltered = receptionsParCollecteur[collector.id] || 0;
                const totalRemboursements = remboursementsParCollecteur[collector.id] || 0;
                const totalCredits = totalDeliveriesFiltered + totalRemboursements;
                
                const balance = totalCredits - totalDebits;
                const status = getCollectorStatus(balance);
                
                let actionButton = '';
                if (status.class === 'debiteur') {
                    actionButton = `<button class="btn btn-icon btn-success" onclick="openRemboursementModal(${collector.id})" title="Enregistrer un remboursement"><span class="material-icons" style="color: white;">paid</span></button>`;
                } else if (status.class === 'crediteur' && balance > 0) {
                    actionButton = `<button class="btn btn-icon btn-primary" onclick="payCollectorCredit(${collector.id})" title="Payer le solde créditeur"><span class="material-icons">payments</span></button>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Collecteur">${collector.name}</td>
                    <td data-label="Total Débits (Avances + Paiements)">${formatCurrency(totalDebits)}</td>
                    <td data-label="Total Crédits (Livr. + Remb.)">${formatCurrency(totalCredits)}</td>
                    <td data-label="Solde">${formatCurrency(balance)}</td>
                    <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="showCollectorDetails(${collector.id})" title="Détails">
                            <span class="material-icons">visibility</span>
                        </button>
                        ${actionButton}
                    </td>
                `;
                fragment.appendChild(row);
            });
            
            tbody.appendChild(fragment);
            
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('analysis', collectorsToShow.length);
            
            initTableSorting();
            console.timeEnd('updateAnalysisTable');
        }

        function updateAnalysisQualityFilter() {
            const select = document.getElementById('analysis-filter-quality');
            if (!select) return;
            const currentValue = select.value;
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            if (appData.qualities) {
                appData.qualities.forEach(quality => {
                    const option = document.createElement('option');
                    option.value = quality.name;
                    option.textContent = quality.name;
                    select.appendChild(option);
                });
            }
            select.value = currentValue;
        }
        function calculateCollectorBalance(collectorId) {
            const advances = getAdvancesForCurrentYear()
                .filter(advance => advance.collectorId === collectorId);

            const paiements = getPaiementsForCurrentYear()
                .filter(p => p.collectorId === collectorId);

            const receptions = getReceptionsForCurrentYear()
                .filter(reception => reception.collectorId === collectorId);

            const remboursements = getRemboursementsForCurrentYear()
                .filter(rem => rem.collectorId === collectorId);

            const totalAdvances = advances.reduce((sum, a) => sum + a.amount, 0);
            const totalPaiements = paiements.reduce((sum, p) => sum + p.amount, 0);
            const totalDebits = totalAdvances + totalPaiements;

            const totalDeliveries = receptions.reduce((sum, r) => sum + r.totalValue, 0);
            const totalRemboursements = remboursements.reduce((sum, rem) => sum + rem.amount, 0);
            const totalCredits = totalDeliveries + totalRemboursements;

            return totalCredits - totalDebits;
        }

        function calculateCollectorBalanceGlobal(collectorId) {
            // On calcule sur TOUTES les données, sans filtre d'année
            const totalAdvances = (appData.advances || [])
                .filter(a => a.collectorId === collectorId)
                .reduce((sum, a) => sum + a.amount, 0);

            const totalPaiements = (appData.paiements || [])
                .filter(p => p.collectorId === collectorId)
                .reduce((sum, p) => sum + p.amount, 0);

            const totalDebits = totalAdvances + totalPaiements;

            const totalDeliveries = (appData.receptions || [])
                .filter(r => r.collectorId === collectorId)
                .reduce((sum, r) => sum + r.totalValue, 0);

            const totalRemboursements = (appData.remboursements || [])
                .filter(rem => rem.collectorId === collectorId)
                .reduce((sum, rem) => sum + rem.amount, 0);

            const totalCredits = totalDeliveries + totalRemboursements;

            return totalCredits - totalDebits;
        }

        function getTotalAdvances(collectorId) {
            return getAdvancesForCurrentYear()
                .filter(advance => advance.collectorId === collectorId)
                .reduce((sum, advance) => sum + advance.amount, 0);
        }

        function getTotalDeliveries(collectorId) {
            return getReceptionsForCurrentYear()
                .filter(reception => reception.collectorId === collectorId)
                .reduce((sum, reception) => sum + reception.totalValue, 0);
        }

        function getCollectorStatus(balance) {
            if (balance > 0) {
                return { class: 'crediteur', label: 'Créditeur' };
            } else if (balance < 0) {
                return { class: 'debiteur', label: 'Débiteur' };
            } else {
                return { class: 'equilibre', label: 'Équilibré' };
            }
        }
        function filterAdvances() {
            let filtered = getAdvancesForCurrentYear();
            const collectorFilter = document.getElementById('advance-filter-collector').value;
            const startDate = document.getElementById('advance-filter-start').value;
            const endDate = document.getElementById('advance-filter-end').value;
            if (collectorFilter) {
                filtered = filtered.filter(advance => advance.collectorId == collectorFilter);
            }
            if (startDate) {
                filtered = filtered.filter(advance => advance.date >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(advance => advance.date <= endDate);
            }
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-MG', {
                style: 'currency',
                currency: 'MGA',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('MGA', 'Ar');
        }
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '-';
            }
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['advance-date', 'reception-date', 'delivery-date'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.value) {
                    input.value = today;
                }
            });
        }
        function formatPhoneNumberForDisplay(phoneString) {
            if (!phoneString || typeof phoneString !== 'string') {
                return phoneString || 'N/A';
            }
            const cleaned = phoneString.replace(/\s/g, '');
            if (cleaned.length === 10 && /^\d+$/.test(cleaned)) {
                return `${cleaned.substring(0, 3)} ${cleaned.substring(3, 5)} ${cleaned.substring(5, 8)} ${cleaned.substring(8, 10)}`;
            }
            return phoneString;
        }
        function exportData() {
            const dataToExport = {
                collectors: appData.collectors || [],
                advances: appData.advances || [],
                receptions: appData.receptions || [],
                deliveries: appData.deliveries || [],
                qualities: appData.qualities || [],
                expenses: appData.expenses || [],
                remboursements: appData.remboursements || [],
                paiements: appData.paiements || [],
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `behavana-data-v2-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Exportation des données terminée.", "success");
        }
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        console.log('Raw imported data:', importedData);
                        if (confirm('Êtes-vous sûr de vouloir importer ces données? Cela remplacera toutes les données existantes.')) {
                            executeWhenReady(() => {
                                if (!db) {
                                    console.warn('Database not available, importing to memory');
                                    appData = {
                                        collectors: importedData.collectors || [],
                                        advances: importedData.advances || [],
                                        receptions: importedData.receptions || [],
                                        deliveries: importedData.deliveries || [],
                                        qualities: importedData.qualities || [],
                                        expenses: importedData.expenses || [],
                                        remboursements: importedData.remboursements || [],
                                        paiements: importedData.paiements || []
                                    };
                                    updateAllTables();
                                    alert('Données importées avec succès (mode mémoire)!');
                                    return;
                                }
                                console.log('Starting database import process...');
                                try {
                                    clearAllData(() => {
                                        console.log('Database cleared, starting import...');
                                        importNewData(importedData);
                                    });
                                } catch (error) {
                                    console.error('Import error:', error);
                                    alert('Erreur lors de l\'importation: ' + error.message);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('JSON parse error:', error);
                        alert('Erreur lors de l\'importation du fichier JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        function clearAllData(callback) {
            if (!db) {
                console.warn('Database not available for clearing, clearing memory only');
                appData = {
                    collectors: [], advances: [], receptions: [], deliveries: [],
                    qualities: [], expenses: [], remboursements: [], paiements: []
                };
                if (callback) callback();
                return;
            }
            const stores = [
                'collectors', 'advances', 'receptions', 'deliveries',
                'expenses', 'qualities', 'remboursements', 'paiements'
            ];
            const transaction = db.transaction(stores, 'readwrite');
            transaction.oncomplete = () => {
                console.log('All stores cleared successfully.');
                if (callback) callback();
            };
            transaction.onerror = (event) => {
                console.error('Transaction error during clearing:', event.target.error);
                if (callback) callback();
            };
            stores.forEach(storeName => {
                if (db.objectStoreNames.contains(storeName)) {
                    transaction.objectStore(storeName).clear();
                }
            });
        }
        function importNewData(importedData) {
            console.log('Starting import process with data:', importedData);
            const collectorIdMapping = {};
            importCollectors(importedData.collectors || [], (newCollectorIds) => {
                console.log('Collectors imported with new IDs:', newCollectorIds);
                (importedData.collectors || []).forEach((collector, index) => {
                    const oldId = collector.id;
                    const newId = newCollectorIds[index];
                    if (oldId && newId) {
                        collectorIdMapping[oldId] = newId;
                    }
                });
                console.log('Complete ID mapping:', collectorIdMapping);
                const createNewDataWithMappedIds = (items) => {
                    if (!items) return [];
                    return items.map(item => {
                        if (item.collectorId && collectorIdMapping[item.collectorId]) {
                            const newItem = { ...item };
                            newItem.collectorId = collectorIdMapping[item.collectorId];
                            delete newItem.id;
                            return newItem;
                        }
                        const newItem = { ...item };
                        delete newItem.id;
                        return newItem;
                    });
                };
                const storesToImport = [
                    { name: 'qualities', data: createNewDataWithMappedIds(importedData.qualities) },
                    { name: 'expenses', data: createNewDataWithMappedIds(importedData.expenses) },
                    { name: 'advances', data: createNewDataWithMappedIds(importedData.advances) },
                    { name: 'receptions', data: createNewDataWithMappedIds(importedData.receptions) },
                    { name: 'deliveries', data: createNewDataWithMappedIds(importedData.deliveries) },
                    { name: 'remboursements', data: createNewDataWithMappedIds(importedData.remboursements) },
                    { name: 'paiements', data: createNewDataWithMappedIds(importedData.paiements) }
                ];
                let remainingImports = storesToImport.length;
                if (remainingImports === 0) {
                    showToast("Tsy misy angona hita ao anaty rakitra.", "error");
                    return;
                }
                const checkComplete = () => {
                    remainingImports--;
                    if (remainingImports === 0) {
                        setTimeout(() => {
                            console.log('All imports completed, reloading data...');
                            loadData();
                            alert('Données importées avec succès! Toutes les relations ont été préservées.');
                        }, 500);
                    }
                };
                storesToImport.forEach(storeInfo => {
                    importStoreData(storeInfo.name, storeInfo.data, checkComplete);
                });
            });
        }
        function importCollectors(collectors, callback) {
            console.log('Importing collectors:', collectors);
            if (!collectors || collectors.length === 0) {
                console.log('No collectors to import');
                if (callback) callback([]);
                return;
            }
            const newIds = [];
            let processedCount = 0;
            try {
                const transaction = db.transaction(['collectors'], 'readwrite');
                const store = transaction.objectStore('collectors');
                collectors.forEach((collector, index) => {
                    const cleanCollector = {
                        name: collector.name,
                        phone: collector.phone,
                        address: collector.address,
                        createdAt: collector.createdAt || new Date().toISOString()
                    };
                    console.log(`Adding collector ${index}:`, cleanCollector);
                    const request = store.add(cleanCollector);
                    request.onsuccess = function (event) {
                        const newId = event.target.result;
                        newIds[index] = newId;
                        console.log(`Collector "${collector.name}" imported with new ID: ${newId}`);
                        processedCount++;
                        if (processedCount === collectors.length) {
                            console.log(`All ${collectors.length} collectors imported. New IDs:`, newIds);
                            if (callback) callback(newIds);
                        }
                    };
                    request.onerror = function (event) {
                        console.error(`Error importing collector "${collector.name}":`, event.target.error);
                        newIds[index] = null;
                        processedCount++;
                        if (processedCount === collectors.length) {
                            if (callback) callback(newIds);
                        }
                    };
                });
                transaction.onerror = function (event) {
                    console.error('Transaction error while importing collectors:', event.target.error);
                    if (callback) callback([]);
                };
            } catch (error) {
                console.error('Error importing collectors:', error);
                if (callback) callback([]);
            }
        }
        function importStoreData(storeName, items, callback) {
            if (!items || items.length === 0) {
                if (callback) callback();
                return;
            }
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                let processedItems = 0;
                items.forEach(item => {
                    const cleanItem = { ...item };
                    delete cleanItem.id;
                    delete cleanItem.exportId;
                    delete cleanItem.collectorExportId;
                    const request = store.add(cleanItem);
                    request.onsuccess = function () {
                        processedItems++;
                        if (processedItems === items.length) {
                            console.log(`Imported ${items.length} items to ${storeName}`);
                            if (callback) callback();
                        }
                    };
                    request.onerror = function (event) {
                        console.error(`Error importing item to ${storeName}:`, event.target.error);
                        processedItems++;
                        if (processedItems === items.length) {
                            if (callback) callback();
                        }
                    };
                });
                transaction.onerror = function (event) {
                    console.error(`Transaction error for ${storeName}:`, event.target.error);
                    if (callback) callback();
                };
            } catch (error) {
                console.error(`Error importing to ${storeName}:`, error);
                if (callback) callback();
            }
        }
        function resetData() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données? Cette action est irréversible.')) {
                if (confirm('Confirmation finale: Toutes les données seront perdues définitivement!')) {
                    executeWhenReady(() => {
                        if (!db) {
                            console.warn('Database not available, clearing memory data');
                            appData = {
                                collectors: [],
                                advances: [],
                                receptions: [],
                                deliveries: [],
                                expenses: []
                            };
                            updateAllTables();
                            alert('Toutes les données ont été supprimées (mode mémoire).');
                            return;
                        }
                        clearAllData(() => {
                            appData = {
                                collectors: [],
                                advances: [],
                                receptions: [],
                                deliveries: [],
                                expenses: []
                            };
                            updateAllTables();
                            alert('Toutes les données ont été supprimées.');
                        });
                    });
                }
            }
        }
        function exportInvoice() {
            const receptionsByCollector = {};
            appData.receptions.forEach(reception => {
                const collector = appData.collectors.find(c => c.id === reception.collectorId);
                const collectorName = collector ? collector.name : 'Collecteur supprimé';
                if (!receptionsByCollector[collectorName]) {
                    receptionsByCollector[collectorName] = [];
                }
                receptionsByCollector[collectorName].push(reception);
            });
            let pdfContent = `
                <html>
                <head>
    <link rel="preconnect" href="https:
    <link rel="preconnect" href="https:
    <link href="https:
                    <title>Facture - BEHAVANA</title>
                    <style>

    /* Landscape Mode Optimization for Small Screens */
    @media (max-height: 600px) and (orientation: landscape) {
        .header { height: 48px !important; }
        .main-content { padding-top: 55px !important; }
        .sidebar { width: 240px !important; }
        .overview-stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; }
        
        .form-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-card { padding: 8px !important; }
        .stat-icon { width: 32px !important; height: 32px !important; font-size: 18px !important; }
    }

    /* Specific fixes for Redmi Note 8 Pro and similar devices */
    @media (max-width: 450px) {
        .overview-stats { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-value { font-size: 16px !important; }
        .header { padding: 0 10px !important; }
        .global-search-wrapper { margin: 0 5px !important; }
        .data-table td { 
            padding-left: 45% !important; 
            font-size: 11px !important;
            white-space: normal !important;
            word-break: break-word !important;
        }
        .data-table td:before { width: 40% !important; }
        .btn { padding: 8px 12px !important; font-size: 12px !important; }
        .form-group { margin-bottom: 10px !important; }
        input, select, textarea { font-size: 16px !important; } /* Prevent zoom on focus in iOS/Android */
    }
     body{font-family:Arial, sans-serif;margin:20px;}.header{text-align:center;margin-bottom:30px;}.company-name{font-size:24px;font-weight:bold;color:#6750a4;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th, td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f2f2f2;}.collector-section{margin-bottom:30px;}.collector-name{font-size:18px;font-weight:bold;margin-bottom:10px;}.total{font-weight:bold;background-color:#f9f9f9;}
    .form-label {
        color: var(--md-sys-color-on-surface) !important;
        font-weight: 600 !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .form-label {
        color: var(--md-sys-color-on-surface) !important;
        text-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
</style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Facture de Réception - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
            `;
            Object.keys(receptionsByCollector).forEach(collectorName => {
                const receptions = receptionsByCollector[collectorName];
                const totalWeight = receptions.reduce((sum, r) => sum + r.netWeight, 0);
                const totalValue = receptions.reduce((sum, r) => sum + r.totalValue, 0);
                pdfContent += `
                    <div class="collector-section">
                        <div class="collector-name">${collectorName}</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Poids Net (kg)</th>
                                    <th style="padding: 8px; text-align: left;">Qualité</th>
                                    <th>Prix/kg</th>
                                    <th>Valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                receptions.forEach(reception => {
                    pdfContent += `
                        <tr>
                            <td>${formatDate(reception.date)}</td>
                            <td>${reception.netWeight}</td>
                            <td>${reception.quality}</td>
                            <td>${formatCurrency(reception.price)}</td>
                            <td>${formatCurrency(reception.totalValue)}</td>
                        </tr>
                    `;
                });
                pdfContent += `
                            <tr class="total">
                                <td colspan="1"><strong>Total</strong></td>
                                <td><strong>${totalWeight.toFixed(2)} kg</strong></td>
                                <td></td> <!-- Avela banga ny toeran'ny Qualité -->
                                <td></td> <!-- Avela banga ny toeran'ny Prix/kg -->
                                <td><strong>${formatCurrency(totalValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            });
            pdfContent += '</body></html>';
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        function generateDeliveryPDF(deliveryId, type = 'BL') {
            const delivery = appData.deliveries.find(d => d.id === deliveryId);
            if (!delivery) {
                alert("Erreur: Impossible de trouver la livraison.");
                return;
            }

            const isFacture = type === 'Facture';
            const title = isFacture ? 'FACTURE' : 'BON DE LIVRAISON';
            const docNumber = isFacture ? delivery.invoice : delivery.bl;
            const docLabel = isFacture ? 'Facture N°' : 'BL N°';

            let pdfContent = `
                <html>
                <head>
                    <title>${title} - ${docNumber}</title>
                    <style>
                        @page { size: A4; margin: 20mm; }
                        body { font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; color: #333; line-height: 1.6; }
                        .container { max-width: 800px; margin: auto; }
                        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #6750a4; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info h1 { color: #6750a4; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px; }
                        .company-info p { margin: 2px 0; color: #6b7280; font-size: 10px; }
                        .doc-info { text-align: right; }
                        .doc-info h2 { margin: 0; color: #6750a4; font-size: 22px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
                        .doc-meta { font-size: 14px; color: #444; }
                        .doc-meta p { margin: 4px 0; }
                        .doc-meta strong { color: #000; }
                        
                        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
                        .detail-box { background: #fcfaff; padding: 15px; border-radius: 8px; border: 1px solid #e0d7f7; }
                        .detail-box h3 { margin-top: 0; font-size: 12px; color: #6750a4; text-transform: uppercase; border-bottom: 1px solid #e0d7f7; padding-bottom: 8px; margin-bottom: 12px; font-weight: 600; }
                        .detail-row { display: flex; margin-bottom: 6px; font-size: 14px; }
                        .detail-label { font-weight: 600; color: #555; width: 100px; flex-shrink: 0; }
                        .detail-value { color: #333; }

                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px; table-layout: fixed; }
                        th { background-color: #6750a4; color: white; padding: 10px 5px; text-align: left; text-transform: uppercase; font-weight: 600; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                        td { border-bottom: 1px solid #eee; padding: 10px 5px; color: #444; word-wrap: break-word; }
                        tr:nth-child(even) { background-color: #fcfaff; }
                        
                        .summary-section { display: flex; justify-content: flex-end; margin-top: 20px; }
                        .summary-table { width: 300px; }
                        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
                        .summary-row.total { border-bottom: none; padding-top: 15px; }
                        .summary-label { font-weight: 600; color: #555; }
                        .summary-value { font-weight: 700; color: #333; }
                        .total-amount { font-size: 20px; color: #6750a4; }

                        .signature-section { margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 100px; }
                        .signature-box { text-align: center; }
                        .signature-line { border-top: 1px solid #ccc; margin-bottom: 10px; height: 80px; }
                        .signature-label { font-weight: 600; color: #6750a4; font-size: 14px; text-transform: uppercase; }

                        .footer { margin-top: 60px; text-align: center; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="company-info">
                                <h1>BEHAVANA</h1>
                                <p>Collecte et Préparation de Vanille</p>
                                <p>Antalaha, Madagascar</p>
                            </div>
                            <div class="doc-info">
                                <h2>${title}</h2>
                                <div class="doc-meta">
                                    <p>${docLabel}: <strong>${docNumber}</strong></p>
                                    <p>Date: <strong>${formatDate(delivery.date)}</strong></p>
                                </div>
                            </div>
                        </div>

                        <div class="details-grid">
                            <div class="detail-box">
                                <h3>Informations Client</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Client:</span>
                                    <span class="detail-value">${delivery.exporter || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="detail-box">
                                <h3>Détails de l'Opération</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Qualité:</span>
                                    <span class="detail-value">Vanille ${delivery.quality || 'N/A'}</span>
                                </div>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Désignation</th>
                                    <th style="text-align: center; width: 10%;">Sacs</th>
                                    <th style="text-align: right; width: 13%;">P. Brut (kg)</th>
                                    <th style="text-align: right; width: 10%;">Tare (kg)</th>
                                    <th style="text-align: right; width: 13%;">P. Net (kg)</th>
                                    ${isFacture ? '<th style="text-align: right; width: 14%;">Prix (Ar)</th>' : ''}
                                    ${isFacture ? '<th style="text-align: right; width: 15%;">Total (Ar)</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: 500;">Vanille ${delivery.quality || ''}</td>
                                    <td style="text-align: center;">${delivery.bagCount || 1}</td>
                                    <td style="text-align: right;">${(delivery.grossWeight || delivery.weight).toFixed(2)}</td>
                                    <td style="text-align: right;">${(delivery.bagWeight || 0).toFixed(2)}</td>
                                    <td style="text-align: right; font-weight: 600;">${delivery.weight.toFixed(2)}</td>
                                    ${isFacture ? `<td style="text-align: right;">${formatCurrency(delivery.price)}</td>` : ''}
                                    ${isFacture ? `<td style="text-align: right; font-weight: 700; color: #6750a4;">${formatCurrency(delivery.totalValue)}</td>` : ''}
                                </tr>
                            </tbody>
                        </table>

                        <div class="summary-section">
                            <div class="summary-table">
                                <div class="summary-row">
                                    <span class="summary-label">Total Poids Net:</span>
                                    <span class="summary-value">${delivery.weight.toFixed(2)} kg</span>
                                </div>
                                ${isFacture ? `
                                <div class="summary-row total">
                                    <span class="summary-label">NET À PAYER:</span>
                                    <span class="summary-value total-amount">${formatCurrency(delivery.totalValue)} Ar</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="signature-section">
                            <div class="signature-box">
                                <div class="signature-label">Le Responsable</div>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-label">Le Client / Réceptionnaire</div>
                                <div class="signature-line"></div>
                            </div>
                        </div>

                        <div class="footer">
                            <p>Document généré par BEHAVANA le ${new Date().toLocaleString()}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        function generateReceipt(receptionId) {
            const baseReception = appData.receptions.find(r => r.id === receptionId);
            if (!baseReception) {
                alert("Erreur: Impossible de trouver la réception de base.");
                return;
            }
            const receptionDate = baseReception.date;
            const collectorId = baseReception.collectorId;
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Erreur: Impossible de trouver les informations du collecteur.");
                return;
            }
            const dailyReceptions = appData.receptions.filter(r =>
                r.collectorId === collectorId && r.date === receptionDate
            );
            if (dailyReceptions.length === 0) {
                alert("Aucune réception trouvée pour ce collecteur à cette date.");
                return;
            }
            const totalNetWeight = dailyReceptions.reduce((sum, r) => sum + r.netWeight, 0);
            const totalValue = dailyReceptions.reduce((sum, r) => sum + r.totalValue, 0);
            let pdfContent = `
                <html>
                <head>
    <link rel="preconnect" href="https:
    <link rel="preconnect" href="https:
    <link href="https:
                    <title>Reçu - ${collector.name} - ${formatDate(receptionDate)}</title>
                    <style>

    /* Landscape Mode Optimization for Small Screens */
    @media (max-height: 600px) and (orientation: landscape) {
        .header { height: 48px !important; }
        .main-content { padding-top: 55px !important; }
        .sidebar { width: 240px !important; }
        .overview-stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; }
        
        .form-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-card { padding: 8px !important; }
        .stat-icon { width: 32px !important; height: 32px !important; font-size: 18px !important; }
    }

    /* Specific fixes for Redmi Note 8 Pro and similar devices */
    @media (max-width: 450px) {
        .overview-stats { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-value { font-size: 16px !important; }
        .header { padding: 0 10px !important; }
        .global-search-wrapper { margin: 0 5px !important; }
        .data-table td { 
            padding-left: 45% !important; 
            font-size: 11px !important;
            white-space: normal !important;
            word-break: break-word !important;
        }
        .data-table td:before { width: 40% !important; }
        .btn { padding: 8px 12px !important; font-size: 12px !important; }
        .form-group { margin-bottom: 10px !important; }
        input, select, textarea { font-size: 16px !important; } /* Prevent zoom on focus in iOS/Android */
    }
     body{font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;margin:20px;font-size:13px;color:#333;}.receipt-container{border:1px solid #ccc;padding:25px;max-width:700px;margin:auto;background-color:#fff;}.header{text-align:center;margin-bottom:20px;}.company-name{font-size:26px;font-weight:bold;color:#6750a4;}.receipt-title{font-size:18px;font-weight:500;margin:5px 0;text-transform:uppercase;letter-spacing:1px;}.info-section{border-top:1px dashed #ccc;border-bottom:1px dashed #ccc;padding:15px 0;margin-bottom:20px;display:flex;justify-content:space-between;}.info-section div{line-height:1.7;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th, td{padding:8px;text-align:left;border-bottom:1px solid #eee;}th{background-color:#f9f9f9;font-weight:600;}.text-right{text-align:right;}.total-row{background-color:#f5f5f5;font-weight:bold;border-top:2px solid #333;}.footer{margin-top:30px;padding-top:20px;display:flex;justify-content:space-around;}.signature-box{width:40%;border-top:1px solid #333;padding-top:8px;text-align:center;font-size:12px;}
    .form-label {
        color: var(--md-sys-color-on-surface) !important;
        font-weight: 600 !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .form-label {
        color: var(--md-sys-color-on-surface) !important;
        text-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
</style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="header">
                            <div class="company-name">BEHAVANA</div>
                            <div class="receipt-title">Reçu de Réception de Vanille</div>
                        </div>
                        <div class="info-section">
                            <div>
                                <strong>Collecteur:</strong> ${collector.name}  
                                <strong>CIN:</strong> ${collector.cin || 'Non fourni'} ${collector.cinDate ? `(délivré le ${formatDate(collector.cinDate)})` : ''}
                            </div>
                            <div>
                                <strong>Date:</strong> ${formatDate(receptionDate)}  
                                <strong>Reçu N°:</strong> R${new Date(receptionDate).getTime().toString().slice(-5)}${collectorId}
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th style="padding: 8px; text-align: left;">Qualité</th>
                                    <th class="text-right">Poids Net (kg)</th>
                                    <th class="text-right">Prix / kg</th>
                                    <th class="text-right">Valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dailyReceptions.map(reception => `
                                    <tr>
                                        <td>${reception.quality}</td>
                                        <td class="text-right">${reception.netWeight.toFixed(2)}</td>
                                        <td class="text-right">${formatCurrency(reception.price)}</td>
                                        <td class="text-right">${formatCurrency(reception.totalValue)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td><strong>TOTAL</strong></td>
                                    <td class="text-right"><strong>${totalNetWeight.toFixed(2)} kg</strong></td>
                                    <td></td>
                                    <td class="text-right"><strong>${formatCurrency(totalValue)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="footer">
                            <div class="signature-box">
                                Signature du Collecteur
                            </div>
                            <div class="signature-box">
                                Signature (BEHAVANA)
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        function exportAnalysis() {
            let pdfContent = `
                <html>
                <head>
    <link rel="preconnect" href="https:
    <link rel="preconnect" href="https:
    <link href="https:
                    <title>Analyse des Collecteurs - BEHAVANA</title>
                    <style>

    /* Landscape Mode Optimization for Small Screens */
    @media (max-height: 600px) and (orientation: landscape) {
        .header { height: 48px !important; }
        .main-content { padding-top: 55px !important; }
        .sidebar { width: 240px !important; }
        .overview-stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; }
        
        .form-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-card { padding: 8px !important; }
        .stat-icon { width: 32px !important; height: 32px !important; font-size: 18px !important; }
    }

    /* Specific fixes for Redmi Note 8 Pro and similar devices */
    @media (max-width: 450px) {
        .overview-stats { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-value { font-size: 16px !important; }
        .header { padding: 0 10px !important; }
        .global-search-wrapper { margin: 0 5px !important; }
        .data-table td { 
            padding-left: 45% !important; 
            font-size: 11px !important;
            white-space: normal !important;
            word-break: break-word !important;
        }
        .data-table td:before { width: 40% !important; }
        .btn { padding: 8px 12px !important; font-size: 12px !important; }
        .form-group { margin-bottom: 10px !important; }
        input, select, textarea { font-size: 16px !important; } /* Prevent zoom on focus in iOS/Android */
    }
     body{font-family:Arial, sans-serif;margin:20px;font-size:10px;}.header{text-align:center;margin-bottom:30px;}.company-name{font-size:24px;font-weight:bold;color:#6750a4;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th, td{border:1px solid #ddd;padding:6px;text-align:left;}th{background-color:#f2f2f2;font-weight:bold;}.status-debiteur{color:#ba1a1a;font-weight:bold;}.status-crediteur{color:#2e7d32;font-weight:bold;}.status-equilibre{color:#625b71;}.amount{text-align:right;}.total-row{background-color:#e8def8;font-weight:bold;}.total-row td{border-top:2px solid #6750a4;}
    .form-label {
        color: var(--md-sys-color-on-surface) !important;
        font-weight: 600 !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .form-label {
        color: var(--md-sys-color-on-surface) !important;
        text-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
</style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Rapport d'Analyse des Comptes - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Collecteur</th>
                                <th>Téléphone</th>
                                <!-- === FANITSARANA ETO === -->
                                <th class="amount">Total Débits (Avances + Paiements)</th>
                                <th class="amount">Total Crédits (Livraisons + Remboursements)</th>
                                <!-- ======================= -->
                                <th class="amount">Solde</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            let totalDebiteur = 0;
            let totalCrediteur = 0;
            appData.collectors.forEach(collector => {
                const totalAdvances = getTotalAdvances(collector.id);
                const totalPaiements = getPaiementsForCurrentYear()
                    .filter(p => p.collectorId === collector.id)
                    .reduce((sum, p) => sum + p.amount, 0);
                const totalDebits = totalAdvances + totalPaiements;
                const totalDeliveries = getTotalDeliveries(collector.id);
                const totalRemboursements = getRemboursementsForCurrentYear()
                    .filter(rem => rem.collectorId === collector.id)
                    .reduce((sum, rem) => sum + rem.amount, 0);
                const totalCredits = totalDeliveries + totalRemboursements;
                const balance = totalCredits - totalDebits;
                const status = getCollectorStatus(balance);
                if (balance < 0) {
                    totalDebiteur += balance;
                } else if (balance > 0) {
                    totalCrediteur += balance;
                }
                pdfContent += `
                    <tr>
                        <td>${collector.name}</td>
                        <td>${formatPhoneNumberForDisplay(collector.phone)}</td>
                        <td class="amount">${formatCurrency(totalDebits)}</td>
                        <td class="amount">${formatCurrency(totalCredits)}</td>
                        <td class="amount">${formatCurrency(balance)}</td>
                        <td class="status-${status.class}">${status.label}</td>
                    </tr>
                `;
            });
            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" class="amount">TOTAL SOLDE NON RÉCUPÉRÉ (Dettes Collecteurs) :</td>
                                <td class="amount status-debiteur">${formatCurrency(totalDebiteur)}</td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4" class="amount">TOTAL CRÉDIT (Dû aux Collecteurs) :</td>
                                <td class="amount status-crediteur">${formatCurrency(totalCrediteur)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        function exportPoidsAnalysis() {
            const toutesLesQualites = [...new Set(receptionsYear.map(r => r.quality))].sort();
            let pdfContent = `
                <html>
                <head>
    <link rel="preconnect" href="https:
    <link rel="preconnect" href="https:
    <link href="https:
                    <title>Analyse des Poids Livrés - BEHAVANA</title>
                    <style>

    /* Landscape Mode Optimization for Small Screens */
    @media (max-height: 600px) and (orientation: landscape) {
        .header { height: 48px !important; }
        .main-content { padding-top: 55px !important; }
        .sidebar { width: 240px !important; }
        .overview-stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; }
        
        .form-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-card { padding: 8px !important; }
        .stat-icon { width: 32px !important; height: 32px !important; font-size: 18px !important; }
    }

    /* Specific fixes for Redmi Note 8 Pro and similar devices */
    @media (max-width: 450px) {
        .overview-stats { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-value { font-size: 16px !important; }
        .header { padding: 0 10px !important; }
        .global-search-wrapper { margin: 0 5px !important; }
        .data-table td { 
            padding-left: 45% !important; 
            font-size: 11px !important;
            white-space: normal !important;
            word-break: break-word !important;
        }
        .data-table td:before { width: 40% !important; }
        .btn { padding: 8px 12px !important; font-size: 12px !important; }
        .form-group { margin-bottom: 10px !important; }
        input, select, textarea { font-size: 16px !important; } /* Prevent zoom on focus in iOS/Android */
    }
     body{font-family:Arial, sans-serif;margin:20px;font-size:10px;}.header{text-align:center;margin-bottom:30px;}.company-name{font-size:24px;font-weight:bold;color:#6750a4;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th, td{border:1px solid #ddd;padding:6px;text-align:right;}th{background-color:#f2f2f2;font-weight:bold;text-align:center;}td.collector-name{text-align:left;font-weight:bold;}.total-col{background-color:#e8def8;font-weight:bold;}.total-row th, .total-row td{border-top:2px solid #6750a4;background-color:#e8def8;font-weight:bold;}
    .form-label {
        color: var(--md-sys-color-on-surface) !important;
        font-weight: 600 !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .form-label {
        color: var(--md-sys-color-on-surface) !important;
        text-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
</style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Analyse des Poids Livrés par Collecteur - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left;">Collecteur</th>
                                ${toutesLesQualites.map(q => `<th>${q} (kg)</th>`).join('')}
                                <th class="total-col">TOTAL LIVRÉ (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            const totalParQualite = {};
            toutesLesQualites.forEach(q => totalParQualite[q] = 0);
            let grandTotalPoids = 0;
            appData.collectors.forEach(collector => {
                let totalPoidsParCollecteur = 0;
                pdfContent += `<tr><td class="collector-name">${collector.name}</td>`;
                toutesLesQualites.forEach(qualite => {
                    const poids = appData.receptions
                        .filter(r => r.collectorId === collector.id && r.quality === qualite)
                        .reduce((sum, r) => sum + r.netWeight, 0);
                    pdfContent += `<td>${poids > 0 ? formatNumber(poids) : '-'}</td>`;
                    totalPoidsParCollecteur += poids;
                    totalParQualite[qualite] += poids;
                });
                pdfContent += `<td class="total-col">${formatNumber(totalPoidsParCollecteur)}</td></tr>`;
                grandTotalPoids += totalPoidsParCollecteur;
            });
            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <th style="text-align: left;">TOTAL GÉNÉRAL</th>
                                <!-- === FANITSARANA ETO === -->
                                ${toutesLesQualites.map(q => `<td>${formatNumber(totalParQualite[q])}</td>`).join('')}
                                <td class="total-col">${formatNumber(grandTotalPoids)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        function quickAdd() {
            const activeSection = document.querySelector('.content-section.active').id;
            switch (activeSection) {
                case 'collectors':
                    openCollectorModal();
                    break;
                case 'advances':
                    openAdvanceModal();
                    break;
                case 'reception':
                    openReceptionModal();
                    break;
                case 'delivery':
                    openDeliveryModal();
                    break;
                default:
                    openCollectorModal();
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            ['advance-filter-collector'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateAdvancesTable);
                }
            });
            const analysisFilter = document.getElementById('analysis-filter-collector');
            if (analysisFilter) {
                analysisFilter.addEventListener('change', updateAnalysisTable);
            }
            initTableSorting();
            const observer = new MutationObserver((mutations) => {
                let shouldUpdate = false;
                for (const mutation of mutations) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        shouldUpdate = true;
                        break;
                    }
                }
                if (shouldUpdate) {
                    setDataLabels();
                }
            });
            document.querySelectorAll('tbody').forEach(tbody => {
                observer.observe(tbody, { childList: true });
            });
            loadData();
        });
        function initTableSorting() {
            const allHeaders = document.querySelectorAll("th");
            const parseDate = (dateStr) => {
                const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (!parts) return null;
                return new Date(parts[3], parts[2] - 1, parts[1]);
            };
            allHeaders.forEach((th) => {
                if (th.dataset.sortInitialized) {
                    return;
                }
                th.dataset.sortInitialized = true;
                th.addEventListener("click", () => {
                    const table = th.closest("table");
                    if (!table) return;
                    const realColumnIndex = Array.from(th.parentNode.children).indexOf(th);
                    const tbody = table.querySelector("tbody");
                    if (!tbody) return;
                    const rows = Array.from(tbody.querySelectorAll("tr:not(:has(.empty-state))"));
                    if (rows.length === 0) return;
                    const direction = th.classList.contains("asc") ? 'desc' : 'asc';
                    rows.sort((a, b) => {
                        const cellA = a.children[realColumnIndex].innerText.trim();
                        const cellB = b.children[realColumnIndex].innerText.trim();
                        const dateA = parseDate(cellA);
                        const dateB = parseDate(cellB);
                        let comparison = 0;
                        if (dateA && dateB) {
                            comparison = dateA.getTime() - dateB.getTime();
                        } else {
                            const numA = parseFloat(cellA.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                            const numB = parseFloat(cellB.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                            if (!isNaN(numA) && !isNaN(numB)) {
                                comparison = numA - numB;
                            } else {
                                comparison = cellA.localeCompare(cellB, 'fr', { sensitivity: 'base' });
                            }
                        }
                        return direction === 'asc' ? comparison : -comparison;
                    });
                    th.parentElement.querySelectorAll("th").forEach(otherTh => {
                        otherTh.classList.remove("asc", "desc");
                    });
                    th.classList.add(direction);
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }
        function setDataLabels() {
            document.querySelectorAll('.data-table').forEach(table => {
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
                table.querySelectorAll('tbody tr').forEach(row => {
                    if (row.querySelector('.empty-state')) return;
                    row.querySelectorAll('td').forEach((td, index) => {
                        if (headers[index]) {
                            td.setAttribute('data-label', headers[index] + ': ');
                        }
                    });
                });
            });
        }
        function setDateFilter(period) {
            const today = new Date();
            const startInput = document.getElementById('advance-filter-start');
            const endInput = document.getElementById('advance-filter-end');
            let startDate, endDate;
            switch (period) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + 1);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    startDate = startOfWeek;
                    endDate = endOfWeek;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                default:
                    return;
            }
            startInput.value = startDate.toISOString().split('T')[0];
            endInput.value = endDate.toISOString().split('T')[0];
            updateAdvancesTable();
        }
        function clearDateFilter() {
            document.getElementById('advance-filter-start').value = '';
            document.getElementById('advance-filter-end').value = '';
            updateAdvancesTable();
        }
        function filterAdvancesByDate() {
            updateAdvancesTable();
        }
        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }
        document.addEventListener('click', function (e) {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            if (window.innerWidth <= 768 && sidebar.classList.contains('mobile-open')) {
                if (!sidebar.contains(e.target) && mainContent.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });
        function showCollectorDetails(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Tsy hita ny Collecteur!");
                return;
            }
            const advances = getAdvancesForCurrentYear()
                .filter(a => a.collectorId === collectorId);

            const receptions = getReceptionsForCurrentYear()
                .filter(r => r.collectorId === collectorId);

            const remboursements = getRemboursementsForCurrentYear()
                .filter(rem => rem.collectorId === collectorId);

            const paiements = getPaiementsForCurrentYear()
                .filter(p => p.collectorId === collectorId);

            const totalAdvances = advances.reduce((sum, a) => sum + a.amount, 0);
            const totalDeliveries = receptions.reduce((sum, r) => sum + r.totalValue, 0);
            const totalRemboursements = remboursements.reduce((sum, rem) => sum + rem.amount, 0);
            const totalPaiements = paiements.reduce((sum, p) => sum + p.amount, 0);
            const balance = calculateCollectorBalance(collectorId);
            const status = getCollectorStatus(balance);
            const modalContent = `
                <div class="modal-header">
                    <h3 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                        <span class="material-icons" style="color: var(--md-sys-color-primary);">person</span>
                        Détails - ${collector.name}
                    </h3>
                    <button class="close-btn" onclick="closeModal('collector-details-modal')">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 15px;">
                    <!-- Fizarana misy an'ireo ICONS efa naverina -->
                    <div style="background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container)); padding: 24px; border-radius: 16px; margin-bottom: 24px; color: var(--md-sys-color-on-primary-container);">
                        <h4 style="margin-bottom: 16px; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">account_circle</span>
                            Informations du Collecteur
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">phone</span>
                                    Téléphone
                                </div>
                                <div style="font-weight: 500;">${collector.phone || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">fingerprint</span>
                                    CIN
                                </div>
                                <div style="font-weight: 500;">
                                    ${collector.cin || 'N/A'}
                                    ${collector.cinDate ? `<small style="opacity: 0.8;">(délivré le ${formatDate(collector.cinDate)})</small>` : ''}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">calendar_today</span>
                                    Inscription
                                </div>
                                <div style="font-weight: 500;">${formatDate(collector.createdAt)}</div>
                            </div>
                        </div>
                    </div>
                    <!-- Fizarana Financial Summary (tsy miova) -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(totalAdvances)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Total Avances</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">(Année ${currentYear})</div>
                        </div>
                        <div style="background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(totalDeliveries)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Total Livraisons</div>
                            <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">(Année ${currentYear})</div>
                        </div>
                        <div style="background: ${balance >= 0 ? 'var(--md-sys-color-success-container)' : 'var(--md-sys-color-error-container)'}; color: ${balance >= 0 ? 'var(--md-sys-color-on-success-container)' : 'var(--md-sys-color-on-error-container)'}; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(Math.abs(balance))}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Solde ${currentYear}</div>
                            <div style="font-size: 12px; margin-top: 4px; font-weight: 500;">${status.label}</div>
                        </div>

                        <!-- NOUVELLE CARTE : Solde Global -->
                        ${(() => {
                            const globalBalance = calculateCollectorBalanceGlobal(collectorId);
                            const globalStatus = getCollectorStatus(globalBalance);
                            return `
                            <div style="background: ${globalBalance >= 0 ? 'var(--md-sys-color-primary-container)' : 'var(--md-sys-color-error-container)'}; color: ${globalBalance >= 0 ? 'var(--md-sys-color-on-primary-container)' : 'var(--md-sys-color-on-error-container)'}; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid var(--md-sys-color-primary);">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(Math.abs(globalBalance))}</div>
                                <div style="font-size: 14px; opacity: 0.8;">Dette Totale</div>
                                <div style="font-size: 11px; margin-top: 4px; opacity: 0.7;">(Toutes années)</div>
                                <div style="font-size: 12px; margin-top: 4px; font-weight: 500;">${globalStatus.label}</div>
                            </div>
                            `;
                        })()}

                    </div>
                    <!-- Transaction History Tabs (efa ahitsy ny filaharana) -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; border-bottom: 2px solid var(--md-sys-color-outline-variant); margin-bottom: 16px; flex-wrap: wrap;">
                            <button class="detail-tab-btn active" onclick="switchDetailTab(event, 'advances-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-primary); font-weight: 500; border-bottom: 2px solid var(--md-sys-color-primary); cursor: pointer;">💰 Avances (${advances.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'receptions-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); opacity: 0.7; font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">📦 Livraisons (${receptions.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'remboursements-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); opacity: 0.7; font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">💵 Remboursements (${remboursements.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'paiements-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); opacity: 0.7; font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">💸 Paiements (${paiements.length})</button>
                        </div>
                        <!-- Onglet Avances -->
                        <div id="advances-tab" class="detail-tab-content" style="display: block;">
                            ${advances.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Motif</th><th style="padding: 8px; text-align: right;">Montant</th></tr></thead>
                                    <tbody>
                                        ${advances.sort((a, b) => new Date(a.date) - new Date(b.date)).map(advance => `
                                            <tr><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${formatDate(advance.date)}</td><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${advance.motif || ''}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(advance.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><td colspan="2" style="padding: 8px;">TOTAL</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(totalAdvances)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface); opacity: 0.6;">Aucune avance</div>`}
                        </div>
                        <!-- Onglet Livraisons (Réceptions) -->
                        <div id="receptions-tab" class="detail-tab-content" style="display: none;">
                            ${receptions.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: right;">Poids</th><th style="padding: 8px; text-align: left;">Qualité</th><th style="padding: 8px; text-align: right;">Prix/kg</th><th style="padding: 8px; text-align: right;">Valeur</th></tr></thead>
                                    <tbody>
                                        ${receptions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(reception => `
                                            <tr><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${formatDate(reception.date)}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${reception.netWeight.toFixed(2)} kg</td><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${reception.quality}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(reception.price)}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(reception.totalValue)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><td colspan="4" style="padding: 8px;">TOTAL</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(totalDeliveries)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface); opacity: 0.6;">Aucune livraison</div>`}
                        </div>
                        <!-- Onglet Remboursements -->
                        <div id="remboursements-tab" class="detail-tab-content" style="display: none;">
                            ${remboursements.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Note</th><th style="padding: 8px; text-align: right;">Montant</th></tr></thead>
                                    <tbody>
                                        ${remboursements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(rem => `
                                            <tr><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${formatDate(rem.date)}</td><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${rem.note || ''}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(rem.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><td colspan="2" style="padding: 8px;">TOTAL REMBOURSÉ</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(totalRemboursements)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface); opacity: 0.6;">Aucun remboursement</div>`}
                        </div>
                        <!-- Onglet Paiements -->
                        <div id="paiements-tab" class="detail-tab-content" style="display: none;">
                            ${paiements.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Note</th><th style="padding: 8px; text-align: right;">Montant Payé</th></tr></thead>
                                    <tbody>
                                        ${paiements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(p => `
                                            <tr><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${formatDate(p.date)}</td><td style="padding: 8px; color: var(--md-sys-color-on-surface);">${p.note || ''}</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(p.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><td colspan="2" style="padding: 8px;">TOTAL PAYÉ</td><td style="padding: 8px; text-align: right; color: var(--md-sys-color-on-surface);">${formatCurrency(totalPaiements)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px; color: var(--md-sys-color-on-surface); opacity: 0.6;">Aucun paiement de solde enregistré.</div>`}
                        </div>
                    </div>
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 20px;">
                        <button class="btn btn-outline" onclick="exportCollectorReport(${collectorId})" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">picture_as_pdf</span>
                            Export PDF
                        </button>
                        <button class="btn btn-success" onclick="exportCollectorDetailsToExcel(${collectorId})" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">table_view</span>
                            Export Excel
                        </button>
                        <button class="btn btn-primary" onclick="closeModal('collector-details-modal')">Fermer</button>
                    </div>
                </div>
            `;
            let detailsModal = document.getElementById('collector-details-modal');
            if (!detailsModal) {
                detailsModal = document.createElement('div');
                detailsModal.className = 'modal';
                detailsModal.id = 'collector-details-modal';
                document.body.appendChild(detailsModal);
            }
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; width: 95%; max-height: 90vh;">
                    ${modalContent}
                </div>
            `;
            openModal('collector-details-modal');
        }
        function switchDetailTab(event, tabId) {
            const parent = event.target.parentElement;
            parent.querySelectorAll('.detail-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = 'var(--md-sys-color-on-surface)';
            });
            parent.parentElement.querySelectorAll('.detail-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
            event.target.style.borderBottomColor = 'var(--md-sys-color-primary)';
            event.target.style.color = 'var(--md-sys-color-primary)';
        }
        function exportCollectorReport(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) return;
            const advances = appData.advances.filter(a => a.collectorId === collectorId);
            const receptions = appData.receptions.filter(r => r.collectorId === collectorId);
            const remboursements = (appData.remboursements || []).filter(rem => rem.collectorId === collectorId);
            const paiements = (appData.paiements || []).filter(p => p.collectorId === collectorId);
            const totalAdvances = advances.reduce((sum, a) => sum + a.amount, 0);
            const totalDeliveries = receptions.reduce((sum, r) => sum + r.totalValue, 0);
            const totalRemboursements = remboursements.reduce((sum, rem) => sum + rem.amount, 0);
            const totalPaiements = paiements.reduce((sum, p) => sum + p.amount, 0);
            const totalCredits = totalDeliveries + totalRemboursements;
            const totalDebits = totalAdvances + totalPaiements;
            const balance = totalCredits - totalDebits;
            const status = getCollectorStatus(balance);
            let pdfContent = `
                <html>
                <head>
    <link rel="preconnect" href="https:
    <link rel="preconnect" href="https:
    <link href="https:
                    <title>Rapport Détaillé - ${collector.name}</title>
                    <style>

    /* Landscape Mode Optimization for Small Screens */
    @media (max-height: 600px) and (orientation: landscape) {
        .header { height: 48px !important; }
        .main-content { padding-top: 55px !important; }
        .sidebar { width: 240px !important; }
        .overview-stats { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)) !important; }
        .modal-content { 
            max-height: 98vh !important; 
            overflow-y: auto !important;
            margin: 5px auto !important;
            padding: 10px !important;
        }
        .form-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-card { padding: 8px !important; }
        .stat-icon { width: 32px !important; height: 32px !important; font-size: 18px !important; }
    }

    /* Specific fixes for Redmi Note 8 Pro and similar devices */
    @media (max-width: 450px) {
        .overview-stats { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
        .stat-value { font-size: 16px !important; }
        .header { padding: 0 10px !important; }
        .global-search-wrapper { margin: 0 5px !important; }
        .data-table td { 
            padding-left: 45% !important; 
            font-size: 11px !important;
            white-space: normal !important;
            word-break: break-word !important;
        }
        .data-table td:before { width: 40% !important; }
        .btn { padding: 8px 12px !important; font-size: 12px !important; }
        .form-group { margin-bottom: 10px !important; }
        input, select, textarea { font-size: 16px !important; } /* Prevent zoom on focus in iOS/Android */
    }
     body{font-family:Arial, sans-serif;margin:20px;color:#333;font-size:12px;}.header{text-align:center;margin-bottom:20px;border-bottom:2px solid #6750a4;padding-bottom:15px;}.company-name{font-size:24px;font-weight:bold;color:#6750a4;}.report-title{font-size:18px;color:#666;}.collector-info{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;}.summary-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px;text-align:center;}.summary-card{border:1px solid #ddd;border-radius:8px;padding:10px;}.summary-value{font-size:18px;font-weight:bold;}.summary-label{font-size:11px;color:#666;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th, td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f2f2f2;font-weight:bold;}.section-title{font-size:16px;font-weight:bold;color:#333;margin:25px 0 10px 0;border-bottom:1px solid #ccc;padding-bottom:5px;}.total-row{background-color:#f8f9fa;font-weight:bold;}.amount-positive{color:#2e7d32;}.amount-negative{color:#ba1a1a;} 
    .form-label {
        color: var(--md-sys-color-on-surface) !important;
        font-weight: 600 !important;
        opacity: 1 !important;
    }
    [data-theme="dark"] .form-label {
        color: var(--md-sys-color-on-surface) !important;
        text-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    
</style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div class="report-title">Rapport Détaillé du Collecteur</div>
                    </div>
                    <div class="collector-info">
                        <strong>Collecteur:</strong> ${collector.name}  
                        <strong>CIN:</strong> ${collector.cin || 'N/A'} ${collector.cinDate ? `(délivré le ${formatDate(collector.cinDate)})` : ''}
                    </div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-value amount-negative">${formatCurrency(totalDebits)}</div>
                            <div class="summary-label">Total Débits (Avances + Paiements)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value amount-positive">${formatCurrency(totalCredits)}</div>
                            <div class="summary-label">Total Crédits (Livr. + Remb.)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${formatCurrency(Math.abs(balance))}</div>
                            <div class="summary-label">Solde Actuel (${status.label})</div>
                        </div>
                    </div>
                    <div class="section-title">💰 Historique des Avances</div>
                    ${advances.length > 0 ? `
                        <table>
                            <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Motif</th><th style="padding: 8px; text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${advances.sort((a, b) => new Date(a.date) - new Date(b.date)).map(advance => `
                                    <tr><td>${formatDate(advance.date)}</td><td>${advance.motif || ''}</td><td style="text-align: right;">${formatCurrency(advance.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL AVANCES</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalAdvances)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucune avance enregistrée.</p>'}
                    <div class="section-title">📦 Historique des Livraisons</div>
                    ${receptions.length > 0 ? `
                        <table>
                            <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="text-align: right;">Poids Net</th><th style="padding: 8px; text-align: left;">Qualité</th><th style="padding: 8px; text-align: right;">Valeur</th></tr></thead>
                            <tbody>
                                ${receptions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(reception => `
                                    <tr><td>${formatDate(reception.date)}</td><td style="text-align: right;">${reception.netWeight.toFixed(2)} kg</td><td>${reception.quality}</td><td style="text-align: right;">${formatCurrency(reception.totalValue)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="3"><strong>TOTAL LIVRAISONS</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalDeliveries)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucune livraison enregistrée.</p>'}
                    <div class="section-title">💵 Historique des Remboursements</div>
                    ${remboursements.length > 0 ? `
                        <table>
                            <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Note</th><th style="padding: 8px; text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${remboursements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(rem => `
                                    <tr><td>${formatDate(rem.date)}</td><td>${rem.note || ''}</td><td style="text-align: right;">${formatCurrency(rem.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL REMBOURSÉ</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalRemboursements)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucun remboursement enregistré.</p>'}
                    <!-- === LISITRY NY PAIEMENTS (VAOVAO) === -->
                    <div class="section-title">💸 Historique des Paiements de Solde</div>
                    ${paiements.length > 0 ? `
                        <table>
                            <thead style="background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant);"><tr><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Note</th><th style="padding: 8px; text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${paiements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(p => `
                                    <tr><td>${formatDate(p.date)}</td><td>${p.note || ''}</td><td style="text-align: right;">${formatCurrency(p.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL PAYÉ</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalPaiements)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucun paiement de solde enregistré.</p>'}
                </body>
                </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }
        function formatCIN(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 12);
            let parts = [];
            for (let i = 0; i < value.length; i += 3) {
                parts.push(value.substring(i, i + 3));
            }
            input.value = parts.join(' ');
        }
        function capitalizeLive(input) {
            if (!input || !input.value) return;
            const cursorPosition = input.selectionStart;
            input.value = input.value
                .toLowerCase()
                .replace(/\b\w/g, c => c.toUpperCase());
            input.setSelectionRange(cursorPosition, cursorPosition);
        }
        function debounce(func, delay = 300) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        const paginationState = {
            collectors: { currentPage: 1, rowsPerPage: 50 },
            advances: { currentPage: 1, rowsPerPage: 50 },
            receptions: { currentPage: 1, rowsPerPage: 50 },
            deliveries: { currentPage: 1, rowsPerPage: 50 },
            analysis: { currentPage: 1, rowsPerPage: 50 },
            expenses: { currentPage: 1, rowsPerPage: 50 },
            remboursements: { currentPage: 1, rowsPerPage: 50 },
            paiements: { currentPage: 1, rowsPerPage: 50 }
        };
        function getPaginatedData(dataArray, tableName) {
            const state = paginationState[tableName];
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            return dataArray.slice(startIndex, endIndex);
        }
        function createPaginationControls(tableName, totalItems) {
            const state = paginationState[tableName];
            const totalPages = Math.ceil(totalItems / state.rowsPerPage);
            if (totalPages <= 1) return '';
            return `
                <div style="display: flex; justify-content: center; align-items: center; gap: 16px; padding: 16px; border-top: 1px solid var(--md-sys-color-outline-variant);">
                    <button class="btn btn-icon btn-outline" onclick="changePage('${tableName}', ${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''}>
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span style="font-size: 14px; color: var(--md-sys-color-on-surface);">
                        Page ${state.currentPage} / ${totalPages} (${totalItems} lignes)
                    </span>
                    <button class="btn btn-icon btn-outline" onclick="changePage('${tableName}', ${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''}>
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
            `;
        }
        function changePage(tableName, newPage) {
            const state = paginationState[tableName];
            const dataArray = getDataArrayForTable(tableName);
            const totalPages = Math.ceil(dataArray.length / state.rowsPerPage);
            if (newPage < 1 || newPage > totalPages) return;
            state.currentPage = newPage;
            const updateFunctions = {
                'collectors': updateCollectorsTable,
                'advances': updateAdvancesTable,
                'receptions': updateReceptionTable,
                'deliveries': updateDeliveryTable,
                'analysis': updateAnalysisTable,
                'expenses': updateExpensesTable,
                'remboursements': updateRemboursementsTable,
                'paiements': updatePaiementsTable
            };
            if (updateFunctions[tableName]) {
                updateFunctions[tableName]();
            }
        }
        function getDataArrayForTable(tableName) {
            switch (tableName) {
                case 'collectors': return appData.collectors || [];
                case 'advances': return filterAdvances();
                case 'receptions': return getReceptionsForCurrentYear();
                case 'deliveries': return getDeliveriesForCurrentYear();
                case 'analysis': return appData.collectors || [];
                case 'expenses': return getExpensesForCurrentYear();
                case 'remboursements': return getRemboursementsForCurrentYear();
                case 'paiements': return getPaiementsForCurrentYear();
                default: return [];
            }
        }
        function globalSearch() {
            const query = document.getElementById("global-search-input").value.toLowerCase();
            if (query.length === 0) {
                updateCurrentActiveTable();
                return;
            }
            if (query.length < 2) return;
            const activeSection = document.querySelector('.content-section.active');
            if (!activeSection) return;
            const sectionId = activeSection.id;
            searchInAllData(sectionId, query);
        }
        function searchInAllData(sectionId, query) {
            let filteredData = [];
            let tableName = '';
            switch (sectionId) {
                case 'collectors':
                    tableName = 'collectors';
                    filteredData = appData.collectors.filter(item => {
                        const searchStr = `${item.name} ${item.phone} ${item.cin || ''} ${item.address || ''}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'advances':
                    tableName = 'advances';
                    const allAdvances = filterAdvances();
                    filteredData = allAdvances.filter(item => {
                        const collector = appData.collectors.find(c => c.id === item.collectorId);
                        const searchStr = `${formatDate(item.date)} ${collector ? collector.name : ''} ${item.motif || ''}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'receptions':
                case 'reception':
                    tableName = 'receptions';
                    filteredData = getReceptionsForCurrentYear().filter(item => {
                        const collector = appData.collectors.find(c => c.id === item.collectorId);
                        const searchStr = `${formatDate(item.date)} ${collector ? collector.name : ''} ${item.quality}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'delivery':
                    tableName = 'deliveries';
                    filteredData = getDeliveriesForCurrentYear().filter(item => {
                        const searchStr = `${formatDate(item.date)} ${item.invoice} ${item.quality} ${item.exporter}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'analysis':
                    tableName = 'analysis';
                    filteredData = appData.collectors.filter(item => {
                        const searchStr = item.name.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'expenses':
                    tableName = 'expenses';
                    filteredData = (appData.expenses || []).filter(item => {
                        const searchStr = `${formatDate(item.date)} ${item.category} ${item.description}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'remboursements':
                    tableName = 'remboursements';
                    filteredData = getRemboursementsForCurrentYear().filter(item => {
                        const collector = appData.collectors.find(c => c.id === item.collectorId);
                        const searchStr = `${formatDate(item.date)} ${collector ? collector.name : ''} ${item.note}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                case 'paiements':
                    tableName = 'paiements';
                    filteredData = getPaiementsForCurrentYear().filter(item => {
                        const collector = appData.collectors.find(c => c.id === item.collectorId);
                        const searchStr = `${formatDate(item.date)} ${collector ? collector.name : ''} ${item.note}`.toLowerCase();
                        return searchStr.includes(query);
                    });
                    break;
                default:
                    return;
            }
            displaySearchResults(sectionId, tableName, filteredData, query);
        }
        function displaySearchResults(sectionId, tableName, filteredData, query) {
            const activeTable = document.querySelector('.content-section.active table');
            if (!activeTable) return;
            const tbody = activeTable.querySelector('tbody');
            const tableWrapper = activeTable.closest('.data-table');
            if (!tbody) return;
            
            // ✅ NOUVEAU: Calculer les résumés
            const summary = calculateSearchSummary(sectionId, filteredData);
            
            const paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (paginationDiv) {
                paginationDiv.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px; padding: 16px; border-top: 1px solid var(--md-sys-color-outline-variant); background-color: var(--md-sys-color-primary-container);">
                        <div style="display: flex; justify-content: center; align-items: center; gap: 16px;">
                            <span class="material-icons" style="color: var(--md-sys-color-on-primary-container);">search</span>
                            <span style="font-size: 14px; color: var(--md-sys-color-on-primary-container); font-weight: 500;">
                                ${filteredData.length} résultat${filteredData.length > 1 ? 's' : ''} trouvé${filteredData.length > 1 ? 's' : ''} pour "${query}"
                            </span>
                            <button class="btn btn-outline" onclick="clearSearch()" style="margin-left: auto;">
                                <span class="material-icons">close</span>
                                Effacer la recherche
                            </button>
                        </div>
                        ${summary ? `<div style="background: var(--md-sys-color-surface); padding: 12px; border-radius: 8px; color: var(--md-sys-color-on-surface);">${summary}</div>` : ''}
                    </div>
                `;
            }
            
            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                const colspan = activeTable.querySelectorAll('thead th').length;
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="empty-state">
                            <div class="material-icons">search_off</div>
                            <div>Aucun résultat trouvé pour "${query}"</div>
                        </td>
                    </tr>
                `;
                return;
            }
            renderTableRows(sectionId, tableName, filteredData, tbody);
        }

        function calculateSearchSummary(sectionId, data) {
            if (!data || data.length === 0) return '';
            
            switch (sectionId) {
                case 'advances':
                    // Calculer le total des avances
                    const totalAdvances = data.reduce((sum, a) => sum + a.amount, 0);
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                            <span class="material-icons" style="color: var(--md-sys-color-primary);">account_balance_wallet</span>
                            <strong>Montant Total:</strong>
                            <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-primary);">${formatCurrency(totalAdvances)}</span>
                        </div>
                    `;
                    
                case 'receptions':
                case 'reception':
                    // Calculer poids et valeur par qualité
                    const byQuality = {};
                    let totalWeight = 0;
                    let totalValue = 0;
                    
                    data.forEach(r => {
                        if (!byQuality[r.quality]) {
                            byQuality[r.quality] = { weight: 0, value: 0 };
                        }
                        byQuality[r.quality].weight += r.netWeight;
                        byQuality[r.quality].value += r.totalValue;
                        totalWeight += r.netWeight;
                        totalValue += r.totalValue;
                    });
                    
                    const qualitiesSummary = Object.entries(byQuality)
                        .map(([quality, stats]) => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--md-sys-color-surface-variant); border-radius: 6px;">
                                <span class="status-badge status-${quality.toLowerCase()}">${quality}</span>
                                <strong>${stats.weight.toFixed(2)} kg</strong>
                                <span style="opacity: 0.7;">•</span>
                                <span>${formatCurrency(stats.value)}</span>
                            </div>
                        `).join('');
                    
                    return `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                ${qualitiesSummary}
                            </div>
                            <div style="display: flex; gap: 24px; justify-content: center; padding-top: 8px; border-top: 1px solid var(--md-sys-color-outline-variant);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="color: var(--md-sys-color-tertiary);">scale</span>
                                    <strong>Total:</strong>
                                    <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-tertiary);">${totalWeight.toFixed(2)} kg</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="color: var(--md-sys-color-primary);">payments</span>
                                    <strong>Valeur:</strong>
                                    <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-primary);">${formatCurrency(totalValue)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                case 'delivery':
                    // Calculer poids et valeur totale des livraisons
                    const totalDeliveryWeight = data.reduce((sum, d) => sum + d.weight, 0);
                    const totalDeliveryValue = data.reduce((sum, d) => sum + d.totalValue, 0);
                    
                    return `
                        <div style="display: flex; gap: 24px; justify-content: center; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" style="color: var(--md-sys-color-tertiary);">local_shipping</span>
                                <strong>Poids Total:</strong>
                                <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-tertiary);">${totalDeliveryWeight.toFixed(2)} kg</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" style="color: var(--md-sys-color-primary);">payments</span>
                                <strong>Valeur Totale:</strong>
                                <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-primary);">${formatCurrency(totalDeliveryValue)}</span>
                            </div>
                        </div>
                    `;
                    
                case 'remboursements':
                    // Total des remboursements
                    const totalRembours = data.reduce((sum, r) => sum + r.amount, 0);
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                            <span class="material-icons" style="color: var(--md-sys-color-success);">paid</span>
                            <strong>Total Remboursé:</strong>
                            <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-success);">${formatCurrency(totalRembours)}</span>
                        </div>
                    `;
                    
                case 'paiements':
                    // Total des paiements
                    const totalPaiements = data.reduce((sum, p) => sum + p.amount, 0);
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                            <span class="material-icons" style="color: var(--md-sys-color-primary);">payments</span>
                            <strong>Total Payé:</strong>
                            <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-primary);">${formatCurrency(totalPaiements)}</span>
                        </div>
                    `;
                    
                case 'expenses':
                    // Total des dépenses
                    const totalExpenses = data.reduce((sum, e) => sum + e.amount, 0);
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                            <span class="material-icons" style="color: var(--md-sys-color-error);">receipt_long</span>
                            <strong>Total Dépenses:</strong>
                            <span style="font-size: 18px; font-weight: bold; color: var(--md-sys-color-error);">${formatCurrency(totalExpenses)}</span>
                        </div>
                    `;
                    
                default:
                    return '';
            }
        }

        function renderTableRows(sectionId, tableName, data, tbody) {
            switch (sectionId) {
                case 'collectors':
                    data.forEach(collector => {
                        const balance = calculateCollectorBalance(collector.id);
                        const status = getCollectorStatus(balance);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Nom">${collector.name}</td>
                            <td data-label="Téléphone">${collector.phone}</td>
                            <td data-label="C.I.N">${collector.cin || ''}</td>
                            <td data-label="Délivré le">${collector.cinDate ? formatDate(collector.cinDate) : ''}</td>
                            <td data-label="Adresse">${collector.address || ''}</td>
                            <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                            <td data-label="Solde">${formatCurrency(Math.abs(balance))}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openCollectorModal(${collector.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteCollector(${collector.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'advances':
                    data.forEach(advance => {
                        const collector = appData.collectors.find(c => c.id === advance.collectorId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Date">${formatDate(advance.date)}</td>
                            <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                            <td data-label="Montant">${formatCurrency(advance.amount)}</td>
                            <td data-label="Motif">${advance.motif || 'N/A'}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openAdvanceModal(${advance.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteAdvance(${advance.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'receptions':
                case 'reception':
                    data.forEach(reception => {
                        const collector = appData.collectors.find(c => c.id === reception.collectorId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(reception.date)}</td>
                            <td>${collector ? collector.name : 'Collecteur supprimé'}</td>
                            <td>${reception.grossWeight} kg</td>
                            <td>${reception.netWeight} kg</td>
                            <td><span class="status-badge status-${reception.quality.toLowerCase()}">${reception.quality}</span></td>
                            <td>${formatCurrency(reception.price)}/kg</td>
                            <td>${formatCurrency(reception.totalValue)}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openReceptionModal(${reception.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteReception(${reception.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                                <button class="btn btn-icon btn-secondary" onclick="generateReceipt(${reception.id})" title="Imprimer le Reçu du Jour">
                                    <span class="material-icons">print</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'delivery':
                    data.forEach(delivery => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(delivery.date)}</td>
                            <td>${delivery.invoice}</td>
                            <td><span class="status-badge" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">${delivery.quality || 'N/A'}</span></td>
                            <td>${delivery.weight} kg</td>
                            <td>${formatCurrency(delivery.totalValue)}</td>
                            <td>${delivery.exporter}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openDeliveryModal(${delivery.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteDelivery(${delivery.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'analysis':
                    data.forEach(collector => {
                        const totalAdvances = getTotalAdvances(collector.id);
                        const totalPaiements = getPaiementsForCurrentYear()
                            .filter(p => p.collectorId === collector.id)
                            .reduce((sum, p) => sum + p.amount, 0);
                        
                        const totalDebits = totalAdvances + totalPaiements;
                        const totalDeliveries = getTotalDeliveries(collector.id);
                        const totalRemboursements = getRemboursementsForCurrentYear()
                            .filter(rem => rem.collectorId === collector.id)
                            .reduce((sum, rem) => sum + rem.amount, 0);
                        
                        const totalCredits = totalDeliveries + totalRemboursements;
                        
                        const balance = totalCredits - totalDebits;
                        const status = getCollectorStatus(balance);
                        let actionButton = '';
                        if (status.class === 'debiteur') {
                            actionButton = `<button class="btn btn-icon btn-success" onclick="openRemboursementModal(${collector.id})" title="Enregistrer un remboursement"><span class="material-icons" style="color: white;">paid</span></button>`;
                        } else if (status.class === 'crediteur' && balance > 0) {
                            actionButton = `<button class="btn btn-icon btn-primary" onclick="payCollectorCredit(${collector.id})" title="Payer le solde créditeur"><span class="material-icons">payments</span></button>`;
                        }
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Collecteur">${collector.name}</td>
                            <td data-label="Total Débits">${formatCurrency(totalDebits)}</td>
                            <td data-label="Total Crédits">${formatCurrency(totalCredits)}</td>
                            <td data-label="Solde">${formatCurrency(balance)}</td>
                            <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="showCollectorDetails(${collector.id})" title="Détails">
                                    <span class="material-icons">visibility</span>
                                </button>
                                ${actionButton}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'expenses':
                    data.forEach(expense => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Date">${formatDate(expense.date)}</td>
                            <td data-label="Catégorie">${expense.category}</td>
                            <td data-label="Description">${expense.description}</td>
                            <td data-label="Montant">${formatCurrency(expense.amount)}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openExpenseModal(${expense.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteExpense(${expense.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'remboursements':
                    data.forEach(rem => {
                        const collector = appData.collectors.find(c => c.id === rem.collectorId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Date">${formatDate(rem.date)}</td>
                            <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                            <td data-label="Montant">${formatCurrency(rem.amount)}</td>
                            <td data-label="Note">${rem.note || ''}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-outline" onclick="openRemboursementModalToEdit(${rem.id})" title="Modifier">
                                    <span class="material-icons">edit</span>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteRemboursement(${rem.id})" title="Supprimer">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
                case 'paiements':
                    data.forEach(p => {
                        const collector = appData.collectors.find(c => c.id === p.collectorId);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td data-label="Date">${formatDate(p.date)}</td>
                            <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                            <td data-label="Montant">${formatCurrency(p.amount)}</td>
                            <td data-label="Note">${p.note || ''}</td>
                            <td class="actions-cell">
                                <button class="btn btn-icon btn-danger" onclick="deletePaiement(${p.id})" title="Annuler ce paiement">
                                    <span class="material-icons">delete_forever</span>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    break;
            }
        }
        function clearSearch() {
            document.getElementById("global-search-input").value = '';
            updateCurrentActiveTable();
        }
        function updateCurrentActiveTable() {
            const activeSection = document.querySelector('.content-section.active');
            if (!activeSection) return;
            const sectionId = activeSection.id;
            if (paginationState[getTableNameFromSection(sectionId)]) {
                paginationState[getTableNameFromSection(sectionId)].currentPage = 1;
            }
            const updateFunctions = {
                'collectors': updateCollectorsTable,
                'advances': updateAdvancesTable,
                'reception': updateReceptionTable,
                'delivery': updateDeliveryTable,
                'analysis': updateAnalysisTable,
                'expenses': updateExpensesTable,
                'remboursements': updateRemboursementsTable,
                'paiements': updatePaiementsTable
            };
            if (updateFunctions[sectionId]) {
                updateFunctions[sectionId]();
            }
        }
        function getTableNameFromSection(sectionId) {
            const mapping = {
                'collectors': 'collectors',
                'advances': 'advances',
                'reception': 'receptions',
                'delivery': 'deliveries',
                'analysis': 'analysis',
                'expenses': 'expenses',
                'remboursements': 'remboursements',
                'paiements': 'paiements'
            };
            return mapping[sectionId] || sectionId;
        }
        const debouncedGlobalSearch = debounce(globalSearch, 300);
        function showToast(message, duration = 3000) {
            let toast = document.createElement("div");
            toast.textContent = message;
            toast.style.position = "fixed";
            toast.style.bottom = "24px";
            toast.style.left = "50%";
            toast.style.transform = "translateX(-50%)";
            toast.style.background = "var(--md-sys-color-primary)";
            toast.style.color = "var(--md-sys-color-on-primary)";
            toast.style.padding = "12px 24px";
            toast.style.borderRadius = "8px";
            toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
            toast.style.zIndex = "3000";
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = "0";
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        function afterAddSuccess(entity) {
            showToast(entity + " ajouté avec succès !");
        }
        function afterDeleteSuccess(entity) {
            showToast(entity + " supprimé avec succès !");
        }
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>Chargement...</span>
                </div>
            `;
        }
        function hideLoading(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
        }
        function showError(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="material-icons">${type === 'error' ? 'error' : 'check_circle'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="toast-close">
                    <span class="material-icons">close</span>
                </button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        function validateForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input[required]');
            let isValid = true;
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('error');
                    isValid = false;
                } else {
                    input.classList.remove('error');
                }
            });
            return isValid;
        }
        function showToast(message, type = 'success', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'check_circle' : 'error';
            toast.innerHTML = `
                <span class="material-icons">${icon}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // Fonction toast améliorée (si pas encore dans votre code)
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                info: '#2196F3',
                warning: '#FF9800'
            };

            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease;
            `;

            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }


        function updateFinancialInsights(stats) {
            const insightTitle1 = document.getElementById('insight-title-1');
            const insightDetail1 = document.getElementById('insight-detail-1');
            const insightIcon1 = document.getElementById('insight-icon-1');
            const recoveryRateEl = document.getElementById('recovery-rate');
            const debtorsInfoEl = document.getElementById('debtors-info');
            const debtorsCard = document.getElementById('debtors-card');
            if (stats.balance > 0) {
                insightTitle1.textContent = 'Situation Financière Positive';
                insightDetail1.textContent = `Excédent de ${formatCurrency(stats.balance)} après couverture des avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_up</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-success)';
            } else if (stats.balance < 0) {
                insightTitle1.textContent = 'Déficit à Surveiller';
                insightDetail1.textContent = `Il manque ${formatCurrency(Math.abs(stats.balance))} pour couvrir toutes les avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_down</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-error)';
            } else {
                insightTitle1.textContent = 'Équilibre Parfait';
                insightDetail1.textContent = 'Les avances et la valeur de la vanille sont parfaitement équilibrées.';
                insightIcon1.innerHTML = '<span class="material-icons">balance</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-secondary)';
            }
            recoveryRateEl.textContent = `${stats.recoveryRate.toFixed(1)}% des avances sont actuellement couvertes par la vanille collectée.`;
            debtorsCard.onclick = null;
            debtorsCard.classList.remove('clickable');
            if (stats.debtorsCount === 0) {
                debtorsInfoEl.textContent = 'Excellent! Aucun collecteur n\'a de dette en cours.';
            } else {
                debtorsInfoEl.textContent = `Attention: ${stats.debtorsCount} collecteur${stats.debtorsCount > 1 ? 's' : ''} ont encore des dettes à rembourser.`;
                debtorsCard.classList.add('clickable');
                debtorsCard.onclick = function () {
                    navigateToSection('analysis');
                    filterAnalysisByStatus('debiteur');
                    showToast('Affichage des collecteurs en dette.', 'success', 2000);
                };
            }
        }
        function filterAnalysisByStatus(statusToFilter) {
            const tbody = document.getElementById('analysis-table');
            if (!tbody) return;
            tbody.querySelectorAll("tr").forEach(row => {
                if (row.querySelector('.empty-state')) return;
                const statusCell = row.querySelector('.status-badge');
                if (statusCell) {
                    if (statusCell.classList.contains(`status-${statusToFilter}`)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            });
        }
        function resetAnalysisView() {
            document.getElementById('analysis-filter-collector').value = '';
            updateAnalysisTable();
            const tbody = document.getElementById('analysis-table');
            if (tbody) {
                tbody.querySelectorAll("tr").forEach(row => {
                    row.style.display = "";
                });
            }
            showToast('Filtres réinitialisés.', 'success', 2000);
        }
        function filterAnalysisForDebtors() {
            const tbody = document.getElementById('analysis-table');
            if (!tbody) return;
            tbody.querySelectorAll("tr").forEach(row => {
                if (row.querySelector('.empty-state')) return;
                const statusCell = row.querySelector('.status-badge.status-debiteur');
                if (statusCell) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
        function showAllInAnalysis() {
            document.getElementById('analysis-filter-collector').value = '';
            document.getElementById('analysis-filter-quality').value = '';
            updateAnalysisTable();
            const tbody = document.getElementById('analysis-table');
            if (tbody) {
                tbody.querySelectorAll("tr").forEach(row => {
                    row.style.display = "";
                });
            }
            showToast('Affichage de tous les collecteurs.', 'success', 2000);
        }
        function updateQualitiesTable() {
            const tbody = document.getElementById('qualities-table');
            tbody.innerHTML = '';
            if (!appData.qualities || appData.qualities.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="empty-state">Aucune qualité définie.</td></tr>`;
                return;
            }
            appData.qualities.forEach(quality => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nom">${quality.name}</td>
                    <td data-label="Description">${quality.description || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openQualityModal(${quality.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteQuality(${quality.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        function openQualityModal(id = null) {
            const form = document.getElementById('quality-form');
            form.reset();
            document.getElementById('quality-id').value = '';
            if (id) {
                const quality = appData.qualities.find(q => q.id === id);
                if (quality) {
                    document.getElementById('quality-id').value = quality.id;
                    document.getElementById('quality-name').value = quality.name;
                    document.getElementById('quality-description').value = quality.description;
                }
            }
            openModal('quality-modal');
        }
        function saveQuality(event) {
            event.preventDefault();
            const id = document.getElementById('quality-id').value;
            const qualityData = {
                name: document.getElementById('quality-name').value.trim(),
                description: document.getElementById('quality-description').value.trim()
            };
            if (id) {
                qualityData.id = parseInt(id);
            }
            saveToDB('qualities', qualityData);
            closeModal('quality-modal');
            showToast('Qualité enregistrée avec succès!');
        }
        function deleteQuality(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette qualité?')) {
                deleteFromDB('qualities', id, () => {
                    showToast('Qualité supprimée.', 'error');
                });
            }
        }
        function updateQualitySelect() {
            const datalist = document.getElementById('quality-list');
            if (!datalist) return;
            datalist.innerHTML = '';
            if (appData.qualities) {
                appData.qualities.forEach(quality => {
                    const option = document.createElement('option');
                    option.value = quality.name;
                    datalist.appendChild(option);
                });
            }
        }
        function updateCharts() {
            const totalAdvances = calculationCache.totals?.advances || 0;
            const totalVanillaValue = calculationCache.totals?.receptions || 0;
            const style = getComputedStyle(document.body);
            const primaryColor = style.getPropertyValue('--md-sys-color-primary').trim();
            const errorColor = style.getPropertyValue('--md-sys-color-error').trim();
            const surfaceColor = style.getPropertyValue('--md-sys-color-surface').trim();
            const chartColors = [
                primaryColor, '#7d5260', '#FFC107', '#4CAF50',
                '#2196F3', '#FF5722', '#9C27B0', '#607D8B'
            ];
            Chart.defaults.color = style.getPropertyValue('--md-sys-color-on-surface').trim();
            Chart.defaults.borderColor = style.getPropertyValue('--md-sys-color-outline-variant').trim();
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            if (pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Total Avances', 'Valeur Vanille'],
                    datasets: [{
                        data: [totalAdvances, totalVanillaValue],
                        backgroundColor: [errorColor, primaryColor],
                        borderColor: surfaceColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.dataset.theme === 'dark' ? '#e6e1e5' : '#1a1c1e'
                            }
                        }
                    }
                }
            });
            const advancesByCollector = {};
            getAdvancesForCurrentYear().forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                if (collector) {
                    advancesByCollector[collector.name] = (advancesByCollector[collector.name] || 0) + advance.amount;
                }
            });
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(advancesByCollector),
                    datasets: [{
                        label: 'Total des Avances',
                        data: Object.values(advancesByCollector),
                        backgroundColor: chartColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                color: document.body.dataset.theme === 'dark' ? '#e6e1e5' : '#1a1c1e'
                            }
                        },
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 10 },
                                color: document.body.dataset.theme === 'dark' ? '#e6e1e5' : '#1a1c1e',
                                callback: function (value) {
                                    if (value >= 1000000) return (value / 1000000) + 'M';
                                    if (value >= 1000) return (value / 1000) + 'k';
                                    return value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return 'Total: ' + context.parsed.x.toLocaleString('fr-MG') + ' Ar';
                                }
                            }
                        }
                    }
                }
            });
            const weightByQuality = {};
            getReceptionsForCurrentYear().forEach(reception => {
                if (!weightByQuality[reception.quality]) weightByQuality[reception.quality] = 0;
                weightByQuality[reception.quality] += reception.netWeight;
            });
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            if (qualityChartInstance) qualityChartInstance.destroy();
            qualityChartInstance = new Chart(qualityCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(weightByQuality),
                    datasets: [{
                        label: 'Poids Net (kg)',
                        data: Object.values(weightByQuality),
                        backgroundColor: chartColors.slice().reverse(),
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.body.dataset.theme === 'dark' ? '#e6e1e5' : '#1a1c1e'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: document.body.dataset.theme === 'dark' ? '#e6e1e5' : '#1a1c1e'
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        function updateExpensesTable() {
            const tbody = document.getElementById('expenses-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            if (!appData.expenses || appData.expenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">receipt_long</div>
                            <div>Aucune dépense enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            const sortedExpenses = [...getExpensesForCurrentYear()].sort((a, b) => new Date(b.date) - new Date(a.date));
            const paginatedExpenses = getPaginatedData(sortedExpenses, 'expenses');
            paginatedExpenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(expense.date)}</td>
                    <td data-label="Catégorie">${expense.category}</td>
                    <td data-label="Description">${expense.description}</td>
                    <td data-label="Montant">${formatCurrency(expense.amount)}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openExpenseModal(${expense.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteExpense(${expense.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('expenses', sortedExpenses.length);
        }
        function openExpenseModal(expenseId = null) {
            const form = document.getElementById('expense-form');
            form.reset();
            delete form.dataset.editId;
            if (expenseId) {
                const expense = appData.expenses.find(e => e.id === expenseId);
                if (expense) {
                    form.dataset.editId = expenseId;
                    document.getElementById('expense-date').value = expense.date;
                    document.getElementById('expense-category').value = expense.category;
                    document.getElementById('expense-description').value = expense.description;
                    document.getElementById('expense-amount').value = expense.amount;
                }
            } else {
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            }
            openModal('expense-modal');
        }
        function saveExpense() {
            const form = document.getElementById('expense-form');
            const cleanAmount = document.getElementById('expense-amount').value.replace(/\D/g, '');
            const expense = {
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                description: document.getElementById('expense-description').value,
                amount: parseInt(cleanAmount) || 0,
                createdAt: new Date().toISOString()
            };
            if (form.dataset.editId) {
                expense.id = parseInt(form.dataset.editId);
            }
            saveToDB('expenses', expense);
            closeModal('expense-modal');
            showToast('Dépense enregistrée avec succès!');
        }
        function deleteExpense(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette dépense?')) {
                deleteFromDB('expenses', id, () => {
                    showToast('Dépense supprimée.', 'error');
                });
            }
        }
        function updatePrixRevientAnalysis() {
            const container = document.getElementById('prix-revient-container');
            container.innerHTML = '';
            const BONNES_QUALITES = ['Lava', 'Fendue'];
            const MAUVAISES_QUALITES = ['Lo', 'Fohy', 'Verte'];
            const totalCost = (appData.advances || []).reduce((sum, a) => sum + a.amount, 0) +
                (appData.expenses || []).reduce((sum, e) => sum + e.amount, 0);
            let poidsBonnesQualites = 0;
            let valeurBonnesQualites = 0;
            let poidsMauvaisesQualites = 0;
            let valeurMauvaisesQualites = 0;
            (appData.receptions || []).forEach(reception => {
                if (BONNES_QUALITES.includes(reception.quality)) {
                    poidsBonnesQualites += reception.netWeight;
                    valeurBonnesQualites += reception.totalValue;
                } else {
                    poidsMauvaisesQualites += reception.netWeight;
                    valeurMauvaisesQualites += reception.totalValue;
                }
            });
            const totalPoidsVert = poidsBonnesQualites + poidsMauvaisesQualites;
            const rendementRate = parseFloat(document.getElementById('rendement-rate').value) || 25;
            const rendementDecimal = rendementRate / 100;
            const poidsSecEstime = poidsBonnesQualites * rendementDecimal;
            if (totalPoidsVert === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">inventory_2</span>
                        <div>Aucune réception de vanille enregistrée. Le calcul est impossible.</div>
                    </div>
                `;
                return;
            }
            const prixRevientPerKgSec = poidsSecEstime > 0 ? totalCost / poidsSecEstime : 0;
            const analysisHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <!-- Karatra 1: Vola Nivoaka (Tsy miova) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background-color: var(--md-sys-color-error-container);">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-error-container);">COÛT TOTAL (ARGENT SORTI)</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-error-container); margin-top: 8px;">${formatCurrency(totalCost)}</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-error-container); opacity: 0.8;">
                            Avances + Dépenses Opérationnelles
                        </div>
                    </div>
                    <!-- Karatra 2: Famakafakana ny Lanja (VAOVAO) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background-color: var(--md-sys-color-primary-container);">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-primary-container);">ANALYSE DES POIDS (VANILLE VERTE)</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-primary-container); margin-top: 8px;">${totalPoidsVert.toFixed(2)} kg</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                            Dont <b>${poidsBonnesQualites.toFixed(2)} kg</b> de bonne qualité  
                            et <b>${poidsMauvaisesQualites.toFixed(2)} kg</b> de qualité inférieure (perte potentielle).
                        </div>
                    </div>
                    <!-- Karatra 3: Prix de Revient (VAOVAO) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background: linear-gradient(135deg, var(--md-sys-color-tertiary-container), var(--md-sys-color-tertiary));">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-tertiary-container);">PRIX DE REVIENT RÉÉVALUÉ</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-tertiary-container); margin-top: 8px;">${formatCurrency(prixRevientPerKgSec)} / kg</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-tertiary-container); opacity: 0.8;">
                            Calculé sur <b>${poidsSecEstime.toFixed(2)} kg</b> de vanille sèche (bonne qualité) avec un rendement de <b>${rendementRate}%</b>.
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = analysisHTML;
        }
        function saveSettings() {
            const rendementRate = document.getElementById('rendement-rate').value;
            localStorage.setItem('rendementRate', rendementRate);
            showToast('Paramètres enregistrés avec succès!');
            updateAllTables();
        }
        function loadSettings() {
            const savedRate = localStorage.getItem('rendementRate');
            if (savedRate) {
                document.getElementById('rendement-rate').value = savedRate;
            }
        }
        function openRemboursementModal(collectorId, remboursementId = null) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Collecteur non trouvé !");
                return;
            }
            const form = document.getElementById('remboursement-form');
            form.reset();
            delete form.dataset.editId;
            document.getElementById('remboursement-collector-id').value = collector.id;
            document.getElementById('remboursement-collector-name').value = collector.name;
            document.getElementById('remboursement-date').value = new Date().toISOString().split('T')[0];
            if (remboursementId) {
                const rem = appData.remboursements.find(r => r.id === remboursementId);
                if (rem) {
                    form.dataset.editId = remboursementId;
                    document.getElementById('remboursement-amount').value = rem.amount;
                    document.getElementById('remboursement-date').value = rem.date;
                    document.getElementById('remboursement-note').value = rem.note;
                }
            } else {
                const balance = calculateCollectorBalance(collector.id);
                if (balance < 0) {
                    document.getElementById('remboursement-amount').placeholder = `Trosa actuel: ${formatCurrency(Math.abs(balance))}`;
                } else {
                    document.getElementById('remboursement-amount').placeholder = '0';
                }
            }
            openModal('remboursement-modal');
        }
        function saveRemboursement(event) {
            event.preventDefault();
            const form = document.getElementById('remboursement-form');
            const cleanAmount = document.getElementById('remboursement-amount').value.replace(/\D/g, '');
            const remboursement = {
                collectorId: parseInt(document.getElementById('remboursement-collector-id').value),
                amount: parseInt(cleanAmount) || 0,
                date: document.getElementById('remboursement-date').value,
                note: document.getElementById('remboursement-note').value.trim(),
            };
            if (remboursement.amount <= 0) {
                alert("Le montant du remboursement doit être supérieur à zéro.");
                return;
            }
            if (form.dataset.editId) {
                remboursement.id = parseInt(form.dataset.editId);
            } else {
                remboursement.createdAt = new Date().toISOString();
            }
            saveToDB('remboursements', remboursement);
            closeModal('remboursement-modal');
            showToast('Remboursement enregistré avec succès!');
        }
        function updateRemboursementsTable() {
            const tbody = document.getElementById('remboursements-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            const remboursementsData = appData.remboursements || [];
            if (remboursementsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">history_toggle_off</div>
                            <div>Aucun remboursement enregistré</div>
                        </td>
                    </tr>
                `;
                return;
            }
            const sortedRemboursements = [...getRemboursementsForCurrentYear()].sort((a, b) => new Date(b.date) - new Date(a.date));
            const paginatedRemboursements = getPaginatedData(sortedRemboursements, 'remboursements');
            paginatedRemboursements.forEach(rem => {
                const collector = appData.collectors.find(c => c.id === rem.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(rem.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td data-label="Montant">${formatCurrency(rem.amount)}</td>
                    <td data-label="Note">${rem.note || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openRemboursementModalToEdit(${rem.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteRemboursement(${rem.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('remboursements', sortedRemboursements.length);
        }
        function openRemboursementModalToEdit(remboursementId) {
            const rem = appData.remboursements.find(r => r.id === remboursementId);
            if (!rem) {
                alert("Remboursement non trouvé !");
                return;
            }
            openRemboursementModal(rem.collectorId, remboursementId);
        }
        function deleteRemboursement(remboursementId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce remboursement ? Cette action est irréversible.')) {
                deleteFromDB('remboursements', remboursementId, () => {
                    showToast('Remboursement supprimé.', 'error');
                });
            }
        }
        function payCollectorCredit(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Collecteur non trouvé !");
                return;
            }
            const balance = calculateCollectorBalance(collectorId);
            if (balance <= 0) {
                alert("Ce collecteur n'a pas de solde créditeur à payer.");
                return;
            }
              let paymentAmount = balance;
            const amountFromUser = prompt(`Solde créditeur actuel de ${collector.name} : ${formatCurrency(balance)}.\n\nEntrez le montant à payer (laissez vide pour payer la totalité) :`, balance);
            
            if (amountFromUser === null) return;
            
            if (amountFromUser.trim() !== "") {
                const parsedAmount = parseInt(amountFromUser.replace(/\D/g, ''));
                if (isNaN(parsedAmount) || parsedAmount <= 0) {
                    alert("Montant invalide.");
                    return;
                }
                if (parsedAmount > balance) {
                    alert("Le montant ne peut pas dépasser le solde actuel.");
                    return;
                }
                paymentAmount = parsedAmount;
            }

            const noteFromUser = prompt(`Vous allez payer ${formatCurrency(paymentAmount)} à ${collector.name}.\n\nVeuillez entrer une note pour ce paiement (ex: Par chèque N°123, En espèce, etc.)`, paymentAmount === balance ? "Paiement du solde créditeur" : "Paiement partiel du solde créditeur");
            if (noteFromUser === null) {
                showToast("Paiement annulé.", "error");
                return;
            }
            if (confirm(`Confirmer le paiement de ${formatCurrency(paymentAmount)} à ${collector.name} avec la note : "${noteFromUser}" ?`)) {
                const paiement = {
                    collectorId: collectorId,
                    amount: paymentAmount,
                    date: new Date().toISOString().split('T')[0],
                    note: noteFromUser.trim() || `Paiement du solde créditeur`,
                    createdAt: new Date().toISOString()
                };
                saveToDB('paiements', paiement);
                showToast(`Paiement de ${formatCurrency(paymentAmount)} à ${collector.name} enregistré avec succès!`);
            }
        }
        function updatePaiementsTable() {
            const tbody = document.getElementById('paiements-table');
            const tableWrapper = tbody.closest('.data-table');
            tbody.innerHTML = '';
            const paiementsData = appData.paiements || [];
            if (paiementsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">history_toggle_off</div>
                            <div>Aucun paiement de solde enregistré</div>
                        </td>
                    </tr>
                `;
                return;
            }
            const sortedPaiements = [...getPaiementsForCurrentYear()].sort((a, b) => new Date(b.date) - new Date(a.date));
            const paginatedPaiements = getPaginatedData(sortedPaiements, 'paiements');
            paginatedPaiements.forEach(p => {
                const collector = appData.collectors.find(c => c.id === p.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(p.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td data-label="Montant">${formatCurrency(p.amount)}</td>
                    <td data-label="Note">${p.note || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-danger" onclick="deletePaiement(${p.id})" title="Annuler ce paiement (irréversible)">
                            <span class="material-icons">delete_forever</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            let paginationDiv = tableWrapper.querySelector('.pagination-controls');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                tableWrapper.appendChild(paginationDiv);
            }
            paginationDiv.innerHTML = createPaginationControls('paiements', sortedPaiements.length);
        }
        function updateRentabiliteInsights() {
            const BONNES_QUALITES = ['Lava', 'Fendue'];
            let valeurBonnesQualites = 0;
            let valeurMauvaisesQualites = 0;
            (appData.receptions || []).forEach(reception => {
                if (BONNES_QUALITES.includes(reception.quality)) {
                    valeurBonnesQualites += reception.totalValue;
                } else {
                    valeurMauvaisesQualites += reception.totalValue;
                }
            });
            const totalCost = (appData.advances || []).reduce((sum, a) => sum + a.amount, 0) +
                (appData.expenses || []).reduce((sum, e) => sum + e.amount, 0);
            const tauxRendement = totalCost > 0 ? (valeurBonnesQualites / totalCost) * 100 : 0;
            const valeurRecuperableEl = document.getElementById('valeur-recuperable-detail');
            valeurRecuperableEl.textContent = `${formatCurrency(valeurBonnesQualites)} - C'est la valeur brute des produits vendables.`;
            const perteQualiteEl = document.getElementById('perte-qualite-detail');
            perteQualiteEl.textContent = `${formatCurrency(valeurMauvaisesQualites)} - Cet argent est difficilement récupérable.`;
            const rendementOpEl = document.getElementById('rendement-op-detail');
            rendementOpEl.textContent = `${tauxRendement.toFixed(1)}% - Pour 100 Ar dépensés, ${formatCurrency(tauxRendement.toFixed(0))} sont couverts par de la bonne qualité.`;
            const rendementCard = document.getElementById('insight-rendement-op');
            if (tauxRendement >= 100) {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-success)';
            } else if (tauxRendement < 50) {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-error)';
            } else {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-primary)';
            }
        }
        function deletePaiement(paiementId) {
            if (confirm('ATTENTION : Annuler un paiement va recréer le crédit pour le collecteur. Êtes-vous sûr de vouloir continuer ?')) {
                deleteFromDB('paiements', paiementId, () => {
                    showToast('Paiement annulé avec succès.', 'error');
                });
            }
        }
        function exportAnalysisToExcel() {
            const table = document.getElementById('analysis-table');
            if (!table) {
                showToast("Tsy hita ny tabilao hanaovana export.", "error");
                return;
            }
            const data = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            headers.pop();
            data.push(headers);
            table.querySelectorAll('tbody tr').forEach(row => {
                if (row.querySelector('td.empty-state')) {
                    return;
                }
                const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                rowData.pop();
                data.push(rowData);
            });
            if (data.length <= 1) {
                showToast("Tsy misy angona azo alefa amin'ny Excel.", "error");
                return;
            }
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Analyse des Collecteurs');
            const colWidths = headers.map(header => ({ wch: Math.max(header.length, 15) }));
            worksheet['!cols'] = colWidths;
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Analyse_Collecteurs_${today}.xlsx`);
            showToast("Export Excel vita soa aman-tsara!", "success");
        }
        function exportCollectorDetailsToExcel(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                showToast("Tsy hita ny collecteur!", "error");
                return;
            }

            // >>> Données filtrées sur l'année active <<<
            const advances = getAdvancesForCurrentYear()
                .filter(a => a.collectorId === collectorId);

            const receptions = getReceptionsForCurrentYear()
                .filter(r => r.collectorId === collectorId);

            const remboursements = getRemboursementsForCurrentYear()
                .filter(rem => rem.collectorId === collectorId);

            const paiements = getPaiementsForCurrentYear()
                .filter(p => p.collectorId === collectorId);
            // <<< fin des 4 lignes modifiées >>>

            const workbook = XLSX.utils.book_new();

            const summaryData = [
                ["Rapport Détaillé du Collecteur"],
                [],
                ["Nom du Collecteur:", collector.name],
                ["Téléphone:", collector.phone || 'N/A'],
                ["CIN:", `${collector.cin || 'N/A'} (délivré le: ${collector.cinDate ? formatDate(collector.cinDate) : 'N/A'})`],
                [],
                ["RÉSUMÉ FINANCIER (Année " + currentYear + ")"],
                ["Total Avances:", getTotalAdvances(collectorId)],
                ["Total Livraisons (Valeur):", getTotalDeliveries(collectorId)],
                ["Total Remboursements:", remboursements.reduce((sum, r) => sum + r.amount, 0)],
                ["Total Paiements de Solde:", paiements.reduce((sum, p) => sum + p.amount, 0)],
                ["Solde Actuel:", calculateCollectorBalance(collectorId)]
            ];

            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            summarySheet['!cols'] = [{ wch: 25 }, { wch: 25 }];
            XLSX.utils.book_append_sheet(workbook, summarySheet, "Résumé");

            const advancesData = advances.map(a => ({
                Date: formatDate(a.date),
                Motif: a.motif || '',
                Montant: a.amount
            }));
            const advancesSheet = XLSX.utils.json_to_sheet(advancesData);
            advancesSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, advancesSheet, "Avances");

            const receptionsData = receptions.map(r => ({
                Date: formatDate(r.date),
                "Poids Net (kg)": r.netWeight,
                "Qualité": r.quality,
                "Prix/kg": r.price,
                "Valeur": r.totalValue
            }));
            const receptionsSheet = XLSX.utils.json_to_sheet(receptionsData);
            receptionsSheet['!cols'] = [
                { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
            ];
            XLSX.utils.book_append_sheet(workbook, receptionsSheet, "Livraisons");

            const rembData = remboursements.map(r => ({
                Date: formatDate(r.date),
                Note: r.note || '',
                Montant: r.amount
            }));
            const rembSheet = XLSX.utils.json_to_sheet(rembData);
            rembSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, rembSheet, "Remboursements");

            const paiementsData = paiements.map(p => ({
                Date: formatDate(p.date),
                Note: p.note || '',
                Montant: p.amount
            }));
            const paiementsSheet = XLSX.utils.json_to_sheet(paiementsData);
            paiementsSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, paiementsSheet, "Paiements de Solde");

            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(
                workbook,
                `Details_${collector.name.replace(/\s/g, '_')}_${currentYear}_${today}.xlsx`
            );

            showToast("Export Excel vita soa aman-tsara!", "success");
        }

        // ✅ SERVICE WORKER REGISTRATION AMBOARIANA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('✅ Service Worker enregistré:', registration.scope);
                        
                        // Vérifier les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible
                                    if (confirm('Misy version vaovao! Havaozina ve?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('❌ Service Worker registration failed:', error);
                    });
                
                // Écouter les changements de contrôleur
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }

        // ✅ AFFICHER STATUS OFFLINE/ONLINE
        window.addEventListener('online', () => {
            showToast('📶 Connecté à Internet', 'success', 2000);
        });

        window.addEventListener('offline', () => {
            showToast('📵 Mode Hors-ligne - Données enregistrées localement', 'info', 3000);
        });

        // ✅ INSTALLER PROMPT PWA 
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('💾 App peut être installée!');
            
            // Mampiseho bouton installation automatiquement
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.style.display = 'inline-flex';
            }
            
            // Toast notification
            showToast('💾 Afaka installer ny app! Jereo ny Settings.', 'info', 4000);
        });

        // Fonction d'installation - appelée par le bouton
        function installApp() {
            if (!deferredPrompt) {
                showToast('⚠️ Azo installer sahady ny app, na tsy mbola vonona.', 'warning', 3000);
                return;
            }
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    showToast('✅ App nao-installer soa aman-tsara!', 'success', 3000);
                    console.log('✅ App installée!');
                    
                    // Manafina ny bouton
                    const installBtn = document.getElementById('pwa-install-btn');
                    if (installBtn) installBtn.style.display = 'none';
                } else {
                    showToast('Installation annulée', 'info', 2000);
                }
                deferredPrompt = null;
            });
        }

        // Vérifier si déjà installé
        window.addEventListener('appinstalled', () => {
            console.log('✅ BEHAVANA a été installé avec succès!');
            showToast('✅ Installation réussie!', 'success', 3000);
            deferredPrompt = null;
            
            // Manafina ny bouton installation
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) installBtn.style.display = 'none';
        });



        function updateCollectorBalanceDisplay() {
            const collectorId = parseInt(document.getElementById('reception-collector').value);
            const balanceInput = document.getElementById('reception-collector-balance');

            if (!collectorId) {
                balanceInput.value = '';
                balanceInput.style.color = '';
                balanceInput.style.fontWeight = '';
                return;
            }

            const balance = calculateCollectorBalance(collectorId);
            const formattedBalance = formatCurrency(Math.abs(balance));

            if (balance > 0) {
                balanceInput.value = 'Créditeur: ' + formattedBalance;
                balanceInput.style.color = '#2e7d32'; // Green
                balanceInput.style.fontWeight = 'bold';
            } else if (balance < 0) {
                balanceInput.value = 'Débiteur: ' + formattedBalance;
                balanceInput.style.color = '#ba1a1a'; // Red
                balanceInput.style.fontWeight = 'bold';
            } else {
                balanceInput.value = 'Équilibré: 0 Ar';
                balanceInput.style.color = 'var(--md-sys-color-on-surface)';
                balanceInput.style.fontWeight = 'normal';
            }
        }

        // ========================================
        // QUALITY CHART MODAL - RENDER TABLE
        // ========================================

        function renderQualityDetailTable() {
            console.log('📊 Rendering quality detail table...');

            const tbody = document.getElementById('quality-detail-table');
            if (!tbody) {
                console.error('❌ Table quality-detail-table tsy hita!');
                return;
            }

            // Calcul data - FILTRÉE PAR ANNÉE ACTUELLE
            const qualityData = {};
            (getReceptionsForCurrentYear() || []).forEach(reception => {  // <-- CHANGEMENT ICI
                const quality = reception.quality || 'Non spécifié';
                if (!qualityData[quality]) {
                    qualityData[quality] = { poids: 0, count: 0 };
                }
                qualityData[quality].poids += parseFloat(reception.netWeight) || 0;
                qualityData[quality].count += 1;
            });

            const totalPoids = Object.values(qualityData).reduce((sum, item) => sum + item.poids, 0);

            // Sort par poids descending
            const sortedData = Object.entries(qualityData).sort((a, b) => b[1].poids - a[1].poids);

            if (sortedData.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                    <div class="material-icons">inventory</div>
                    <div>Aucune réception pour l'année ${currentYear}</div>
                    </td>
                </tr>
                `;
                console.log(`⚠️ Aucune réception pour l'année ${currentYear}`);
                return;
            }

            // Render rows
            tbody.innerHTML = sortedData.map(([quality, data]) => {
                const percentage = totalPoids > 0 ? ((data.poids / totalPoids) * 100).toFixed(1) : 0;
                return `
                <tr>
                    <td><strong>${quality}</strong></td>
                    <td style="text-align: right; font-weight: 600;">${data.poids.toFixed(2)} kg</td>
                    <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; background: var(--md-sys-color-surface-variant); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: var(--md-sys-color-primary);"></div>
                        </div>
                        <span style="font-weight: 600; min-width: 50px; text-align: right;">${percentage}%</span>
                    </div>
                    </td>
                    <td style="text-align: center;">${data.count}</td>
                </tr>
                `;
            }).join('');

            // Total row
            const totalCount = sortedData.reduce((sum, [, data]) => sum + data.count, 0);
            tbody.innerHTML += `
                <tr style="background: var(--md-sys-color-primary-container); font-weight: bold;">
                <td>TOTAL</td>
                <td style="text-align: right;">${totalPoids.toFixed(2)} kg</td>
                <td style="text-align: right;">100%</td>
                <td style="text-align: center;">${totalCount}</td>
                </tr>
            `;

            console.log(`✅ Table rendered: ${sortedData.length} qualities, ${totalPoids.toFixed(2)} kg total (Année ${currentYear})`);
        }


        // ========================================

        // Manova ny chart container ho clickable
        function makeQualityChartClickable() {
            console.log('🔍 Mitady quality chart container...');

            // Tadiavo DAHOLO ny chart-container
            const allContainers = document.querySelectorAll('.chart-container');
            let targetContainer = null;

            allContainers.forEach(container => {
                // Jereo raha misy #qualityChart ao anatiny
                const canvas = container.querySelector('#qualityChart');
                if (canvas) {
                    targetContainer = container;
                    console.log('✅ Quality chart container hita!');
                }
            });

            if (!targetContainer) {
                console.warn('⚠️ Quality chart container tsy hita. Hanandrana indray...');
                // Andraso kely dia manandrana indray
                setTimeout(makeQualityChartClickable, 1000);
                return;
            }

            // Asiana cursor pointer
            targetContainer.style.cursor = 'pointer';

            // Asiana onclick - misy protection hoe tsy mi-trigger rehefa canvas
            targetContainer.addEventListener('click', function (e) {
                console.log('🖱️ Quality chart clicked!');
                openQualityChartModal();
            });

            // Asiana icon indication fa clickable
            const title = targetContainer.querySelector('h3');
            if (title && !title.querySelector('.open-indicator')) {
                const currentText = title.textContent.trim();
                title.innerHTML = `
                <span style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <span>${currentText}</span>
                    <span class="material-icons open-indicator" style="font-size: 18px; opacity: 0.5;">open_in_full</span>
                </span>
                `;
            }

            console.log('✅ Quality chart clickable tsara!');
        }


        // Fonction manokatra ny modal
        function openQualityChartModal() {
            const modal = document.getElementById('quality-chart-modal');
            if (!modal) return;
            openModal('quality-chart-modal');
            setTimeout(() => {
                renderQualityChartInModal();
                renderQualityDetailTable();
            }, 150);
        }

        // Global chart instances
        window.qualityChartModalInstance = null;
        window.advancesChartModalInstance = null;

        // ========================================
        // ADVANCES CHART MODAL FUNCTIONS
        // ========================================

        // Render table détaillé - Advances
        function renderAdvancesDetailTable() {
            console.log('📊 Rendering advances detail table...');

            const tbody = document.getElementById('advances-detail-table');
            if (!tbody) {
                console.error('❌ Table advances-detail-table tsy hita!');
                return;
            }

            // Calcul data
            const advancesByCollector = {};
            (appData.advances || []).forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                const collectorName = collector ? collector.name : 'Collecteur supprimé';

                if (!advancesByCollector[collectorName]) {
                    advancesByCollector[collectorName] = { total: 0, count: 0 };
                }
                advancesByCollector[collectorName].total += parseFloat(advance.amount) || 0;
                advancesByCollector[collectorName].count += 1;
            });

            const totalAdvances = Object.values(advancesByCollector).reduce((sum, item) => sum + item.total, 0);
            const sortedData = Object.entries(advancesByCollector).sort((a, b) => b[1].total - a[1].total);

            if (sortedData.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                    <div class="material-icons">account_balance_wallet</div>
                    <div>Aucune avance enregistrée</div>
                    </td>
                </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedData.map(([collectorName, data]) => {
                const percentage = totalAdvances > 0 ? ((data.total / totalAdvances) * 100).toFixed(1) : 0;
                return `
                <tr>
                    <td><strong>${collectorName}</strong></td>
                    <td style="text-align: right; font-weight: 600;">${formatCurrency(data.total)}</td>
                    <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; background: var(--md-sys-color-surface-variant); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: var(--md-sys-color-error);"></div>
                        </div>
                        <span style="font-weight: 600; min-width: 50px; text-align: right;">${percentage}%</span>
                    </div>
                    </td>
                    <td style="text-align: center;">${data.count}</td>
                </tr>
                `;
            }).join('');

            const totalCount = sortedData.reduce((sum, [, data]) => sum + data.count, 0);
            tbody.innerHTML += `
                <tr style="background: var(--md-sys-color-error-container); font-weight: bold;">
                <td>TOTAL</td>
                <td style="text-align: right;">${formatCurrency(totalAdvances)}</td>
                <td style="text-align: right;">100%</td>
                <td style="text-align: center;">${totalCount}</td>
                </tr>
            `;

            console.log(`✅ Advances table rendered`);
        }

        // Render graphique - Advances
        function renderAdvancesChartInModal() {
            console.log('📊 Rendering advances chart in modal...');

            const ctx = document.getElementById('advancesChartModal');
            if (!ctx) {
                console.error('❌ Canvas advancesChartModal tsy hita!');
                return;
            }

            if (window.advancesChartModalInstance) {
                window.advancesChartModalInstance.destroy();
            }

            const advancesByCollector = {};
            (appData.advances || []).forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                const collectorName = collector ? collector.name : 'Collecteur supprimé';
                if (!advancesByCollector[collectorName]) {
                    advancesByCollector[collectorName] = 0;
                }
                advancesByCollector[collectorName] += advance.amount;
            });

            const labels = Object.keys(advancesByCollector);
            const data = Object.values(advancesByCollector);

            const backgroundColors = labels.map((_, index) => {
                const hue = (index * 360 / labels.length);
                return `hsla(${hue}, 70%, 50%, 0.8)`;
            });

            const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));

            window.advancesChartModalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Montant (Ar)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 'flex',
                        maxBarThickness: 80
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Distribution Complète des Avances par Collecteur',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.x;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return [
                                        `Montant: ${formatCurrency(value)}`,
                                        `Pourcentage: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });

            console.log('✅ Advances chart rendered');
        }

        // Open advances modal - ITY NO TOKONY MISY
        function openAdvancesChartModal() {
            const modal = document.getElementById('advances-chart-modal');
            if (!modal) return;
            openModal('advances-chart-modal');
            setTimeout(() => {
                renderAdvancesChartInModal();
                renderAdvancesDetailTable();
            }, 150);
        }

        // Manova advances chart ho clickable
        function makeAdvancesChartClickable() {
            console.log('🔍 Mitady advances chart container...');

            const allContainers = document.querySelectorAll('.chart-container');
            let targetContainer = null;

            allContainers.forEach(container => {
                const canvas = container.querySelector('#barChart');
                if (canvas) {
                    targetContainer = container;
                    console.log('✅ Advances chart container hita!');
                }
            });

            if (!targetContainer) {
                console.warn('⚠️ Advances chart container tsy hita.');
                setTimeout(makeAdvancesChartClickable, 1000);
                return;
            }

            targetContainer.style.cursor = 'pointer';

            const newContainer = targetContainer.cloneNode(true);
            targetContainer.parentNode.replaceChild(newContainer, targetContainer);

            newContainer.addEventListener('click', function (e) {
                console.log('🖱️ Advances chart clicked!');
                openAdvancesChartModal();
            });

            const title = newContainer.querySelector('h3');
            if (title && !title.querySelector('.open-indicator')) {
                const currentText = title.textContent.trim();
                title.innerHTML = `
                <span style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <span>${currentText}</span>
                    <span class="material-icons open-indicator" style="font-size: 18px; opacity: 0.5;">open_in_full</span>
                </span>
                `;
            }

            console.log('✅ Advances chart clickable tsara!');
        }

        function renderQualityChartInModal() {
            const ctx = document.getElementById('qualityChartModal');
            if (!ctx) return;

            // Destroy chart taloha
            if (qualityChartModalInstance) {
                qualityChartModalInstance.destroy();
            }

            // Calcul ny data - FILTRÉE PAR ANNÉE ACTUELLE
            const qualityData = {};
            getReceptionsForCurrentYear().forEach(reception => {  // <-- CHANGEMENT ICI
                const quality = reception.quality || 'Non spécifié';
                if (!qualityData[quality]) {
                    qualityData[quality] = 0;
                }
                qualityData[quality] += parseFloat(reception.netWeight) || 0;
            });

            const labels = Object.keys(qualityData);
            const data = Object.values(qualityData);

            // Colors dynamique
            const backgroundColors = labels.map((_, index) => {
                const hue = (index * 360 / labels.length);
                return `hsla(${hue}, 70%, 60%, 0.8)`;
            });

            const borderColors = backgroundColors.map(color =>
                color.replace('0.8', '1')
            );

            qualityChartModalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Poids (kg)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 'flex',
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `Distribution des Poids par Qualité - Année ${currentYear}`,  // <-- CHANGEMENT ICI
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function (context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return [
                                        `${label}: ${value.toFixed(2)} kg`,
                                        `Pourcentage: ${percentage}%`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString() + ' kg';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }


        // Table ny data
        function renderQualityTable() {
            const tbody = document.getElementById('quality-detail-table');
            if (!tbody) return;

            // Calcul ny data
            const qualityData = {};
            appData.receptions.forEach(reception => {
                const quality = reception.quality || 'Non spécifié';
                if (!qualityData[quality]) {
                    qualityData[quality] = {
                        poids: 0,
                        count: 0
                    };
                }
                qualityData[quality].poids += parseFloat(reception.netWeight) || 0;
                qualityData[quality].count += 1;
            });

            const totalPoids = Object.values(qualityData).reduce((sum, item) => sum + item.poids, 0);

            // Sort par poids descending
            const sortedData = Object.entries(qualityData).sort((a, b) => b[1].poids - a[1].poids);

            if (sortedData.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                    <div class="material-icons">inventory</div>
                    <div>Aucune réception enregistrée</div>
                    </td>
                </tr>
                `;
                return;
            }

            tbody.innerHTML = sortedData.map(([quality, data]) => {
                const percentage = ((data.poids / totalPoids) * 100).toFixed(1);
                return `
                    <tr>
                        <td><strong>${quality}</strong></td>
                        <td style="text-align: right; font-weight: 600;">${data.poids.toFixed(2)} kg</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex-grow: 1; background: var(--md-sys-color-surface-variant); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percentage}%; height: 100%; background: var(--md-sys-color-primary);"></div>
                                </div>
                                <span style="font-weight: 600; min-width: 50px; text-align: right;">${percentage}%</span>
                            </div>
                        </td>
                        <td style="text-align: center;">${data.count}</td>
                    </tr>
                    `;
            }).join('');

            // Ampiana total row
            tbody.innerHTML += `
                <tr style="background: var(--md-sys-color-primary-container); font-weight: bold;">
                    <td>TOTAL</td>
                    <td style="text-align: right;">${totalPoids.toFixed(2)} kg</td>
                    <td style="text-align: right;">100%</td>
                    <td style="text-align: center;">${sortedData.reduce((sum, [, data]) => sum + data.count, 0)}</td>
                </tr>
            `;
        }

        // Antsoina amin'ny load
        document.addEventListener('DOMContentLoaded', () => {
            // ... code hafa ...
            makeQualityChartClickable();
        });

        // ========================================
        // YEAR SLIDER - FLUID DRAGGABLE FUNCTIONALITY
        // ========================================

        let isDragging = false;
        let startY = 0;
        let startYear = 0;

        function initYearSlider() {
            const track = document.getElementById('yearSliderTrack');
            const thumb = document.getElementById('yearSliderThumb');
            const fill = document.getElementById('yearSliderFill');
            const display = document.getElementById('yearDisplay');
            
            if (!track || !thumb) return;
            
            const now = new Date().getFullYear();
            const minYear = now - 3;
            const maxYear = now + 4;
            
            // Initialiser la position
            updateSliderPosition();
            
            // Click sur la track pour jump avec animation
            track.addEventListener('click', (e) => {
                if (e.target === thumb || thumb.contains(e.target)) return;
                
                const rect = track.getBoundingClientRect();
                const clickY = e.clientY - rect.top;
                const percentage = 1 - (clickY / rect.height); // Inversé car 0 en haut
                const range = maxYear - minYear;
                const newYear = Math.round(minYear + (percentage * range));
                
                if (newYear >= minYear && newYear <= maxYear) {
                    currentYear = newYear;
                    localStorage.setItem(ACTIVE_YEAR_STORAGE_KEY, currentYear);
                    updateSliderPosition(true); // Animation activée
                    refreshAllData();
                }
            });
            
            // Drag avec souris
            thumb.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            // Drag avec tactile - AVEC PASSIVE FALSE pour mobile
            thumb.addEventListener('touchstart', startDragTouch, { passive: false });
            document.addEventListener('touchmove', dragTouch, { passive: false });
            document.addEventListener('touchend', stopDrag);
            
            // Click sur track avec tactile
            track.addEventListener('touchstart', (e) => {
                if (e.target === thumb || thumb.contains(e.target)) return;
                
                const rect = track.getBoundingClientRect();
                const touchY = e.touches[0].clientY - rect.top;
                const percentage = 1 - (touchY / rect.height);
                const range = maxYear - minYear;
                const newYear = Math.round(minYear + (percentage * range));
                
                if (newYear >= minYear && newYear <= maxYear) {
                    currentYear = newYear;
                    localStorage.setItem(ACTIVE_YEAR_STORAGE_KEY, currentYear);
                    updateSliderPosition(true);
                    refreshAllData();
                }
                e.preventDefault();
            }, { passive: false });
            
            // Scroll avec molette sur le thumb
            thumb.addEventListener('wheel', (e) => {
                e.preventDefault();
                const direction = e.deltaY > 0 ? -1 : 1;
                const newYear = currentYear + direction;
                
                if (newYear >= minYear && newYear <= maxYear) {
                    currentYear = newYear;
                    localStorage.setItem(ACTIVE_YEAR_STORAGE_KEY, currentYear);
                    updateSliderPosition(true);
                    refreshAllData();
                }
            }, { passive: false });
            
            function startDrag(e) {
                isDragging = true;
                startY = e.clientY;
                startYear = currentYear;
                thumb.classList.add('dragging');
                track.classList.add('dragging'); // AMPIANA - manova ny track koa
                e.preventDefault();
            }
            
            function startDragTouch(e) {
                isDragging = true;
                startY = e.touches[0].clientY;
                startYear = currentYear;
                thumb.classList.add('dragging');
                track.classList.add('dragging'); // AMPIANA
                e.preventDefault();
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                const rect = track.getBoundingClientRect();
                const deltaY = startY - e.clientY;
                const pixelsPerYear = rect.height / (maxYear - minYear);
                const yearDelta = Math.round(deltaY / pixelsPerYear);
                const newYear = Math.max(minYear, Math.min(maxYear, startYear + yearDelta));
                
                if (newYear !== currentYear) {
                    currentYear = newYear;
                    updateSliderPosition(false); // Tsy misy animation rehefa drag
                }
            }
            
            function dragTouch(e) {
                if (!isDragging) return;
                e.preventDefault(); // IMPORTANTE - manakatona ny default scroll
                
                const rect = track.getBoundingClientRect();
                const deltaY = startY - e.touches[0].clientY;
                const pixelsPerYear = rect.height / (maxYear - minYear);
                const yearDelta = Math.round(deltaY / pixelsPerYear);
                const newYear = Math.max(minYear, Math.min(maxYear, startYear + yearDelta));
                
                if (newYear !== currentYear) {
                    currentYear = newYear;
                    updateSliderPosition(false); // Tsy misy animation rehefa drag
                }
            }
            
            function stopDrag() {
                if (isDragging) {
                    isDragging = false;
                    thumb.classList.remove('dragging');
                    track.classList.remove('dragging'); // AMPIANA
                    localStorage.setItem(ACTIVE_YEAR_STORAGE_KEY, currentYear);
                    
                    // AMPIANA: Animation bounce rehefa avy drag
                    thumb.classList.add('changing');
                    display.classList.add('changing');
                    setTimeout(() => {
                        thumb.classList.remove('changing');
                        display.classList.remove('changing');
                    }, 600);
                    
                    refreshAllData();
                }
            }
        }

        function updateSliderPosition(animate = true) {
            const thumb = document.getElementById('yearSliderThumb');
            const fill = document.getElementById('yearSliderFill');
            const display = document.getElementById('yearDisplay');
            const track = document.getElementById('yearSliderTrack');
            
            if (!thumb || !track) return;
            
            const now = new Date().getFullYear();
            const minYear = now - 3;
            const maxYear = now + 4;
            const range = maxYear - minYear;
            const position = (currentYear - minYear) / range;
            
            // Position du thumb (inversé: haut = année future)
            const thumbPosition = (1 - position) * 100;
            thumb.style.top = `${thumbPosition}%`;
            
            // Hauteur du fill avec smooth transition
            if (fill) {
                fill.style.height = `${position * 100}%`;
            }
            
            // Afficher l'année
            if (display) {
                display.textContent = currentYear;
            }
            
            // Animation si demandée
            if (animate) {
                thumb.classList.add('changing');
                if (display) {
                    display.classList.add('changing');
                }
                setTimeout(() => {
                    thumb.classList.remove('changing');
                    if (display) {
                        display.classList.remove('changing');
                    }
                }, 600);
            }
        }

        function refreshAllData() {
            const overviewMonthEl = document.getElementById('overview-month');
            if (overviewMonthEl) {
                overviewMonthEl.textContent = `Année ${currentYear}`;
            }
            
            invalidateCache();
            buildCache();
            updateAllTables();
            updateEnhancedDashboard();
            updatePrixRevientAnalysis();
            updateCharts();
            
            showToast(`Année ${currentYear}`, 'success', 1000);
        }

        // Initialiser au chargement
        function initYearDisplay() {
            const saved = parseInt(localStorage.getItem(ACTIVE_YEAR_STORAGE_KEY), 10);
            const now = new Date().getFullYear();
            currentYear = !isNaN(saved) ? saved : now;
            
            const overviewMonthEl = document.getElementById('overview-month');
            if (overviewMonthEl) {
                overviewMonthEl.textContent = `Année ${currentYear}`;
            }
            
            // Attendre que le DOM soit complètement chargé
            setTimeout(() => {
                initYearSlider();
                updateSliderPosition(false); // Initialisation sans animation
            }, 100);
        }


        // Validation en temps réel pour le nom du collecteur
        function validateCollectorNameLive() {
            const nameInput = document.getElementById('collector-name');
            const form = document.getElementById('collector-form');
            
            if (!nameInput) return;
            
            // Créer le message d'erreur s'il n'existe pas
            let errorMsg = nameInput.parentElement.querySelector('.error-message');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: none;';
                nameInput.parentElement.appendChild(errorMsg);
            }
            
            nameInput.addEventListener('input', function() {
                const name = this.value.trim();
                const editId = form.dataset.editId;
                
                if (name.length === 0) {
                    this.style.borderColor = '';
                    errorMsg.style.display = 'none';
                    return;
                }
                
                // Vérifier si le nom existe déjà
                const exists = appData.collectors.some(c => {
                    if (editId && c.id == editId) return false; // Ignorer lors de la modification
                    return c.name.toLowerCase() === name.toLowerCase();
                });
                
                if (exists) {
                    this.style.borderColor = '#d32f2f';
                    this.style.borderWidth = '2px';
                    errorMsg.textContent = '⚠️ Ce nom existe déjà!';
                    errorMsg.style.display = 'block';
                } else {
                    this.style.borderColor = '#4caf50';
                    this.style.borderWidth = '2px';
                    errorMsg.style.display = 'none';
                }
            });
        }

        // Validation en temps réel pour le CIN
        function validateCollectorCINLive() {
            const cinInput = document.getElementById('collector-cin');
            const form = document.getElementById('collector-form');
            
            if (!cinInput) return;
            
            // Créer le message d'erreur s'il n'existe pas
            let errorMsg = cinInput.parentElement.querySelector('.error-message');
            if (!errorMsg) {
                errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: none;';
                cinInput.parentElement.appendChild(errorMsg);
            }
            
            cinInput.addEventListener('input', function() {
                const cin = this.value.trim();
                const editId = form.dataset.editId;
                
                if (cin.length === 0) {
                    this.style.borderColor = '';
                    errorMsg.style.display = 'none';
                    return;
                }
                
                // Vérifier si le CIN existe déjà
                const exists = appData.collectors.some(c => {
                    if (editId && c.id == editId) return false; // Ignorer lors de la modification
                    return c.cin && c.cin.toLowerCase() === cin.toLowerCase();
                });
                
                if (exists) {
                    this.style.borderColor = '#d32f2f';
                    this.style.borderWidth = '2px';
                    errorMsg.textContent = '⚠️ Ce N° CIN existe déjà!';
                    errorMsg.style.display = 'block';
                } else {
                    this.style.borderColor = '#4caf50';
                    this.style.borderWidth = '2px';
                    errorMsg.style.display = 'none';
                }
            });
        }

        /**
         * Module d'export PDF amélioré pour le module RÉCEPTION (Collecte)
         * Version v1.5 - QR Code 100% HORS LIGNE
         */

        (function() {
            /**
             * Générateur de QR Code simple (bibliothèque qrcodegen intégrée)
             * Source: https://www.nayuki.io/page/qr-code-generator-library
             */
            const qrcodegen = (function() {
                'use strict';
                
                // Classe principale QrCode
                class QrCode {
                    constructor(version, errorCorrectionLevel, dataCodewords, mask) {
                        this.version = version;
                        this.errorCorrectionLevel = errorCorrectionLevel;
                        this.modules = [];
                        this.isFunction = [];
                        
                        const size = version * 4 + 17;
                        for (let i = 0; i < size; i++) {
                            this.modules.push([]);
                            this.isFunction.push([]);
                            for (let j = 0; j < size; j++) {
                                this.modules[i].push(false);
                                this.isFunction[i].push(false);
                            }
                        }
                        
                        this.size = size;
                        this.drawFunctionPatterns();
                        const allCodewords = this.addEccAndInterleave(dataCodewords);
                        this.drawCodewords(allCodewords);
                        
                        if (mask == -1) {
                            let minPenalty = 1000000000;
                            for (let i = 0; i < 8; i++) {
                                this.applyMask(i);
                                this.drawFormatBits(i);
                                const penalty = this.getPenaltyScore();
                                if (penalty < minPenalty) {
                                    mask = i;
                                    minPenalty = penalty;
                                }
                                this.applyMask(i);
                            }
                        }
                        this.mask = mask;
                        this.applyMask(mask);
                        this.drawFormatBits(mask);
                        
                        this.isFunction = [];
                    }
                    
                    static encodeText(text, ecl) {
                        const segs = QrSegment.makeSegments(text);
                        return QrCode.encodeSegments(segs, ecl);
                    }
                    
                    static encodeSegments(segs, ecl, minVersion = 1, maxVersion = 40, mask = -1, boostEcl = true) {
                        for (const seg of segs) {
                            if (seg.mode.modeBits >> 16 != 0)
                                throw "Assertion error";
                        }
                        
                        let version;
                        let dataUsedBits;
                        for (version = minVersion; ; version++) {
                            const dataCapacityBits = QrCode.getNumDataCodewords(version, ecl) * 8;
                            const usedBits = QrSegment.getTotalBits(segs, version);
                            if (usedBits != null && usedBits <= dataCapacityBits) {
                                dataUsedBits = usedBits;
                                break;
                            }
                            if (version >= maxVersion)
                                throw "Data too long";
                        }
                        
                        for (const newEcl of [QrCode.Ecc.MEDIUM, QrCode.Ecc.QUARTILE, QrCode.Ecc.HIGH]) {
                            if (boostEcl && dataUsedBits <= QrCode.getNumDataCodewords(version, newEcl) * 8)
                                ecl = newEcl;
                        }
                        
                        const bb = [];
                        for (const seg of segs) {
                            appendBits(seg.mode.modeBits, 4, bb);
                            appendBits(seg.numChars, seg.mode.numCharCountBits(version), bb);
                            for (const b of seg.getData())
                                bb.push(b);
                        }
                        
                        const dataCapacityBits = QrCode.getNumDataCodewords(version, ecl) * 8;
                        appendBits(0, Math.min(4, dataCapacityBits - bb.length), bb);
                        appendBits(0, (8 - bb.length % 8) % 8, bb);
                        for (let padByte = 0xEC; bb.length < dataCapacityBits; padByte ^= 0xEC ^ 0x11)
                            appendBits(padByte, 8, bb);
                        
                        const dataCodewords = [];
                        while (dataCodewords.length * 8 < bb.length)
                            dataCodewords.push(0);
                        bb.forEach((b, i) =>
                            dataCodewords[i >>> 3] |= b << (7 - (i & 7)));
                        
                        return new QrCode(version, ecl, dataCodewords, mask);
                    }
                    
                    getModule(x, y) {
                        return 0 <= x && x < this.size && 0 <= y && y < this.size && this.modules[y][x];
                    }
                    
                    drawFunctionPatterns() {
                        for (let i = 0; i < this.size; i++) {
                            this.setFunctionModule(6, i, i % 2 == 0);
                            this.setFunctionModule(i, 6, i % 2 == 0);
                        }
                        
                        this.drawFinderPattern(3, 3);
                        this.drawFinderPattern(this.size - 4, 3);
                        this.drawFinderPattern(3, this.size - 4);
                        
                        const alignPatPos = this.getAlignmentPatternPositions();
                        const numAlign = alignPatPos.length;
                        for (let i = 0; i < numAlign; i++) {
                            for (let j = 0; j < numAlign; j++) {
                                if (!(i == 0 && j == 0 || i == 0 && j == numAlign - 1 || i == numAlign - 1 && j == 0))
                                    this.drawAlignmentPattern(alignPatPos[i], alignPatPos[j]);
                            }
                        }
                        
                        this.drawFormatBits(0);
                        this.drawVersion();
                    }
                    
                    drawFormatBits(mask) {
                        const data = this.errorCorrectionLevel.formatBits << 3 | mask;
                        let rem = data;
                        for (let i = 0; i < 10; i++)
                            rem = (rem << 1) ^ ((rem >>> 9) * 0x537);
                        const bits = (data << 10 | rem) ^ 0x5412;
                        
                        for (let i = 0; i <= 5; i++)
                            this.setFunctionModule(8, i, getBit(bits, i));
                        this.setFunctionModule(8, 7, getBit(bits, 6));
                        this.setFunctionModule(8, 8, getBit(bits, 7));
                        this.setFunctionModule(7, 8, getBit(bits, 8));
                        for (let i = 9; i < 15; i++)
                            this.setFunctionModule(14 - i, 8, getBit(bits, i));
                        
                        for (let i = 0; i < 8; i++)
                            this.setFunctionModule(this.size - 1 - i, 8, getBit(bits, i));
                        for (let i = 8; i < 15; i++)
                            this.setFunctionModule(8, this.size - 15 + i, getBit(bits, i));
                        this.setFunctionModule(8, this.size - 8, true);
                    }
                    
                    drawVersion() {
                        if (this.version < 7)
                            return;
                        
                        let rem = this.version;
                        for (let i = 0; i < 12; i++)
                            rem = (rem << 1) ^ ((rem >>> 11) * 0x1F25);
                        const bits = this.version << 12 | rem;
                        
                        for (let i = 0; i < 18; i++) {
                            const color = getBit(bits, i);
                            const a = this.size - 11 + i % 3;
                            const b = Math.floor(i / 3);
                            this.setFunctionModule(a, b, color);
                            this.setFunctionModule(b, a, color);
                        }
                    }
                    
                    drawFinderPattern(x, y) {
                        for (let dy = -4; dy <= 4; dy++) {
                            for (let dx = -4; dx <= 4; dx++) {
                                const dist = Math.max(Math.abs(dx), Math.abs(dy));
                                const xx = x + dx;
                                const yy = y + dy;
                                if (0 <= xx && xx < this.size && 0 <= yy && yy < this.size)
                                    this.setFunctionModule(xx, yy, dist != 2 && dist != 4);
                            }
                        }
                    }
                    
                    drawAlignmentPattern(x, y) {
                        for (let dy = -2; dy <= 2; dy++) {
                            for (let dx = -2; dx <= 2; dx++)
                                this.setFunctionModule(x + dx, y + dy, Math.max(Math.abs(dx), Math.abs(dy)) != 1);
                        }
                    }
                    
                    setFunctionModule(x, y, isDark) {
                        this.modules[y][x] = isDark;
                        this.isFunction[y][x] = true;
                    }
                    
                    addEccAndInterleave(data) {
                        const ver = this.version;
                        const ecl = this.errorCorrectionLevel;
                        if (data.length != QrCode.getNumDataCodewords(ver, ecl))
                            throw "Invalid argument";
                        
                        const numBlocks = QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
                        const blockEccLen = QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver];
                        const rawCodewords = Math.floor(QrCode.getNumRawDataModules(ver) / 8);
                        const numShortBlocks = numBlocks - rawCodewords % numBlocks;
                        const shortBlockLen = Math.floor(rawCodewords / numBlocks);
                        
                        const blocks = [];
                        const rsDiv = QrCode.reedSolomonComputeDivisor(blockEccLen);
                        for (let i = 0, k = 0; i < numBlocks; i++) {
                            const dat = data.slice(k, k + shortBlockLen - blockEccLen + (i < numShortBlocks ? 0 : 1));
                            k += dat.length;
                            const ecc = QrCode.reedSolomonComputeRemainder(dat, rsDiv);
                            if (i < numShortBlocks)
                                dat.push(0);
                            blocks.push(dat.concat(ecc));
                        }
                        
                        const result = [];
                        for (let i = 0; i < blocks[0].length; i++) {
                            blocks.forEach((block, j) => {
                                if (i != shortBlockLen - blockEccLen || j >= numShortBlocks)
                                    result.push(block[i]);
                            });
                        }
                        return result;
                    }
                    
                    drawCodewords(data) {
                        if (data.length != Math.floor(QrCode.getNumRawDataModules(this.version) / 8))
                            throw "Invalid argument";
                        let i = 0;
                        for (let right = this.size - 1; right >= 1; right -= 2) {
                            if (right == 6)
                                right = 5;
                            for (let vert = 0; vert < this.size; vert++) {
                                for (let j = 0; j < 2; j++) {
                                    const x = right - j;
                                    const upward = ((right + 1) & 2) == 0;
                                    const y = upward ? this.size - 1 - vert : vert;
                                    if (!this.isFunction[y][x] && i < data.length * 8) {
                                        this.modules[y][x] = getBit(data[i >>> 3], 7 - (i & 7));
                                        i++;
                                    }
                                }
                            }
                        }
                    }
                    
                    applyMask(mask) {
                        if (mask < 0 || mask > 7)
                            throw "Mask value out of range";
                        for (let y = 0; y < this.size; y++) {
                            for (let x = 0; x < this.size; x++) {
                                let invert;
                                switch (mask) {
                                    case 0:  invert = (x + y) % 2 == 0;  break;
                                    case 1:  invert = y % 2 == 0;  break;
                                    case 2:  invert = x % 3 == 0;  break;
                                    case 3:  invert = (x + y) % 3 == 0;  break;
                                    case 4:  invert = (Math.floor(x / 3) + Math.floor(y / 2)) % 2 == 0;  break;
                                    case 5:  invert = x * y % 2 + x * y % 3 == 0;  break;
                                    case 6:  invert = (x * y % 2 + x * y % 3) % 2 == 0;  break;
                                    case 7:  invert = ((x + y) % 2 + x * y % 3) % 2 == 0;  break;
                                    default:  throw "Assertion error";
                                }
                                if (!this.isFunction[y][x] && invert)
                                    this.modules[y][x] = !this.modules[y][x];
                            }
                        }
                    }
                    
                    getPenaltyScore() {
                        let result = 0;
                        
                        // Adjacent modules in row having same color, and finder-like patterns
                        for (let y = 0; y < this.size; y++) {
                            let runColor = false;
                            let runX = 0;
                            const runHistory = [0, 0, 0, 0, 0, 0, 0];
                            for (let x = 0; x < this.size; x++) {
                                if (this.modules[y][x] == runColor) {
                                    runX++;
                                    if (runX == 5)
                                        result += QrCode.PENALTY_N1;
                                    else if (runX > 5)
                                        result++;
                                } else {
                                    this.finderPenaltyAddHistory(runX, runHistory);
                                    if (!runColor)
                                        result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                                    runColor = this.modules[y][x];
                                    runX = 1;
                                }
                            }
                            result += this.finderPenaltyTerminateAndCount(runColor, runX, runHistory) * QrCode.PENALTY_N3;
                        }
                        // Adjacent modules in column having same color, and finder-like patterns
                        for (let x = 0; x < this.size; x++) {
                            let runColor = false;
                            let runY = 0;
                            const runHistory = [0, 0, 0, 0, 0, 0, 0];
                            for (let y = 0; y < this.size; y++) {
                                if (this.modules[y][x] == runColor) {
                                    runY++;
                                    if (runY == 5)
                                        result += QrCode.PENALTY_N1;
                                    else if (runY > 5)
                                        result++;
                                } else {
                                    this.finderPenaltyAddHistory(runY, runHistory);
                                    if (!runColor)
                                        result += this.finderPenaltyCountPatterns(runHistory) * QrCode.PENALTY_N3;
                                    runColor = this.modules[y][x];
                                    runY = 1;
                                }
                            }
                            result += this.finderPenaltyTerminateAndCount(runColor, runY, runHistory) * QrCode.PENALTY_N3;
                        }
                        
                        // 2*2 blocks of modules having same color
                        for (let y = 0; y < this.size - 1; y++) {
                            for (let x = 0; x < this.size - 1; x++) {
                                const color = this.modules[y][x];
                                if (  color == this.modules[y][x + 1] &&
                                    color == this.modules[y + 1][x] &&
                                    color == this.modules[y + 1][x + 1])
                                    result += QrCode.PENALTY_N2;
                            }
                        }
                        
                        // Balance of dark and light modules
                        let dark = 0;
                        for (const row of this.modules)
                            dark = row.reduce((sum, color) => sum + (color ? 1 : 0), dark);
                        const total = this.size * this.size;
                        const k = Math.ceil(Math.abs(dark * 20 - total * 10) / total) - 1;
                        result += k * QrCode.PENALTY_N4;
                        return result;
                    }
                    
                    getAlignmentPatternPositions() {
                        if (this.version == 1)
                            return [];
                        else {
                            const numAlign = Math.floor(this.version / 7) + 2;
                            const step = (this.version == 32) ? 26 :
                                Math.ceil((this.version * 4 + 4) / (numAlign * 2 - 2)) * 2;
                            const result = [6];
                            for (let pos = this.size - 7; result.length < numAlign; pos -= step)
                                result.splice(1, 0, pos);
                            return result;
                        }
                    }
                    
                    static getNumRawDataModules(ver) {
                        let result = (16 * ver + 128) * ver + 64;
                        if (ver >= 2) {
                            const numAlign = Math.floor(ver / 7) + 2;
                            result -= (25 * numAlign - 10) * numAlign - 55;
                            if (ver >= 7)
                                result -= 36;
                        }
                        return result;
                    }
                    
                    static getNumDataCodewords(ver, ecl) {
                        return Math.floor(QrCode.getNumRawDataModules(ver) / 8) -
                            QrCode.ECC_CODEWORDS_PER_BLOCK[ecl.ordinal][ver] *
                            QrCode.NUM_ERROR_CORRECTION_BLOCKS[ecl.ordinal][ver];
                    }
                    
                    static reedSolomonComputeDivisor(degree) {
                        const result = [];
                        for (let i = 0; i < degree - 1; i++)
                            result.push(0);
                        result.push(1);
                        let root = 1;
                        for (let i = 0; i < degree; i++) {
                            for (let j = 0; j < result.length; j++) {
                                result[j] = QrCode.reedSolomonMultiply(result[j], root);
                                if (j + 1 < result.length)
                                    result[j] ^= result[j + 1];
                            }
                            root = QrCode.reedSolomonMultiply(root, 0x02);
                        }
                        return result;
                    }
                    
                    static reedSolomonComputeRemainder(data, divisor) {
                        const result = divisor.map(_ => 0);
                        for (const b of data) {
                            const factor = b ^ result.shift();
                            result.push(0);
                            divisor.forEach((coef, i) =>
                                result[i] ^= QrCode.reedSolomonMultiply(coef, factor));
                        }
                        return result;
                    }
                    
                    static reedSolomonMultiply(x, y) {
                        let z = 0;
                        for (let i = 7; i >= 0; i--) {
                            z = (z << 1) ^ ((z >>> 7) * 0x11D);
                            z ^= ((y >>> i) & 1) * x;
                        }
                        return z;
                    }
                    
                    finderPenaltyCountPatterns(runHistory) {
                        const n = runHistory[1];
                        const core = n > 0 && runHistory[2] == n && runHistory[3] == n * 3 && runHistory[4] == n && runHistory[5] == n;
                        return (core && runHistory[0] >= n * 4 && runHistory[6] >= n ? 1 : 0)
                            + (core && runHistory[6] >= n * 4 && runHistory[0] >= n ? 1 : 0);
                    }
                    
                    finderPenaltyTerminateAndCount(currentRunColor, currentRunLength, runHistory) {
                        if (currentRunColor) {
                            this.finderPenaltyAddHistory(currentRunLength, runHistory);
                            currentRunLength = 0;
                        }
                        currentRunLength += this.size;
                        this.finderPenaltyAddHistory(currentRunLength, runHistory);
                        return this.finderPenaltyCountPatterns(runHistory);
                    }
                    
                    finderPenaltyAddHistory(currentRunLength, runHistory) {
                        if (runHistory[0] == 0)
                            currentRunLength += this.size;
                        runHistory.pop();
                        runHistory.unshift(currentRunLength);
                    }
                }
                
                QrCode.MIN_VERSION = 1;
                QrCode.MAX_VERSION = 40;
                QrCode.PENALTY_N1 = 3;
                QrCode.PENALTY_N2 = 3;
                QrCode.PENALTY_N3 = 40;
                QrCode.PENALTY_N4 = 10;
                
                QrCode.ECC_CODEWORDS_PER_BLOCK = [
                    [-1,  7, 10, 15, 20, 26, 18, 20, 24, 30, 18, 20, 24, 26, 30, 22, 24, 28, 30, 28, 28, 28, 28, 30, 30, 26, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    [-1, 10, 16, 26, 18, 24, 16, 18, 22, 22, 26, 30, 22, 22, 24, 24, 28, 28, 26, 26, 26, 26, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28],
                    [-1, 13, 22, 18, 26, 18, 24, 18, 22, 20, 24, 28, 26, 24, 20, 30, 24, 28, 28, 26, 30, 28, 30, 30, 30, 30, 28, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    [-1, 17, 28, 22, 16, 22, 28, 26, 26, 24, 28, 24, 28, 22, 24, 24, 30, 28, 28, 26, 28, 30, 24, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                ];
                
                QrCode.NUM_ERROR_CORRECTION_BLOCKS = [
                    [-1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 4,  4,  4,  4,  4,  6,  6,  6,  6,  7,  8,  8,  9,  9, 10, 12, 12, 12, 13, 14, 15, 16, 17, 18, 19, 19, 20, 21, 22, 24, 25],
                    [-1, 1, 1, 1, 2, 2, 4, 4, 4, 5, 5,  5,  8,  9,  9, 10, 10, 11, 13, 14, 16, 17, 17, 18, 20, 21, 23, 25, 26, 28, 29, 31, 33, 35, 37, 38, 40, 43, 45, 47, 49],
                    [-1, 1, 1, 2, 2, 4, 4, 6, 6, 8, 8,  8, 10, 12, 16, 12, 17, 16, 18, 21, 20, 23, 23, 25, 27, 29, 34, 34, 35, 38, 40, 43, 45, 48, 51, 53, 56, 59, 62, 65, 68],
                    [-1, 1, 1, 2, 4, 4, 4, 5, 6, 8, 8, 11, 11, 16, 16, 18, 16, 19, 21, 25, 25, 25, 34, 30, 32, 35, 37, 40, 42, 45, 48, 51, 54, 57, 60, 63, 66, 70, 74, 77, 81],
                ];
                
                // Classe Ecc (Error Correction Level)
                class Ecc {
                    constructor(ordinal, formatBits) {
                        this.ordinal = ordinal;
                        this.formatBits = formatBits;
                    }
                }
                
                QrCode.Ecc = {
                    LOW     : new Ecc(0, 1),
                    MEDIUM  : new Ecc(1, 0),
                    QUARTILE: new Ecc(2, 3),
                    HIGH    : new Ecc(3, 2),
                };
                
                // Classe QrSegment
                class QrSegment {
                    constructor(mode, numChars, bitData) {
                        this.mode = mode;
                        this.numChars = numChars;
                        this.bitData = bitData;
                    }
                    
                    static makeBytes(data) {
                        const bb = [];
                        for (const b of data)
                            appendBits(b, 8, bb);
                        return new QrSegment(QrSegment.Mode.BYTE, data.length, bb);
                    }
                    
                    static makeNumeric(digits) {
                        const bb = [];
                        for (let i = 0; i < digits.length; ) {
                            const n = Math.min(digits.length - i, 3);
                            appendBits(parseInt(digits.substr(i, n), 10), n * 3 + 1, bb);
                            i += n;
                        }
                        return new QrSegment(QrSegment.Mode.NUMERIC, digits.length, bb);
                    }
                    
                    static makeAlphanumeric(text) {
                        const bb = [];
                        let i;
                        for (i = 0; i + 2 <= text.length; i += 2) {
                            let temp = QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)) * 45;
                            temp += QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i + 1));
                            appendBits(temp, 11, bb);
                        }
                        if (i < text.length)
                            appendBits(QrSegment.ALPHANUMERIC_CHARSET.indexOf(text.charAt(i)), 6, bb);
                        return new QrSegment(QrSegment.Mode.ALPHANUMERIC, text.length, bb);
                    }
                    
                    static makeSegments(text) {
                        if (text == "")
                            return [];
                        else if (QrSegment.isNumeric(text))
                            return [QrSegment.makeNumeric(text)];
                        else if (QrSegment.isAlphanumeric(text))
                            return [QrSegment.makeAlphanumeric(text)];
                        else
                            return [QrSegment.makeBytes(QrSegment.toUtf8ByteArray(text))];
                    }
                    
                    static makeEci(assignVal) {
                        const bb = [];
                        if (assignVal < 0)
                            throw "ECI assignment value out of range";
                        else if (assignVal < (1 << 7))
                            appendBits(assignVal, 8, bb);
                        else if (assignVal < (1 << 14)) {
                            appendBits(2, 2, bb);
                            appendBits(assignVal, 14, bb);
                        } else if (assignVal < 1000000) {
                            appendBits(6, 3, bb);
                            appendBits(assignVal, 21, bb);
                        } else
                            throw "ECI assignment value out of range";
                        return new QrSegment(QrSegment.Mode.ECI, 0, bb);
                    }
                    
                    static isNumeric(text) {
                        return QrSegment.NUMERIC_REGEX.test(text);
                    }
                    
                    static isAlphanumeric(text) {
                        return QrSegment.ALPHANUMERIC_REGEX.test(text);
                    }
                    
                    getData() {
                        return this.bitData.slice();
                    }
                    
                    static getTotalBits(segs, version) {
                        let result = 0;
                        for (const seg of segs) {
                            const ccbits = seg.mode.numCharCountBits(version);
                            if (seg.numChars >= (1 << ccbits))
                                return null;
                            result += 4 + ccbits + seg.bitData.length;
                        }
                        return result;
                    }
                    
                    static toUtf8ByteArray(str) {
                        str = encodeURI(str);
                        const result = [];
                        for (let i = 0; i < str.length; i++) {
                            if (str.charAt(i) != "%")
                                result.push(str.charCodeAt(i));
                            else {
                                result.push(parseInt(str.substr(i + 1, 2), 16));
                                i += 2;
                            }
                        }
                        return result;
                    }
                }
                
                QrSegment.NUMERIC_REGEX = /^[0-9]*$/;
                QrSegment.ALPHANUMERIC_REGEX = /^[A-Z0-9 $%*+.\/:-]*$/;
                QrSegment.ALPHANUMERIC_CHARSET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:";
                
                // Classe Mode
                class Mode {
                    constructor(modeBits, numBitsCharCount) {
                        this.modeBits = modeBits;
                        this.numBitsCharCount = numBitsCharCount;
                    }
                    
                    numCharCountBits(ver) {
                        return this.numBitsCharCount[Math.floor((ver + 7) / 17)];
                    }
                }
                
                QrSegment.Mode = {
                    NUMERIC     : new Mode(0x1, [10, 12, 14]),
                    ALPHANUMERIC: new Mode(0x2, [ 9, 11, 13]),
                    BYTE        : new Mode(0x4, [ 8, 16, 16]),
                    KANJI       : new Mode(0x8, [ 8, 10, 12]),
                    ECI         : new Mode(0x7, [ 0,  0,  0]),
                };
                
                function appendBits(val, len, bb) {
                    if (len < 0 || len > 31 || val >>> len != 0)
                        throw "Value out of range";
                    for (let i = len - 1; i >= 0; i--)
                        bb.push((val >>> i) & 1);
                }
                
                function getBit(x, i) {
                    return ((x >>> i) & 1) != 0;
                }
                
                return {QrCode, QrSegment};
            })();

            /**
             * Génère un QR Code en SVG (format Data URL)
             */
            function generateQRCodeSVG(text) {
                const qr = qrcodegen.QrCode.encodeText(text, qrcodegen.QrCode.Ecc.MEDIUM);
                const border = 2;
                const parts = [];
                
                for (let y = 0; y < qr.size; y++) {
                    for (let x = 0; x < qr.size; x++) {
                        if (qr.getModule(x, y))
                            parts.push(`M${x + border},${y + border}h1v1h-1z`);
                    }
                }
                
                const svg = `<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 ${qr.size + border * 2} ${qr.size + border * 2}" stroke="none">
            <rect width="100%" height="100%" fill="#FFFFFF"/>
            <path d="${parts.join(" ")}" fill="#000000"/>
        </svg>`;
                
                return 'data:image/svg+xml;base64,' + btoa(svg);
            }

            /**
             * Génère un PDF au format A4 classique
             */
            function generateReceiptA4(receptionId) {
                const baseReception = appData.receptions.find(r => r.id === receptionId);
                if (!baseReception) return;
                
                const receptionDate = baseReception.date;
                const collectorId = baseReception.collectorId;
                const collector = appData.collectors.find(c => c.id === collectorId);
                const dailyReceptions = appData.receptions.filter(r => r.collectorId === collectorId && r.date === receptionDate);
                const totalNetWeight = dailyReceptions.reduce((sum, r) => sum + r.netWeight, 0);
                const totalValue = dailyReceptions.reduce((sum, r) => sum + r.totalValue, 0);
                const receiptNum = `R${new Date(receptionDate).getTime().toString().slice(-5)}${collectorId}`;

                let pdfContent = `
                    <html>
                    <head>
                        <title>Reçu - ${collector.name}</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20mm; color: #333; line-height: 1.5; }
                            .container { max-width: 800px; margin: auto; border: 1px solid #eee; padding: 40px; border-radius: 10px; }
                            .header { text-align: center; border-bottom: 3px solid #6750a4; padding-bottom: 20px; margin-bottom: 30px; }
                            .company { font-size: 32px; font-weight: bold; color: #6750a4; margin: 0; }
                            .title { font-size: 18px; color: #666; text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; }
                            .info { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 15px; background: #fcfaff; padding: 20px; border-radius: 8px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                            th { background: #6750a4; color: white; padding: 12px; text-align: left; }
                            td { padding: 12px; border-bottom: 1px solid #eee; }
                            .total { font-weight: bold; background: #fcfaff; font-size: 16px; color: #6750a4; }
                            .footer { margin-top: 60px; display: flex; justify-content: space-between; }
                            .sig { width: 45%; border-top: 1px solid #333; text-align: center; padding-top: 10px; font-size: 13px; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <div class="company">BEHAVANA</div>
                                <div class="title">Reçu de Réception</div>
                            </div>
                            <div class="info">
                                <div>
                                    <strong>Collecteur:</strong> ${collector.name}<br>
                                    <strong>CIN:</strong> ${collector.cin || 'N/A'}
                                </div>
                                <div style="text-align:right;">
                                    <strong>Date:</strong> ${formatDate(receptionDate)}<br>
                                    <strong>N° Reçu:</strong> ${receiptNum}
                                </div>
                            </div>
                            <table>
                                <thead><tr><th>Qualité</th><th style="text-align:right">Poids Net (kg)</th><th style="text-align:right">Valeur (Ar)</th></tr></thead>
                                <tbody>
                                    ${dailyReceptions.map(r => `<tr><td>Vanille ${r.quality}</td><td style="text-align:right">${r.netWeight.toFixed(2)}</td><td style="text-align:right">${formatCurrency(r.totalValue)}</td></tr>`).join('')}
                                    <tr class="total"><td>TOTAL</td><td style="text-align:right">${totalNetWeight.toFixed(2)} kg</td><td style="text-align:right">${formatCurrency(totalValue)}</td></tr>
                                </tbody>
                            </table>
                            <div class="footer"><div class="sig">Le Collecteur</div><div class="sig">Pour BEHAVANA</div></div>
                            <div style="text-align:center; margin-top:40px; font-size:10px; color:#999;">Imprimé le ${new Date().toLocaleString()}</div>
                        </div>
                    </body>
                    </html>`;
                const win = window.open('', '_blank');
                win.document.write(pdfContent);
                win.document.close();
                win.print();
            }

            /**
             * Génère un ticket thermique réaliste 80mm avec QR code HORS LIGNE
             */
            function generateReceiptThermal(receptionId) {
                const baseReception = appData.receptions.find(r => r.id === receptionId);
                if (!baseReception) return;

                const receptionDate = baseReception.date;
                const collectorId = baseReception.collectorId;
                const collector = appData.collectors.find(c => c.id === collectorId);
                const dailyReceptions = appData.receptions.filter(r => r.collectorId === collectorId && r.date === receptionDate);
                const totalNetWeight = dailyReceptions.reduce((sum, r) => sum + r.netWeight, 0);
                const totalValue = dailyReceptions.reduce((sum, r) => sum + r.totalValue, 0);
                const receiptNum = `R${new Date(receptionDate).getTime().toString().slice(-5)}${collectorId}`;

                // ✅ GÉNÉRATION DU QR CODE HORS LIGNE
                const qrData = `BEHAVANA-${receiptNum}-${collector.name}-${totalNetWeight.toFixed(2)}kg-${formatCurrency(totalValue)}Ar`;
                const qrCodeDataURL = generateQRCodeSVG(qrData);

                let pdfContent = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            @page { 
                                size: 80mm 297mm;
                                margin: 0;
                            }
                            @media print {
                                @page {
                                    size: 80mm 297mm;
                                    margin: 0;
                                }
                                html, body {
                                    width: 80mm;
                                    height: auto;
                                }
                            }
                            * { 
                                margin: 0; 
                                padding: 0; 
                                box-sizing: border-box; 
                            }
                            html {
                                width: 80mm;
                            }
                            body { 
                                font-family: 'Courier New', 'Consolas', monospace; 
                                width: 80mm;
                                max-width: 80mm;
                                padding: 3mm 4mm;
                                font-size: 9pt;
                                line-height: 1.4;
                                color: #000;
                                background: white;
                            }
                            .center { text-align: center; }
                            .right { text-align: right; }
                            .bold { font-weight: bold; }
                            .large { font-size: 11pt; }
                            .xlarge { font-size: 13pt; }
                            .small { font-size: 8pt; }
                            .xsmall { font-size: 7pt; }
                            
                            .separator { 
                                border-bottom: 1px dashed #000; 
                                margin: 4mm 0; 
                            }
                            
                            .double-separator {
                                border-bottom: 2px solid #000;
                                margin: 3mm 0;
                            }
                            
                            .header {
                                margin-bottom: 3mm;
                            }
                            
                            .line {
                                display: flex;
                                justify-content: space-between;
                                margin: 1mm 0;
                            }
                            
                            .item-line {
                                display: flex;
                                justify-content: space-between;
                                padding: 1mm 0;
                                font-size: 8.5pt;
                            }
                            
                            .total-box {
                                border: 2px solid #000;
                                padding: 3mm;
                                margin: 4mm 0;
                                text-align: center;
                            }
                            
                            .barcode-container {
                                text-align: center;
                                margin: 5mm 0;
                            }
                            
                            .signature-area {
                                margin-top: 8mm;
                                text-align: center;
                            }
                            
                            .signature-line {
                                border-top: 1px solid #000;
                                width: 50mm;
                                margin: 3mm auto 2mm auto;
                            }
                        </style>
                    </head>
                    <body>
                        <!-- En-tête -->
                        <div class="header center">
                            <div class="bold xlarge">BEHAVANA</div>
                            <div class="bold large">RECU RECEPTION</div>
                        </div>
                        
                        <div class="separator"></div>
                        
                        <!-- Informations réception -->
                        <div class="small">
                            <div class="line">
                                <span>N° Recu:</span>
                                <span class="bold">${receiptNum}</span>
                            </div>
                            <div class="line">
                                <span>Date:</span>
                                <span>${formatDate(receptionDate)}</span>
                            </div>
                            <div class="line">
                                <span>Collecteur:</span>
                                <span>${collector.name}</span>
                            </div>
                        </div>
                        
                        <div class="separator"></div>
                        
                        <!-- Articles -->
                        <div class="small bold">DETAILS:</div>
                        <div style="margin-top: 2mm;">
                            ${dailyReceptions.map(r => `
                                <div class="item-line">
                                    <span>Vanille ${r.quality}</span>
                                    <span class="bold">${r.netWeight.toFixed(2)} kg</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="double-separator"></div>
                        
                        <!-- Total -->
                        <div class="total-box">
                            <div class="bold large">TOTAL POIDS</div>
                            <div class="bold xlarge" style="margin: 2mm 0;">${totalNetWeight.toFixed(2)} kg</div>
                            <div class="separator" style="margin: 3mm 0;"></div>
                            <div class="bold">VALEUR TOTALE</div>
                            <div class="bold xlarge" style="margin-top: 1mm;">${formatCurrency(totalValue)}</div>
                        </div>
                        
                        <!-- QR Code généré HORS LIGNE ✅ -->
                        <div class="barcode-container">
                            <img src="${qrCodeDataURL}" 
                                alt="QR Code" 
                                style="width: 35mm; height: 35mm; margin: 2mm auto; display: block;">
                            <div class="xsmall">${receiptNum}</div>
                        </div>
                        
                        <div class="separator"></div>
                        
                        <!-- Signature -->
                        <div class="signature-area">
                            <div class="xsmall">Signature du collecteur</div>
                            <div class="signature-line"></div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="center xsmall" style="margin-top: 6mm; color: #666;">
                            Merci de votre confiance<br>
                            ${new Date().toLocaleString('fr-FR')}
                        </div>
                    </body>
                    </html>`;
                    
                const win = window.open('', '_blank');
                win.document.write(pdfContent);
                win.document.close();
                setTimeout(() => win.print(), 250);
            }

            /**
             * Exposer les fonctions globalement
             */
            window.generateReceiptA4 = generateReceiptA4;
            window.generateReceiptThermal = generateReceiptThermal;

            /**
             * Modal de sélection de format - Version épurée et minimaliste
             */
            window.generateReceipt = function(receptionId) {
                // Supprimer le modal s'il existe déjà
                const existing = document.getElementById('behavanaPrintModal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'behavanaPrintModal';
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;';
                
                modal.innerHTML = `
                    <div style="background:white;padding:32px;border-radius:8px;width:340px;box-shadow:0 4px 24px rgba(0,0,0,0.15);">
                        <h3 style="margin:0 0 8px 0;color:#1a1a1a;font-size:20px;font-weight:600;">Impression du reçu</h3>
                        <p style="font-size:14px;color:#666;margin:0 0 24px 0;line-height:1.5;">Choisissez le format d'impression</p>
                        
                        <button id="btnA4" style="width:100%;padding:16px;margin-bottom:10px;border:1px solid #e0e0e0;border-radius:6px;background:white;color:#1a1a1a;font-weight:500;cursor:pointer;font-size:15px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;">
                            <span style="font-size:18px;">📄</span>
                            <span>Format A4</span>
                        </button>
                        
                        <button id="btnThermal" style="width:100%;padding:16px;margin-bottom:20px;border:1px solid #e0e0e0;border-radius:6px;background:white;color:#1a1a1a;font-weight:500;cursor:pointer;font-size:15px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;">
                            <span style="font-size:18px;">🧾</span>
                            <span>Ticket 80mm</span>
                        </button>
                        
                        <button onclick="document.getElementById('behavanaPrintModal').remove()" style="width:100%;padding:12px;background:none;border:none;color:#666;cursor:pointer;font-size:14px;border-radius:6px;transition:background 0.2s;">
                            Annuler
                        </button>
                    </div>`;
                    
                document.body.appendChild(modal);

                // Effets hover
                const btnA4 = document.getElementById('btnA4');
                const btnThermal = document.getElementById('btnThermal');
                
                btnA4.onmouseenter = () => btnA4.style.background = '#f5f5f5';
                btnA4.onmouseleave = () => btnA4.style.background = 'white';
                btnThermal.onmouseenter = () => btnThermal.style.background = '#f5f5f5';
                btnThermal.onmouseleave = () => btnThermal.style.background = 'white';

                // Actions des boutons
                btnA4.onclick = () => { generateReceiptA4(receptionId); modal.remove(); };
                btnThermal.onclick = () => { generateReceiptThermal(receptionId); modal.remove(); };
                
                // Fermeture au clic extérieur
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                // Fermeture avec Escape
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            };
        })();

    </script>
</body>

</html>