<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEHAVANA - Système de Gestion</title>
    <!-- ... ao anatin'ny <head> ... -->
    <meta name="theme-color" content="#6750a4">
    <link rel="manifest" href="/behavana-app/manifest.json">
    <!-- ... -->

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --md-sys-color-primary: #6750a4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #eaddff;
            --md-sys-color-on-primary-container: #21005d;
            --md-sys-color-secondary: #625b71;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #e8def8;
            --md-sys-color-on-secondary-container: #1d192b;
            --md-sys-color-tertiary: #7d5260;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #ffd8e4;
            --md-sys-color-on-tertiary-container: #31111d;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;
            --md-sys-color-success: #2e7d32;
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-success-container: #e8f5e8;
            --md-sys-color-on-success-container: #1b5e20;
            --md-sys-color-background: #fffbfe;
            --md-sys-color-on-background: #1c1b1f;
            --md-sys-color-surface: #fffbfe;
            --md-sys-color-on-surface: #1c1b1f;
            --md-sys-color-surface-variant: #e7e0ec;
            --md-sys-color-on-surface-variant: #49454f;
            --md-sys-color-outline: #79747e;
            --md-sys-color-outline-variant: #cab6d0;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #f4eff4;
            --md-sys-color-inverse-primary: #d0bcff;
            --md-sys-color-surface-tint: #6750a4;
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #d0bcff;
            --md-sys-color-on-primary: #381e72;
            --md-sys-color-primary-container: #4f378b;
            --md-sys-color-on-primary-container: #eaddff;
            --md-sys-color-secondary: #ccc2dc;
            --md-sys-color-on-secondary: #332d41;
            --md-sys-color-secondary-container: #4a4458;
            --md-sys-color-on-secondary-container: #e8def8;
            --md-sys-color-tertiary: #efb8c8;
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633b48;
            --md-sys-color-on-tertiary-container: #ffd8e4;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-on-error: #690005;
            --md-sys-color-error-container: #93000a;
            --md-sys-color-on-error-container: #ffdad6;
            --md-sys-color-success: #a5d6a7;
            --md-sys-color-on-success: #1b5e20;
            --md-sys-color-success-container: #2e7d32;
            --md-sys-color-on-success-container: #e8f5e8;
            --md-sys-color-background: #10081c;
            --md-sys-color-on-background: #e6e1e5;
            --md-sys-color-surface: #10081c;
            --md-sys-color-on-surface: #e6e1e5;
            --md-sys-color-surface-variant: #49454f;
            --md-sys-color-on-surface-variant: #cab6d0;
            --md-sys-color-outline: #938f99;
            --md-sys-color-outline-variant: #49454f;
            --md-sys-color-shadow: #000000;
            --md-sys-color-scrim: #000000;
            --md-sys-color-inverse-surface: #e6e1e5;
            --md-sys-color-inverse-on-surface: #313033;
            --md-sys-color-inverse-primary: #6750a4;
            --md-sys-color-surface-tint: #d0bcff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: all 0.3s ease;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--md-sys-color-surface);
            border-right: 1px solid var(--md-sys-color-outline-variant);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            /*font-size: 24px;*/
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
        }

        .company-subtitle {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            padding: 24px 0;
        }

        .nav-item {
            margin: 4px 12px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-link:hover {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .nav-link.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 24px;
            transition: all 0.3s ease;
        }

        /* Manome endrika boribory kokoa sy malefaka kokoa ny scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--md-sys-color-surface-variant);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--md-sys-color-primary);
            border-radius: 10px;
            border: 2px solid var(--md-sys-color-surface-variant);
        }



        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            background-color: var(--md-sys-color-surface);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            letter-spacing: 0.5px;
        }

        /* Manampy fihetsehana malefaka rehefa alefa eo amboniny ny totozy */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary:hover {
            background-color: #5a3e9a; /* Loko maizina kely rehefa voatondro */
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }

        /* Enhanced Dashboard Overview */
        .dashboard-overview {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-overview::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" opacity="0.1"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>') no-repeat;
            background-size: contain;
        }

        .dashboard-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--md-sys-color-on-primary-container);
            margin-bottom: 8px;
        }

        .dashboard-subtitle {
            font-size: 16px;
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
            margin-bottom: 24px;
        }

        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .overview-stat {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .overview-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--md-sys-color-on-primary-container);
            margin-bottom: 4px;
        }

        .overview-stat-label {
            font-size: 14px;
            color: var(--md-sys-color-on-primary-container);
            opacity: 0.8;
        }

        /* Ampiana any amin'ny faran'ny CSS */

        /* --- Toast / Snackbar --- */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            color: var(--md-sys-color-on-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9999; /* Mba ho eo ambonin'ny zavatra rehetra */
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-weight: 500;
        }

        /* Fampisehoana azy */
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Fanesorana azy */
        .toast.hide {
            opacity: 0;
        }

        /* Karazana "Success" (fahombiazana) */
        .toast.success {
            background-color: var(--md-sys-color-success);
            color: var(--md-sys-color-on-success);
        }

        /* Karazana "Error" (fahadisoana) */
        .toast.error {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }
 

        /* Ampiana any amin'ny faran'ny CSS */
        .global-search-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 24px;
            padding: 4px 16px;
            flex-grow: 0.5; /* Mba haka toerana malalaka kely */
            max-width: 400px;
            transition: all 0.2s ease;
        }

        .global-search-wrapper:focus-within {
            background-color: var(--md-sys-color-surface);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary);
        }

        .global-search-wrapper .material-icons {
            color: var(--md-sys-color-on-surface-variant);
            margin-right: 8px;
        }

        #global-search-input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            padding: 8px 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }



        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background-color: var(--md-sys-color-surface);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            opacity: 0.8;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 15px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 12px;
        }

        .stat-trend.positive {
            color: var(--md-sys-color-success);
        }

        .stat-trend.negative {
            color: var(--md-sys-color-error);
        }

        .stat-trend.neutral {
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Solde Global Card - Special styling */
        .solde-global-card {
            background: linear-gradient(135deg, var(--md-sys-color-success-container), var(--md-sys-color-success));
            color: var(--md-sys-color-on-success);
        }

        .solde-global-card.debiteur {
            background: linear-gradient(135deg, var(--md-sys-color-error-container), var(--md-sys-color-error));
            color: var(--md-sys-color-on-error);
        }

        .solde-global-card.equilibre {
            background: linear-gradient(135deg, var(--md-sys-color-secondary-container), var(--md-sys-color-secondary));
            color: var(--md-sys-color-on-secondary);
        }

        .solde-global-card .stat-value,
        .solde-global-card .stat-label,
        .solde-global-card .stat-trend {
            color: inherit;
        }

        .solde-global-card .stat-icon {
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--md-sys-color-outline-variant);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .summary-insights {
            background-color: var(--md-sys-color-surface);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--md-sys-color-outline-variant);
            margin-bottom: 32px;
        }

        .insights-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            background-color: var(--md-sys-color-surface-variant);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--md-sys-color-on-primary);
        }

        .insight-content {
            flex: 1;
        }

        .insight-text {
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .insight-detail {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .data-table {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-header {
            padding: 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th, td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            vertical-align: top;
        }

        th {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: sticky;                       
            top: 0;                                
            z-index: 10;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        tbody tr:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        td {
            color: var(--md-sys-color-on-surface);
            word-wrap: break-word;                  /* ← NAMPIANA */
            overflow-wrap: break-word;
        }

        .form-container {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 8px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(103, 80, 164, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 8px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 16px;
            cursor: pointer;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-debiteur {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }

        .status-crediteur {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-equilibre {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--md-sys-color-surface);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            animation: scaleIn 0.3s ease forwards;
        }

        @keyframes scaleIn {
            to { transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--md-sys-color-on-surface);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-danger {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }

        .btn-success {
            background-color: #4caf50;
            color: white;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px;
            min-width: auto;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .empty-state .material-icons {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Ny bokotra dia hita foana */
        #sidebar-toggle {
            margin-right: 16px; /* Mba hisy elanelany kely */
        }

        /* Rehefa manana ny kilasy 'collapsed' ny sidebar */
        .sidebar.collapsed {
            width: 80px; /* Ahena ny sakany fa tsy afenina tanteraka */
            overflow: hidden; /* Afenina ny lahatsoratra mihoatra */
        }

        /* Afenina ny lahatsoratra fa avela ny sary masina (icon) */
        .sidebar.collapsed .nav-link span:not(.material-icons) {
            display: none;
        }

        /* Rehefa manana ny kilasy 'expanded' ny atiny */
        .main-content.sidebar-collapsed {
            margin-left: 80px; /* Ahitsy ny sisin'ny atiny */
        }


        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 1001;
                background: var(--md-sys-color-primary);
                color: var(--md-sys-color-on-primary);
                border: none;
                border-radius: 12px;
                padding: 12px;
                font-size: 24px;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                position: fixed;
                z-index: 1000;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding-top: 80px;
            }
        
        

            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }

            .overview-stats {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .data-table table,
            .data-table thead,
            .data-table tbody,
            .data-table th,
            .data-table td,
            .data-table tr {
                display: block;
            }
            
            .data-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .data-table tr {
                border: 1px solid var(--md-sys-color-outline-variant);
                border-radius: 16px;
                margin-bottom: 16px;
                padding: 16px;
                background: var(--md-sys-color-surface);
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .data-table td {
                border: none;
                border-bottom: 1px solid var(--md-sys-color-outline-variant); /* Tsipika manasaraka isaky ny andininy */
                position: relative;
                padding-left: 50%;
                padding-top: 12px;
                padding-bottom: 12px;
                min-height: 40px; /* Mba tsy hifaningotra */
                display: flex;
                align-items: center;
            }
            
            .data-table tr td:last-child {
                border-bottom: none; /* Esory ny tsipika amin'ny farany */
            }

            .data-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--md-sys-color-on-surface-variant);
                font-size: 13px;
            }
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--md-sys-color-outline-variant);
            border-top: 3px solid var(--md-sys-color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ampiana any amin'ny faran'ny CSS */
        th {
            cursor: pointer; /* Mampiseho fa azo tsindriana */
            user-select: none; /* Mba tsy ho voamarika ny soratra rehefa tsindriana */
            position: relative;
        }

        /* Manampy zana-tsipìka kely aorian'ny soratra */
        th::after {
            content: ' ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            opacity: 0.3;
        }

        /* Zana-tsipìka manondro ambony (miakatra) */
        th.asc::after {
            border-bottom-color: var(--md-sys-color-on-surface-variant);
            opacity: 1;
        }

        /* Zana-tsipìka manondro ambany (midina) */
        th.desc::after {
            border-top-color: var(--md-sys-color-on-surface-variant);
            opacity: 1;
        }


        /* Endrika ho an'ny karatra "Collecteurs en Dette" rehefa azo tsindriana */
        #debtors-card.clickable {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #debtors-card.clickable:hover {
            background-color: var(--md-sys-color-primary-container);
            transform: scale(1.02);
        }

        /* Manampy zana-tsipìka kely ho marika */
        #debtors-card.clickable .insight-content::after {
            content: 'arrow_forward';
            font-family: 'Material Icons';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-primary);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        #debtors-card.clickable:hover .insight-content::after {
            opacity: 1;
        }

        /* Mba hiasan'ny ::after dia mila position relative ny parent */
        .insight-content {
            position: relative;
        }

        /* ======== CSS VAOVAO HO AN'NY SIGNATURE/CRÉDIT ======== */
        .credit-card {
            display: flex;
            align-items: center;
            gap: 20px;
            background-color: var(--md-sys-color-surface-variant );
            color: var(--md-sys-color-on-surface-variant);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .credit-icon {
            /* 1. Famaritana ny haben'ilay faribolana */
            width: 70px;
            height: 70px;

            /* 2. Fanaovana azy ho boribory sy fametrahana ny sisiny */
            border-radius: 50%;
            border: 3px solid var(--md-sys-color-primary); /* Nalehibeazina kely ny sisiny */
            flex-shrink: 0; /* Mba tsy hiovaova ny habeny */
            background-color: var(--md-sys-color-surface); /* Loko fototra raha misy tsisin'ny sary */

            /* 3. Fametrahana ny sary ho "background" */
            background-image: url('logo.jpg'); /* <--- OVAY ETO NY ANARAN'NY SARINAO */

            /* 4. Ireto no manao ny MAZIA: Mifehy ny fisehon'ny sary ao anaty faribolana */
            background-size: cover;     /* Mampanitatra ny sary mba hameno ilay faribolana */
            background-position: center; /* Mametraka ny sary eo afovoany tsara */
            background-repeat: no-repeat;  /* Mba tsy hiverimberina ilay sary */
        }


        .credit-text {
            flex-grow: 1;
        }

        .credit-text p {
            font-size: 14px;
            margin: 0;
        }

        .credit-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-primary);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .credit-name:hover {
            text-decoration: underline;
            color: var(--md-sys-color-tertiary);
        }

        .credit-version {
            font-size: 12px;
            font-weight: 500;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            padding: 4px 10px;
            border-radius: 8px;
        }


    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar" role="navigation" aria-label="Menu principal">
            <div class="sidebar-header">
                <div class="logo">
                    <!-- Kaody vaovao misy ny icon vanille SVG -->
                    <div class="logo-icon">
                        <i class="fa-solid fa-spa" style="font-size: 24px;"></i>
                    </div>



                    <div>
                        <div class="company-name">BEHAVANA</div>
                        <div class="company-subtitle">Gestion de Collecte</div>
                    </div>
                </div>
            </div>
            
            <ul class="nav-menu" role="menubar">
                <li class="nav-item" role="none">
                    <a class="nav-link active" data-section="dashboard" role="menuitem" aria-current="page" tabindex="0">
                        <span class="material-icons" aria-hidden="true">dashboard</span>
                        Tableau de Bord
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="collectors" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">people</span>
                        Collecteurs
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="advances" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">account_balance_wallet</span>
                        Avances
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="remboursements" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">paid</span>
                        Remboursements
                    </a>
                </li>
                <!-- =================== -->
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="paiements" role="menuitem" tabindex="-1">
                        <span class="material-icons" style="transform: scaleX(-1);">payments</span>
                        Paiements Effectués
                    </a>
                </li>
                <!-- =================== -->
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="expenses" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">receipt_long</span>
                        Dépenses
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="reception" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">inventory</span>
                        Réception Vanille
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="delivery" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">local_shipping</span>
                        Livraison Export
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="analysis" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">analytics</span>
                        Suivi & Analyse
                    </a>
                </li>
                <li class="nav-item" role="none">
                    <a class="nav-link" data-section="settings" role="menuitem" tabindex="-1">
                        <span class="material-icons" aria-hidden="true">settings</span>
                        Paramètres
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <button id="sidebar-toggle" class="btn btn-icon" title="Afeno/Asehoy ny sisin-dàlana">
                    <span class="material-icons" aria-hidden="true">menu_open</span>
                </button>
                <h1 id="page-title">Tableau de Bord</h1>
                <div class="global-search-wrapper">
                    <span class="material-icons">search</span>
                    <input id="global-search-input" 
                        type="text" 
                        placeholder="Recherche Globale..." 
                        oninput="globalSearch()">
                </div>

                <div class="header-actions">
                    <button class="theme-toggle" id="theme-toggle" aria-label="Manova ny lohahevitra (maizina/mazava)">
                        <span class="material-icons" aria-hidden="true">dark_mode</span>
                    </button>
                    <button class="btn btn-outline" onclick="exportData()">
                        <span class="material-icons">download</span>
                        Exporter
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section class="content-section active" id="dashboard">
                <!-- Dashboard Overview -->
                <div class="dashboard-overview">
                    <div class="dashboard-title">Aperçu Global</div>
                    <div class="dashboard-subtitle">État financier et opérationnel de BEHAVANA</div>
                    
                    <div class="overview-stats">
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-collectors">0</div>
                            <div class="overview-stat-label">Collecteurs Actifs</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-transactions">0</div>
                            <div class="overview-stat-label">Transactions Totales</div>
                        </div>
                        <div class="overview-stat">
                            <div class="overview-stat-value" id="overview-month">Ce Mois</div>
                            <div class="overview-stat-label">Période Active</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Stats Grid -->
                <div class="stats-grid">
                    <!-- Total Avances -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-advances">0 Ar</div>
                                <div class="stat-label">Total Avances Accordées</div>
                                <div class="stat-trend negative">
                                    <span class="material-icons">trending_down</span>
                                    Argent sorti
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-error);">
                                <span class="material-icons">savings</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="advances-progress" style="width: 100%;"></div>
                        </div>
                    </div>

                    <!-- === TOTAL DÉPENSES === -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-expenses">0 Ar</div>
                                <div class="stat-label">Total Dépenses Opérationnelles</div>
                                <div class="stat-trend negative">
                                    <span class="material-icons">trending_down</span>
                                    Argent sorti
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-secondary);">
                                <span class="material-icons">receipt_long</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="expenses-progress" style="width: 100%; background: var(--md-sys-color-secondary);"></div>
                        </div>
                    </div>
                    
                    <!-- Vanille Collectée -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-vanilla-weight">0 kg</div>
                                <div class="stat-label">Vanille Collectée</div>
                                <div class="stat-trend positive">
                                    <span class="material-icons">trending_up</span>
                                    Stock physique
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-primary);">
                                <span class="material-icons">eco</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="vanilla-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <!-- Valeur Totale Vanille -->
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-vanilla-value">0 Ar</div>
                                <div class="stat-label">Valeur Totale Vanille</div>
                                <div class="stat-trend positive">
                                    <span class="material-icons">trending_up</span>
                                    Argent rentré
                                </div>
                            </div>
                            <div class="stat-icon" style="background-color: var(--md-sys-color-tertiary);">
                                <span class="material-icons">attach_money</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="value-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <!-- SOLDE GLOBAL - NEW ENHANCED CARD -->
                    <div class="stat-card solde-global-card equilibre" id="solde-global-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="solde-global">0 Ar</div>
                                <div class="stat-label">Solde Global</div>
                                <div class="stat-trend" id="solde-trend">
                                    <span class="material-icons" id="solde-trend-icon">trending_flat</span>
                                    <span id="solde-trend-text">État équilibré</span>
                                </div>
                            </div>
                            <div class="stat-icon">
                                <span class="material-icons" id="solde-icon">account_balance</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="solde-progress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Summary Insights -->
                <div class="summary-insights">
                    <div class="insights-title">
                        <span class="material-icons">insights</span>
                        Analyse de Rentabilité
                    </div>
                    
                    <!-- Karatra 1: Valeur Récupérable (Kalitao Tsara) -->
                    <div class="insight-item" id="insight-valeur-recuperable">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-success);">
                            <span class="material-icons">diamond</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Valeur Récupérable (Bonnes Qualités)</div>
                            <div class="insight-detail" id="valeur-recuperable-detail">Calcul en cours...</div>
                        </div>
                    </div>

                    <!-- Karatra 2: Perte sur Qualité Inférieure -->
                    <div class="insight-item" id="insight-perte-qualite">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-error);">
                            <span class="material-icons">trending_down</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Perte sur Qualité Inférieure</div>
                            <div class="insight-detail" id="perte-qualite-detail">Calcul en cours...</div>
                        </div>
                    </div>

                    <!-- Karatra 3: Taux de Rendement Opérationnel -->
                    <div class="insight-item" id="insight-rendement-op">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-primary);">
                            <span class="material-icons">percent</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Taux de Rendement Opérationnel</div>
                            <div class="insight-detail" id="rendement-op-detail">Calcul en cours...</div>
                        </div>
                    </div>
                </div>
                <!-- =================================================================== -->
                <!-- === BLOC VAOVAO AMPIANA: FIVERENAN'NY RÉSUMÉ FINANCIER TALOHA === -->
                <!-- =================================================================== -->
                <div class="summary-insights" style="margin-top: 32px;"> <!-- Nampiana elanelana kely -->
                    <div class="insights-title">
                        <span class="material-icons">query_stats</span>
                        Résumé Financier (Suivi des Comptes)
                    </div>
                    
                    <!-- Karatra 1: État Financier (Déficit/Excédent) -->
                    <div class="insight-item">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-error);" id="insight-icon-1">
                            <span class="material-icons">trending_flat</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text" id="insight-title-1">État Financier</div>
                            <div class="insight-detail" id="insight-detail-1">Aucune donnée disponible pour le moment</div>
                        </div>
                    </div>

                    <!-- Karatra 2: Taux de Récupération -->
                    <div class="insight-item">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-primary);" id="insight-icon-2">
                            <span class="material-icons">timeline</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Taux de Récupération des Avances</div>
                            <div class="insight-detail" id="recovery-rate">0% des avances sont actuellement couvertes par la vanille collectée</div>
                        </div>
                    </div>

                    <!-- Karatra 3: Collecteurs en Dette (Clicable) -->
                    <div class="insight-item" id="debtors-card">
                        <div class="insight-icon" style="background-color: var(--md-sys-color-tertiary);" id="insight-icon-3">
                            <span class="material-icons">people</span>
                        </div>
                        <div class="insight-content">
                            <div class="insight-text">Collecteurs en Dette</div>
                            <div class="insight-detail" id="debtors-info">Aucun collecteur enregistré</div>
                        </div>
                    </div>
                </div>


                <!-- === BLOC VAOVAO MISY TOERANA HO AN'NY GRAFIKA 3 === -->
                <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 32px;">
                    
                    <!-- Toerana ho an'ny Grafika Mitsangana (Tsy miova) -->
                    <div class="chart-container" style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">Total des Avances par Collecteur</h3>
                        <canvas id="barChart"></canvas>
                    </div>

                    <!-- Toerana ho an'ny Grafika Boribory (Tsy miova) -->
                    <div class="chart-container" style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">Répartition (Avances vs Valeur Vanille)</h3>
                        <canvas id="pieChart"></canvas>
                    </div>

                    <!-- === TOERANA VAOVAO HO AN'NY GRAFIKA FAHATELO === -->
                    <div class="chart-container" style="background-color: var(--md-sys-color-surface); border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border: 1px solid var(--md-sys-color-outline-variant);">
                        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--md-sys-color-on-surface);">Poids Recéptionnées par Qualité de Vanille  </h3>
                        <canvas id="qualityChart"></canvas>
                    </div>
                    <!-- =============================================== -->

                </div>


            </section>

            <!-- Collectors Section -->
            <section class="content-section" id="collectors">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Collecteurs</h2>
                        <button class="btn btn-primary" onclick="openCollectorModal()">
                            <span class="material-icons">add</span>
                            Ajouter Collecteur
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Téléphone</th>
                                <th>C.I.N</th>
                                <th>Délivré le</th> <!-- <-- TSANGANANA VAOVAO -->
                                <th>Adresse</th>
                                <th>Statut</th>
                                <th>Solde</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="collectors-table">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="material-icons">people_outline</div>
                                    <div>Aucun collecteur enregistré</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Advances Section -->
            <section class="content-section" id="advances">
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Collecteur</label>
                        <select class="form-select" id="advance-filter-collector">
                            <option value="">Tous les collecteurs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date début</label>
                        <input type="date" class="form-input" id="advance-filter-start" onchange="filterAdvancesByDate()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date fin</label>
                        <input type="date" class="form-input" id="advance-filter-end" onchange="filterAdvancesByDate()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Actions rapides</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;" onclick="setDateFilter('today')">Aujourd'hui</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;" onclick="setDateFilter('week')">Cette semaine</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;" onclick="setDateFilter('month')">Ce mois</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;" onclick="setDateFilter('year')">Cette année</button>
                            <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;" onclick="clearDateFilter()">Effacer</button>
                        </div>
                    </div>
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Avances</h2>
                        <button class="btn btn-primary" onclick="openAdvanceModal()">
                            <span class="material-icons">add</span>
                            Nouvelle Avance
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Collecteur</th>
                                <th>Montant</th>
                                <th>Motif</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="advances-table">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <div class="material-icons">account_balance_wallet</div>
                                    <div>Aucune avance enregistrée</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- === REMBOURSEMENTS Section === -->
            <section class="content-section" id="remboursements">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Historique des Remboursements</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Collecteur</th>
                                <th>Montant Remboursé</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="remboursements-table">
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- ================================= -->

            <!-- === PAIEMENTS Section === -->
            <section class="content-section" id="paiements">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Historique des Paiements de Soldes</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Collecteur</th>
                                <th>Montant Payé</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paiements-table">
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- ============================== -->

            <!-- Expenses Section -->
            <section class="content-section" id="expenses">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Dépenses Opérationnelles</h2>
                        <button class="btn btn-primary" onclick="openExpenseModal()">
                            <span class="material-icons">add</span>
                            Ajouter Dépense
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Catégorie</th>
                                <th>Description</th>
                                <th>Montant</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table">
                            <!-- Ho fenoina amin'ny JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>


            <!-- Reception Section -->
            <section class="content-section" id="reception">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Réception de la Vanille</h2>
                        <div>
                            <button class="btn btn-outline" onclick="exportInvoice()">
                                <span class="material-icons">picture_as_pdf</span>
                                Export PDF
                            </button>
                            <button class="btn btn-primary" onclick="openReceptionModal()">
                                <span class="material-icons">add</span>
                                Nouvelle Réception
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Collecteur</th>
                                <th>Poids Brut</th>
                                <th>Poids Net</th>
                                <th>Qualité</th>
                                <th>Prix/kg</th>
                                <th>Valeur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reception-table">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div class="material-icons">inventory</div>
                                    <div>Aucune réception enregistrée</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Delivery Section -->
            <section class="content-section" id="delivery">
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">Livraison à l'Exportateur</h2>
                        <button class="btn btn-primary" onclick="openDeliveryModal()">
                            <span class="material-icons">add</span>
                            Nouvelle Livraison
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>N° Facture</th>
                                <th>Qualité</th>
                                <th>Poids</th>
                                <th>Valeur</th>
                                <th>Exportateur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="delivery-table">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="material-icons">local_shipping</div>
                                    <div>Aucune livraison enregistrée</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analysis Section -->
            <section class="content-section" id="analysis">
                <!-- Ovaina ho toy izao -->
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">Filtrer par Collecteur</label>
                        <select class="form-select" id="analysis-filter-collector" onchange="updateAnalysisTable()">
                            <option value="">Tous les collecteurs</option>
                        </select>
                    </div>
                    <!-- === SIVANA VAOVAO AMPIANA ETU === -->
                    <div class="filter-group">
                        <label class="filter-label">Filtrer par Qualité de Vanille</label>
                        <select class="form-select" id="analysis-filter-quality" onchange="updateAnalysisTable()">
                            <option value="">Toutes les qualités</option>
                            <!-- Ho fenoina ho azy amin'ny JavaScript ity -->
                        </select>
                    </div>
                    <!-- ================================== -->

                    <!-- BOKOTRA VAOVAO -->
                    <div class="filter-group">
                        <label class="filter-label">Actions & Rapports</label>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="showAllInAnalysis()">
                                <span class="material-icons">clear_all</span>
                                Afficher Tout
                            </button>
                            <!-- Bokotra efa nisy -->
                            <button class="btn btn-outline" onclick="exportAnalysis()">
                                <span class="material-icons">paid</span> <!-- Novaina icon -->
                                Rapport Comptes
                            </button>
                            <!-- === BOKOTRA VAOVAO AMPIANA ETU === -->
                            <button class="btn btn-outline" onclick="exportPoidsAnalysis()">
                                <span class="material-icons">scale</span> <!-- Icon vaovao -->
                                Rapport Poids
                            </button>
                            <!-- ================================== -->
                            <button class="btn btn-success" onclick="exportAnalysisToExcel()">
                                <span class="material-icons">table_view</span>
                                Export Excel
                            </button>
                        </div>
                    </div>

                </div>

                <!-- === BLOC VAOVAO: ANALYSE DU PRIX DE REVIENT === -->
                <div class="summary-insights" style="margin-bottom: 32px;">
                    <div class="insights-title">
                        <span class="material-icons">calculate</span>
                        Analyse du Prix de Revient
                    </div>
                    
                    <div id="prix-revient-container">
                        <!-- Ho fenoina amin'ny JavaScript ity -->
                        <div class="empty-state">
                            <span class="material-icons">hourglass_empty</span>
                            <div>Aucune réception de vanille pour calculer le prix de revient.</div>
                        </div>
                    </div>
                </div>
                <!-- ============================================= -->
                
                <div class="data-table">
                    <div class="table-header">
                        <h2 class="table-title">État des Collecteurs</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Collecteur</th>
                                <th>Total Avances</th>
                                <th>Total Crédits (Livr. + Remb.)</th>
                                <th>Solde</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="analysis-table">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="material-icons">analytics</div>
                                    <div>Aucune donnée d'analyse disponible</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="content-section" id="settings">
                <div class="credit-card">
                    <div class="credit-icon">
                    </div>

                    <div class="credit-text">
                        <p>Application développée et maintenue par</p>
                        <a href="#" target="_blank" class="credit-name">Rado Mandimbiarijao Developer</a>
                    </div>
                    <div class="credit-version">
                        Version 1.0.0
                    </div>
                </div>
                <div class="form-container">
                    <h2>Paramètres</h2>
                    
                    <div class="form-group">
                        <label class="form-label">Apparence</label>
                        <select class="form-select" id="theme-select">
                            <option value="light">Mode Clair</option>
                            <option value="dark">Mode Sombre</option>
                        </select>
                    </div>
                    
                    <!-- === BLOC VAOVAO AMPIANA === -->
                    <div class="form-group">
                        <label class="form-label" for="rendement-rate">
                            Taux de Rendement (Vanille Verte → Noire)
                            <span class="material-icons" title="Pourcentage du poids final après séchage. Exemple : 25 % si 100 kg de vanille verte donnent 25 kg de vanille noire, soit un rendement de 25 % (ratio 4:1)." style="font-size: 16px; vertical-align: middle; cursor: help;">help_outline</span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" class="form-input" id="rendement-rate" value="25" style="flex-grow: 1;">
                            <span style="font-size: 20px; font-weight: 500;">%</span>
                            <button class="btn btn-secondary" onclick="saveSettings()">Enregistrer</button>
                        </div>
                        <small style="display: block; margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">Ce taux est utilisé pour estimer le poids sec et calculer le prix de revient final.</small>
                    </div>
                    <!-- ============================ -->

                    <div class="form-group">
                        <label class="form-label">Gestion des Données</label>
                        <div class="btn-group">
                            <button class="btn btn-outline" onclick="exportData()">
                                <span class="material-icons">download</span>
                                Exporter les Données
                            </button>
                            <button class="btn btn-secondary" onclick="importData()">
                                <span class="material-icons">upload</span>
                                Importer les Données
                            </button>
                            <button class="btn btn-danger" onclick="resetData()">
                                <span class="material-icons">delete_forever</span>
                                Remise à Zéro
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ampiana ao anatin'ny <section id="settings"> -->
                <div class="data-table" style="margin-top: 32px;">
                    <div class="table-header">
                        <h2 class="table-title">Gestion des Qualités de Vanille</h2>
                        <button class="btn btn-primary" onclick="openQualityModal()">
                            <span class="material-icons">add</span>
                            Ajouter Qualité
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom de la Qualité</th>
                                <th>Description</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="qualities-table">
                            <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                        </tbody>
                    </table>
                </div>

            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Collector Modal -->
    <div class="modal" id="collector-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter/Modifier Collecteur</h3>
                <button class="close-btn" onclick="closeModal('collector-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="collector-form">
                <div class="form-group">
                    <label class="form-label">Nom Complet</label>
                    <input type="text"
                        id="collector-name"
                        class="form-input"
                        required aria-required="true"
                        oninput="capitalizeLive(this)">

                </div>
                <div class="form-group">
                    <label for="collector-phone" class="form-label">Téléphone</label>
                    <input type="tel" class="form-input" id="collector-phone" placeholder="030 00 000 00">
                </div>
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 6px;">
                        <span class="material-symbols-outlined" style="font-size: 18px;">badge</span>
                        CIN
                    </label>
                    <input type="text"
                        class="form-input"
                        id="collector-cin"
                        placeholder="000 000 000 000"
                        maxlength="17"
                        oninput="formatCIN(this)">
                </div>
                <!-- === SAHA VAOVAO AMPIANA === -->
                <div class="form-group">
                    <label class="form-label" for="collector-cin-date">Date de délivrance CIN</label>
                    <input type="date" class="form-input" id="collector-cin-date">
                </div>
                <!-- ========================== -->

                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input type="text" class="form-input" id="collector-address" placeholder="Adresse du collecteur">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('collector-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Advance Modal -->
    <div class="modal" id="advance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Avance</h3>
                <button class="close-btn" onclick="closeModal('advance-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="advance-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="advance-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Collecteur</label>
                    <select class="form-select" id="advance-collector" required>
                        <option value="">Sélectionner un collecteur</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="advance-amount" required placeholder="0">

                </div>
                <div class="form-group">
                    <label class="form-label" for="advance-motif">Motif de l'avance</label>
                    <input type="text" class="form-input" id="advance-motif" placeholder="Ex: Achat vanille verte...">
                </div>
                <!-- ========================== -->
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('advance-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reception Modal -->
    <div class="modal" id="reception-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Réception de Vanille</h3>
                <button class="close-btn" onclick="closeModal('reception-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="reception-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Collecteur</label>
                        <select class="form-select" id="reception-collector" required>
                            <option value="">Sélectionner un collecteur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="reception-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Brut (kg)</label>
                        <input type="number" step="0.01" class="form-input" id="reception-gross-weight">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre de Sacs</label>
                        <input type="number" class="form-input" id="reception-bag-count" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids par Sac (kg)</label>
                        <input type="number" step="0.01" class="form-input" id="reception-bag-weight" value="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Poids Net (kg)</label>
                        <input type="number" step="0.01" class="form-input" id="reception-net-weight">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Qualité</label>
                        <select class="form-select" id="reception-quality" required>
                            <!-- Ho fenoina amin'ny alalan'ny JavaScript -->
                            <option value="">Sélectionner la qualité</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prix par kg (Ar)</label>
                        <input type="number" class="form-input" id="reception-price" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valeur Totale (Ar)</label>
                        <input type="number" class="form-input" id="reception-total-value" readonly>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('reception-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div class="modal" id="delivery-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Livraison</h3>
                <button class="close-btn" onclick="closeModal('delivery-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="delivery-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="delivery-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Numéro de Facture</label>
                    <input type="text" class="form-input" id="delivery-invoice" required>
                </div>
                <!-- === BLOC VAOVAO AMPIANA === -->
                <div class="form-group">
                    <label class="form-label">Qualité de la Vanille</label>
                    <select class="form-select" id="delivery-quality" required>
                        <!-- Ho fenoina ho azy amin'ny JavaScript ity -->
                        <option value="">Sélectionner la qualité</option>
                    </select>
                </div>
                <!-- ============================ -->

                <div class="form-group">
                    <label class="form-label">Poids (kg)</label>
                    <input type="number" step="0.01" class="form-input" id="delivery-weight" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Prix par kg (Ar)</label>
                    <input type="number" class="form-input" id="delivery-price">
                </div>
                <div class="form-group">
                    <label class="form-label">Valeur Totale (Ar)</label>
                    <input type="number" class="form-input" id="delivery-total-value" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Exportateur</label>
                    <input type="text" class="form-input" id="delivery-exporter">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('delivery-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal" id="expense-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle Dépense</h3>
                <button class="close-btn" onclick="closeModal('expense-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Catégorie</label>
                    <select class="form-select" id="expense-category" required>
                        <option value="">Sélectionner une catégorie</option>
                        <option value="Paiement Collecteur">Paiement Solde Collecteur</option>
                        <option value="Salaire">Salaire Mpiasa</option>
                        <option value="Transport">Transport</option>
                        <option value="Nourriture">Nourriture / Sakafo</option>
                        <option value="Ristourne">Ristourne / Quittance</option>
                        <option value="Carburant">Carburant</option>
                        <option value="Logistique">Logistique (sacs, matériels...)</option>
                        <option value="Administratif">Administratif (téléphone, internet...)</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="expense-description" required placeholder="Ex: Karama volana Jona, Sakafo antoandro...">
                </div>
                <div class="form-group">
                    <label class="form-label">Montant (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="expense-amount" required placeholder="0">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('expense-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===REMBOURSEMENT MODAL  === -->
    <div class="modal" id="remboursement-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enregistrer un Remboursement</h3>
                <button class="close-btn" onclick="closeModal('remboursement-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="remboursement-form" onsubmit="saveRemboursement(event)">
                <input type="hidden" id="remboursement-collector-id">
                <div class="form-group">
                    <label class="form-label">Collecteur</label>
                    <input type="text" class="form-input" id="remboursement-collector-name" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Montant du remboursement (Ar)</label>
                    <input type="text" inputmode="numeric" class="form-input" id="remboursement-amount" required placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Date du remboursement</label>
                    <input type="date" class="form-input" id="remboursement-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note (optionnel)</label>
                    <input type="text" class="form-input" id="remboursement-note" placeholder="Ex: Reliquat du 15/08/2024">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('remboursement-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    <!-- ================================== -->


    <!--Quality modal-->
    <!-- Ampiana miaraka amin'ny modals hafa -->
    <div class="modal" id="quality-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter/Modifier Qualité</h3>
                <button class="close-btn" onclick="closeModal('quality-modal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="quality-form" onsubmit="saveQuality(event)">
                <input type="hidden" id="quality-id">
                <div class="form-group">
                    <label class="form-label">Nom de la Qualité</label>
                    <input type="text" id="quality-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optionnel)</label>
                    <input type="text" id="quality-description" class="form-input">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeModal('quality-modal')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Application State
        let appData = {
            collectors: [],
            advances: [],
            receptions: [],
            deliveries: [],
            qualities: [],
            expenses: [],
            remboursements: [],
            paiements: []
        };
        let pieChartInstance = null;
        let barChartInstance = null;
        let qualityChartInstance = null;

        // IndexedDB Setup
        let db;
        const dbName = 'BehavanaDB_v2';
        const dbVersion = 3;
        let dbInitialized = false;

        // Queue for operations waiting for DB
        let pendingOperations = [];

        // Execute operation when DB is ready
        function executeWhenReady(operation) {
            if (dbInitialized && db) {
                operation();
            } else {
                pendingOperations.push(operation);
            }
        }

        // Process pending operations
        function processPendingOperations() {
            while (pendingOperations.length > 0) {
                const operation = pendingOperations.shift();
                operation();
            }
        }

        // Initialize IndexedDB
        function initDB() {
            if (!window.indexedDB) {
                console.warn('IndexedDB not supported, using memory storage');
                dbInitialized = true;
                // Initialize with empty dashboard if IndexedDB not supported
                updateEnhancedDashboard();
                updateCollectorSelects();
                updateCollectorsTable();
                updateAdvancesTable();
                updateReceptionTable();
                updateDeliveryTable();
                updateAnalysisTable();
                return;
            }
            
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
                dbInitialized = true; // Mark as initialized even on error to prevent hanging
                // Initialize with empty dashboard on error
                updateEnhancedDashboard();
                updateCollectorSelects();
                updateCollectorsTable();
                updateAdvancesTable();
                updateReceptionTable();
                updateDeliveryTable();
                updateAnalysisTable();
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                dbInitialized = true;
                console.log('Database initialized successfully');
                
                // Handle database errors after opening
                db.onerror = function(event) {
                    console.error('Database error:', event.target.error);
                };
                
                loadData();
                processPendingOperations();
            };
            
            // Ahitsio ny fizarana onupgradeneeded ao anatin'ny initDB()
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                console.log(`Creating new database structure for ${dbName} version ${db.version}...`);

                // --- Famoronana ireo "stores" rehetra ilaina ho an'ny database vaovao ---

                // 1. Store ho an'ny COLLECTORS
                if (!db.objectStoreNames.contains('collectors')) {
                    db.createObjectStore('collectors', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "collectors" store.');
                }

                // 2. Store ho an'ny ADVANCES
                if (!db.objectStoreNames.contains('advances')) {
                    db.createObjectStore('advances', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "advances" store.');
                }

                // 3. Store ho an'ny RECEPTIONS
                if (!db.objectStoreNames.contains('receptions')) {
                    db.createObjectStore('receptions', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "receptions" store.');
                }

                // 4. Store ho an'ny DELIVERIES
                if (!db.objectStoreNames.contains('deliveries')) {
                    db.createObjectStore('deliveries', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "deliveries" store.');
                }
                
                // 5. Store ho an'ny QUALITIES
                if (!db.objectStoreNames.contains('qualities')) {
                    const qualityStore = db.createObjectStore('qualities', { keyPath: 'id', autoIncrement: true });
                    qualityStore.createIndex('name', 'name', { unique: true });
                    console.log('Created "qualities" store.');

                    // Fampidirana ireo kalitao fototra
                    const defaultQualities = [
                        { name: 'Lava', description: 'Vanille de qualité supérieure' },
                        { name: 'Fohy', description: 'Vanille plus courte' },
                        { name: 'Fendue', description: 'Vanille fendue ou vaky' },
                        { name: 'Lo', description: 'Vanille de qualité inférieure' },
                        { name: 'Verte', description: 'Vanille non préparée' }
                    ];
                    
                    defaultQualities.forEach(q => qualityStore.add(q));
                    console.log('Added default qualities.');
                }

                // 6. Store ho an'ny EXPENSES
                if (!db.objectStoreNames.contains('expenses')) {
                    db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "expenses" store.');
                }

                // 7. Store ho an'ny REMBOURSEMENTS (VAOVAO)
                if (!db.objectStoreNames.contains('remboursements')) {
                    db.createObjectStore('remboursements', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "remboursements" store.');
                }

                // 8. Store ho an'ny PAIEMENTS (VAOVAO)
                if (!db.objectStoreNames.contains('paiements')) {
                    db.createObjectStore('paiements', { keyPath: 'id', autoIncrement: true });
                    console.log('Created "paiements" store.');
                }
            };



        }

        // Load data from IndexedDB
        // Load data from IndexedDB
        function loadData() {
            if (!db) {
                console.warn('Database not initialized, using empty data.');
                updateAllTables();
                return;
            }

            // 1. Alaina ho azy ny lisitry ny "object stores" rehetra misy
            const storeNames = Array.from(db.objectStoreNames);

            // Fiarovana raha tsy misy na inona na inona ny database
            if (storeNames.length === 0) {
                console.warn('No object stores found in the database.');
                updateAllTables();
                return;
            }

            // 2. Mampiasa Promise.all mba hiandry ny famahanana angona rehetra ho vita
            // Ity dia fomba maoderina sy madio kokoa hikarakarana hetsika maro miaraka
            const promises = storeNames.map(storeName => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        // Averina ny anaran'ny store sy ny angona ao anatiny
                        resolve({ storeName: storeName, data: request.result || [] });
                    };

                    request.onerror = () => {
                        console.error(`Error loading data from ${storeName}:`, request.error);
                        // Na dia misy hadisoana aza, dia averina ihany ny anarany sy angona banga
                        // mba tsy hanakana ny fandehan'ny aplikasiona
                        reject({ storeName: storeName, data: [] });
                    };
                });
            });

            // 3. Rehefa vita daholo ny famahanana angona rehetra...
            Promise.allSettled(promises)
                .then(results => {
                    // Averina amin'ny laoniny aloha ny appData
                    storeNames.forEach(name => appData[name] = []);

                    results.forEach(result => {
                        if (result.status === 'fulfilled') {
                            const { storeName, data } = result.value;
                            // Ity no ampahany manan-danja: apetraka ao anaty appData ny angona
                            appData[storeName] = data;
                        } else {
                            // Raha nisy hadisoana, efa nisy console.error teo ambony
                            // ary efa banga ny appData[storeName]
                        }
                    });

                    console.log('All data loaded successfully:', appData);
                    
                    // Antsoy indray mandeha fotsiny ny fanavaozana ny pejy REHETRA
                    updateAllTables();
                });
        }




        // Save data to IndexedDB
        /**
         * Fiasa nohavaozina sy maoderina kokoa ho an'ny fitehirizana angona.
         * Mampiasa async/await mba hanamorana ny famakiana ny kaody.
         */
        async function saveToDB(storeName, data) {
            try {
                await executeWhenReadyPromise(); 

                if (!db || db.readyState === 'done') {
                    console.warn(`Database not available for '${storeName}', using memory fallback.`);
                    saveToDB_Fallback(storeName, data);
                    return;
                }

                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    transaction.oncomplete = () => {
                        console.log(`Data successfully saved to ${storeName}.`);
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error(`Transaction error on ${storeName}:`, event.target.error);
                        reject(event.target.error);
                    };
                });

                // Rehefa vita soa aman-tsara ny fitehirizana, dia alaina indray ny angona rehetra
                loadData();

            } catch (error) {
                console.error(`Failed to save data to ${storeName}. Error:`, error);
                showToast(`Erreur lors de l'enregistrement dans ${storeName}.`, 'error');
                saveToDB_Fallback(storeName, data);
            }
        }

        /**
         * Fiasa kely mpanampy izay manova ny executeWhenReady ho Promise.
         * Ilaina mba hahafahana mampiasa await.
         */
        function executeWhenReadyPromise() {
            return new Promise(resolve => {
                if (dbInitialized && db) {
                    resolve();
                } else {
                    pendingOperations.push(resolve);
                }
            });
        }


        // Fallback save function
        function saveToDB_Fallback(storeName, data) {
            if (!data.id) {
                data.id = Date.now() + Math.random();
            }
            const existingIndex = appData[storeName].findIndex(item => item.id === data.id);
            if (existingIndex >= 0) {
                appData[storeName][existingIndex] = data;
            } else {
                appData[storeName].push(data);
            }
            updateAllTables();
        }

        // Delete from IndexedDB
        // Soloina ity ny fiasa deleteFromDB efa misy
        /**
         * Fiasa nohavaozina sy maoderina kokoa ho an'ny famafana angona.
         * Mampiasa async/await mba hanamorana ny famakiana ny kaody.
         */
        async function deleteFromDB(storeName, id, onSuccessCallback) {
            try {
                await executeWhenReadyPromise();

                if (!db || db.readyState === 'done') {
                    console.warn(`Database not available for deleting from '${storeName}', using memory fallback.`);
                    deleteFromDB_Fallback(storeName, id);
                    if (onSuccessCallback) onSuccessCallback();
                    return;
                }

                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);

                    transaction.oncomplete = () => {
                        console.log(`Data with id ${id} successfully deleted from ${storeName}.`);
                        resolve();
                    };

                    transaction.onerror = (event) => {
                        console.error(`Transaction error on deleting from ${storeName}:`, event.target.error);
                        reject(event.target.error);
                    };
                });

                if (onSuccessCallback) {
                    onSuccessCallback();
                }

                // Rehefa vita soa aman-tsara ny famafana, dia alaina indray ny angona rehetra
                loadData();

            } catch (error) {
                console.error(`Failed to delete data with id ${id} from ${storeName}. Error:`, error);
                showToast(`Erreur lors de la suppression dans ${storeName}.`, 'error');
                deleteFromDB_Fallback(storeName, id);
                if (onSuccessCallback) onSuccessCallback();
            }
        }



        // Fallback delete function
        function deleteFromDB_Fallback(storeName, id) {
            const index = appData[storeName].findIndex(item => item.id === id);
            if (index >= 0) {
                appData[storeName].splice(index, 1);
                updateAllTables();
            }
        }

        // Update all tables helper function
        function updateAllTables() {
            updateCollectorSelects();
            updateCollectorsTable();
            updateAdvancesTable();
            updateReceptionTable();
            updateDeliveryTable();
            updateAnalysisTable();
            updateEnhancedDashboard();
            updateCharts();
            updateQualitiesTable();
            updateQualitySelect();
            updateAnalysisQualityFilter();
            updateExpensesTable();
            updateRemboursementsTable();
            updatePaiementsTable();
            updatePrixRevientAnalysis();
        }

        // Enhanced Dashboard Functions
        function calculateGlobalBalance() {
            const totalAdvances = appData.advances.reduce((sum, advance) => sum + advance.amount, 0);
            const totalVanillaValue = appData.receptions.reduce((sum, reception) => sum + reception.totalValue, 0);
            const balance = totalVanillaValue - totalAdvances;
            const recoveryRate = totalAdvances > 0 ? (totalVanillaValue / totalAdvances * 100).toFixed(1) : 0;
            
            return {
                balance: balance,
                recoveryRate: recoveryRate,
                isPositive: balance >= 0,
                deficit: Math.abs(balance),
                totalAdvances: totalAdvances,
                totalVanillaValue: totalVanillaValue
            };
        }

        // Soloina manontolo ity fiasa ity
        function updateEnhancedDashboard() {
            // --- FIAROVANA: Hamarino aloha raha misy ny appData.expenses ---
            // Raha tsy misy, dia heverina ho array banga izy
            const expensesData = appData.expenses || [];
            const advancesData = appData.advances || [];
            const receptionsData = appData.receptions || [];
            const collectorsData = appData.collectors || [];
            const deliveriesData = appData.deliveries || [];
            // -------------------------------------------------------------

            // Kajiana ny totaliny rehetra amin'ny fampiasana ireo variable voaaro
            const totalAdvances = advancesData.reduce((sum, advance) => sum + advance.amount, 0);
            const totalExpenses = expensesData.reduce((sum, expense) => sum + expense.amount, 0);
            const totalMoneyOut = totalAdvances + totalExpenses;
            
            const totalVanillaValue = receptionsData.reduce((sum, reception) => sum + reception.totalValue, 0);
            // KAJY VAOVAO: Alaina ny totalin'ny famerenam-bola rehetra
            const totalRemboursements = (appData.remboursements || []).reduce((sum, rem) => sum + rem.amount, 0);
            // Atambatra ny vola miditra rehetra
            const totalMoneyIn = totalVanillaValue + totalRemboursements;

            const totalVanillaWeight = receptionsData.reduce((sum, reception) => sum + reception.netWeight, 0);
            
            const balance = totalMoneyIn - totalMoneyOut; // Kajiana ny elanelany
            const recoveryRate = totalMoneyOut > 0 ? (totalVanillaValue / totalMoneyOut * 100) : 0;
            
            const globalBalanceInfo = {
                balance: balance,
                recoveryRate: recoveryRate.toFixed(1),
                isPositive: balance >= 0,
                deficit: Math.abs(balance),
                totalAdvances: totalAdvances,
                totalExpenses: totalExpenses,
                totalMoneyOut: totalMoneyOut,
                totalVanillaValue: totalVanillaValue
            };

            // Update main stats
            document.getElementById('total-advances').textContent = formatCurrency(totalAdvances);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('total-vanilla-value').textContent = formatCurrency(totalVanillaValue);
            document.getElementById('total-vanilla-weight').textContent = totalVanillaWeight.toFixed(2) + ' kg';
            
            // Update overview stats
            const totalTransactions = advancesData.length + receptionsData.length + deliveriesData.length + expensesData.length;
            document.getElementById('overview-collectors').textContent = collectorsData.length;
            document.getElementById('overview-transactions').textContent = totalTransactions;
            document.getElementById('overview-month').textContent = getCurrentMonth();
            
            // Antsoy ireo fiasa hafa
            updateGlobalBalanceCard(globalBalanceInfo);
            updateInsights(globalBalanceInfo);
            updateRentabiliteInsights();
            updateProgressBars(globalBalanceInfo, totalVanillaWeight);
        }



        function updateGlobalBalanceCard(balanceInfo) {
            const soldeCard = document.getElementById('solde-global-card');
            const soldeValue = document.getElementById('solde-global');
            const soldeIcon = document.getElementById('solde-icon');
            const soldeTrendIcon = document.getElementById('solde-trend-icon');
            const soldeTrendText = document.getElementById('solde-trend-text');
            
            // Update value
            soldeValue.textContent = (balanceInfo.isPositive ? '+' : '-') + formatCurrency(balanceInfo.deficit);
            
            // Update card styling and icons based on status
            soldeCard.className = 'stat-card solde-global-card ' + 
                (balanceInfo.isPositive ? 'crediteur' : balanceInfo.balance === 0 ? 'equilibre' : 'debiteur');
            
            if (balanceInfo.isPositive) {
                soldeIcon.textContent = 'account_balance_wallet';
                soldeTrendIcon.textContent = 'trending_up';
                soldeTrendText.textContent = 'Excédent disponible';
            } else if (balanceInfo.balance === 0) {
                soldeIcon.textContent = 'balance';
                soldeTrendIcon.textContent = 'trending_flat';
                soldeTrendText.textContent = 'Parfaitement équilibré';
            } else {
                soldeIcon.textContent = 'account_balance';
                soldeTrendIcon.textContent = 'trending_down';
                soldeTrendText.textContent = 'Argent non récupéré';
            }
        }

        // Soloina ity ny fiasa updateInsights efa misy
        // Fiasa mamerina ny Résumé Financier (Suivi des Comptes)
        function updateInsights(balanceInfo) {
            const insightTitle1 = document.getElementById('insight-title-1');
            const insightDetail1 = document.getElementById('insight-detail-1');
            const recoveryRate = document.getElementById('recovery-rate');
            const debtorsInfo = document.getElementById('debtors-info');
            const insightIcon1 = document.getElementById('insight-icon-1');
            const debtorsCard = document.getElementById('debtors-card');

            // Kajy ny totalin'ny vola nivoaka rehetra (avances + dépenses)
            const totalMoneyOut = balanceInfo.totalAdvances + balanceInfo.totalExpenses;
            
            // Kajy ny tahan'ny famerenana mifototra amin'ny vola nivoaka REHETRA
            const recoveryRateValue = totalMoneyOut > 0 ? (balanceInfo.totalVanillaValue / totalMoneyOut * 100) : 0;

            // Kajy ny deficit/excédent mifototra amin'ny avances vs valeur vanille
            const avanceBalance = balanceInfo.totalVanillaValue - balanceInfo.totalAdvances;

            if (avanceBalance >= 0) {
                insightTitle1.textContent = 'Excédent sur Avances';
                insightDetail1.textContent = `La valeur de la vanille couvre les avances de ${formatCurrency(avanceBalance)}.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_up</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-success)';
            } else {
                insightTitle1.textContent = 'Déficit sur Avances';
                insightDetail1.textContent = `Il manque ${formatCurrency(Math.abs(avanceBalance))} de vanille pour couvrir les avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_down</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-error)';
            }
            
            recoveryRate.textContent = `${recoveryRateValue.toFixed(1)}% des coûts (avances+dépenses) sont couverts par la valeur de la vanille.`;
            
            const debtorsCount = calculateDebtorsCount();
            
            debtorsCard.onclick = null;
            debtorsCard.classList.remove('clickable');

            if (debtorsCount === 0) {
                debtorsInfo.textContent = 'Aucun collecteur n\'a de dette en cours.';
            } else {
                debtorsInfo.textContent = `${debtorsCount} collecteur${debtorsCount > 1 ? 's' : ''} ont encore des dettes. Cliquez pour voir.`;
                
                debtorsCard.classList.add('clickable');
                debtorsCard.onclick = function() {
                    sessionStorage.setItem('analysis_filter', 'debiteur');
                    navigateToSection('analysis');
                };
            }
        }

        // Fiasa kely mpanampy (ataovy azo antoka fa misy ity)
        function calculateDebtorsCount() {
            let debtorsCount = 0;
            if (!appData.collectors) return 0;
            appData.collectors.forEach(collector => {
                const balance = calculateCollectorBalance(collector.id);
                if (balance < 0) {
                    debtorsCount++;
                }
            });
            return debtorsCount;
        }



        function updateProgressBars(balanceInfo, totalVanillaWeight) {
            // Advances progress (always 100% since it's money out)
            document.getElementById('advances-progress').style.width = '100%';
            
            // Vanilla progress (based on target of 200kg)
            const vanillaTarget = 200;
            const vanillaPercentage = Math.min((totalVanillaWeight / vanillaTarget) * 100, 100);
            document.getElementById('vanilla-progress').style.width = vanillaPercentage + '%';
            
            // Value progress (based on recovery rate)
            const valuePercentage = Math.min(parseFloat(balanceInfo.recoveryRate), 100);
            document.getElementById('value-progress').style.width = valuePercentage + '%';
            
            // Balance progress
            document.getElementById('solde-progress').style.width = valuePercentage + '%';
        }

        function calculateDebtorsCount() {
            let debtorsCount = 0;
            appData.collectors.forEach(collector => {
                const balance = calculateCollectorBalance(collector.id);
                if (balance < 0) {
                    debtorsCount++;
                }
            });
            return debtorsCount;
        }

        function getCurrentMonth() {
            const months = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];
            return months[new Date().getMonth()];
        }

        // Navigation
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            loadSettings();
            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    navigateToSection(section);
                });
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Form submissions
            setupFormHandlers();
            
            // Set current date as default
            setCurrentDate();
            
            // Calculate reception values
            setupReceptionCalculations();
            
            // Calculate delivery values
            setupDeliveryCalculations();
            
            // Load theme preference
            loadThemePreference();

            const amountInput = document.getElementById('advance-amount');
            if (amountInput) {
                amountInput.addEventListener('input', function(e) {
                    // 1. Raiso ny sanda madio (esorina daholo izay tsy isa)
                    let rawValue = e.target.value.replace(/\D/g, '');

                    // Raha banga ny sanda dia avelao ho banga
                    if (rawValue === '') {
                        e.target.value = '';
                        return;
                    }

                    // 2. Amboary ny endrika misy habaka isaky ny arivo
                    // Mampiasa fomba azo antoka ity mba tsy hisy hadisoana
                    let formattedValue = Number(rawValue).toLocaleString('fr-MG');

                    // 3. Averina ao anaty input ilay sanda efa voamboatra
                    e.target.value = formattedValue;
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById("sidebar-toggle").addEventListener("click", () => {
                const sidebar = document.getElementById("sidebar");
                const mainContent = document.querySelector(".main-content");
                const toggleIcon = document.querySelector("#sidebar-toggle .material-icons");

                    // Manampy na manesotra ny kilasy
                sidebar.classList.toggle("collapsed");
                mainContent.classList.toggle("sidebar-collapsed");

                    // Manova ny sary masina (icon) arak'izany
                if (sidebar.classList.contains("collapsed")) {
                    toggleIcon.textContent = "menu"; // Lasa menu rehefa mifintina
                } else {
                    toggleIcon.textContent = "menu_open"; // Lasa menu_open rehefa mivelatra
                }
            });
        });

        // Soloina ity ny fiasa navigateToSection efa misy
        function navigateToSection(sectionName) {
            // Ity ampahany ity tsy miova
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionName);
            if (activeSection) {
                activeSection.classList.add('active');
            }
            
            const titles = {
                'dashboard': 'Tableau de Bord',
                'collectors': 'Gestion des Collecteurs',
                'advances': 'Gestion des Avances',
                'reception': 'Réception de la Vanille',
                'delivery': 'Livraison à l\'Exportateur',
                'expenses': 'Gestion des Dépenses',
                'analysis': 'Suivi & Analyse',
                'settings': 'Paramètres'
            };
            document.getElementById('page-title').textContent = titles[sectionName] || 'BEHAVANA';

            // --- ITY NO AMPIANA ---
            const requestedFilter = sessionStorage.getItem('analysis_filter');
            
            if (sectionName === 'analysis') {
                // Havaozy foana ny tabilao rehefa tonga eto mba ho feno izy aloha
                updateAnalysisTable();

                if (requestedFilter === 'debiteur') {
                    // Mampiasa setTimeout mba hiandry kely an'i updateAnalysisTable ho vita
                    setTimeout(() => {
                        filterAnalysisForDebtors();
                    }, 100); // Atao somary lava kely mba ho azo antoka

                    sessionStorage.removeItem('analysis_filter');
                }
            }
        }

        // Theme Management
        function toggleTheme() {
            const currentTheme = document.body.dataset.theme || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);

            // Rehefa avy manova ny theme, dia havaozy ny grafika
            // Mampiasa setTimeout kely mba hanomezana fotoana ny CSS hiova
            setTimeout(updateCharts, 50); 
        }


        function setTheme(theme) {
            document.body.dataset.theme = theme;
            document.getElementById('theme-select').value = theme;
            
            const themeIcon = document.querySelector('#theme-toggle .material-icons');
            themeIcon.textContent = theme === 'light' ? 'dark_mode' : 'light_mode';
            
            localStorage.setItem('theme', theme);
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCollectorModal(collectorId = null) {
            const form = document.getElementById('collector-form'); // <-- Tsara kokoa raha alaina eto
            form.reset(); // <-- Fafana aloha ny formulaire
            delete form.dataset.editId;

            if (collectorId) {
                const collector = appData.collectors.find(c => c.id === collectorId);
                if (collector) {
                    document.getElementById('collector-name').value = collector.name;
                    document.getElementById('collector-phone').value = collector.phone;
                    document.getElementById('collector-cin').value = collector.cin || '';
                    document.getElementById('collector-cin-date').value = collector.cinDate || ''; // <-- AMPIANA
                    document.getElementById('collector-address').value = collector.address || '';
                    form.dataset.editId = collectorId;
                }
            }
            openModal('collector-modal');
        }


        function openAdvanceModal(advanceId = null) {
            updateCollectorSelects();
            const form = document.getElementById('advance-form');
            form.reset(); // Fafana aloha ny formulaire
            delete form.dataset.editId;

            if (advanceId) {
                const advance = appData.advances.find(a => a.id === advanceId);
                if (advance) {
                    document.getElementById('advance-date').value = advance.date;
                    document.getElementById('advance-collector').value = advance.collectorId;
                    document.getElementById('advance-amount').value = advance.amount;
                    document.getElementById('advance-motif').value = advance.motif || ''; // <-- AMPIANA          
                    form.dataset.editId = advanceId;
                }
            } else {
                setCurrentDate();
            }
            openModal('advance-modal');
        }


        function openReceptionModal(receptionId = null) {
            updateCollectorSelects();
            updateQualitySelect();
            
            const form = document.getElementById('reception-form');
            form.reset(); // Fafana aloha ny formulaire
            delete form.dataset.editId;

            if (receptionId) {
                // --- MODE MODIFICATION ---
                const reception = appData.receptions.find(r => r.id === receptionId);
                if (reception) {
                    form.dataset.editId = receptionId;
                    
                    // Fenoy ny saha rehetra avy amin'ny angona voatahiry
                    document.getElementById('reception-collector').value = reception.collectorId;
                    document.getElementById('reception-date').value = reception.date;
                    document.getElementById('reception-gross-weight').value = reception.grossWeight;
                    document.getElementById('reception-bag-count').value = reception.bagCount;
                    document.getElementById('reception-bag-weight').value = reception.bagWeight;
                    document.getElementById('reception-quality').value = reception.quality;
                    document.getElementById('reception-price').value = reception.price;
                    
                    // --- FANITSARANA LEHIBE ETO ---
                    // Apetraka mivantana ny "Poids Net" efa voatahiry
                    document.getElementById('reception-net-weight').value = reception.netWeight;
                    
                    // Kajiana fotsiny ny "Valeur Totale" mba hifanaraka
                    document.getElementById('reception-total-value').value = reception.totalValue;
                }
            } else {
                // --- MODE AJOUT (Tsy miova) ---
                setCurrentDate();
                document.getElementById('reception-bag-count').value = 1;
                // Omena sanda kely default ny lanjan'ny lasaka mba tsy ho 0 ny kajy
                const bagWeightInput = document.getElementById('reception-bag-weight');
                if (!bagWeightInput.value) {
                    bagWeightInput.value = 0.1;
                }
                calculateReceptionValues(); // Antsoina mba hikajy ny Poids Net sy Valeur
            }
            
            openModal('reception-modal');
        }


        function openDeliveryModal(deliveryId = null) {
            const select = document.getElementById('delivery-quality');
            const currentValue = select.value;
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            if (appData.qualities) {
                appData.qualities.forEach(quality => {
                    const option = document.createElement('option');
                    option.value = quality.name;
                    option.textContent = quality.name;
                    select.appendChild(option);
                });
            }
            select.value = currentValue;
            // ----------------------
            if (deliveryId) {
                const delivery = appData.deliveries.find(d => d.id === deliveryId);
                if (delivery) {
                    document.getElementById('delivery-date').value = delivery.date;
                    document.getElementById('delivery-invoice').value = delivery.invoice;
                    document.getElementById('delivery-weight').value = delivery.weight;
                    document.getElementById('delivery-price').value = delivery.price;
                    document.getElementById('delivery-exporter').value = delivery.exporter;
                    document.getElementById('delivery-form').dataset.editId = deliveryId;
                    calculateDeliveryValue();
                }
            } else {
                document.getElementById('delivery-form').reset();
                setCurrentDate();
                delete document.getElementById('delivery-form').dataset.editId;
            }
            openModal('delivery-modal');
        }

        // Form Handlers
        function setupFormHandlers() {
            // Collector form
            document.getElementById('collector-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCollector();
            });
            
            // Advance form
            document.getElementById('advance-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveAdvance();
            });
            
            // Reception form
            document.getElementById('reception-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveReception();
            });
            
            // Delivery form
            document.getElementById('delivery-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDelivery();
            });
            
            // Theme select
            document.getElementById('theme-select').addEventListener('change', function() {
                setTheme(this.value);
            });
            
            // Phone formatting
            document.getElementById('collector-phone').addEventListener('input', formatPhoneNumber);

            document.getElementById('expense-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveExpense();
            });

        }

        function formatPhoneNumber(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 10) {
                value = value.substring(0, 10);
                value = value.replace(/(\d{3})(\d{2})(\d{3})(\d{2})/, '$1 $2 $3 $4');
            }
            e.target.value = value;
        }

        function capitalizeWords(str) {
            return str.replace(/\w\S*/g, (txt) => 
                txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }

        // Data Management Functions
        function saveCollector() {
            const form = document.getElementById('collector-form');
            const name = capitalizeWords(document.getElementById('collector-name').value);
            const phone = document.getElementById('collector-phone').value.replace(/\s/g, '');
            const cin = document.getElementById('collector-cin').value;
            const cinDate = document.getElementById('collector-cin-date').value;
            const address = document.getElementById('collector-address').value;
            

            if (phone && (phone.length !== 10 || !phone.startsWith('0'))) {
                alert('Le numéro de téléphone doit contenir 10 chiffres et commencer par 0.');
                return; // Ajanona ny fitehirizana raha diso ny laharana
            }


            // Check for duplicate names
            // ... ao anatin'ny saveCollector()
            const existingCollector = appData.collectors.find(c => {
                // FANAMARINANA: Hamarino aloha raha misy ny c sy ny c.name
                if (c && c.name) {
                    return c.name.toLowerCase() === name.toLowerCase() && c.id != form.dataset.editId;
                }
                // Raha tsy misy dia averina false mba tsy hiteraka hadisoana
                return false;
            });

            
            if (existingCollector) {
                alert('Un collecteur avec ce nom existe déjà!');
                return;
            }
            
            const collector = {
                name: name,
                phone: phone,
                cin: cin,        // ← Champ vaovao
                cinDate: cinDate,
                address: address, // ← Champ vaovao misaraka
                createdAt: new Date().toISOString()
            };
            
            if (form.dataset.editId) {
                collector.id = parseInt(form.dataset.editId);
            }
            
            saveToDB('collectors', collector);
            closeModal('collector-modal');
            showToast('Collecteur enregistré avec succès!');
        }

        function saveAdvance() {
            const form = document.getElementById('advance-form');
            // Eto no misy ny fanovana: esorina izay tsy isa rehetra
            const cleanAmount = document.getElementById('advance-amount').value.replace(/\D/g, '');

            const advance = {
                date: document.getElementById('advance-date').value,
                collectorId: parseInt(document.getElementById('advance-collector').value),
                amount: parseInt(cleanAmount) || 0, // Atao 0 raha banga
                motif: document.getElementById('advance-motif').value.trim(),
                createdAt: new Date().toISOString()
            };
            
            if (form.dataset.editId) {
                advance.id = parseInt(form.dataset.editId);
            }
            
            saveToDB('advances', advance);
            closeModal('advance-modal');
            showToast('Avance enregistrée avec succès!');
        }


        function saveReception() {
            const form = document.getElementById('reception-form');
            const reception = {
                collectorId: parseInt(document.getElementById('reception-collector').value),
                date: document.getElementById('reception-date').value,
                grossWeight: parseFloat(document.getElementById('reception-gross-weight').value),
                bagCount: parseInt(document.getElementById('reception-bag-count').value),
                bagWeight: parseFloat(document.getElementById('reception-bag-weight').value),
                netWeight: parseFloat(document.getElementById('reception-net-weight').value),
                quality: document.getElementById('reception-quality').value,
                price: parseInt(document.getElementById('reception-price').value),
                totalValue: parseInt(document.getElementById('reception-total-value').value),
                createdAt: new Date().toISOString()
            };
            
            if (form.dataset.editId) {
                reception.id = parseInt(form.dataset.editId);
            }
            
            saveToDB('receptions', reception);
            closeModal('reception-modal');
            showToast('Réception enregistrée avec succès!');
        }

        function saveDelivery() {
            const form = document.getElementById('delivery-form');
            const delivery = {
                date: document.getElementById('delivery-date').value,
                invoice: document.getElementById('delivery-invoice').value,
                quality: document.getElementById('delivery-quality').value,
                weight: parseFloat(document.getElementById('delivery-weight').value),
                price: parseInt(document.getElementById('delivery-price').value),
                totalValue: parseInt(document.getElementById('delivery-total-value').value),
                exporter: document.getElementById('delivery-exporter').value,
                createdAt: new Date().toISOString()
            };
            
            if (form.dataset.editId) {
                delivery.id = parseInt(form.dataset.editId);
            }
            
            saveToDB('deliveries', delivery);
            closeModal('delivery-modal');
            showToast('Livraison enregistrée avec succès!');
        }

        // Delete Functions
        function deleteCollector(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce collecteur?')) {
                // Omeo azy ho callback ilay fiasa mampiseho toast
                deleteFromDB('collectors', id, () => {
                    showToast('Collecteur supprimé.', 'error');
                });
            }
        }

        function deleteAdvance(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette avance?')) {
                deleteFromDB('advances', id, () => {
                    showToast('Avance supprimée.', 'error');
                });
            }
        }

        function deleteReception(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette réception?')) {
                deleteFromDB('receptions', id, () => {
                    showToast('Réception supprimée.', 'error');
                });
            }
        }

        function deleteDelivery(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette livraison?')) {
                deleteFromDB('deliveries', id, () => {
                    showToast('Livraison supprimée.', 'error');
                });
            }
        }


        // Calculation Functions
        function setupReceptionCalculations() {
            ['reception-gross-weight', 'reception-bag-count', 'reception-bag-weight', 'reception-price', 'reception-net-weight'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateReceptionValues);
            });
        }

        function calculateReceptionValues() {
            const grossWeightInput = document.getElementById('reception-gross-weight');
            const netWeightInput = document.getElementById('reception-net-weight');
            
            const grossWeight = parseFloat(grossWeightInput.value) || 0;
            const bagCount = parseInt(document.getElementById('reception-bag-count').value) || 0;
            const bagWeight = parseFloat(document.getElementById('reception-bag-weight').value) || 0;
            const price = parseInt(document.getElementById('reception-price').value) || 0;

            // Jereo hoe iza no saha novaina farany
            const source = event ? event.target.id : '';

            let netWeight = 0;

            // Raha ny Poids Brut na ny momba ny lasaka no ovaina, dia kajiana ny Poids Net
            if (source === 'reception-gross-weight' || source === 'reception-bag-count' || source === 'reception-bag-weight') {
                const totalBagWeight = bagCount * bagWeight;
                netWeight = grossWeight - totalBagWeight;
                netWeightInput.value = netWeight > 0 ? netWeight.toFixed(2) : '0.00';
            } else {
                // Raha tsy izany (anisan'izany ny fanovana mivantana ny Poids Net), dia alaina ny sandany
                netWeight = parseFloat(netWeightInput.value) || 0;
            }
            
            // Kajiana foana ny Valeur Totale mifototra amin'ny Poids Net farany
            const totalValue = netWeight * price;
            document.getElementById('reception-total-value').value = Math.round(totalValue);
        }


        function setupDeliveryCalculations() {
            ['delivery-weight', 'delivery-price'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateDeliveryValue);
            });
        }

        function calculateDeliveryValue() {
            const weight = parseFloat(document.getElementById('delivery-weight').value) || 0;
            const price = parseInt(document.getElementById('delivery-price').value) || 0;
            const totalValue = weight * price;
            
            document.getElementById('delivery-total-value').value = Math.round(totalValue);
        }

        // Update Functions
        function updateCollectorSelects() {
            const selects = ['advance-collector', 'reception-collector', 'advance-filter-collector', 'analysis-filter-collector'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear existing options (except first one)
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add collector options
                appData.collectors.forEach(collector => {
                    const option = document.createElement('option');
                    option.value = collector.id;
                    option.textContent = collector.name;
                    select.appendChild(option);
                });
                
                // Restore selected value
                select.value = currentValue;
            });
        }

        function updateCollectorsTable() {
            const tbody = document.getElementById('collectors-table');
            tbody.innerHTML = '';
            
            if (appData.collectors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="material-icons">people_outline</div>
                            <div>Aucun collecteur enregistré</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.collectors.forEach(collector => {
                const balance = calculateCollectorBalance(collector.id);
                const status = getCollectorStatus(balance);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nom">${collector.name}</td>
                    <td data-label="Téléphone">${collector.phone}</td>
                    <td data-label="C.I.N">${collector.cin || ''}</td>
                    <td data-label="Délivré le">${collector.cinDate ? formatDate(collector.cinDate) : ''}</td> <!-- <-- ANDININY VAOVAO -->
                    <td data-label="Adresse">${collector.address || ''}</td>
                    <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                    <td data-label="Solde">${formatCurrency(Math.abs(balance))}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openCollectorModal(${collector.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteCollector(${collector.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            initTableSorting();
        }

        function updateAdvancesTable() {
            const tbody = document.getElementById('advances-table');
            tbody.innerHTML = '';
            
            if (appData.advances.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="material-icons">account_balance_wallet</div>
                            <div>Aucune avance enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Filter advances
            const filteredAdvances = filterAdvances();
            
            filteredAdvances.forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(advance.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>                  
                    <td data-label="Montant">${formatCurrency(advance.amount)}</td>
                    <td data-label="Motif">${advance.motif || 'N/A'}</td> <!-- <-- ANDININY VAOVAO -->
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openAdvanceModal(${advance.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteAdvance(${advance.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            initTableSorting();
        }

        function updateReceptionTable() {
            const tbody = document.getElementById('reception-table');
            tbody.innerHTML = '';
            
            if (appData.receptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="material-icons">inventory</div>
                            <div>Aucune réception enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.receptions.forEach(reception => {
                const collector = appData.collectors.find(c => c.id === reception.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(reception.date)}</td>
                    <td>${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td>${reception.grossWeight} kg</td>
                    <td>${reception.netWeight} kg</td>
                    <td><span class="status-badge status-${reception.quality.toLowerCase()}">${reception.quality}</span></td>
                    <td>${formatCurrency(reception.price)}/kg</td>
                    <td>${formatCurrency(reception.totalValue)}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openReceptionModal(${reception.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteReception(${reception.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                        <!-- === BOKOTRA VAOVAO === -->
                        <button class="btn btn-icon btn-secondary" onclick="generateReceipt(${reception.id})" title="Imprimer le Reçu du Jour">
                            <span class="material-icons">print</span>
                        </button>
                        <!-- ===================== -->
                    </td>
                `;
                tbody.appendChild(row);
            });
            initTableSorting();
        }

        // Kaody vaovao
        function updateDeliveryTable() {
            const tbody = document.getElementById('delivery-table');
            tbody.innerHTML = '';
            
            if (appData.deliveries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state"> <!-- Niova ho 7 ny colspan -->
                            <div class="material-icons">local_shipping</div>
                            <div>Aucune livraison enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            appData.deliveries.forEach(delivery => {
                const row = document.createElement('tr');
                // Ampiana ny fampisehoana ny kalitao
                row.innerHTML = `
                    <td>${formatDate(delivery.date)}</td>
                    <td>${delivery.invoice}</td>
                    <td><span class="status-badge" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">${delivery.quality || 'N/A'}</span></td>
                    <td>${delivery.weight} kg</td>
                    <td>${formatCurrency(delivery.totalValue)}</td>
                    <td>${delivery.exporter}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openDeliveryModal(${delivery.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteDelivery(${delivery.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            initTableSorting();
        }


        function updateAnalysisTable() {
            const tbody = document.getElementById('analysis-table');
            tbody.innerHTML = '';
            
            if (appData.collectors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="material-icons">analytics</div>
                            <div>Aucune donnée d'analyse disponible</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Alaina ny sivana voafidy
            const filterCollectorId = document.getElementById('analysis-filter-collector').value;
            const filterQuality = document.getElementById('analysis-filter-quality').value;

            const collectorsToShow = filterCollectorId ? 
                appData.collectors.filter(c => c.id == filterCollectorId) : 
                appData.collectors;
            
            collectorsToShow.forEach(collector => {
                // Alaina ny totalin'ny avances (tsy miova)
                const totalAdvances = getTotalAdvances(collector.id);

                // --- KAJY VAOVAO HO AN'NY CRÉDITS ---
                // 1. Sivany aloha ny receptions araka ny kalitao voafidy
                let filteredReceptions = appData.receptions.filter(r => r.collectorId === collector.id);
                if (filterQuality) {
                    filteredReceptions = filteredReceptions.filter(r => r.quality === filterQuality);
                }
                
                // 2. Kajiana ny sandan'ireo receptions voasivana ireo
                const totalDeliveriesFiltered = filteredReceptions.reduce((sum, reception) => sum + reception.totalValue, 0);

                // 3. Alaina ny totalin'ny famerenam-bola (tsy miova)
                const totalRemboursements = (appData.remboursements || [])
                    .filter(rem => rem.collectorId === collector.id)
                    .reduce((sum, rem) => sum + rem.amount, 0);
                
                // 4. Atambatra ny vola miditra rehetra (livraisons voasivana + remboursements)
                const totalCredits = totalDeliveriesFiltered + totalRemboursements;
                // ------------------------------------

                // Kajiana ny balance vaovao mifototra amin'ny crédit voasivana
                const balance = totalCredits - totalAdvances;
                const status = getCollectorStatus(balance);
                
                let actionButton = '';
                if (status.class === 'debiteur') {
                    actionButton = `<button class="btn btn-icon btn-success" onclick="openRemboursementModal(${collector.id})" title="Enregistrer un remboursement"><span class="material-icons" style="color: white;">paid</span></button>`;
                } else if (status.class === 'crediteur') {
                    actionButton = `<button class="btn btn-icon btn-primary" onclick="payCollectorCredit(${collector.id})" title="Payer le solde créditeur"><span class="material-icons">payments</span></button>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Collecteur">${collector.name}</td>
                    <td data-label="Total Avances">${formatCurrency(totalAdvances)}</td>
                    <td data-label="Total Crédits (Filtré)">${formatCurrency(totalCredits)}</td>
                    <td data-label="Solde (Filtré)">${formatCurrency(Math.abs(balance))}</td>
                    <td data-label="Statut"><span class="status-badge status-${status.class}">${status.label}</span></td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="showCollectorDetails(${collector.id})" title="Détails">
                            <span class="material-icons">visibility</span>
                        </button>
                        ${actionButton}
                    </td>
                `;
                tbody.appendChild(row);
            });
            initTableSorting();
        }


        // Fiasa vaovao hamenoana ny sivana araka ny kalitao
        function updateAnalysisQualityFilter() {
            const select = document.getElementById('analysis-filter-quality');
            if (!select) return; // Fiarovana raha tsy misy ilay element

            const currentValue = select.value;
            // Esorina ny safidy taloha afa-tsy ilay voalohany ("Toutes les qualités")
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            if (appData.qualities) {
                appData.qualities.forEach(quality => {
                    const option = document.createElement('option');
                    option.value = quality.name;
                    option.textContent = quality.name;
                    select.appendChild(option);
                });
            }
            
            select.value = currentValue; // Averina ilay sanda voafidy teo aloha
        }


        // Helper Functions
        // Helper Functions
        function calculateCollectorBalance(collectorId) {
            // --- VOLA NIVOAKA REHETRA ---
            // Vola nindramina
            const totalAdvances = (appData.advances || [])
                .filter(advance => advance.collectorId === collectorId)
                .reduce((sum, advance) => sum + advance.amount, 0);
            
            // Vola naloa taminy (rehefa créditeur izy)
            const totalPaiements = (appData.paiements || [])
                .filter(p => p.collectorId === collectorId)
                .reduce((sum, p) => sum + p.amount, 0);
            
            // Totalin'ny vola nivoaka ho an'io collecteur io
            const totalDebits = totalAdvances + totalPaiements;

            // --- VOLA NIDITRA REHETRA ---
            // Sandan'ny lavanila nateriny
            const totalDeliveries = (appData.receptions || [])
                .filter(reception => reception.collectorId === collectorId)
                .reduce((sum, reception) => sum + reception.totalValue, 0);

            // Vola naveriny
            const totalRemboursements = (appData.remboursements || [])
                .filter(rem => rem.collectorId === collectorId)
                .reduce((sum, rem) => sum + rem.amount, 0);

            // Totalin'ny vola niditra avy amin'io collecteur io
            const totalCredits = totalDeliveries + totalRemboursements;
            
            // Kajiana ny elanelany
            return totalCredits - totalDebits;
        }



        function getTotalAdvances(collectorId) {
            return appData.advances
                .filter(advance => advance.collectorId === collectorId)
                .reduce((sum, advance) => sum + advance.amount, 0);
        }

        function getTotalDeliveries(collectorId) {
            return appData.receptions
                .filter(reception => reception.collectorId === collectorId)
                .reduce((sum, reception) => sum + reception.totalValue, 0);
        }

        function getCollectorStatus(balance) {
            if (balance > 0) {
                return { class: 'crediteur', label: 'Créditeur' };
            } else if (balance < 0) {
                return { class: 'debiteur', label: 'Débiteur' };
            } else {
                return { class: 'equilibre', label: 'Équilibré' };
            }
        }

        function filterAdvances() {
            let filtered = [...appData.advances];
            
            const collectorFilter = document.getElementById('advance-filter-collector').value;
            const startDate = document.getElementById('advance-filter-start').value;
            const endDate = document.getElementById('advance-filter-end').value;
            
            if (collectorFilter) {
                filtered = filtered.filter(advance => advance.collectorId == collectorFilter);
            }
            
            if (startDate) {
                filtered = filtered.filter(advance => advance.date >= startDate);
            }
            
            if (endDate) {
                filtered = filtered.filter(advance => advance.date <= endDate);
            }
            
            return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-MG', {
                style: 'currency',
                currency: 'MGA',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('MGA', 'Ar');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }

        /**
         * @param {number} num - Ny isa tiana hovaina.
         * @returns {string} - Ny isa efa misy endrika.
         */
        function formatNumber(num) {
            // Hamarino aloha raha isa marina no nomena
            if (typeof num !== 'number' || isNaN(num)) {
                return '-'; // Averina tiret raha tsy isa
            }
            
            // Mampiasa Intl.NumberFormat mba hahazoana endrika frantsay
            // 'fr-FR' dia mampiasa habaka ho an'ny arivo ary virgule ho an'ny desimaly
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2, // Asehoy foana ny isa 2 aorian'ny faingo
                maximumFractionDigits: 2  // Ferana ho 2 ny isa aorian'ny faingo
            }).format(num);
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['advance-date', 'reception-date', 'delivery-date'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.value) {
                    input.value = today;
                }
            });
        }

        /**
         * Fiasa vaovao hanamboatra ny endriky ny laharan-tariby ho an'ny fampisehoana.
         * Manova ny "0320000000" ho "032 00 000 00".
         * @param {string} phoneString - Ny laharan-tariby tsy misy habaka.
         * @returns {string} - Ny laharana efa misy endrika na ilay tany am-boalohany raha misy olana.
         */
        function formatPhoneNumberForDisplay(phoneString) {
            // Raha tsy misy ny laharana na tsy string dia averina izay nomena
            if (!phoneString || typeof phoneString !== 'string') {
                return phoneString || 'N/A';
            }

            // Esorina izay mety ho habaka efa misy
            const cleaned = phoneString.replace(/\s/g, '');

            // Hamarino raha 10 isa marina ilay izy
            if (cleaned.length === 10 && /^\d+$/.test(cleaned)) {
                // Apetraka ny habaka amin'ny toerana tokony hisy azy
                return `${cleaned.substring(0, 3)} ${cleaned.substring(3, 5)} ${cleaned.substring(5, 8)} ${cleaned.substring(8, 10)}`;
            }

            // Raha tsy manaraka ny fenitra dia averina ilay laharana tany am-boalohany
            return phoneString;
        }


        // Export/Import Functions
        function exportData() {
            const dataToExport = {
                collectors: appData.collectors.map(collector => ({
                    ...collector,
                    exportId: collector.id // Garder l'ID original pour les relations
                })),
                advances: appData.advances.map(advance => ({
                    ...advance,
                    exportId: advance.id,
                    collectorExportId: advance.collectorId // Référence à l'export ID du collecteur
                })),
                receptions: appData.receptions.map(reception => ({
                    ...reception,
                    exportId: reception.id,
                    collectorExportId: reception.collectorId // Référence à l'export ID du collecteur
                })),
                deliveries: appData.deliveries.map(delivery => ({
                    ...delivery,
                    exportId: delivery.id
                })),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `behavana-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        console.log('Raw imported data:', importedData);
                        
                        if (confirm('Êtes-vous sûr de vouloir importer ces données? Cela remplacera toutes les données existantes.')) {
                            executeWhenReady(() => {
                                if (!db) {
                                    console.warn('Database not available, importing to memory');
                                    // Import to memory as fallback
                                    appData = {
                                        collectors: importedData.collectors || [],
                                        advances: importedData.advances || [],
                                        receptions: importedData.receptions || [],
                                        deliveries: importedData.deliveries || []
                                    };
                                    updateAllTables();
                                    alert('Données importées avec succès (mode mémoire)!');
                                    return;
                                }
                                
                                console.log('Starting database import process...');
                                
                                try {
                                    // Clear existing data first
                                    clearAllData(() => {
                                        console.log('Database cleared, starting import...');
                                        // Import new data after clearing
                                        importNewData(importedData);
                                    });
                                } catch (error) {
                                    console.error('Import error:', error);
                                    alert('Erreur lors de l\'importation: ' + error.message);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('JSON parse error:', error);
                        alert('Erreur lors de l\'importation du fichier JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Helper function to clear all data
        function clearAllData(callback) {
            if (!db || db.readyState === 'done') {
                console.warn('Database not available for clearing, clearing memory only');
                appData = {
                    collectors: [],
                    advances: [],
                    receptions: [],
                    deliveries: []
                };
                if (callback) callback();
                return;
            }

            const stores = ['collectors', 'advances', 'receptions', 'deliveries', 'expenses'];
            let clearedStores = 0;
            
            try {
                stores.forEach(storeName => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const clearRequest = store.clear();
                    
                    clearRequest.onsuccess = function() {
                        clearedStores++;
                        console.log(`Cleared store: ${storeName} (${clearedStores}/${stores.length})`);
                        if (clearedStores === stores.length) {
                            console.log('All stores cleared successfully');
                            // Wait a bit for the database to settle
                            setTimeout(() => {
                                if (callback) callback();
                            }, 200);
                        }
                    };
                    
                    clearRequest.onerror = function(event) {
                        console.error(`Error clearing ${storeName}:`, event.target.error);
                        clearedStores++;
                        if (clearedStores === stores.length) {
                            if (callback) callback();
                        }
                    };

                    transaction.onerror = function(event) {
                        console.error(`Transaction error clearing ${storeName}:`, event.target.error);
                        clearedStores++;
                        if (clearedStores === stores.length) {
                            if (callback) callback();
                        }
                    };
                });
            } catch (error) {
                console.error('Error accessing database for clearing:', error);
                if (callback) callback();
            }
        }

        // Helper function to import new data
        function importNewData(importedData) {
            console.log('Starting import process with data:', importedData);
            
            const collectorIdMapping = {}; // Mapping des anciens IDs vers les nouveaux
            
            // Étape 1: Importer les collecteurs d'abord
            importCollectors(importedData.collectors || [], (newCollectorIds) => {
                console.log('Collectors imported with new IDs:', newCollectorIds);
                
                // Étape 2: Créer le mapping des IDs
                (importedData.collectors || []).forEach((collector, index) => {
                    const oldId = collector.exportId || collector.id;
                    const newId = newCollectorIds[index];
                    if (oldId && newId) {
                        collectorIdMapping[oldId] = newId;
                        console.log(`Mapping: ${oldId} → ${newId}`);
                    }
                });
                
                console.log('Complete ID mapping:', collectorIdMapping);
                
                // Étape 3: Importer les avances avec les nouveaux IDs
                const advancesWithNewIds = (importedData.advances || []).map((advance, index) => {
                    const oldCollectorId = advance.collectorExportId || advance.collectorId;
                    const newCollectorId = collectorIdMapping[oldCollectorId];
                    
                    console.log(`Advance ${index}: oldCollectorId=${oldCollectorId}, newCollectorId=${newCollectorId}`);
                    
                    if (newCollectorId) {
                        return {
                            amount: advance.amount,
                            date: advance.date,
                            collectorId: newCollectorId,
                            createdAt: advance.createdAt || new Date().toISOString()
                        };
                    } else {
                        console.warn(`No mapping found for advance collector ID: ${oldCollectorId}`);
                        return null;
                    }
                }).filter(Boolean);
                
                console.log('Advances with new IDs:', advancesWithNewIds);
                
                // Étape 4: Importer les réceptions avec les nouveaux IDs  
                const receptionsWithNewIds = (importedData.receptions || []).map((reception, index) => {
                    const oldCollectorId = reception.collectorExportId || reception.collectorId;
                    const newCollectorId = collectorIdMapping[oldCollectorId];
                    
                    console.log(`Reception ${index}: oldCollectorId=${oldCollectorId}, newCollectorId=${newCollectorId}`);
                    
                    if (newCollectorId) {
                        return {
                            collectorId: newCollectorId,
                            date: reception.date,
                            grossWeight: reception.grossWeight,
                            bagCount: reception.bagCount,
                            bagWeight: reception.bagWeight,
                            netWeight: reception.netWeight,
                            quality: reception.quality,
                            price: reception.price,
                            totalValue: reception.totalValue,
                            createdAt: reception.createdAt || new Date().toISOString()
                        };
                    } else {
                        console.warn(`No mapping found for reception collector ID: ${oldCollectorId}`);
                        return null;
                    }
                }).filter(Boolean);
                
                console.log('Receptions with new IDs:', receptionsWithNewIds);
                
                // Étape 5: Importer les autres données
                let remainingImports = 0;
                const totalImports = 3; // advances, receptions, deliveries
                
                const checkComplete = () => {
                    remainingImports++;
                    console.log(`Import completed: ${remainingImports}/${totalImports}`);
                    if (remainingImports >= totalImports) {
                        setTimeout(() => {
                            console.log('All imports completed, reloading data...');
                            loadData();
                            alert('Données importées avec succès! Toutes les relations ont été préservées.');
                        }, 500);
                    }
                };
                
                importStoreData('advances', advancesWithNewIds, checkComplete);
                importStoreData('receptions', receptionsWithNewIds, checkComplete);
                importStoreData('deliveries', importedData.deliveries || [], checkComplete);
            });
        }

        // Helper function to import collectors and return their new IDs
        function importCollectors(collectors, callback) {
            console.log('Importing collectors:', collectors);
            
            if (!collectors || collectors.length === 0) {
                console.log('No collectors to import');
                if (callback) callback([]);
                return;
            }
            
            const newIds = [];
            let processedCount = 0;
            
            try {
                const transaction = db.transaction(['collectors'], 'readwrite');
                const store = transaction.objectStore('collectors');
                
                collectors.forEach((collector, index) => {
                    const cleanCollector = {
                        name: collector.name,
                        phone: collector.phone,
                        address: collector.address,
                        createdAt: collector.createdAt || new Date().toISOString()
                    };
                    
                    console.log(`Adding collector ${index}:`, cleanCollector);
                    
                    const request = store.add(cleanCollector);
                    
                    request.onsuccess = function(event) {
                        const newId = event.target.result;
                        newIds[index] = newId;
                        console.log(`Collector "${collector.name}" imported with new ID: ${newId}`);
                        processedCount++;
                        
                        if (processedCount === collectors.length) {
                            console.log(`All ${collectors.length} collectors imported. New IDs:`, newIds);
                            if (callback) callback(newIds);
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error(`Error importing collector "${collector.name}":`, event.target.error);
                        newIds[index] = null;
                        processedCount++;
                        
                        if (processedCount === collectors.length) {
                            if (callback) callback(newIds);
                        }
                    };
                });
                
                transaction.onerror = function(event) {
                    console.error('Transaction error while importing collectors:', event.target.error);
                    if (callback) callback([]);
                };
            } catch (error) {
                console.error('Error importing collectors:', error);
                if (callback) callback([]);
            }
        }

        // Helper function to import data for a specific store
        function importStoreData(storeName, items, callback) {
            if (!items || items.length === 0) {
                if (callback) callback();
                return;
            }
            
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                let processedItems = 0;
                
                items.forEach(item => {
                    // Remove export-related fields and ID to let IndexedDB auto-generate new ones
                    const cleanItem = { ...item };
                    delete cleanItem.id;
                    delete cleanItem.exportId;
                    delete cleanItem.collectorExportId;
                    
                    const request = store.add(cleanItem);
                    
                    request.onsuccess = function() {
                        processedItems++;
                        if (processedItems === items.length) {
                            console.log(`Imported ${items.length} items to ${storeName}`);
                            if (callback) callback();
                        }
                    };
                    
                    request.onerror = function(event) {
                        console.error(`Error importing item to ${storeName}:`, event.target.error);
                        processedItems++;
                        if (processedItems === items.length) {
                            if (callback) callback();
                        }
                    };
                });
                
                transaction.onerror = function(event) {
                    console.error(`Transaction error for ${storeName}:`, event.target.error);
                    if (callback) callback();
                };
            } catch (error) {
                console.error(`Error importing to ${storeName}:`, error);
                if (callback) callback();
            }
        }

        function resetData() {
            if (confirm('Êtes-vous sûr de vouloir effacer toutes les données? Cette action est irréversible.')) {
                // ... ao anatin'ny resetData()
                if (confirm('Confirmation finale: Toutes les données seront perdues définitivement!')) {
                    executeWhenReady(() => {
                        if (!db) {
                            console.warn('Database not available, clearing memory data');
                            // Clear memory data as fallback
                            appData = {
                                collectors: [],
                                advances: [],
                                receptions: [],
                                deliveries: [],
                                expenses: [] // <-- AMPIANA ITY
                            };
                            updateAllTables();
                            alert('Toutes les données ont été supprimées (mode mémoire).');
                            return;
                        }
                        
                        // Use the same clear function as import
                        clearAllData(() => {
                            // Reset app data
                            appData = {
                                collectors: [],
                                advances: [],
                                receptions: [],
                                deliveries: [],
                                expenses: [] // <-- AMPIANA ITY
                            };
                            
                            // Update all tables immediately
                            updateAllTables();
                            alert('Toutes les données ont été supprimées.');
                        });
                    });
                }

            }
        }

        // PDF Export Functions
        function exportInvoice() {
            // Group receptions by collector
            const receptionsByCollector = {};
            appData.receptions.forEach(reception => {
                const collector = appData.collectors.find(c => c.id === reception.collectorId);
                const collectorName = collector ? collector.name : 'Collecteur supprimé';
                
                if (!receptionsByCollector[collectorName]) {
                    receptionsByCollector[collectorName] = [];
                }
                receptionsByCollector[collectorName].push(reception);
            });
            
            // Create PDF content
            let pdfContent = `
                <html>
                <head>
                    <title>Facture - BEHAVANA</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .company-name { font-size: 24px; font-weight: bold; color: #6750a4; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .collector-section { margin-bottom: 30px; }
                        .collector-name { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        .total { font-weight: bold; background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Facture de Réception - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
            `;
            
            Object.keys(receptionsByCollector).forEach(collectorName => {
                const receptions = receptionsByCollector[collectorName];
                const totalWeight = receptions.reduce((sum, r) => sum + r.netWeight, 0);
                const totalValue = receptions.reduce((sum, r) => sum + r.totalValue, 0);
                
                pdfContent += `
                    <div class="collector-section">
                        <div class="collector-name">${collectorName}</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Poids Net (kg)</th>
                                    <th>Qualité</th>
                                    <th>Prix/kg</th>
                                    <th>Valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                receptions.forEach(reception => {
                    pdfContent += `
                        <tr>
                            <td>${formatDate(reception.date)}</td>
                            <td>${reception.netWeight}</td>
                            <td>${reception.quality}</td>
                            <td>${formatCurrency(reception.price)}</td>
                            <td>${formatCurrency(reception.totalValue)}</td>
                        </tr>
                    `;
                });
                
                pdfContent += `
                            <tr class="total">
                                <td colspan="1"><strong>Total</strong></td>
                                <td><strong>${totalWeight.toFixed(2)} kg</strong></td>
                                <td></td> <!-- Avela banga ny toeran'ny Qualité -->
                                <td></td> <!-- Avela banga ny toeran'ny Prix/kg -->
                                <td><strong>${formatCurrency(totalValue)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                `;
            });
            
            pdfContent += '</body></html>';
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        /**
         * Fiasa vaovao hamoronana "reçu" ho an'ny fanaterana rehetra
         * nataon'ny mpanangom-bokatra iray tamin'ny daty iray manokana.
         */
        function generateReceipt(receptionId) {
            // 1. Tadiavo ilay fanaterana fototra natsindriana mba hahazoana ny daty sy ny collecteur
            const baseReception = appData.receptions.find(r => r.id === receptionId);
            if (!baseReception) {
                alert("Erreur: Impossible de trouver la réception de base.");
                return;
            }

            const receptionDate = baseReception.date;
            const collectorId = baseReception.collectorId;

            // 2. Tadiavo ny mombamomba ilay mpanangom-bokatra
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Erreur: Impossible de trouver les informations du collecteur.");
                return;
            }

            // 3. Angony ny fanaterana REHETRA nataon'io mpanangom-bokatra io tamin'io daty io
            const dailyReceptions = appData.receptions.filter(r => 
                r.collectorId === collectorId && r.date === receptionDate
            );

            if (dailyReceptions.length === 0) {
                alert("Aucune réception trouvée pour ce collecteur à cette date.");
                return;
            }

            // 4. Kajiana ny totaliny rehetra
            const totalNetWeight = dailyReceptions.reduce((sum, r) => sum + r.netWeight, 0);
            const totalValue = dailyReceptions.reduce((sum, r) => sum + r.totalValue, 0);

            // 5. Amboary ny votoatin'ny PDF miaraka amin'ny endrika (style) tsara kokoa
            let pdfContent = `
                <html>
                <head>
                    <title>Reçu - ${collector.name} - ${formatDate(receptionDate)}</title>
                    <style>
                        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; margin: 20px; font-size: 13px; color: #333; }
                        .receipt-container { border: 1px solid #ccc; padding: 25px; max-width: 700px; margin: auto; background-color: #fff; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .company-name { font-size: 26px; font-weight: bold; color: #6750a4; }
                        .receipt-title { font-size: 18px; font-weight: 500; margin: 5px 0; text-transform: uppercase; letter-spacing: 1px; }
                        .info-section { border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 15px 0; margin-bottom: 20px; display: flex; justify-content: space-between; }
                        .info-section div { line-height: 1.7; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
                        th { background-color: #f9f9f9; font-weight: 600; }
                        .text-right { text-align: right; }
                        .total-row { background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #333; }
                        .footer { margin-top: 30px; padding-top: 20px; display: flex; justify-content: space-around; }
                        .signature-box { width: 40%; border-top: 1px solid #333; padding-top: 8px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="header">
                            <div class="company-name">BEHAVANA</div>
                            <div class="receipt-title">Reçu de Réception de Vanille</div>
                        </div>

                        <div class="info-section">
                            <div>
                                <strong>Collecteur:</strong> ${collector.name}  

                                <strong>CIN:</strong> ${collector.cin || 'Non fourni'} ${collector.cinDate ? `(délivré le ${formatDate(collector.cinDate)})` : ''}
                            </div>
                            <div>
                                <strong>Date:</strong> ${formatDate(receptionDate)}  

                                <strong>Reçu N°:</strong> R${new Date(receptionDate).getTime().toString().slice(-5)}${collectorId}
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Qualité</th>
                                    <th class="text-right">Poids Net (kg)</th>
                                    <th class="text-right">Prix / kg</th>
                                    <th class="text-right">Valeur</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${dailyReceptions.map(reception => `
                                    <tr>
                                        <td>${reception.quality}</td>
                                        <td class="text-right">${reception.netWeight.toFixed(2)}</td>
                                        <td class="text-right">${formatCurrency(reception.price)}</td>
                                        <td class="text-right">${formatCurrency(reception.totalValue)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td><strong>TOTAL</strong></td>
                                    <td class="text-right"><strong>${totalNetWeight.toFixed(2)} kg</strong></td>
                                    <td></td>
                                    <td class="text-right"><strong>${formatCurrency(totalValue)}</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="footer">
                            <div class="signature-box">
                                Signature du Collecteur
                            </div>
                            <div class="signature-box">
                                Signature (BEHAVANA)
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // 6. Sokafy anaty varavarankely vaovao mba hahafahana manao "print"
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Soloina manontolo ity fiasa ity
        function exportAnalysis() {
            let pdfContent = `
                <html>
                <head>
                    <title>Analyse des Collecteurs - BEHAVANA</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 10px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .company-name { font-size: 24px; font-weight: bold; color: #6750a4; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .status-debiteur { color: #ba1a1a; font-weight: bold; }
                        .status-crediteur { color: #2e7d32; font-weight: bold; }
                        .status-equilibre { color: #625b71; }
                        .amount { text-align: right; }
                        .total-row { background-color: #e8def8; font-weight: bold; }
                        .total-row td { border-top: 2px solid #6750a4; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Rapport d'Analyse des Comptes - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Collecteur</th>
                                <th>Téléphone</th>
                                <!-- === FANITSARANA ETO === -->
                                <th class="amount">Total Débits (Avances + Paiements)</th>
                                <th class="amount">Total Crédits (Livraisons + Remboursements)</th>
                                <!-- ======================= -->
                                <th class="amount">Solde</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalDebiteur = 0;
            let totalCrediteur = 0;

            appData.collectors.forEach(collector => {
                const totalAdvances = getTotalAdvances(collector.id);
                const totalPaiements = (appData.paiements || []).filter(p => p.collectorId === collector.id).reduce((sum, p) => sum + p.amount, 0);
                const totalDebits = totalAdvances + totalPaiements;
                const totalDeliveries = getTotalDeliveries(collector.id);
                const totalRemboursements = (appData.remboursements || []).filter(rem => rem.collectorId === collector.id).reduce((sum, rem) => sum + rem.amount, 0);
                const totalCredits = totalDeliveries + totalRemboursements;
                const balance = totalCredits - totalDebits;
                const status = getCollectorStatus(balance);
                
                if (balance < 0) {
                    totalDebiteur += balance;
                } else if (balance > 0) {
                    totalCrediteur += balance;
                }

                pdfContent += `
                    <tr>
                        <td>${collector.name}</td>
                        <td>${formatPhoneNumberForDisplay(collector.phone)}</td>
                        <td class="amount">${formatCurrency(totalDebits)}</td>
                        <td class="amount">${formatCurrency(totalCredits)}</td>
                        <td class="amount">${formatCurrency(balance)}</td>
                        <td class="status-${status.class}">${status.label}</td>
                    </tr>
                `;
            });
            
            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4" class="amount">TOTAL SOLDE NON RÉCUPÉRÉ (Dettes Collecteurs) :</td>
                                <td class="amount status-debiteur">${formatCurrency(totalDebiteur)}</td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="4" class="amount">TOTAL CRÉDIT (Dû aux Collecteurs) :</td>
                                <td class="amount status-crediteur">${formatCurrency(totalCrediteur)}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }

        function exportPoidsAnalysis() {
            const toutesLesQualites = [...new Set(appData.receptions.map(r => r.quality))].sort();

            let pdfContent = `
                <html>
                <head>
                    <title>Analyse des Poids Livrés - BEHAVANA</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 10px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .company-name { font-size: 24px; font-weight: bold; color: #6750a4; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: right; }
                        th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
                        td.collector-name { text-align: left; font-weight: bold; }
                        .total-col { background-color: #e8def8; font-weight: bold; }
                        .total-row th, .total-row td { border-top: 2px solid #6750a4; background-color: #e8def8; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div>Analyse des Poids Livrés par Collecteur - ${formatDate(new Date().toISOString().split('T')[0])}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left;">Collecteur</th>
                                ${toutesLesQualites.map(q => `<th>${q} (kg)</th>`).join('')}
                                <th class="total-col">TOTAL LIVRÉ (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const totalParQualite = {};
            toutesLesQualites.forEach(q => totalParQualite[q] = 0);
            let grandTotalPoids = 0;

            appData.collectors.forEach(collector => {
                let totalPoidsParCollecteur = 0;
                
                pdfContent += `<tr><td class="collector-name">${collector.name}</td>`;

                toutesLesQualites.forEach(qualite => {
                    const poids = appData.receptions
                        .filter(r => r.collectorId === collector.id && r.quality === qualite)
                        .reduce((sum, r) => sum + r.netWeight, 0);
                    
                    // === FANITSARANA ETO ===
                    pdfContent += `<td>${poids > 0 ? formatNumber(poids) : '-'}</td>`;
                    totalPoidsParCollecteur += poids;
                    totalParQualite[qualite] += poids;
                });

                // === FANITSARANA ETO ===
                pdfContent += `<td class="total-col">${formatNumber(totalPoidsParCollecteur)}</td></tr>`;
                grandTotalPoids += totalPoidsParCollecteur;
            });
            
            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <th style="text-align: left;">TOTAL GÉNÉRAL</th>
                                <!-- === FANITSARANA ETO === -->
                                ${toutesLesQualites.map(q => `<td>${formatNumber(totalParQualite[q])}</td>`).join('')}
                                <td class="total-col">${formatNumber(grandTotalPoids)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }



        // Quick Add Function
        function quickAdd() {
            // Quick add based on current section
            const activeSection = document.querySelector('.content-section.active').id;
            
            switch (activeSection) {
                case 'collectors':
                    openCollectorModal();
                    break;
                case 'advances':
                    openAdvanceModal();
                    break;
                case 'reception':
                    openReceptionModal();
                    break;
                case 'delivery':
                    openDeliveryModal();
                    break;
                default:
                    openCollectorModal();
            }
        }

        // Event Listeners for filters
        // Event Listeners for filters AND Initialization
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Add filter event listeners (tsy miova)
            ['advance-filter-collector'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateAdvancesTable);
                }
            });
            
            const analysisFilter = document.getElementById('analysis-filter-collector');
            if (analysisFilter) {
                analysisFilter.addEventListener('change', updateAnalysisTable);
            }

            // 2. Initialize Table Sorting for the first time
            initTableSorting();

            // 3. Initialize MutationObserver for automatic data-label updates
            const observer = new MutationObserver((mutations) => {
                let shouldUpdate = false;
                for (const mutation of mutations) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        shouldUpdate = true;
                        break;
                    }
                }
                if (shouldUpdate) {
                    setDataLabels();
                }
            });

            document.querySelectorAll('tbody').forEach(tbody => {
                observer.observe(tbody, { childList: true });
            });

            // 4. Load initial data
            loadData(); // It will trigger the observer and sorting initialization via update...Table() calls
        });


        // === INITIALISATION DU TRI DES TABLEAUX (GLOBAL FUNCTION) ===
        // Kaody VAOVAO nohavaozina
        function initTableSorting() {
            const allHeaders = document.querySelectorAll("th");

            // Fiasa kely hanovana ny daty "DD/MM/YYYY" ho objet Date marina
            const parseDate = (dateStr) => {
                const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (!parts) return null;
                // parts[0] dia ny daty feno, [1] ny andro, [2] ny volana, [3] ny taona
                return new Date(parts[3], parts[2] - 1, parts[1]);
            };

            allHeaders.forEach((th) => {
                if (th.dataset.sortInitialized) {
                    return;
                }
                th.dataset.sortInitialized = true;

                th.addEventListener("click", () => {
                    const table = th.closest("table");
                    if (!table) return;

                    const realColumnIndex = Array.from(th.parentNode.children).indexOf(th);
                    const tbody = table.querySelector("tbody");
                    if (!tbody) return;

                    const rows = Array.from(tbody.querySelectorAll("tr:not(:has(.empty-state))"));
                    if (rows.length === 0) return;

                    const direction = th.classList.contains("asc") ? 'desc' : 'asc';

                    rows.sort((a, b) => {
                        const cellA = a.children[realColumnIndex].innerText.trim();
                        const cellB = b.children[realColumnIndex].innerText.trim();

                        // Andramana aloha raha daty izy ireo
                        const dateA = parseDate(cellA);
                        const dateB = parseDate(cellB);

                        let comparison = 0;

                        if (dateA && dateB) {
                            // Raha samy daty dia ny fotoana no ampitahaina
                            comparison = dateA.getTime() - dateB.getTime();
                        } else {
                            // Raha tsy daty, dia andramana raha isa (toy ny teo aloha)
                            const numA = parseFloat(cellA.replace(/[^0-9,.-]+/g, "").replace(',', '.'));
                            const numB = parseFloat(cellB.replace(/[^0-9,.-]+/g, "").replace(',', '.'));

                            if (!isNaN(numA) && !isNaN(numB)) {
                                comparison = numA - numB;
                            } else {
                                // Raha tsy daty na isa, dia lahatsoratra tsotra
                                comparison = cellA.localeCompare(cellB, 'fr', { sensitivity: 'base' });
                            }
                        }

                        return direction === 'asc' ? comparison : -comparison;
                    });

                    th.parentElement.querySelectorAll("th").forEach(otherTh => {
                        otherTh.classList.remove("asc", "desc");
                    });

                    th.classList.add(direction);
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }



        function setDataLabels() {
            document.querySelectorAll('.data-table').forEach(table => {
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
                table.querySelectorAll('tbody tr').forEach(row => {
                    if (row.querySelector('.empty-state')) return;
                    row.querySelectorAll('td').forEach((td, index) => {
                        if (headers[index]) {
                            td.setAttribute('data-label', headers[index] + ': ');
                        }
                    });
                });
            });
        }

        // Date Filter Functions for Advances
        function setDateFilter(period) {
            const today = new Date();
            const startInput = document.getElementById('advance-filter-start');
            const endInput = document.getElementById('advance-filter-end');
            
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = endDate = today;
                    break;
                    
                case 'week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
                    startDate = startOfWeek;
                    endDate = endOfWeek;
                    break;
                    
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                    
                default:
                    return;
            }
            
            startInput.value = startDate.toISOString().split('T')[0];
            endInput.value = endDate.toISOString().split('T')[0];
            
            // Trigger filter update
            updateAdvancesTable();
        }

        function clearDateFilter() {
            document.getElementById('advance-filter-start').value = '';
            document.getElementById('advance-filter-end').value = '';
            updateAdvancesTable();
        }

        function filterAdvancesByDate() {
            updateAdvancesTable();
        }

        // Mobile responsive menu toggle
        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        


        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth <= 768 && sidebar.classList.contains('mobile-open')) {
                if (!sidebar.contains(e.target) && mainContent.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });
        // Collector Details Functions
        //======================================================================
        //                 KAODY VAOVAO HASOLO ILAY IRAY MANONTOLO
        //======================================================================

        //======================================================================
        //                 KAODY VAOVAO sy FENO miaraka amin'ny ICONS
        //======================================================================

        function showCollectorDetails(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Tsy hita ny Collecteur!");
                return;
            }

            // Angonina daholo ny transaction rehetra mifandraika amin'ilay collecteur
            const advances = appData.advances.filter(a => a.collectorId === collectorId);
            const receptions = appData.receptions.filter(r => r.collectorId === collectorId);
            const remboursements = (appData.remboursements || []).filter(rem => rem.collectorId === collectorId);
            const paiements = (appData.paiements || []).filter(p => p.collectorId === collectorId);

            // Kajiana ny totaliny isan-karazany
            const totalAdvances = advances.reduce((sum, a) => sum + a.amount, 0);
            const totalDeliveries = receptions.reduce((sum, r) => sum + r.totalValue, 0);
            const totalRemboursements = remboursements.reduce((sum, rem) => sum + rem.amount, 0);
            const totalPaiements = paiements.reduce((sum, p) => sum + p.amount, 0);
            
            const balance = calculateCollectorBalance(collectorId);
            const status = getCollectorStatus(balance);

            // Create detailed modal content
            const modalContent = `
                <div class="modal-header">
                    <h3 class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                        <span class="material-icons" style="color: var(--md-sys-color-primary);">person</span>
                        Détails - ${collector.name}
                    </h3>
                    <button class="close-btn" onclick="closeModal('collector-details-modal')">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 15px;">
                    <!-- Fizarana misy an'ireo ICONS efa naverina -->
                    <div style="background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-tertiary-container)); padding: 24px; border-radius: 16px; margin-bottom: 24px; color: var(--md-sys-color-on-primary-container);">
                        <h4 style="margin-bottom: 16px; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">account_circle</span>
                            Informations du Collecteur
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">phone</span>
                                    Téléphone
                                </div>
                                <div style="font-weight: 500;">${collector.phone || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">fingerprint</span>
                                    CIN
                                </div>
                                <div style="font-weight: 500;">
                                    ${collector.cin || 'N/A'}
                                    ${collector.cinDate ? `<small style="opacity: 0.8;">(délivré le ${formatDate(collector.cinDate)})</small>` : ''}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-icons" style="font-size: 18px;">calendar_today</span>
                                    Inscription
                                </div>
                                <div style="font-weight: 500;">${formatDate(collector.createdAt)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Fizarana Financial Summary (tsy miova) -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(totalAdvances)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Total Avances</div>
                        </div>
                        <div style="background: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container); padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(totalDeliveries)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Total Livraisons</div>
                        </div>
                        <div style="background: ${balance >= 0 ? 'var(--md-sys-color-success-container)' : 'var(--md-sys-color-error-container)'}; color: ${balance >= 0 ? 'var(--md-sys-color-on-success-container)' : 'var(--md-sys-color-on-error-container)'}; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 4px;">${formatCurrency(Math.abs(balance))}</div>
                            <div style="font-size: 14px; opacity: 0.8;">Solde Actuel</div>
                            <div style="font-size: 12px; margin-top: 4px; font-weight: 500;">${status.label}</div>
                        </div>
                    </div>

                    <!-- Transaction History Tabs (efa ahitsy ny filaharana) -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; border-bottom: 2px solid var(--md-sys-color-outline-variant); margin-bottom: 16px; flex-wrap: wrap;">
                            <button class="detail-tab-btn active" onclick="switchDetailTab(event, 'advances-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-primary); font-weight: 500; border-bottom: 2px solid var(--md-sys-color-primary); cursor: pointer;">💰 Avances (${advances.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'receptions-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">📦 Livraisons (${receptions.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'remboursements-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">💵 Remboursements (${remboursements.length})</button>
                            <button class="detail-tab-btn" onclick="switchDetailTab(event, 'paiements-tab')" style="padding: 12px 20px; border: none; background: none; color: var(--md-sys-color-on-surface); font-weight: 500; border-bottom: 2px solid transparent; cursor: pointer;">💸 Paiements (${paiements.length})</button>
                        </div>

                        <!-- Onglet Avances -->
                        <div id="advances-tab" class="detail-tab-content" style="display: block;">
                            ${advances.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead><tr><th>Date</th><th>Motif</th><th style="text-align: right;">Montant</th></tr></thead>
                                    <tbody>
                                        ${advances.sort((a, b) => new Date(a.date) - new Date(b.date)).map(advance => `
                                            <tr><td style="padding: 8px;">${formatDate(advance.date)}</td><td style="padding: 8px;">${advance.motif || ''}</td><td style="padding: 8px; text-align: right;">${formatCurrency(advance.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: #f5f5f5;"><td colspan="2" style="padding: 8px;">TOTAL</td><td style="padding: 8px; text-align: right;">${formatCurrency(totalAdvances)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px;">Aucune avance</div>`}
                        </div>

                        <!-- Onglet Livraisons (Réceptions) -->
                        <div id="receptions-tab" class="detail-tab-content" style="display: none;">
                            ${receptions.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead><tr><th>Date</th><th style="text-align: right;">Poids</th><th>Qualité</th><th style="text-align: right;">Prix/kg</th><th style="text-align: right;">Valeur</th></tr></thead>
                                    <tbody>
                                        ${receptions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(reception => `
                                            <tr><td style="padding: 8px;">${formatDate(reception.date)}</td><td style="padding: 8px; text-align: right;">${reception.netWeight.toFixed(2)} kg</td><td style="padding: 8px;">${reception.quality}</td><td style="padding: 8px; text-align: right;">${formatCurrency(reception.price)}</td><td style="padding: 8px; text-align: right;">${formatCurrency(reception.totalValue)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: #f5f5f5;"><td colspan="4" style="padding: 8px;">TOTAL</td><td style="padding: 8px; text-align: right;">${formatCurrency(totalDeliveries)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px;">Aucune livraison</div>`}
                        </div>

                        <!-- Onglet Remboursements -->
                        <div id="remboursements-tab" class="detail-tab-content" style="display: none;">
                            ${remboursements.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead><tr><th>Date</th><th>Note</th><th style="text-align: right;">Montant</th></tr></thead>
                                    <tbody>
                                        ${remboursements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(rem => `
                                            <tr><td style="padding: 8px;">${formatDate(rem.date)}</td><td style="padding: 8px;">${rem.note || ''}</td><td style="padding: 8px; text-align: right;">${formatCurrency(rem.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: #f5f5f5;"><td colspan="2" style="padding: 8px;">TOTAL REMBOURSÉ</td><td style="padding: 8px; text-align: right;">${formatCurrency(totalRemboursements)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px;">Aucun remboursement</div>`}
                        </div>
                        
                        <!-- Onglet Paiements -->
                        <div id="paiements-tab" class="detail-tab-content" style="display: none;">
                            ${paiements.length > 0 ? `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead><tr><th>Date</th><th>Note</th><th style="text-align: right;">Montant Payé</th></tr></thead>
                                    <tbody>
                                        ${paiements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(p => `
                                            <tr><td style="padding: 8px;">${formatDate(p.date)}</td><td style="padding: 8px;">${p.note || ''}</td><td style="padding: 8px; text-align: right;">${formatCurrency(p.amount)}</td></tr>
                                        `).join('')}
                                        <tr style="font-weight: bold; background-color: #f5f5f5;"><td colspan="2" style="padding: 8px;">TOTAL PAYÉ</td><td style="padding: 8px; text-align: right;">${formatCurrency(totalPaiements)}</td></tr>
                                    </tbody>
                                </table>
                            ` : `<div style="text-align: center; padding: 20px;">Aucun paiement de solde enregistré.</div>`}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 20px;">
                        <button class="btn btn-outline" onclick="exportCollectorReport(${collectorId})" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">picture_as_pdf</span>
                            Export PDF
                        </button>
                        <button class="btn btn-success" onclick="exportCollectorDetailsToExcel(${collectorId})" style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons">table_view</span>
                            Export Excel
                        </button>
                        <button class="btn btn-primary" onclick="closeModal('collector-details-modal')">Fermer</button>
                    </div>
                </div>
            `;

            // Create or update the details modal
            let detailsModal = document.getElementById('collector-details-modal');
            if (!detailsModal) {
                detailsModal = document.createElement('div');
                detailsModal.className = 'modal';
                detailsModal.id = 'collector-details-modal';
                document.body.appendChild(detailsModal);
            }

            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; width: 95%; max-height: 90vh;">
                    ${modalContent}
                </div>
            `;

            openModal('collector-details-modal');
        }





        // Tab switching function for collector details
        function switchDetailTab(event, tabId) {
            const parent = event.target.parentElement;
            // Esory ny active class amin'ny bokotra rehetra
            parent.querySelectorAll('.detail-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = 'var(--md-sys-color-on-surface)';
            });

            // Afeno ny atiny rehetra
            parent.parentElement.querySelectorAll('.detail-tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Asehoy ny atiny voafidy
            document.getElementById(tabId).style.display = 'block';

            // Ampio ny active class amin'ilay bokotra vao notsindriana
            event.target.classList.add('active');
            event.target.style.borderBottomColor = 'var(--md-sys-color-primary)';
            event.target.style.color = 'var(--md-sys-color-primary)';
        }


        // Export collector report function
        function exportCollectorReport(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) return;

            // --- KAJY VAOVAO SY FENO ---
            const advances = appData.advances.filter(a => a.collectorId === collectorId);
            const receptions = appData.receptions.filter(r => r.collectorId === collectorId);
            const remboursements = (appData.remboursements || []).filter(rem => rem.collectorId === collectorId);
            const paiements = (appData.paiements || []).filter(p => p.collectorId === collectorId); // <-- Alaina ny paiements

            const totalAdvances = advances.reduce((sum, a) => sum + a.amount, 0);
            const totalDeliveries = receptions.reduce((sum, r) => sum + r.totalValue, 0);
            const totalRemboursements = remboursements.reduce((sum, rem) => sum + rem.amount, 0);
            const totalPaiements = paiements.reduce((sum, p) => sum + p.amount, 0); // <-- Kajiana ny totaliny

            const totalCredits = totalDeliveries + totalRemboursements;
            const totalDebits = totalAdvances + totalPaiements; // <-- Ampiasaina eto ny totalPaiements

            const balance = totalCredits - totalDebits;
            const status = getCollectorStatus(balance);
            // ---------------------------

            let pdfContent = `
                <html>
                <head>
                    <title>Rapport Détaillé - ${collector.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #6750a4; padding-bottom: 15px; }
                        .company-name { font-size: 24px; font-weight: bold; color: #6750a4; }
                        .report-title { font-size: 18px; color: #666; }
                        .collector-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; text-align: center; }
                        .summary-card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
                        .summary-value { font-size: 18px; font-weight: bold; }
                        .summary-label { font-size: 11px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .section-title { font-size: 16px; font-weight: bold; color: #333; margin: 25px 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .total-row { background-color: #f8f9fa; font-weight: bold; }
                        .amount-positive { color: #2e7d32; }
                        .amount-negative { color: #ba1a1a; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-name">BEHAVANA</div>
                        <div class="report-title">Rapport Détaillé du Collecteur</div>
                    </div>
                    
                    <div class="collector-info">
                        <strong>Collecteur:</strong> ${collector.name}  

                        <strong>CIN:</strong> ${collector.cin || 'N/A'} ${collector.cinDate ? `(délivré le ${formatDate(collector.cinDate)})` : ''}
                    </div>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-value amount-negative">${formatCurrency(totalDebits)}</div>
                            <div class="summary-label">Total Débits (Avances + Paiements)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value amount-positive">${formatCurrency(totalCredits)}</div>
                            <div class="summary-label">Total Crédits (Livr. + Remb.)</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value">${formatCurrency(Math.abs(balance))}</div>
                            <div class="summary-label">Solde Actuel (${status.label})</div>
                        </div>
                    </div>
                    
                    <div class="section-title">💰 Historique des Avances</div>
                    ${advances.length > 0 ? `
                        <table>
                            <thead><tr><th>Date</th><th>Motif</th><th style="text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${advances.sort((a, b) => new Date(a.date) - new Date(b.date)).map(advance => `
                                    <tr><td>${formatDate(advance.date)}</td><td>${advance.motif || ''}</td><td style="text-align: right;">${formatCurrency(advance.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL AVANCES</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalAdvances)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucune avance enregistrée.</p>'}
                    
                    <div class="section-title">📦 Historique des Livraisons</div>
                    ${receptions.length > 0 ? `
                        <table>
                            <thead><tr><th>Date</th><th style="text-align: right;">Poids Net</th><th>Qualité</th><th style="text-align: right;">Valeur</th></tr></thead>
                            <tbody>
                                ${receptions.sort((a, b) => new Date(a.date) - new Date(b.date)).map(reception => `
                                    <tr><td>${formatDate(reception.date)}</td><td style="text-align: right;">${reception.netWeight.toFixed(2)} kg</td><td>${reception.quality}</td><td style="text-align: right;">${formatCurrency(reception.totalValue)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="3"><strong>TOTAL LIVRAISONS</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalDeliveries)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucune livraison enregistrée.</p>'}

                    <div class="section-title">💵 Historique des Remboursements</div>
                    ${remboursements.length > 0 ? `
                        <table>
                            <thead><tr><th>Date</th><th>Note</th><th style="text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${remboursements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(rem => `
                                    <tr><td>${formatDate(rem.date)}</td><td>${rem.note || ''}</td><td style="text-align: right;">${formatCurrency(rem.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL REMBOURSÉ</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalRemboursements)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucun remboursement enregistré.</p>'}

                    <!-- === LISITRY NY PAIEMENTS (VAOVAO) === -->
                    <div class="section-title">💸 Historique des Paiements de Solde</div>
                    ${paiements.length > 0 ? `
                        <table>
                            <thead><tr><th>Date</th><th>Note</th><th style="text-align: right;">Montant</th></tr></thead>
                            <tbody>
                                ${paiements.sort((a, b) => new Date(a.date) - new Date(b.date)).map(p => `
                                    <tr><td>${formatDate(p.date)}</td><td>${p.note || ''}</td><td style="text-align: right;">${formatCurrency(p.amount)}</td></tr>
                                `).join('')}
                                <tr class="total-row"><td colspan="2"><strong>TOTAL PAYÉ</strong></td><td style="text-align: right;"><strong>${formatCurrency(totalPaiements)}</strong></td></tr>
                            </tbody>
                        </table>
                    ` : '<p>Aucun paiement de solde enregistré.</p>'}
                    
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
        }



        function formatCIN(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.substring(0, 12);
            let parts = [];

            for (let i = 0; i < value.length; i += 3) {
                parts.push(value.substring(i, i + 3));
            }

            input.value = parts.join(' ');
        }

        function capitalizeLive(input) {
            if (!input || !input.value) return;

            // Tazomina ny cursor position
            const cursorPosition = input.selectionStart;

            // Capitalize chaque mot
            input.value = input.value
                .toLowerCase()
                .replace(/\b\w/g, c => c.toUpperCase());

            // Averina amin'ny position tany aloha ilay cursor
            input.setSelectionRange(cursorPosition, cursorPosition);
        }

        
        /* === GLOBAL SEARCH === */
        function globalSearch() {
            const query = document.getElementById("global-search-input").value.toLowerCase();
            
            // Manivana ny tabilao hita maso ihany
            const activeTable = document.querySelector('.content-section.active table');
            if (!activeTable) return;

            const tbody = activeTable.querySelector("tbody");
            if (!tbody) return;

            tbody.querySelectorAll("tr").forEach(row => {
                // Tsy manafina ny andalana mampiseho hoe "banga"
                if (row.querySelector('.empty-state')) {
                    return;
                }
                
                let text = row.innerText.toLowerCase();
                if (text.includes(query)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }


        /* === TOAST / SNACKBAR === */
        function showToast(message, duration = 3000) {
            let toast = document.createElement("div");
            toast.textContent = message;
            toast.style.position = "fixed";
            toast.style.bottom = "24px";
            toast.style.left = "50%";
            toast.style.transform = "translateX(-50%)";
            toast.style.background = "var(--md-sys-color-primary)";
            toast.style.color = "var(--md-sys-color-on-primary)";
            toast.style.padding = "12px 24px";
            toast.style.borderRadius = "8px";
            toast.style.boxShadow = "0 4px 8px rgba(0,0,0,0.3)";
            toast.style.zIndex = "3000";
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = "0";
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        /* Exemple d'utilisation toast après ajout ou suppression */
        function afterAddSuccess(entity) {
            showToast(entity + " ajouté avec succès !");
        }
        function afterDeleteSuccess(entity) {
            showToast(entity + " supprimé avec succès !");
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span>Chargement...</span>
                </div>
            `;
        }

        function hideLoading(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
        }
        //-----  Error Handling sy Validation -----------
        function showError(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="material-icons">${type === 'error' ? 'error' : 'check_circle'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="toast-close">
                    <span class="material-icons">close</span>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function validateForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('error');
                    isValid = false;
                } else {
                    input.classList.remove('error');
                }
            });
            
            return isValid;
        }

        // Mampiseho fampandrenesana "toast"
        function showToast(message, type = 'success', duration = 3000) {
            // Esory aloha izay toast efa misy
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Forony ilay singa toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; // Mampiasa ny kilasy 'success' na 'error'
            
            const icon = type === 'success' ? 'check_circle' : 'error';
            toast.innerHTML = `
                <span class="material-icons">${icon}</span>
                <span>${message}</span>
            `;

            // Ampio ao anaty body
            document.body.appendChild(toast);

            // Ampio ny kilasy 'show' mba hisehoany miaraka amin'ny transition
            // Mampiasa setTimeout kely mba hahazoan'ny navigateur ny fotoana
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Esory ny toast aorian'ny fotoana voatondro
            setTimeout(() => {
                toast.classList.remove('show');
                // Esory tanteraka ao amin'ny DOM rehefa vita ny transition
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }


        // Soloina tanteraka ity fiasa ity
        function updateFinancialInsights(stats) {
            const insightTitle1 = document.getElementById('insight-title-1');
            const insightDetail1 = document.getElementById('insight-detail-1');
            const insightIcon1 = document.getElementById('insight-icon-1');
            const recoveryRateEl = document.getElementById('recovery-rate');
            const debtorsInfoEl = document.getElementById('debtors-info');
            
            // --- VAOVAO: Alaina ilay karatra ---
            const debtorsCard = document.getElementById('debtors-card');

            // Insight 1: Toe-bola ankapobeny (tsy miova)
            if (stats.balance > 0) {
                insightTitle1.textContent = 'Situation Financière Positive';
                insightDetail1.textContent = `Excédent de ${formatCurrency(stats.balance)} après couverture des avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_up</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-success)';
            } else if (stats.balance < 0) {
                insightTitle1.textContent = 'Déficit à Surveiller';
                insightDetail1.textContent = `Il manque ${formatCurrency(Math.abs(stats.balance))} pour couvrir toutes les avances.`;
                insightIcon1.innerHTML = '<span class="material-icons">trending_down</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-error)';
            } else {
                insightTitle1.textContent = 'Équilibre Parfait';
                insightDetail1.textContent = 'Les avances et la valeur de la vanille sont parfaitement équilibrées.';
                insightIcon1.innerHTML = '<span class="material-icons">balance</span>';
                insightIcon1.style.backgroundColor = 'var(--md-sys-color-secondary)';
            }

            // Insight 2: Taux de récupération (tsy miova)
            recoveryRateEl.textContent = `${stats.recoveryRate.toFixed(1)}% des avances sont actuellement couvertes par la vanille collectée.`;

            // --- VAOVAO: Lojika ho an'ny karatra "Collecteurs en Dette" ---
            // Esory aloha izay "event listener" efa nisy teo aloha
            debtorsCard.onclick = null;
            debtorsCard.classList.remove('clickable');

            if (stats.debtorsCount === 0) {
                debtorsInfoEl.textContent = 'Excellent! Aucun collecteur n\'a de dette en cours.';
            } else {
                debtorsInfoEl.textContent = `Attention: ${stats.debtorsCount} collecteur${stats.debtorsCount > 1 ? 's' : ''} ont encore des dettes à rembourser.`;
                
                // Ataovy azo tsindriana ilay karatra
                debtorsCard.classList.add('clickable');
                
                // Ampio ny hetsika rehefa tsindriana
                debtorsCard.onclick = function() {
                    // 1. Mandehana any amin'ny fizarana "Suivi & Analyse"
                    navigateToSection('analysis');
                    
                    // 2. Ovay ny sivana mba hampisehoana an'ireo misy trosa ihany
                    filterAnalysisByStatus('debiteur');
                    
                    // 3. Ampahafantaro ny mpampiasa
                    showToast('Affichage des collecteurs en dette.', 'success', 2000);
                };
            }
        }

        // --- VAOVAO: Fiasa vaovao hanivanana ny tabilao Analyse ---
        function filterAnalysisByStatus(statusToFilter) {
            const tbody = document.getElementById('analysis-table');
            if (!tbody) return;

            tbody.querySelectorAll("tr").forEach(row => {
                if (row.querySelector('.empty-state')) return;

                const statusCell = row.querySelector('.status-badge');
                if (statusCell) {
                    // Jereo raha misy ilay kilasy mifanaraka amin'ny sivana
                    if (statusCell.classList.contains(`status-${statusToFilter}`)) {
                        row.style.display = ""; // Asehoy
                    } else {
                        row.style.display = "none"; // Afeno
                    }
                }
            });
        }


        // Ampio ity fiasa vaovao ity
        function resetAnalysisView() {
            // 1. Averina ho banga ny select
            document.getElementById('analysis-filter-collector').value = '';
            
            // 2. Antsoy ny updateAnalysisTable mba hanavao ny tabilao
            updateAnalysisTable();
            
            // 3. Asehoy ny andalana rehetra (raha nisy sivana hafa natao)
            const tbody = document.getElementById('analysis-table');
            if (tbody) {
                tbody.querySelectorAll("tr").forEach(row => {
                    row.style.display = "";
                });
            }
            
            showToast('Filtres réinitialisés.', 'success', 2000);
        }


        // Ampio ireto fiasa vaovao ireto

        /**
         * Ity fiasa ity dia manafina ny andalana rehetra afa-tsy ireo misy trosa.
         * Tsy manova ny atin'ny tabilao izy fa manafina fotsiny.
         */
        function filterAnalysisForDebtors() {
            const tbody = document.getElementById('analysis-table');
            if (!tbody) return;

            tbody.querySelectorAll("tr").forEach(row => {
                if (row.querySelector('.empty-state')) return;

                const statusCell = row.querySelector('.status-badge.status-debiteur');
                if (statusCell) {
                    row.style.display = ""; // Asehoy raha misy trosa
                } else {
                    row.style.display = "none"; // Afeno raha tsy izany
                }
            });
        }

        /**
         * Ity fiasa ity dia mamerina ny sivana rehetra amin'ny laoniny.
         * Mamerina ny select ho banga ary mampiseho ny andalana rehetra.
         */
        function showAllInAnalysis() {
            // 1. Averina ho banga ny select
            document.getElementById('analysis-filter-collector').value = '';
            document.getElementById('analysis-filter-quality').value = '';
            
            // 2. Antsoy ny updateAnalysisTable mba hamerenana ny lisitra feno
            updateAnalysisTable();
            
            // 3. Asehoy ny andalana rehetra (double-check)
            const tbody = document.getElementById('analysis-table');
            if (tbody) {
                tbody.querySelectorAll("tr").forEach(row => {
                    row.style.display = "";
                });
            }
            
            showToast('Affichage de tous les collecteurs.', 'success', 2000);
        }

        // --- FIASA VAOVAO HO AN'NY GESTION DE QUALITÉ ---

        function updateQualitiesTable() {
            const tbody = document.getElementById('qualities-table');
            tbody.innerHTML = '';
            if (!appData.qualities || appData.qualities.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="empty-state">Aucune qualité définie.</td></tr>`;
                return;
            }
            appData.qualities.forEach(quality => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Nom">${quality.name}</td>
                    <td data-label="Description">${quality.description || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openQualityModal(${quality.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteQuality(${quality.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openQualityModal(id = null) {
            const form = document.getElementById('quality-form');
            form.reset();
            document.getElementById('quality-id').value = '';
            if (id) {
                const quality = appData.qualities.find(q => q.id === id);
                if (quality) {
                    document.getElementById('quality-id').value = quality.id;
                    document.getElementById('quality-name').value = quality.name;
                    document.getElementById('quality-description').value = quality.description;
                }
            }
            openModal('quality-modal');
        }

        function saveQuality(event) {
            event.preventDefault();
            const id = document.getElementById('quality-id').value;
            const qualityData = {
                name: document.getElementById('quality-name').value.trim(),
                description: document.getElementById('quality-description').value.trim()
            };

            if (id) {
                qualityData.id = parseInt(id);
            }

            saveToDB('qualities', qualityData);
            closeModal('quality-modal');
            showToast('Qualité enregistrée avec succès!');
        }

        function deleteQuality(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette qualité?')) {
                deleteFromDB('qualities', id, () => {
                    showToast('Qualité supprimée.', 'error');
                    
                });
            }
        }

        // Apetaho miaraka amin'ireo fiasa hafa ity
        function updateQualitySelect() {
            const select = document.getElementById('reception-quality');
            const currentValue = select.value; // Tehirizina ny sanda voafidy
            
            // Esorina ny safidy taloha afa-tsy ilay voalohany
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }

            if (appData.qualities) {
                appData.qualities.forEach(quality => {
                    const option = document.createElement('option');
                    option.value = quality.name; // Tehirizina ny anarany
                    option.textContent = quality.name;
                    select.appendChild(option);
                });
            }
            
            select.value = currentValue; // Averina ilay sanda voafidy
        }

        function updateCharts() {
            // Alaina fotsiny ireo loko tena ilaina amin'ny DATASETS
            const style = getComputedStyle(document.body);
            const primaryColor = style.getPropertyValue('--md-sys-color-primary').trim();
            const errorColor = style.getPropertyValue('--md-sys-color-error').trim();
            const surfaceColor = style.getPropertyValue('--md-sys-color-surface').trim();

            // Loko maro samihafa (tsy miova)
            const chartColors = [
                primaryColor, '#7d5260', '#FFC107', '#4CAF50',
                '#2196F3', '#FF5722', '#9C27B0', '#607D8B'
            ];

            // --- Fikirana ankapobeny ho an'ny soratra sy tsipika ---
            // Ity no mamaha ny olana. Avelantsika i Chart.js hitantana ny loko
            // amin'ny alalan'ny fanomezana loko fototra azy.
            Chart.defaults.color = style.getPropertyValue('--md-sys-color-on-surface').trim();
            Chart.defaults.borderColor = style.getPropertyValue('--md-sys-color-outline-variant').trim();


            // --- 1. GRAFIKA BORIBORY (PIE CHART) ---
            const totalAdvances = appData.advances.reduce((sum, advance) => sum + advance.amount, 0);
            const totalVanillaValue = appData.receptions.reduce((sum, reception) => sum + reception.totalValue, 0);
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            if (pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Total Avances', 'Valeur Vanille'],
                    datasets: [{
                        data: [totalAdvances, totalVanillaValue],
                        backgroundColor: [errorColor, primaryColor],
                        borderColor: surfaceColor,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } } // Tsy mila mamaritra loko intsony eto
                }
            });

            // --- 2. GRAFIKA MITSIVALANA: AVANCES PAR COLLECTEUR ---
            const advancesByCollector = {};
            appData.advances.forEach(advance => {
                const collector = appData.collectors.find(c => c.id === advance.collectorId);
                if (collector) {
                    advancesByCollector[collector.name] = (advancesByCollector[collector.name] || 0) + advance.amount;
                }
            });
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(advancesByCollector),
                    datasets: [{
                        label: 'Total des Avances',
                        data: Object.values(advancesByCollector),
                        backgroundColor: chartColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        y: { grid: { display: false } }, // Tsy mila mamaritra loko intsony eto
                        x: {}
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- 3. GRAFIKA MITSANGANA: LANJA ISAKY NY KALITAO ---
            const weightByQuality = {};
            appData.receptions.forEach(reception => {
                if (reception.quality) {
                    weightByQuality[reception.quality] = (weightByQuality[reception.quality] || 0) + reception.netWeight;
                }
            });
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            if (qualityChartInstance) qualityChartInstance.destroy();
            qualityChartInstance = new Chart(qualityCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(weightByQuality),
                    datasets: [{
                        label: 'Poids Net (kg)',
                        data: Object.values(weightByQuality),
                        backgroundColor: chartColors.slice().reverse(),
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }, // Tsy mila mamaritra loko intsony eto
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- FIASA VAOVAO HO AN'NY DÉPENSES ---
        function updateExpensesTable() {
            const tbody = document.getElementById('expenses-table');
            tbody.innerHTML = '';
            
            // Hamarino aloha raha misy ny appData.expenses
            if (!appData.expenses || appData.expenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">receipt_long</div>
                            <div>Aucune dépense enregistrée</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by date descending
            const sortedExpenses = [...appData.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedExpenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(expense.date)}</td>
                    <td data-label="Catégorie">${expense.category}</td>
                    <td data-label="Description">${expense.description}</td>
                    <td data-label="Montant">${formatCurrency(expense.amount)}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openExpenseModal(${expense.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteExpense(${expense.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Manokatra ny modal fampidirana fandaniana
        function openExpenseModal(expenseId = null) {
            const form = document.getElementById('expense-form');
            form.reset();
            delete form.dataset.editId;

            if (expenseId) {
                const expense = appData.expenses.find(e => e.id === expenseId);
                if (expense) {
                    form.dataset.editId = expenseId;
                    document.getElementById('expense-date').value = expense.date;
                    document.getElementById('expense-category').value = expense.category;
                    document.getElementById('expense-description').value = expense.description;
                    document.getElementById('expense-amount').value = expense.amount;
                }
            } else {
                // Apetraka ho anio ny daty default
                document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            }
            openModal('expense-modal');
        }

        // Mitehiry ny fandaniana
        function saveExpense() {
            const form = document.getElementById('expense-form');
            const cleanAmount = document.getElementById('expense-amount').value.replace(/\D/g, '');

            const expense = {
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                description: document.getElementById('expense-description').value,
                amount: parseInt(cleanAmount) || 0,
                createdAt: new Date().toISOString()
            };

            if (form.dataset.editId) {
                expense.id = parseInt(form.dataset.editId);
            }

            saveToDB('expenses', expense);
            closeModal('expense-modal');
            showToast('Dépense enregistrée avec succès!');
        }

        // Mamafa ny fandaniana
        function deleteExpense(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette dépense?')) {
                deleteFromDB('expenses', id, () => {
                    showToast('Dépense supprimée.', 'error');
                });
            }
        }

        // Fiasa vaovao hikajiana sy hampisehoana ny Prix de Revient
        function updatePrixRevientAnalysis() {
            const container = document.getElementById('prix-revient-container');
            container.innerHTML = '';

            // --- 1. Famaritana ny atao hoe kalitao tsara sy ratsy ---
            // Ireto no heverina ho mitondra tombony
            const BONNES_QUALITES = ['Lava', 'Fendue']; 
            // Ireto kosa no heverina ho fatiantoka na kalitao ambany
            const MAUVAISES_QUALITES = ['Lo', 'Fohy', 'Verte'];

            // --- 2. Angonina ny totaliny rehetra ---
            const totalCost = (appData.advances || []).reduce((sum, a) => sum + a.amount, 0) + 
                            (appData.expenses || []).reduce((sum, e) => sum + e.amount, 0);

            // --- 3. Sarahana ny lanja araka ny kalitao ---
            let poidsBonnesQualites = 0;
            let valeurBonnesQualites = 0;
            let poidsMauvaisesQualites = 0;
            let valeurMauvaisesQualites = 0;

            (appData.receptions || []).forEach(reception => {
                if (BONNES_QUALITES.includes(reception.quality)) {
                    poidsBonnesQualites += reception.netWeight;
                    valeurBonnesQualites += reception.totalValue;
                } else { // Raha tsy ao anatin'ny kalitao tsara dia heverina ho ratsy
                    poidsMauvaisesQualites += reception.netWeight;
                    valeurMauvaisesQualites += reception.totalValue;
                }
            });

            const totalPoidsVert = poidsBonnesQualites + poidsMauvaisesQualites;

            // --- 4. Alaina ny tahan'ny rendement avy amin'ny paramètre ---
            const rendementRate = parseFloat(document.getElementById('rendement-rate').value) || 25;
            const rendementDecimal = rendementRate / 100;
            
            // --- 5. Kajiana ny lanja maina TOMBANA ho an'ny kalitao tsara IHANY ---
            const poidsSecEstime = poidsBonnesQualites * rendementDecimal;

            // Fiarovana raha tsy misy na inona na inona
            if (totalPoidsVert === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">inventory_2</span>
                        <div>Aucune réception de vanille enregistrée. Le calcul est impossible.</div>
                    </div>
                `;
                return;
            }

            // --- 6. Kajiana ny Prix de Revient mifototra amin'ny kalitao tsara ---
            // Ny vidiny dia ny vola nivoaka REHETRA, fa ny lanja dia ny an'ny kalitao tsara maina IHANY
            const prixRevientPerKgSec = poidsSecEstime > 0 ? totalCost / poidsSecEstime : 0;

            // --- 7. Amboarina ny fampisehoana (HTML) vaovao ---
            const analysisHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    
                    <!-- Karatra 1: Vola Nivoaka (Tsy miova) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background-color: var(--md-sys-color-error-container);">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-error-container);">COÛT TOTAL (ARGENT SORTI)</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-error-container); margin-top: 8px;">${formatCurrency(totalCost)}</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-error-container); opacity: 0.8;">
                            Avances + Dépenses Opérationnelles
                        </div>
                    </div>

                    <!-- Karatra 2: Famakafakana ny Lanja (VAOVAO) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background-color: var(--md-sys-color-primary-container);">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-primary-container);">ANALYSE DES POIDS (VANILLE VERTE)</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-primary-container); margin-top: 8px;">${totalPoidsVert.toFixed(2)} kg</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-primary-container); opacity: 0.8;">
                            Dont <b>${poidsBonnesQualites.toFixed(2)} kg</b> de bonne qualité  

                            et <b>${poidsMauvaisesQualites.toFixed(2)} kg</b> de qualité inférieure (perte potentielle).
                        </div>
                    </div>

                    <!-- Karatra 3: Prix de Revient (VAOVAO) -->
                    <div class="insight-item" style="flex-direction: column; align-items: flex-start; background: linear-gradient(135deg, var(--md-sys-color-tertiary-container), var(--md-sys-color-tertiary));">
                        <div class="insight-text" style="font-size: 14px; color: var(--md-sys-color-on-tertiary-container);">PRIX DE REVIENT RÉÉVALUÉ</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--md-sys-color-on-tertiary-container); margin-top: 8px;">${formatCurrency(prixRevientPerKgSec)} / kg</div>
                        <div style="font-size: 12px; margin-top: 12px; color: var(--md-sys-color-on-tertiary-container); opacity: 0.8;">
                            Calculé sur <b>${poidsSecEstime.toFixed(2)} kg</b> de vanille sèche (bonne qualité) avec un rendement de <b>${rendementRate}%</b>.
                        </div>
                    </div>

                </div>
            `;
            container.innerHTML = analysisHTML;
        }



        function saveSettings() {
            const rendementRate = document.getElementById('rendement-rate').value;
            localStorage.setItem('rendementRate', rendementRate);
            showToast('Paramètres enregistrés avec succès!');
            // Havaozina ny kajy rehetra rehefa miova ny paramètre
            updateAllTables();
        }

        function loadSettings() {
            const savedRate = localStorage.getItem('rendementRate');
            if (savedRate) {
                document.getElementById('rendement-rate').value = savedRate;
            }
        }

        // --- FIASA VAOVAO HO AN'NY REMBOURSEMENT ---

        function openRemboursementModal(collectorId, remboursementId = null) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Collecteur non trouvé !");
                return;
            }
            
            const form = document.getElementById('remboursement-form');
            form.reset();
            delete form.dataset.editId;

            document.getElementById('remboursement-collector-id').value = collector.id;
            document.getElementById('remboursement-collector-name').value = collector.name;
            document.getElementById('remboursement-date').value = new Date().toISOString().split('T')[0];

            if (remboursementId) {
                // Mode MODIFICATION
                const rem = appData.remboursements.find(r => r.id === remboursementId);
                if (rem) {
                    form.dataset.editId = remboursementId;
                    document.getElementById('remboursement-amount').value = rem.amount;
                    document.getElementById('remboursement-date').value = rem.date;
                    document.getElementById('remboursement-note').value = rem.note;
                }
            } else {
                // Mode AJOUT
                const balance = calculateCollectorBalance(collector.id);
                if (balance < 0) {
                    document.getElementById('remboursement-amount').placeholder = `Trosa actuel: ${formatCurrency(Math.abs(balance))}`;
                } else {
                    document.getElementById('remboursement-amount').placeholder = '0';
                }
            }

            openModal('remboursement-modal');
        }


        function saveRemboursement(event) {
            event.preventDefault();
            const form = document.getElementById('remboursement-form');
            const cleanAmount = document.getElementById('remboursement-amount').value.replace(/\D/g, '');

            const remboursement = {
                collectorId: parseInt(document.getElementById('remboursement-collector-id').value),
                amount: parseInt(cleanAmount) || 0,
                date: document.getElementById('remboursement-date').value,
                note: document.getElementById('remboursement-note').value.trim(),
            };

            if (remboursement.amount <= 0) {
                alert("Le montant du remboursement doit être supérieur à zéro.");
                return;
            }

            if (form.dataset.editId) {
                remboursement.id = parseInt(form.dataset.editId);
            } else {
                remboursement.createdAt = new Date().toISOString();
            }

            saveToDB('remboursements', remboursement);
            closeModal('remboursement-modal');
            showToast('Remboursement enregistré avec succès!');
        }


        // --- FIASA VAOVAO HO AN'NY LISITRY NY REMBOURSEMENTS ---

        function updateRemboursementsTable() {
            const tbody = document.getElementById('remboursements-table');
            tbody.innerHTML = '';
            
            const remboursementsData = appData.remboursements || [];

            if (remboursementsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">history_toggle_off</div>
                            <div>Aucun remboursement enregistré</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedRemboursements = [...remboursementsData].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedRemboursements.forEach(rem => {
                const collector = appData.collectors.find(c => c.id === rem.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(rem.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td data-label="Montant">${formatCurrency(rem.amount)}</td>
                    <td data-label="Note">${rem.note || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-outline" onclick="openRemboursementModalToEdit(${rem.id})" title="Modifier">
                            <span class="material-icons">edit</span>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteRemboursement(${rem.id})" title="Supprimer">
                            <span class="material-icons">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openRemboursementModalToEdit(remboursementId) {
            const rem = appData.remboursements.find(r => r.id === remboursementId);
            if (!rem) {
                alert("Remboursement non trouvé !");
                return;
            }
            
            openRemboursementModal(rem.collectorId, remboursementId);
        }

        function deleteRemboursement(remboursementId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce remboursement ? Cette action est irréversible.')) {
                deleteFromDB('remboursements', remboursementId, () => {
                    showToast('Remboursement supprimé.', 'error');
                });
            }
        }


        /**
         * Fiasa vaovao handoavana ny trosan'ny orinasa amin'ny mpanangom-bokatra.
         * Mamorona "paiement" manokana izy ity fa TSY "dépense".
         */
        // Kaody VAOVAO hasolo ilay teo ambony
        function payCollectorCredit(collectorId) {
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                alert("Collecteur non trouvé !");
                return;
            }

            // Kajiana ny balance alohan'ny fandoavana
            const balance = calculateCollectorBalance(collectorId);

            if (balance <= 0) {
                alert("Ce collecteur n'a pas de solde créditeur à payer.");
                return;
            }

            const paymentAmount = balance;

            // --- FANONTANIANA VAOVAO MANGATAKA NOTE ---
            const noteFromUser = prompt(`Vous allez payer ${formatCurrency(paymentAmount)} à ${collector.name}.\n\nVeuillez entrer une note pour ce paiement (ex: Par chèque N°123, En espèce, etc.)`, "Paiement du solde créditeur");

            // Raha manindry "Annuler" (Cancel) ny mpampiasa dia ajanona ny processus
            if (noteFromUser === null) {
                showToast("Paiement annulé.", "error");
                return;
            }

            // Fanontaniana fanamafisana miaraka amin'ny note
            if (confirm(`Confirmer le paiement de ${formatCurrency(paymentAmount)} à ${collector.name} avec la note : "${noteFromUser}" ?`)) {
                
                // Amboary ilay "paiement" vaovao
                const paiement = {
                    collectorId: collectorId,
                    amount: paymentAmount,
                    date: new Date().toISOString().split('T')[0],
                    // Alaina ny note avy amin'ny mpampiasa, na ilay default raha navelany banga
                    note: noteFromUser.trim() || `Paiement du solde créditeur`,
                    createdAt: new Date().toISOString()
                };

                // Tehirizo ao amin'ny "paiements"
                saveToDB('paiements', paiement);

                showToast(`Paiement de ${formatCurrency(paymentAmount)} à ${collector.name} enregistré avec succès!`);
            }
        }


        // --- FIASA VAOVAO HO AN'NY LISITRY NY PAIEMENTS ---

        function updatePaiementsTable() {
            const tbody = document.getElementById('paiements-table');
            tbody.innerHTML = '';
            
            const paiementsData = appData.paiements || [];

            if (paiementsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <div class="material-icons">history_toggle_off</div>
                            <div>Aucun paiement de solde enregistré</div>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedPaiements = [...paiementsData].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedPaiements.forEach(p => {
                const collector = appData.collectors.find(c => c.id === p.collectorId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Date">${formatDate(p.date)}</td>
                    <td data-label="Collecteur">${collector ? collector.name : 'Collecteur supprimé'}</td>
                    <td data-label="Montant">${formatCurrency(p.amount)}</td>
                    <td data-label="Note">${p.note || ''}</td>
                    <td class="actions-cell">
                        <button class="btn btn-icon btn-danger" onclick="deletePaiement(${p.id})" title="Annuler ce paiement (irréversible)">
                            <span class="material-icons">delete_forever</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fiasa vaovao hikajiana sy hampisehoana ny analyse de rentabilité
        function updateRentabiliteInsights() {
            // Famaritana ny kalitao (mitovy amin'ny dingana 2)
            const BONNES_QUALITES = ['Lava', 'Fendue'];

            // Kajiana ny sandan'ny kalitao tsara sy ratsy
            let valeurBonnesQualites = 0;
            let valeurMauvaisesQualites = 0;

            (appData.receptions || []).forEach(reception => {
                if (BONNES_QUALITES.includes(reception.quality)) {
                    valeurBonnesQualites += reception.totalValue;
                } else {
                    valeurMauvaisesQualites += reception.totalValue;
                }
            });

            // Kajiana ny totalin'ny vola nivoaka (avances + dépenses)
            const totalCost = (appData.advances || []).reduce((sum, a) => sum + a.amount, 0) + 
                            (appData.expenses || []).reduce((sum, e) => sum + e.amount, 0);

            // Kajiana ny tahan'ny vokatra
            // (Vola azo avy amin'ny kalitao tsara / Vola nivoaka rehetra) * 100
            const tauxRendement = totalCost > 0 ? (valeurBonnesQualites / totalCost) * 100 : 0;

            // Fenoy ny karatra 1: Valeur Récupérable
            const valeurRecuperableEl = document.getElementById('valeur-recuperable-detail');
            valeurRecuperableEl.textContent = `${formatCurrency(valeurBonnesQualites)} - C'est la valeur brute des produits vendables.`;

            // Fenoy ny karatra 2: Perte sur Qualité
            const perteQualiteEl = document.getElementById('perte-qualite-detail');
            perteQualiteEl.textContent = `${formatCurrency(valeurMauvaisesQualites)} - Cet argent est difficilement récupérable.`;

            // Fenoy ny karatra 3: Taux de Rendement
            const rendementOpEl = document.getElementById('rendement-op-detail');
            rendementOpEl.textContent = `${tauxRendement.toFixed(1)}% - Pour 100 Ar dépensés, ${formatCurrency(tauxRendement.toFixed(0))} sont couverts par de la bonne qualité.`;

            // Manova loko miankina amin'ny tahan'ny vokatra
            const rendementCard = document.getElementById('insight-rendement-op');
            if (tauxRendement >= 100) {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-success)';
            } else if (tauxRendement < 50) {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-error)';
            } else {
                rendementCard.querySelector('.insight-icon').style.backgroundColor = 'var(--md-sys-color-primary)';
            }
        }


        function deletePaiement(paiementId) {
            if (confirm('ATTENTION : Annuler un paiement va recréer le crédit pour le collecteur. Êtes-vous sûr de vouloir continuer ?')) {
                deleteFromDB('paiements', paiementId, () => {
                    showToast('Paiement annulé avec succès.', 'error');
                });
            }
        }

        function exportAnalysisToExcel() {
            // 1. Angonina aloha ny angona avy amin'ny tabilao
            const table = document.getElementById('analysis-table');
            if (!table) {
                showToast("Tsy hita ny tabilao hanaovana export.", "error");
                return;
            }

            const data = [];
            // Ampidirina ny lohan'ny tabilao (headers)
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            // Esory ny tsanganana "Actions"
            headers.pop(); 
            data.push(headers);

            // Angonina ny andalana tsirairay
            table.querySelectorAll('tbody tr').forEach(row => {
                // Hamarino raha andalana misy angona fa tsy ilay hoe "banga"
                if (row.querySelector('td.empty-state')) {
                    return;
                }
                const rowData = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                // Esory ny votoatin'ny sela "Actions"
                rowData.pop(); 
                data.push(rowData);
            });

            if (data.length <= 1) {
                showToast("Tsy misy angona azo alefa amin'ny Excel.", "error");
                return;
            }

            // 2. Amboarina ny "worksheet" sy ny "workbook" Excel
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Analyse des Collecteurs');

            // Manamboatra ny sakan'ny tsanganana mba ho malalaka tsara
            const colWidths = headers.map(header => ({ wch: Math.max(header.length, 15) }));
            worksheet['!cols'] = colWidths;

            // 3. Avoaka ny rakitra Excel
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Analyse_Collecteurs_${today}.xlsx`);

            showToast("Export Excel vita soa aman-tsara!", "success");
        }

        function exportCollectorDetailsToExcel(collectorId) {
            // 1. Angonina ny mombamomba ilay collecteur
            const collector = appData.collectors.find(c => c.id === collectorId);
            if (!collector) {
                showToast("Tsy hita ny collecteur!", "error");
                return;
            }

            // 2. Angonina ny transaction rehetra mifandraika aminy
            const advances = appData.advances.filter(a => a.collectorId === collectorId);
            const receptions = appData.receptions.filter(r => r.collectorId === collectorId);
            const remboursements = (appData.remboursements || []).filter(rem => rem.collectorId === collectorId);
            const paiements = (appData.paiements || []).filter(p => p.collectorId === collectorId);

            // 3. Amboarina ny "workbook" Excel
            const workbook = XLSX.utils.book_new();

            // === Takelaka 1: Famintinana (Summary) ===
            const summaryData = [
                ["Rapport Détaillé du Collecteur"],
                [], // Andalana banga
                ["Nom du Collecteur:", collector.name],
                ["Téléphone:", collector.phone || 'N/A'],
                ["CIN:", `${collector.cin || 'N/A'} (délivré le: ${collector.cinDate ? formatDate(collector.cinDate) : 'N/A'})`],
                [], // Andalana banga
                ["RÉSUMÉ FINANCIER"],
                ["Total Avances:", getTotalAdvances(collectorId)],
                ["Total Livraisons (Valeur):", getTotalDeliveries(collectorId)],
                ["Total Remboursements:", remboursements.reduce((sum, r) => sum + r.amount, 0)],
                ["Total Paiements de Solde:", paiements.reduce((sum, p) => sum + p.amount, 0)],
                ["Solde Actuel:", calculateCollectorBalance(collectorId)]
            ];
            const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
            // Manamboatra ny sakan'ny tsanganana
            summarySheet['!cols'] = [{ wch: 25 }, { wch: 25 }];
            XLSX.utils.book_append_sheet(workbook, summarySheet, "Résumé");

            // === Takelaka 2: Avances ===
            const advancesData = advances.map(a => ({
                Date: formatDate(a.date),
                Motif: a.motif || '',
                Montant: a.amount
            }));
            const advancesSheet = XLSX.utils.json_to_sheet(advancesData);
            advancesSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, advancesSheet, "Avances");

            // === Takelaka 3: Livraisons (Réceptions) ===
            const receptionsData = receptions.map(r => ({
                Date: formatDate(r.date),
                "Poids Net (kg)": r.netWeight,
                Qualité: r.quality,
                "Prix/kg": r.price,
                Valeur: r.totalValue
            }));
            const receptionsSheet = XLSX.utils.json_to_sheet(receptionsData);
            receptionsSheet['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, receptionsSheet, "Livraisons");

            // === Takelaka 4: Remboursements ===
            const rembData = remboursements.map(r => ({
                Date: formatDate(r.date),
                Note: r.note || '',
                Montant: r.amount
            }));
            const rembSheet = XLSX.utils.json_to_sheet(rembData);
            rembSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, rembSheet, "Remboursements");

            // === Takelaka 5: Paiements de Solde ===
            const paiementsData = paiements.map(p => ({
                Date: formatDate(p.date),
                Note: p.note || '',
                Montant: p.amount
            }));
            const paiementsSheet = XLSX.utils.json_to_sheet(paiementsData);
            paiementsSheet['!cols'] = [{ wch: 12 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(workbook, paiementsSheet, "Paiements de Solde");

            // 4. Avoaka ny rakitra Excel
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Details_${collector.name.replace(/\s/g, '_')}_${today}.xlsx`);

            showToast("Export Excel vita soa aman-tsara!", "success");
        }

        // Fisoratana anarana ny Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/behavana-app/sw.js') // <-- AHITSY ETO
                    .then(registration => {
                        console.log('Service Worker enregistré avec succès:', registration);
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement du Service Worker:', error);
                    });
            });
        }

    </script>
    </body>
</html>